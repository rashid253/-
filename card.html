<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title id="dynamicTitle">Digital Business</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a" id="themeColorMeta">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Premium Digital Business App">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap">
<link rel="manifest" href="manifest.json" id="manifestLink">

<style>
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
  --whatsapp-gradient: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --dark-color: #0f172a;
  --darker-color: #020617;
  --light-color: #f8fafc;
  --lighter-color: #ffffff;
  --glass-bg: rgba(255, 255, 255, 0.98);
  --glass-border: rgba(255, 255, 255, 0.2);
  --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  --shadow-lg: 0 20px 60px rgba(0,0,0,0.15);
  --shadow-md: 0 10px 30px rgba(0,0,0,0.1);
  --shadow-sm: 0 4px 15px rgba(0,0,0,0.08);
  --border-radius-xl: 32px;
  --border-radius-lg: 24px;
  --border-radius-md: 16px;
  --border-radius-sm: 12px;
  --border-radius-xs: 8px;
  --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Poppins', sans-serif;
  background: var(--primary-gradient);
  min-height: 100vh;
  color: var(--dark-color);
  position: fixed;
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: none;
}

.app-container {
  position: relative;
  width: 100%;
  height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  background: var(--light-color);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
  border-radius: 0;
}

.page {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 0;
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--light-color);
  transform: translateX(100%);
  opacity: 0;
  visibility: hidden;
  transition: var(--transition-slow);
  z-index: 1;
}

.page.active {
  transform: translateX(0);
  opacity: 1;
  visibility: visible;
  z-index: 2;
}

.page.slide-out {
  transform: translateX(-100%);
  opacity: 0;
  visibility: hidden;
}

#loadingScreen {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: var(--primary-gradient);
  z-index: 100;
}

.loader {
  width: 80px;
  height: 80px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 30px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-width: 480px;
  height: 70px;
  background: var(--glass-bg);
  backdrop-filter: blur(30px);
  border-top: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0 15px;
  z-index: 1000;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
  border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 8px;
  border-radius: var(--border-radius-md);
  cursor: pointer;
  transition: var(--transition);
  flex: 1;
  position: relative;
}

.nav-item.active {
  background: rgba(102, 126, 234, 0.1);
}

.nav-icon {
  font-size: 22px;
  color: #64748b;
  transition: var(--transition);
  position: relative;
}

.nav-item.active .nav-icon {
  color: #667eea;
  transform: scale(1.1);
}

.nav-label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  transition: var(--transition);
}

.nav-item.active .nav-label {
  color: #667eea;
  font-weight: 700;
}

/* ===== FIXED HEADER ===== */
.header-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  max-width: 480px;
  height: 80px;
  background: rgba(102, 126, 234, 0.95);
  backdrop-filter: blur(30px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 1001;
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.header-back-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: absolute;
  left: 16px;
  top: 18px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.save-contact-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: absolute;
  left: 76px;
  top: 18px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.header-icons {
  position: absolute;
  top: 18px;
  right: 16px;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 12px;
  z-index: 9998;
}

.header-icon-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.delivery-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #10b981;
  color: white;
  font-size: 10px;
  font-weight: 900;
  min-width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid rgba(255,255,255,0.5);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 11;
}

.cart-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ef4444;
  color: white;
  font-size: 11px;
  font-weight: 900;
  min-width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
  z-index: 12;
  padding: 0 4px;
}

/* ===== NOTIFICATION DRAWER ===== */
.notification-drawer {
  position: fixed;
  top: 0;
  right: -350px;
  width: 320px;
  height: 100%;
  background: white;
  box-shadow: -5px 0 30px rgba(0,0,0,0.2);
  z-index: 2000;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
}

.notification-drawer.open {
  right: 0;
}

.notification-header {
  padding: 20px;
  background: white;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-header h3 {
  font-size: 18px;
  font-weight: 800;
  color: var(--dark-color);
  display: flex;
  align-items: center;
  gap: 8px;
}

.notification-count {
  background: var(--primary-gradient);
  color: white;
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 12px;
}

.notification-list {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

.notification-item {
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 10px;
  transition: all 0.2s;
  cursor: pointer;
  border-left: 4px solid transparent;
}

.notification-item:hover {
  background: #f8fafc;
}

.notification-item.unread {
  background: #f0f9ff;
  border-left-color: #3b82f6;
}

.notification-item.read {
  opacity: 0.8;
}

.notification-footer {
  padding: 15px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 10px;
}

/* ===== NOTIFICATION ALERT ===== */
.notification-alert {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: var(--shadow-xl);
  z-index: 3000;
  max-width: 300px;
  animation: slideDown 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
  font-weight: 700;
  font-size: 14px;
  text-align: center;
  display: none;
}

@keyframes slideDown {
  from { top: -100px; opacity: 0; }
  to { top: 100px; opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

/* ===== PRODUCT CARDS ===== */
.products-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  padding: 0 12px;
  align-items: stretch;
  margin-bottom: 20px;
}

.product-card {
  height: 280px;
  width: 100%;
  display: flex;
  flex-direction: column;
  background: var(--lighter-color);
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  padding: 10px;
  overflow: hidden;
  transition: var(--transition-fast);
  cursor: pointer;
  position: relative;
  min-height: 280px;
  max-height: 280px;
}

.product-image-container {
  position: relative;
  width: 100%;
  height: 160px;
  background: #f8fafc;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 8px;
  flex-shrink: 0;
  border: 1px solid #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
}

.product-image {
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  display: block;
  padding: 4px;
}

.badge-container {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  z-index: 15;
}

.discount-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background: rgba(239, 68, 68, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 10px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 800;
  box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}

.offer-badge {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(16, 185, 129, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 12px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}

.feature-badge {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(139, 92, 246, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 10px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}

.product-content {
  display: flex;
  flex-direction: column;
  flex: 1;
  padding: 0 2px;
  position: relative;
}

.product-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--dark-color);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  height: 34px;
  margin-bottom: 6px;
}

.price-badge-container {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  height: 24px;
}

.current-price {
  font-weight: 900;
  color: #10b981;
  font-size: 15px;
  background: rgba(16, 185, 129, 0.1);
  padding: 4px 10px;
  border-radius: 20px;
  display: inline-flex;
  align-items: center;
}

.original-price {
  text-decoration: line-through;
  color: #94a3b8;
  font-size: 11px;
  font-weight: 500;
  margin-left: 8px;
}

.product-actions {
  display: flex;
  gap: 8px;
  height: 32px;
  margin-top: auto;
}

.btn-primary, .btn-secondary {
  flex: 1;
  height: 32px;
  border: none;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  transition: var(--transition-fast);
  white-space: nowrap;
  padding: 0 8px;
}

.btn-primary {
  background: var(--success-gradient);
  color: white;
}

.btn-secondary {
  background: var(--info-gradient);
  color: white;
}

/* ===== IMAGE ZOOM OVERLAY ===== */
.image-zoom-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}

.image-zoom-content {
  max-width: 90%;
  max-height: 90%;
  animation: zoomIn 0.3s ease;
}

/* ===== EXIT MODAL ===== */
.exit-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  padding: 20px;
}

/* ===== INSTALL BUTTON ===== */
.install-button-container {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  animation: slideDown 0.5s ease;
}

.install-btn {
  padding: 12px 24px;
  background: var(--primary-gradient);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ===== ORDER MANAGEMENT ===== */
.order-card {
  background: var(--lighter-color);
  border-radius: var(--border-radius-lg);
  padding: 16px;
  margin: 12px 16px;
  box-shadow: var(--shadow-md);
  border: 1px solid #e2e8f0;
  border-left: 5px solid #667eea;
}

/* ===== ADDRESS AUTO-DETECT ===== */
.address-auto-detect {
  background: var(--light-color);
  border-radius: var(--border-radius-md);
  padding: 16px;
  margin: 16px 0;
  border: 2px dashed #667eea;
}

.delivery-charge-calculator {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: var(--border-radius-md);
  padding: 20px;
  margin: 16px 0;
  border: 1px solid #e2e8f0;
}

/* ===== PROFESSIONAL PAYMENT METHODS ===== */
.pro-payment-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin: 16px 0;
}

.pro-payment-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: var(--border-radius-md);
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.pro-payment-card.selected {
  border-color: #10b981;
  background: #f0fdf4;
}

/* ===== ORDER TICKET ===== */
.order-ticket {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: var(--border-radius-lg);
  padding: 24px;
  margin: 20px 0;
  color: white;
  position: relative;
  overflow: hidden;
}

/* ===== TOKEN MANAGEMENT ===== */
.token-management {
  background: white;
  border-radius: var(--border-radius-lg);
  padding: 20px;
  margin: 16px;
  box-shadow: var(--shadow-md);
}

.token-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(15px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: var(--glass-bg);
  border-radius: var(--border-radius-xl);
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--glass-border);
}

.close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(0,0,0,0.1);
  color: var(--dark-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  cursor: pointer;
  z-index: 10;
}

/* ===== PRODUCT MODAL ===== */
.product-modal-image-container {
  position: relative;
  width: 100%;
  min-height: 200px;
  max-height: 300px;
  background: #f8fafc;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #f1f5f9;
}

.product-modal-image {
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 280px;
  object-fit: contain;
  display: block;
  padding: 8px;
}

.modal-price-container {
  margin-bottom: 16px;
  padding: 12px 0;
  border-bottom: 1px solid #f1f5f9;
}

/* ===== PAGE HEADERS ===== */
#homePage, #productsPage, #cartPage, #aboutPage, #contactPage, #deliveryPage, #adminPage, #loginPage {
  padding-top: 80px;
  padding-bottom: 100px;
  background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
}

.app-header {
  background: var(--primary-gradient);
  padding: 30px 25px;
  border-radius: 0 0 50px 50px;
  margin: 0;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-md);
}

.quick-actions {
  display: grid;
  grid-template-columns: repeat(4,1fr);
  gap: 12px;
  margin-top: 30px;
}

.action-card {
  background: rgba(255,255,255,0.2);
  padding: 12px;
  border-radius: 16px;
  text-align: center;
  color: white;
  cursor: pointer;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 480px) {
  .app-container { max-width: 100%; }
  .pro-payment-grid { grid-template-columns: 1fr; }
  .token-stats { grid-template-columns: 1fr; }
  .quick-actions { grid-template-columns: repeat(2,1fr); }
  .notification-drawer { width: 100%; right: -100%; }
}

@keyframes zoomIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f5f9;
}

::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 10px;
}
</style>
</head>

<body>
<div class="app-container">
  <!-- ===== FIXED HEADER ===== -->
  <div class="header-container">
    <button class="header-back-btn" id="headerBackBtn" onclick="window.goBack()" style="display:none;">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <button class="save-contact-btn" onclick="window.saveBusinessToContacts()" title="Save to Contacts">
      <i class="fas fa-address-card"></i>
    </button>
    
    <div class="header-icons">
      <div class="header-icon-btn" onclick="window.toggleNotificationDrawer()" title="Notifications">
        <i class="fas fa-bell" id="notificationBell"></i>
        <div class="delivery-badge" id="notificationBadge" style="display:none;">!</div>
      </div>
      
      <div class="header-icon-btn" id="deliveryStatusBtn" onclick="window.checkDeliveryStatus()" title="Delivery Status">
        <i class="fas fa-truck" id="deliveryIcon"></i>
        <div class="delivery-badge" id="deliveryBadge" style="display:none;"></div>
      </div>
      
      <div class="header-icon-btn" id="loginBtn" onclick="window.toggleLogin()" title="Login/Logout">
        <i class="fas fa-sign-in-alt" id="loginIcon"></i>
      </div>
      
      <div class="header-icon-btn" onclick="window.shareBusiness()" title="Share Business">
        <i class="fas fa-share-alt"></i>
      </div>
    </div>
  </div>

  <!-- ===== NOTIFICATION DRAWER ===== -->
  <div class="notification-drawer" id="notificationDrawer">
    <div class="notification-header">
      <h3><i class="fas fa-bell"></i> Notifications <span class="notification-count" id="notificationCount">0</span></h3>
      <button onclick="window.toggleNotificationDrawer()" style="background:none; border:none; font-size:24px; cursor:pointer;">√ó</button>
    </div>
    
    <div class="notification-list" id="notificationList"></div>
    
    <div class="notification-footer">
      <button onclick="window.notificationManager.markAllAsRead()" 
              style="flex:1; padding:12px; background:#f1f5f9; border:none; border-radius:8px; font-weight:700; cursor:pointer;">
        Mark All Read
      </button>
      <button onclick="window.notificationManager.requestPermission()" 
              style="flex:1; padding:12px; background:var(--primary-gradient); color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">
        Enable Alerts
      </button>
    </div>
  </div>

  <!-- ===== NOTIFICATION ALERT ===== -->
  <div class="notification-alert" id="notificationAlert"></div>

  <!-- ===== IMAGE ZOOM OVERLAY ===== -->
  <div class="image-zoom-overlay" id="imageZoomOverlay" onclick="window.closeImageZoom()">
    <img src="" class="image-zoom-content" id="zoomedImage">
  </div>

  <!-- ===== EXIT MODAL ===== -->
  <div class="exit-modal-overlay" id="exitModal">
    <div class="exit-modal">
      <h2><i class="fas fa-sign-out-alt"></i> Exit App?</h2>
      <p>Are you sure you want to exit? Press back again to confirm.</p>
      <div class="exit-modal-buttons">
        <button class="exit-modal-btn cancel" onclick="window.closeExitModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="exit-modal-btn exit" onclick="window.exitApp()">
          <i class="fas fa-sign-out-alt"></i> Exit
        </button>
      </div>
    </div>
  </div>

  <!-- ===== INSTALL PERMISSION MODAL ===== -->
  <div class="exit-modal-overlay" id="installPermissionModal" style="display:none;">
    <div class="install-permission-modal" style="background:white; max-width:340px; padding:24px; border-radius:24px;">
      <h2 style="margin-bottom:12px;"><i class="fas fa-download" style="color:#667eea;"></i> Enhance Your Experience</h2>
      <p style="margin-bottom:16px; color:#64748b;">To provide you with the best experience, we'd like to:</p>
      <div class="permission-features" style="margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Save business details to your contacts</span></div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Enable push notifications for orders</span></div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Install app for quick access</span></div>
      </div>
      <p style="font-size: 14px; color: #94a3b8; margin-bottom:20px;">Your data is secure and never shared with third parties.</p>
      <div class="permission-buttons" style="display:flex; gap:12px;">
        <button class="permission-btn cancel" onclick="window.closeInstallPermissionModal()" style="flex:1; padding:12px; background:#f1f5f9; border:none; border-radius:12px; font-weight:700; color:#475569; cursor:pointer;">
          <i class="fas fa-times"></i> Skip
        </button>
        <button class="permission-btn accept" onclick="window.acceptInstallPermissions()" style="flex:1; padding:12px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
          <i class="fas fa-check"></i> Accept & Continue
        </button>
      </div>
    </div>
  </div>

  <!-- ===== LOADING SCREEN ===== -->
  <div id="loadingScreen" class="page active">
    <div class="loader"></div>
    <h1 id="loadingTitle">Digital Business</h1>
    <p id="loadingSubtitle">Loading your premium business experience...</p>
  </div>

  <!-- ===== HOME PAGE ===== -->
  <div id="homePage" class="page">
    <div class="app-header">
      <div class="welcome-text">
        <h1 id="businessHeader" style="color:white;">Welcome</h1>
        <p style="color:rgba(255,255,255,0.9);">Premium business at your fingertips</p>
      </div>
      
      <div class="quick-actions">
        <div class="action-card" onclick="window.navigateTo('productsPage')">
          <div class="action-icon"><i class="fas fa-shopping-bag" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Shop Now</h3>
          <p style="font-size:11px; opacity:0.9;">Browse products</p>
        </div>
        <div class="action-card" onclick="window.navigateTo('cartPage')">
          <div class="action-icon"><i class="fas fa-shopping-cart" style="font-size:24px; position:relative;" id="cartIcon">
            <span class="cart-badge" id="cartBadge" style="display:none;">0</span>
          </i></div>
          <h3 style="font-size:14px; margin-top:8px;">My Cart</h3>
          <p style="font-size:11px; opacity:0.9;"><span id="cartCountMini">0</span> items</p>
        </div>
        <div class="action-card" onclick="window.openWhatsAppChat()">
          <div class="action-icon"><i class="fab fa-whatsapp" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Live Chat</h3>
          <p style="font-size:11px; opacity:0.9;">Instant support</p>
        </div>
        <div class="action-card" onclick="window.navigateTo('contactPage')">
          <div class="action-icon"><i class="fas fa-map-marker-alt" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Location</h3>
          <p style="font-size:11px; opacity:0.9;">Find us</p>
        </div>
      </div>
    </div>

    <div class="profile-section" style="display:flex; align-items:center; gap:16px; padding:20px; background:white; margin:20px; border-radius:20px; box-shadow:var(--shadow-md);">
      <img src="" id="photo" class="profile-avatar" loading="lazy" style="width:64px; height:64px; border-radius:50%; object-fit:cover; border:3px solid var(--primary-gradient);">
      <div>
        <div class="profile-name" style="display:flex; align-items:center; gap:6px;">
          <span id="name" style="font-size:18px; font-weight:800; color:var(--dark-color);">Loading...</span>
          <i class="fas fa-badge-check verified-badge" style="color:#10b981;"></i>
        </div>
        <div class="profile-business" id="business" style="font-size:14px; color:#64748b; margin-top:4px;"></div>
      </div>
    </div>

    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; padding:0 16px; margin-bottom:16px;">
      <h2 style="font-size:18px; font-weight:800; color:var(--dark-color); display:flex; align-items:center; gap:8px;">
        <i class="fas fa-gift" style="color:#667eea;"></i> Featured Products
      </h2>
      <div class="see-all" onclick="window.navigateTo('productsPage')" style="font-size:14px; color:#667eea; font-weight:600; cursor:pointer;">
        See All <i class="fas fa-arrow-right"></i>
      </div>
    </div>
    
    <div class="products-grid" id="featuredProducts"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== PRODUCTS PAGE ===== -->
  <div id="productsPage" class="page">
    <div class="products-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">Products & Offers</h1>
      <p style="color:#64748b; margin-top:4px;">Discover our premium collection</p>
    </div>
    
    <div class="products-search" style="position:relative; margin:16px; padding:0 4px;">
      <input type="text" id="productsSearch" placeholder="Search products..." onkeyup="window.filterProducts()" style="width:100%; padding:14px 20px; padding-left:50px; border:2px solid #e2e8f0; border-radius:30px; font-size:15px;">
      <i class="fas fa-search" style="position:absolute; left:24px; top:50%; transform:translateY(-50%); color:#94a3b8;"></i>
    </div>
    
    <div class="products-grid" id="allProducts"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== CART PAGE ===== -->
  <div id="cartPage" class="page">
    <div class="cart-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">My Cart</h1>
      <p id="cartItemsCount" style="color:#64748b; margin-top:4px;">0 items</p>
    </div>
    <div id="cartContent" style="padding:16px;"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== ABOUT PAGE ===== -->
  <div id="aboutPage" class="page">
    <div class="about-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">About Business</h1>
    </div>
    <div class="about-content" id="aboutContent" style="padding:20px; color:#475569; line-height:1.6;"></div>
    <div class="business-hours" style="padding:20px;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-clock" style="color:#667eea;"></i> Business Hours
      </h3>
      <div class="hours-list" id="businessHours" style="background:white; border-radius:16px; padding:16px;"></div>
    </div>
    <div class="business-hours" style="padding:20px; padding-top:0;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-calendar-times" style="color:#ef4444;"></i> Holidays
      </h3>
      <div class="hours-list" id="holidaysList" style="background:white; border-radius:16px; padding:16px;"></div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== CONTACT PAGE ===== -->
  <div id="contactPage" class="page">
    <div class="contact-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">Contact Us</h1>
      <p style="color:#64748b; margin-top:4px;">Get in touch anytime</p>
    </div>
    
    <div class="contact-info" style="padding:16px;">
      <div class="contact-item" onclick="window.saveBusinessToContacts()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#667eea; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-address-card"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Save Business Contact</div>
          <div class="contact-value" style="font-size:16px; font-weight:700; color:var(--dark-color);">Tap to save to phonebook</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="window.openPhoneInput()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#10b981; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-mobile-alt"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">My Delivery Phone</div>
          <div class="contact-value" id="customerPhoneDisplay" style="font-size:16px; font-weight:700; color:var(--dark-color);">Tap to set your number</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="window.openAddressInput()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#f59e0b; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-map-marker-alt"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">My Delivery Address</div>
          <div class="contact-value" id="customerAddressDisplay" style="font-size:16px; font-weight:700; color:var(--dark-color);">Tap to set your address</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="window.makeCall()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#2563eb; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-phone"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Call Business</div>
          <div class="contact-value" id="contactPhone" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="window.openWhatsAppChat()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#25D366; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fab fa-whatsapp"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">WhatsApp</div>
          <div class="contact-value" id="contactWhatsApp" style="font-size:16px; font-weight:700; color:var(--dark-color);">Chat Now</div>
        </div>
      </div>
      
      <div class="contact-item email-item" onclick="window.sendEmail()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#8b5cf6; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-envelope"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Email</div>
          <div class="contact-value" id="contactEmail" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="window.openMap()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#ef4444; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-map-marker-alt"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Address</div>
          <div class="contact-value" id="contactAddress" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
    </div>
    
    <div class="social-links" style="padding:16px;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-share-alt" style="color:#667eea;"></i> Follow Us
      </h3>
      <div class="social-grid" id="socialGrid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px;"></div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== DELIVERY STATUS PAGE ===== -->
  <div id="deliveryPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-truck" style="color:#10b981;"></i> My Orders</h1>
      <p style="color:#64748b; margin-top:4px;">Track your orders in real-time</p>
    </div>
    <div id="deliveryContent" style="padding:16px;"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== ADMIN PAGE ===== -->
  <div id="adminPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-cog" style="color:#667eea;"></i> Business Admin</h1>
      <p style="color:#64748b; margin-top:4px;">Manage orders, tokens & deliveries</p>
    </div>
    
    <!-- Admin Tabs -->
    <div style="display:flex; margin:15px; gap:5px;">
      <button onclick="showAdminTab('orders')" id="tabOrders" style="flex:1; padding:10px; background:#667eea; color:white; border:none; border-radius:8px; font-weight:700;">Orders</button>
      <button onclick="showAdminTab('notifications')" id="tabNotifications" style="flex:1; padding:10px; background:#f1f5f9; color:#475569; border:none; border-radius:8px; font-weight:700;">Notifications</button>
      <button onclick="showAdminTab('tokens')" id="tabTokens" style="flex:1; padding:10px; background:#f1f5f9; color:#475569; border:none; border-radius:8px; font-weight:700;">Tokens</button>
    </div>
    
    <!-- Orders Tab -->
    <div id="adminOrdersTab" style="display:block;">
      <div class="token-management">
        <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:15px;">
          <i class="fas fa-clock" style="color:#f59e0b;"></i> Pending Payment Confirmations
          <span id="pendingPaymentCount" style="background:#f59e0b; color:white; padding:2px 10px; border-radius:20px; font-size:12px;">0</span>
        </h3>
        
        <div id="pendingPaymentsList"></div>
      </div>
      
      <div class="token-management">
        <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:15px;">
          <i class="fas fa-search"></i> Search Orders
        </h3>
        <input type="text" id="adminOrderSearch" placeholder="Search by order ID, token, phone..." 
               style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; margin-bottom:15px;"
               onkeyup="searchOrders()">
        <div id="allOrdersList"></div>
      </div>
    </div>
    
    <!-- Notifications Tab -->
    <div id="adminNotificationsTab" style="display:none;">
      <div class="token-management">
        <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:15px;">
          <i class="fas fa-pen"></i> Create New Notification
        </h3>
        
        <div style="margin-bottom:15px;">
          <label style="font-weight:600; display:block; margin-bottom:5px;">Notification Title</label>
          <input type="text" id="notifTitle" placeholder="e.g., Summer Sale" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px;">
        </div>
        
        <div style="margin-bottom:15px;">
          <label style="font-weight:600; display:block; margin-bottom:5px;">Notification Message</label>
          <textarea id="notifBody" rows="3" placeholder="Your message here..." style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px;"></textarea>
        </div>
        
        <div style="margin-bottom:15px;">
          <label style="font-weight:600; display:block; margin-bottom:5px;">Notification Type</label>
          <select id="notifType" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px;">
            <option value="promo">üéâ Promotion / Offer</option>
            <option value="info">‚ÑπÔ∏è General Info</option>
            <option value="warning">‚ö†Ô∏è Important Alert</option>
            <option value="success">‚úÖ Success Update</option>
            <option value="order">üõçÔ∏è Order Update</option>
          </select>
        </div>
        
        <div style="margin-bottom:15px;">
          <label style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <input type="checkbox" id="sendWhatsApp" checked> 
            <span>Send via WhatsApp to all customers</span>
          </label>
          <label style="display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="sendPush" checked> 
            <span>Send Push Notification</span>
          </label>
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="font-weight:600; display:block; margin-bottom:5px;">Target Audience</label>
          <select id="notifAudience" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px;">
            <option value="all">All Customers</option>
            <option value="active">Active Customers (last 30 days)</option>
            <option value="new">New Customers (last 7 days)</option>
            <option value="vip">VIP Customers (spent > PKR 5000)</option>
          </select>
        </div>
        
        <button onclick="sendPromotionalNotification()" 
                style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:800; cursor:pointer; margin-bottom:15px;">
          <i class="fas fa-paper-plane"></i> SEND NOTIFICATION
        </button>
        
        <div style="background:#f8fafc; padding:15px; border-radius:8px;">
          <h4 style="font-weight:700; margin-bottom:8px;">üìä Stats</h4>
          <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>Total Customers:</span>
            <span id="totalCustomersStat">0</span>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span>WhatsApp Enabled:</span>
            <span id="whatsappCustomersStat">0</span>
          </div>
        </div>
      </div>
      
      <div class="token-management">
        <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:15px;">
          <i class="fas fa-history"></i> Notification History
        </h3>
        <div id="notificationHistory"></div>
      </div>
    </div>
    
    <!-- Tokens Tab -->
    <div id="adminTokensTab" style="display:none;">
      <div class="token-management">
        <div class="token-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3 style="font-size:18px; font-weight:800; color:var(--dark-color);">
            <i class="fas fa-ticket-alt" style="color:#667eea;"></i> Order Tokens
          </h3>
          <button onclick="window.generateNewToken()" style="background:var(--success-gradient); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer;">
            <i class="fas fa-plus"></i> Generate Token
          </button>
        </div>
        
        <div class="token-stats" id="tokenStats">
          <div class="stat-card">
            <div class="stat-number" id="totalTokensCount">0</div>
            <div class="stat-label">Total Tokens</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="activeTokensCount">0</div>
            <div class="stat-label">Active</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="todayTokensCount">0</div>
            <div class="stat-label">Today</div>
          </div>
        </div>
        
        <div style="margin-bottom:16px;">
          <input type="text" id="adminTokenSearch" placeholder="Search tokens, orders, customers..." 
                 style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px;"
                 onkeyup="window.searchAdminTokens()">
        </div>
        
        <div class="token-list" id="tokenList"></div>
      </div>
    </div>
    
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== LOGIN PAGE ===== -->
  <div id="loginPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-lock" style="color:#667eea;"></i> Admin Login</h1>
      <p style="color:#64748b; margin-top:4px;">Enter password to access admin panel</p>
    </div>
    
    <div class="login-page-content" style="padding:24px;">
      <div class="login-title" style="font-size:20px; font-weight:800; color:var(--dark-color); margin-bottom:8px;">Admin Access</div>
      <div class="login-subtitle" style="color:#64748b; margin-bottom:24px;">Enter the admin password to continue</div>
      
      <input type="password" class="password-input" id="adminPasswordInput" 
             placeholder="Enter password" onkeypress="window.handleLoginKeypress(event)"
             style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:12px; font-size:16px;">
      
      <button onclick="window.attemptLogin()" class="admin-btn success" style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:700; font-size:16px; margin-top:20px; cursor:pointer;">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
      
      <div class="password-hint" id="passwordHint" style="margin-top:20px; padding:16px; background:#f1f5f9; border-radius:12px; color:#64748b; font-size:14px;"></div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== BOTTOM NAVIGATION ===== -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="window.navigateTo('homePage')">
      <div class="nav-icon"><i class="fas fa-home"></i></div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" onclick="window.navigateTo('productsPage')">
      <div class="nav-icon"><i class="fas fa-shopping-bag"></i></div>
      <div class="nav-label">Products</div>
    </div>
    <div class="nav-item" onclick="window.navigateTo('cartPage')">
      <div class="nav-icon"><i class="fas fa-shopping-cart"></i></div>
      <div class="nav-label">Cart</div>
    </div>
    <div class="nav-item" onclick="window.navigateTo('aboutPage')">
      <div class="nav-icon"><i class="fas fa-info-circle"></i></div>
      <div class="nav-label">About</div>
    </div>
    <div class="nav-item" onclick="window.navigateTo('contactPage')">
      <div class="nav-icon"><i class="fas fa-phone"></i></div>
      <div class="nav-label">Contact</div>
    </div>
  </div>
</div>

<!-- ===== PAYMENT PROOF MODAL ===== -->
<div class="modal-overlay" id="paymentProofModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('paymentProofModal')">√ó</button>
    
    <div style="padding:25px;">
      <div style="text-align:center; margin-bottom:20px;">
        <i class="fas fa-camera" style="font-size:48px; color:#667eea;"></i>
        <h2 style="font-size:22px; font-weight:800; margin-top:10px;">Submit Payment Proof</h2>
        <p style="color:#64748b;">Apne payment ka screenshot ya transaction ID share karein</p>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="font-weight:600; display:block; margin-bottom:8px;">Transaction ID / Reference Number</label>
        <input type="text" id="proofTransactionId" placeholder="e.g., T20240213ABCD" 
               style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:12px;">
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="font-weight:600; display:block; margin-bottom:8px;">Amount Paid (PKR)</label>
        <input type="number" id="proofAmount" placeholder="e.g., 1500" 
               style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:12px;">
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="font-weight:600; display:block; margin-bottom:8px;">Payment Screenshot (Optional)</label>
        <div id="proofDropZone" style="border:3px dashed #667eea; border-radius:16px; padding:25px; text-align:center; background:#f8fafc; cursor:pointer;">
          <i class="fas fa-cloud-upload-alt" style="font-size:48px; color:#667eea;"></i>
          <p style="margin:10px 0;">Click ya drag & drop</p>
          <p style="font-size:12px; color:#94a3b8;">JPG, PNG (Max 5MB)</p>
          <input type="file" id="proofImage" accept="image/*" style="display:none;">
        </div>
        <div id="proofImagePreview" style="margin-top:15px; display:none;">
          <img src="" style="max-width:100%; max-height:150px; border-radius:8px;">
          <button onclick="removeProofImage()" style="margin-top:8px; background:#ef4444; color:white; border:none; padding:5px 15px; border-radius:6px;">Remove</button>
        </div>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="font-weight:600; display:block; margin-bottom:8px;">Additional Notes</label>
        <textarea id="proofNotes" rows="2" placeholder="Koi extra information..." 
                  style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:12px;"></textarea>
      </div>
      
      <button onclick="submitPaymentProof()" 
              style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:800; font-size:16px; cursor:pointer;">
        <i class="fas fa-check-circle"></i> SUBMIT PROOF
      </button>
    </div>
  </div>
</div>

<!-- ===== PROFESSIONAL CHECKOUT MODAL ===== -->
<div class="modal-overlay" id="checkoutModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('checkoutModal')">√ó</button>
    
    <div style="padding:25px;">
      <h2 style="font-size:22px;font-weight:800;color:var(--dark-color);margin-bottom:20px;">
        <i class="fas fa-shopping-cart"></i> Secure Checkout
      </h2>
      
      <div id="checkoutItems" style="margin-bottom:20px; max-height:200px; overflow-y:auto; padding-right:10px;"></div>
      
      <div class="address-auto-detect">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3 style="font-size:16px; font-weight:800; color:var(--dark-color);">
            <i class="fas fa-map-marker-alt" style="color:#667eea;"></i> Delivery Address
          </h3>
          <button onclick="window.openAddressInput(true)" style="background:#667eea; color:white; border:none; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:700; cursor:pointer;">
            <i class="fas fa-pencil-alt"></i> Change
          </button>
        </div>
        
        <div id="checkoutAddressDisplay" style="padding:12px; background:#f8fafc; border-radius:8px; font-size:14px; color:#475569; border-left:4px solid #667eea;"></div>
        
        <div id="checkoutPhoneDisplay" style="margin-top:8px; padding:8px 12px; background:#f1f5f9; border-radius:8px; font-size:13px; color:#475569;">
          <i class="fas fa-phone-alt"></i> <span id="checkoutPhoneText">No phone number</span>
        </div>
      </div>
      
      <div class="delivery-charge-calculator" id="deliveryCalculator">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span style="font-weight:700; color:var(--dark-color);">
            <i class="fas fa-truck"></i> Delivery Estimate
          </span>
          <span id="deliveryZoneBadge" style="background:#667eea; color:white; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:700;">Calculating...</span>
        </div>
        
        <div class="delivery-estimate" id="deliveryEstimate">
          <i class="fas fa-clock" style="color:#3b82f6;"></i>
          <span id="deliveryTimeEstimate">Calculating delivery time...</span>
        </div>
        
        <div style="display:flex; justify-content:space-between; margin-top:12px; padding-top:12px; border-top:1px dashed #e2e8f0;">
          <span style="font-weight:600; color:#475569;">Delivery Charge</span>
          <span id="deliveryChargeAmount" style="font-weight:800; color:#10b981;">PKR 0</span>
        </div>
      </div>
      
      <h3 style="font-size:16px; font-weight:800; color:var(--dark-color); margin:20px 0 12px;">
        <i class="fas fa-credit-card"></i> Payment Method
      </h3>
      
      <div class="pro-payment-grid" id="proPaymentGrid"></div>
      
      <div style="background:#f8fafc; padding:20px; border-radius:var(--border-radius-md); margin:20px 0; border:1px solid #e2e8f0;">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
          <span style="color:#64748b;">Subtotal</span>
          <span style="font-weight:800; color:var(--dark-color);">PKR <span id="checkoutSubtotal">0</span></span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
          <span style="color:#64748b;">Delivery</span>
          <span style="font-weight:800; color:var(--dark-color);">PKR <span id="checkoutDelivery">0</span></span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:12px; padding-top:12px; border-top:2px solid #e2e8f0;">
          <span style="font-size:18px; font-weight:800; color:var(--dark-color);">Total</span>
          <span style="font-size:24px; font-weight:900; color:#10b981;">PKR <span id="checkoutTotal">0</span></span>
        </div>
      </div>
      
      <button onclick="window.placeOrder()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:var(--border-radius-md); font-size:17px; font-weight:800; cursor:pointer;">
        <i class="fas fa-lock"></i> Place Order
      </button>
    </div>
  </div>
</div>

<!-- ===== PAYMENT DETAILS MODAL ===== -->
<div class="modal-overlay" id="paymentDetailsModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('paymentDetailsModal')">√ó</button>
    
    <div style="padding:25px;">
      <div style="text-align:center; margin-bottom:20px;">
        <i class="fas fa-credit-card" style="font-size:48px; color:#667eea;"></i>
        <h2 id="paymentMethodTitle" style="font-size:22px; font-weight:800; margin-top:10px;">Payment Details</h2>
      </div>
      
      <div id="paymentDetailsContent"></div>
      
      <!-- I HAVE PAID BUTTON -->
      <button onclick="window.markAsPaid()" 
              style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:800; font-size:16px; cursor:pointer; margin:20px 0;">
        <i class="fas fa-check-circle"></i> I HAVE PAID - Submit Proof
      </button>
      
      <p style="font-size:12px; color:#64748b; text-align:center;">
        <i class="fas fa-info-circle"></i> 
        Payment karne ke baad proof upload karein. Admin verify karega.
      </p>
    </div>
  </div>
</div>

<!-- ===== ORDER CONFIRMATION MODAL ===== -->
<div class="modal-overlay" id="orderConfirmationModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('orderConfirmationModal')">√ó</button>
    <div style="padding:25px;" id="orderConfirmationContent"></div>
  </div>
</div>

<!-- ===== PRODUCT MODAL ===== -->
<div class="modal-overlay" id="productModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('productModal')">√ó</button>
    
    <div class="product-modal-image-container" style="background:white;">
      <img src="" id="modalImage" class="product-modal-image" loading="lazy">
    </div>
    
    <div style="padding:25px;">
      <div id="modalPrice" class="modal-price-container"></div>
      
      <h2 id="modalTitle" style="font-size:20px;font-weight:800;color:var(--dark-color);margin-bottom:12px;"></h2>
      <p id="modalDescription" style="color:#64748b;line-height:1.6;margin-bottom:20px;font-size:14px;"></p>
      
      <div style="display:flex;gap:12px;margin-top:25px;">
        <button onclick="window.buyNowFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--primary-gradient);color:white;">
          <i class="fas fa-bolt"></i> Quick Buy
        </button>
        <button onclick="window.addToCartFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--secondary-gradient);color:white;">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// ===== SUPABASE CLIENT =====
const supa = supabase.createClient(
  "https://dfvnefbxgayxqgjjgtrr.supabase.co",
  "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ===== MAIN APP VARIABLES =====
let card = {};
let currentProduct = null;
let cart = [];
let checkoutPaymentMethod = 'cod';
let currentPage = 'loadingScreen';
let deliveryStatusData = [];
let businessAdminPassword = "";
let shortCardId = "";
let isAdminLoggedIn = false;
let currentBusinessId = '';
let orders = [];
let orderTokens = [];
let selectedCheckoutAddress = '';
let selectedCheckoutPhone = '';
let deliveryCharge = 0;
let deliveryTime = '';
let detectedZone = '';
let notificationPermission = false;
let innerNotifications = [];
let unreadNotifications = 0;
let customerData = { deviceId: '', name: '', phone: '', email: '' };
let navigationHistory = [];
let currentOrderForProof = null;

// ===== PWA INSTALL VARIABLES =====
let deferredPrompt = null;
let installButtonShown = false;

// ===== NOTIFICATION MANAGER =====
class NotificationManager {
  constructor() {
    this.notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    this.unreadCount = this.notifications.filter(n => !n.read).length;
  }

  showAlert(message, type = 'info') {
    const alert = document.getElementById('notificationAlert');
    if (!alert) return;

    const icons = {
      'success': '‚úÖ',
      'error': '‚ùå',
      'warning': '‚ö†Ô∏è',
      'info': '‚ÑπÔ∏è',
      'whatsapp': 'üì±',
      'payment': 'üí∞',
      'order': 'üõçÔ∏è'
    };

    alert.innerHTML = `${icons[type] || 'üîî'} ${message}`;
    alert.style.display = 'block';
    
    alert.style.background = 
      type === 'success' ? 'var(--success-gradient)' :
      type === 'error' ? 'var(--danger-gradient)' :
      type === 'warning' ? 'var(--warning-gradient)' :
      'var(--info-gradient)';

    setTimeout(() => {
      alert.style.display = 'none';
    }, 3000);
  }

  addNotification(title, message, type = 'info', orderId = null) {
    const notification = {
      id: Date.now(),
      title: title,
      message: message,
      type: type,
      orderId: orderId,
      time: new Date().toLocaleString(),
      read: false,
      icon: this.getIcon(type)
    };

    this.notifications.unshift(notification);
    if (this.notifications.length > 50) this.notifications.pop();
    
    this.unreadCount++;
    localStorage.setItem('notifications', JSON.stringify(this.notifications));
    
    this.updateDrawer();
    this.updateBadge();
    
    // Show in-app alert
    this.showAlert(message, type);
  }

  getIcon(type) {
    const icons = {
      'order': 'üõçÔ∏è',
      'payment': 'üí∞',
      'delivery': 'üöö',
      'success': '‚úÖ',
      'error': '‚ùå',
      'warning': '‚ö†Ô∏è',
      'info': '‚ÑπÔ∏è',
      'whatsapp': 'üì±',
      'promo': 'üéâ'
    };
    return icons[type] || 'üîî';
  }

  updateDrawer() {
    const list = document.getElementById('notificationList');
    if (!list) return;

    if (this.notifications.length === 0) {
      list.innerHTML = `
        <div style="text-align:center; padding:40px;">
          <i class="fas fa-bell-slash" style="font-size:60px; color:#cbd5e1;"></i>
          <h3 style="margin-top:16px; color:#64748b;">No notifications</h3>
        </div>
      `;
      return;
    }

    let html = '';
    this.notifications.slice(0, 20).forEach(notif => {
      html += `
        <div class="notification-item ${notif.read ? 'read' : 'unread'}" 
             onclick="window.notificationManager.markAsRead(${notif.id})"
             style="background:${notif.read ? '#ffffff' : '#f0f9ff'};">
          <div style="display:flex; align-items:start; gap:12px;">
            <div style="font-size:24px;">${notif.icon}</div>
            <div style="flex:1;">
              <div style="font-weight:800; color:#1e293b; font-size:14px;">${notif.title}</div>
              <div style="color:#64748b; font-size:13px; margin-top:4px;">${notif.message}</div>
              <div style="font-size:11px; color:#94a3b8; margin-top:8px;">${notif.time}</div>
            </div>
            ${!notif.read ? '<div style="width:10px; height:10px; background:#3b82f6; border-radius:50%;"></div>' : ''}
          </div>
        </div>
      `;
    });

    list.innerHTML = html;
    document.getElementById('notificationCount').textContent = this.unreadCount > 9 ? '9+' : this.unreadCount;
  }

  updateBadge() {
    const badge = document.getElementById('notificationBadge');
    const bell = document.getElementById('notificationBell');
    
    if (this.unreadCount > 0) {
      badge.textContent = this.unreadCount > 9 ? '9+' : this.unreadCount;
      badge.style.display = 'flex';
      bell.style.color = '#f59e0b';
    } else {
      badge.style.display = 'none';
      bell.style.color = 'white';
    }
  }

  markAsRead(id) {
    this.notifications = this.notifications.map(n => 
      n.id === id ? { ...n, read: true } : n
    );
    this.unreadCount = this.notifications.filter(n => !n.read).length;
    localStorage.setItem('notifications', JSON.stringify(this.notifications));
    this.updateDrawer();
    this.updateBadge();
  }

  markAllAsRead() {
    this.notifications = this.notifications.map(n => ({ ...n, read: true }));
    this.unreadCount = 0;
    localStorage.setItem('notifications', JSON.stringify(this.notifications));
    this.updateDrawer();
    this.updateBadge();
    this.showAlert('‚úÖ All notifications marked as read', 'success');
  }

  async requestPermission() {
    if (!('Notification' in window)) {
      this.showAlert('‚ùå Notifications not supported', 'error');
      return false;
    }

    if (Notification.permission === 'granted') {
      this.showAlert('‚úÖ Notifications already enabled', 'success');
      return true;
    }

    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      this.showAlert('‚úÖ Notifications enabled!', 'success');
      this.addNotification('Notifications Enabled', 'You will receive alerts', 'success');
      return true;
    } else {
      this.showAlert('‚ùå Notification permission denied', 'error');
      return false;
    }
  }

  async sendWhatsApp(phone, message) {
    const cleanedPhone = phone.replace(/\D/g, '');
    if (cleanedPhone.length < 10) return false;

    const whatsappUrl = `https://wa.me/${cleanedPhone}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    return true;
  }

  async sendOrderNotifications(orderData) {
    // Customer WhatsApp
    const customerMessage = this.getCustomerOrderMessage(orderData);
    await this.sendWhatsApp(orderData.customerPhone, customerMessage);

    // Admin WhatsApp
    if (card.phone) {
      const adminMessage = this.getAdminOrderMessage(orderData);
      await this.sendWhatsApp(card.phone, adminMessage);
    }

    // In-app notifications
    this.addNotification('Order Placed', `Order #${orderData.orderId} confirmed`, 'order', orderData.orderId);
    this.showAlert('‚úÖ Order placed! Check WhatsApp', 'success');
  }

  getCustomerOrderMessage(orderData) {
    return `üõçÔ∏è *ORDER CONFIRMED* ‚úÖ

Order ID: ${orderData.orderId}
Token: ${orderData.token}
Total: PKR ${orderData.total}
Payment: ${orderData.paymentMethod}

Items:
${orderData.items.map(i => `‚Ä¢ ${i.title} x${i.quantity}`).join('\n')}

Track: Use token in app
Thank you! üõçÔ∏è`;
  }

  getAdminOrderMessage(orderData) {
    return `üîî *NEW ORDER*

Order: ${orderData.orderId}
Customer: ${orderData.customerPhone}
Amount: PKR ${orderData.total}
Payment: ${orderData.paymentMethod}

Check admin panel to confirm`;
  }

  async sendPaymentNotifications(orderData, proofData) {
    // Admin notification for proof
    if (card.phone) {
      const message = `üì∏ *PAYMENT PROOF RECEIVED*

Order: ${orderData.orderId}
Amount: PKR ${orderData.total}
Transaction: ${proofData.transactionId}

Verify in admin panel`;
      await this.sendWhatsApp(card.phone, message);
    }

    this.addNotification('Payment Proof', `Order #${orderData.orderId} proof received`, 'payment', orderData.orderId);
    this.showAlert('üí∞ Proof submitted! Admin will verify', 'payment');
  }

  async sendPaymentConfirmation(orderData) {
    const message = `‚úÖ *PAYMENT CONFIRMED!*

Your payment of PKR ${orderData.total} has been received.
Order #${orderData.orderId} is now processing.

Token: ${orderData.token}`;

    await this.sendWhatsApp(orderData.customerPhone, message);
    this.addNotification('Payment Confirmed', `Order #${orderData.orderId} payment verified`, 'success', orderData.orderId);
    this.showAlert('‚úÖ Payment confirmed!', 'success');
  }

  async sendPromotionalNotification(title, message, type = 'promo') {
    this.addNotification(title, message, type);
    this.showAlert(`üì¢ ${title}`, 'info');
  }
}

// Initialize notification manager
window.notificationManager = new NotificationManager();

// ===== ATTACH ALL FUNCTIONS TO WINDOW =====
window.navigateTo = navigateTo;
window.goBack = goBack;
window.toggleNotificationDrawer = toggleNotificationDrawer;
window.saveBusinessToContacts = saveBusinessToContacts;
window.checkDeliveryStatus = checkDeliveryStatus;
window.toggleLogin = toggleLogin;
window.shareBusiness = shareBusiness;
window.openWhatsAppChat = openWhatsAppChat;
window.makeCall = makeCall;
window.sendEmail = sendEmail;
window.openMap = openMap;
window.openPhoneInput = openPhoneInput;
window.openAddressInput = openAddressInput;
window.zoomImage = zoomImage;
window.closeImageZoom = closeImageZoom;
window.filterProducts = filterProducts;
window.addToCart = addToCart;
window.buyNow = buyNow;
window.buyNowFromModal = buyNowFromModal;
window.removeFromCart = removeFromCart;
window.updateQuantity = updateQuantity;
window.openCheckoutModal = openCheckoutModal;
window.selectProPaymentMethod = selectProPaymentMethod;
window.placeOrder = placeOrder;
window.closeModal = closeModal;
window.openModal = openModal;
window.attemptLogin = attemptLogin;
window.handleLoginKeypress = handleLoginKeypress;
window.logoutAdmin = logoutAdmin;
window.generateNewToken = generateNewToken;
window.searchAdminTokens = searchAdminTokens;
window.viewOrderDetails = viewOrderDetails;
window.updateOrderStatus = updateOrderStatus;
window.closeExitModal = closeExitModal;
window.exitApp = exitApp;
window.closeInstallPermissionModal = closeInstallPermissionModal;
window.acceptInstallPermissions = acceptInstallPermissions;
window.addToCartFromModal = addToCartFromModal;
window.showProductModal = showProductModal;
window.markAsPaid = markAsPaid;
window.submitPaymentProof = submitPaymentProof;
window.showAdminTab = showAdminTab;
window.sendPromotionalNotification = sendPromotionalNotification;
window.searchOrders = searchOrders;

// ===== DATA ISOLATION SYSTEM =====
function getStorageKey(key) {
  const businessKey = currentBusinessId ? currentBusinessId.substring(0, 8) : 'default';
  return `business_${businessKey}_${key}`;
}

const isolatedLocalStorage = {
  setItem: function(key, value) {
    localStorage.setItem(getStorageKey(key), value);
  },
  getItem: function(key) {
    return localStorage.getItem(getStorageKey(key));
  },
  removeItem: function(key) {
    localStorage.removeItem(getStorageKey(key));
  }
};

// ===== CUSTOMER DATA MANAGEMENT =====
function getCustomerPhone() {
  return isolatedLocalStorage.getItem('customerPhone') || '';
}

function saveCustomerPhone(phone) {
  isolatedLocalStorage.setItem('customerPhone', phone);
  const el = document.getElementById('customerPhoneDisplay');
  if (el) el.textContent = phone || 'Tap to set your number';
  const phoneEl = document.getElementById('checkoutPhoneText');
  if (phoneEl) phoneEl.textContent = phone || 'No phone number';
  selectedCheckoutPhone = phone;
}

function getCustomerAddress() {
  return isolatedLocalStorage.getItem('customerAddress') || '';
}

function saveCustomerAddress(address) {
  isolatedLocalStorage.setItem('customerAddress', address);
  const el = document.getElementById('customerAddressDisplay');
  if (el) el.textContent = address || 'Tap to set your address';
  const addrEl = document.getElementById('checkoutAddressDisplay');
  if (addrEl) addrEl.innerHTML = `<i class="fas fa-home"></i> ${address || 'No address saved'}`;
  selectedCheckoutAddress = address;
  if (currentPage === 'checkoutModal' && address) calculateDeliveryCharge(address);
}

function openAddressInput(fromCheckout = false) {
  const currentAddress = getCustomerAddress();
  const address = prompt("Enter your complete delivery address:", currentAddress || "");
  if (address && address.trim()) {
    saveCustomerAddress(address.trim());
    notificationManager.showAlert('‚úÖ Delivery address saved!', 'success');
  }
}

function openPhoneInput() {
  const currentPhone = getCustomerPhone();
  const phone = prompt("Enter your phone number for delivery:", currentPhone || "");
  if (phone) {
    const cleanedPhone = phone.replace(/\D/g, '');
    if (cleanedPhone.length >= 10) {
      saveCustomerPhone(cleanedPhone);
      notificationManager.showAlert('‚úÖ Phone number saved!', 'success');
    } else {
      notificationManager.showAlert('‚ùå Please enter a valid phone number', 'error');
    }
  }
}

// ===== DELIVERY CHARGE CALCULATOR =====
function calculateDeliveryCharge(address) {
  if (!address) {
    deliveryCharge = 0;
    deliveryTime = 'Enter address to calculate';
    detectedZone = 'Unknown';
    updateDeliveryUI();
    return;
  }
  
  const addressLower = address.toLowerCase();
  let charge = 0, time = '', zone = 'Standard';
  
  if (card.deliverySettings && card.deliverySettings.zones && card.deliverySettings.zones.length > 0) {
    let zoneFound = false;
    for (const zoneConfig of card.deliverySettings.zones) {
      if (addressLower.includes(zoneConfig.city.toLowerCase())) {
        charge = parseFloat(zoneConfig.charge) || 0;
        time = zoneConfig.time || '2-3 business days';
        zone = zoneConfig.city;
        zoneFound = true;
        break;
      }
    }
    if (!zoneFound) {
      charge = parseFloat(card.deliverySettings?.default?.otherCities?.charge) || 300;
      time = card.deliverySettings?.default?.otherCities?.time || '3-5 business days';
      zone = 'Other City';
    }
  } else {
    if (addressLower.includes('karachi') || addressLower.includes('lahore') || addressLower.includes('islamabad')) {
      charge = 150;
      time = '1-2 business days';
      zone = 'Metro City';
    } else {
      charge = 300;
      time = '3-5 business days';
      zone = 'Other City';
    }
  }
  
  const subtotal = calculateCartSubtotal();
  if (card.deliverySettings?.freeDeliveryMin && subtotal >= card.deliverySettings.freeDeliveryMin) {
    charge = 0;
    time += ' (Free Delivery)';
    zone += ' - Free';
  }
  
  deliveryCharge = charge;
  deliveryTime = time;
  detectedZone = zone;
  updateDeliveryUI();
  return { charge, time, zone };
}

function updateDeliveryUI() {
  const zoneBadge = document.getElementById('deliveryZoneBadge');
  const timeEl = document.getElementById('deliveryTimeEstimate');
  const chargeEl = document.getElementById('deliveryChargeAmount');
  const deliveryEl = document.getElementById('checkoutDelivery');
  const totalEl = document.getElementById('checkoutTotal');
  
  if (zoneBadge) zoneBadge.textContent = detectedZone || 'Standard';
  if (timeEl) timeEl.innerHTML = `<i class="fas fa-clock"></i> ${deliveryTime || 'Calculating...'}`;
  if (chargeEl) chargeEl.textContent = `PKR ${deliveryCharge || 0}`;
  if (deliveryEl) deliveryEl.textContent = deliveryCharge || 0;
  
  const subtotal = parseFloat(document.getElementById('checkoutSubtotal')?.textContent) || 0;
  const total = subtotal + deliveryCharge;
  if (totalEl) totalEl.textContent = total.toFixed(2);
}

function calculateCartSubtotal() {
  return cart.reduce((sum, item) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    return sum + (price * (item.quantity || 1));
  }, 0);
}

// ===== ORDER TOKEN GENERATION =====
function generateOrderToken() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  const prefix = card.tokenSystem?.prefix || 'TKT';
  const timestamp = Date.now().toString().slice(-6);
  let random = '';
  for (let i = 0; i < 4; i++) random += chars.charAt(Math.floor(Math.random() * chars.length));
  return `${prefix}-${timestamp}-${random}`;
}

// ===== PASSWORD GENERATOR =====
function generateAdminPassword(cardId, shortId) {
  const shortPart = shortId ? shortId.toLowerCase() : (cardId ? cardId.substring(0, 6).toLowerCase() : 'default');
  return `business123_${shortPart}`;
}

// ===== PAYMENT METHOD NAME =====
function getPaymentMethodName(method) {
  const names = { 
    'cod': 'Cash on Delivery', 
    'jazzcash': 'JazzCash', 
    'easypaisa': 'EasyPaisa', 
    'bank': 'Bank Transfer', 
    'card': 'Card Payment', 
    'whatsapp': 'WhatsApp Order' 
  };
  return names[method] || method;
}

// ===== MODAL FUNCTIONS =====
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

// ===== NOTIFICATION DRAWER =====
function toggleNotificationDrawer() {
  const drawer = document.getElementById('notificationDrawer');
  drawer.classList.toggle('open');
  if (drawer.classList.contains('open')) {
    notificationManager.updateDrawer();
  }
}

// ===== PWA SETUP =====
function setupDynamicPWA(businessData) {
  const businessName = businessData.businessName || businessData.name || "Digital Business";
  document.title = businessName;
  
  const titleEl = document.getElementById('loadingTitle');
  const subtitleEl = document.getElementById('loadingSubtitle');
  if (titleEl) titleEl.textContent = businessName;
  if (subtitleEl) subtitleEl.textContent = `Loading ${businessName} experience...`;
  
  document.getElementById('themeColorMeta').content = "#667eea";
  
  updateFavicon(businessData.profileImage || getDefaultIcon(businessName));
  setupManifest(businessData, businessName);
}

function getDefaultIcon(businessName) {
  const firstLetter = businessName.charAt(0).toUpperCase();
  const colors = ['#667eea', '#764ba2', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'];
  const color = colors[businessName.length % colors.length];
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="${color}" rx="20"/><text x="50" y="65" font-size="40" fill="white" text-anchor="middle" font-weight="bold">${firstLetter}</text></svg>`;
  return 'data:image/svg+xml;base64,' + btoa(svg);
}

function updateFavicon(iconUrl) {
  let favicon = document.querySelector('link[rel="icon"]');
  if (!favicon) {
    favicon = document.createElement('link');
    favicon.rel = 'icon';
    document.head.appendChild(favicon);
  }
  favicon.href = iconUrl;
}

function setupManifest(businessData, businessName) {
  const profileImage = businessData.profileImage || getDefaultIcon(businessName);
  const baseUrl = window.location.origin + window.location.pathname;
  
  const manifest = {
    name: businessName,
    short_name: businessName.length > 12 ? businessName.substring(0, 10) + '‚Ä¶' : businessName,
    description: `Premium business app for ${businessName}`,
    theme_color: "#667eea",
    background_color: "#ffffff",
    display: "standalone",
    orientation: "portrait",
    scope: "/",
    start_url: baseUrl + "?source=pwa",
    icons: [
      { src: profileImage, sizes: "192x192", type: "image/png" },
      { src: profileImage, sizes: "512x512", type: "image/png" }
    ]
  };
  
  const manifestData = JSON.stringify(manifest);
  const blob = new Blob([manifestData], {type: 'application/json'});
  const manifestURL = URL.createObjectURL(blob);
  
  const manifestLink = document.getElementById('manifestLink');
  if (manifestLink) manifestLink.href = manifestURL;
}

// ===== SAVE TO CONTACTS =====
function saveBusinessToContacts() {
  if (!card.name || !card.phone) {
    notificationManager.showAlert('‚ùå Business information incomplete', 'error');
    return;
  }
  
  let contactInfo = `Business: ${card.name}\nPhone: ${card.phone}\n`;
  if (card.email) contactInfo += `Email: ${card.email}\n`;
  if (card.address) contactInfo += `Address: ${card.address}\n`;
  
  navigator.clipboard.writeText(contactInfo);
  notificationManager.showAlert('üìã Business info copied!', 'success');
}

// ===== SHARE BUSINESS =====
function shareBusiness() {
  const businessName = card.businessName || card.name || "Business";
  const currentUrl = window.location.href.split('?')[0];
  let shareUrl = shortCardId ? `${currentUrl}?id=${shortCardId}` : currentUrl;
  const shareText = `Check out ${businessName} on their business app!\n\n${shareUrl}`;
  
  if (navigator.share) {
    navigator.share({ title: businessName, text: shareText, url: shareUrl });
  } else {
    navigator.clipboard.writeText(shareText);
    notificationManager.showAlert('üìã Link copied to clipboard!', 'success');
  }
}

// ===== DELIVERY STATUS =====
async function checkForDeliveries() {
  const phone = getCustomerPhone();
  if (!phone) return;
  
  try {
    const { data, error } = await supa
      .from('orders')
      .select('*')
      .eq('customer_phone', phone)
      .eq('business_id', currentBusinessId)
      .order('created_at', { ascending: false });
    
    if (!error && data) {
      deliveryStatusData = data;
      updateDeliveryIcon();
    }
  } catch (error) {
    console.error('Error checking deliveries:', error);
  }
}

function updateDeliveryIcon() {
  const icon = document.getElementById('deliveryIcon');
  const badge = document.getElementById('deliveryBadge');
  
  if (deliveryStatusData.length > 0) {
    icon.style.color = '#10b981';
    badge.textContent = deliveryStatusData.length;
    badge.style.display = 'flex';
  } else {
    icon.style.color = 'white';
    badge.style.display = 'none';
  }
}

async function loadDeliveryStatus() {
  const phone = getCustomerPhone();
  
  if (!phone) {
    document.getElementById('deliveryContent').innerHTML = `
      <div style="text-align:center; padding:40px; background:white; border-radius:20px; margin:16px;">
        <i class="fas fa-phone" style="font-size:48px; color:#cbd5e1;"></i>
        <h3 style="margin-top:16px;">Phone Number Needed</h3>
        <button onclick="openPhoneInput()" style="margin-top:20px; padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px;">Add Phone Number</button>
      </div>
    `;
    return;
  }
  
  const { data, error } = await supa
    .from('orders')
    .select('*')
    .eq('customer_phone', phone)
    .eq('business_id', currentBusinessId)
    .order('created_at', { ascending: false });
  
  if (error || !data || data.length === 0) {
    document.getElementById('deliveryContent').innerHTML = `
      <div style="text-align:center; padding:40px; background:white; border-radius:20px; margin:16px;">
        <i class="fas fa-truck" style="font-size:48px; color:#10b981;"></i>
        <h3 style="margin-top:16px;">No Orders Yet</h3>
        <button onclick="navigateTo('productsPage')" style="margin-top:20px; padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px;">Shop Now</button>
      </div>
    `;
    return;
  }
  
  let html = '';
  data.forEach(order => {
    const statusColor = 
      order.status === 'delivered' ? '#10b981' : 
      order.status === 'cancelled' ? '#ef4444' : 
      order.payment_status === 'paid' ? '#667eea' : '#f59e0b';
    
    html += `
      <div class="order-card" style="border-left-color: ${statusColor};">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <span class="order-id">${order.order_id}</span>
          <span style="background:${statusColor}20; color:${statusColor}; padding:4px 8px; border-radius:6px;">
            ${order.payment_status === 'paid' ? 'Paid' : order.payment_status === 'proof_submitted' ? 'Proof Sent' : 'Pending'}
          </span>
        </div>
        <div><strong>Token:</strong> ${order.token}</div>
        <div><strong>Total:</strong> PKR ${order.total}</div>
        <div style="font-size:12px; color:#64748b; margin-top:8px;">${new Date(order.created_at).toLocaleDateString()}</div>
      </div>
    `;
  });
  
  document.getElementById('deliveryContent').innerHTML = html;
}

function checkDeliveryStatus() {
  const phone = getCustomerPhone();
  if (!phone) {
    openPhoneInput();
    return;
  }
  navigateTo('deliveryPage');
}

// ===== ORDERS DATABASE =====
async function saveOrderToDatabase(orderData) {
  try {
    if (!currentBusinessId) return false;
    
    const orderToInsert = {
      business_id: currentBusinessId,
      order_id: orderData.orderId,
      token: orderData.token,
      customer_name: orderData.customerName || 'Customer',
      customer_phone: orderData.customerPhone,
      customer_address: orderData.customerAddress,
      items: orderData.items,
      subtotal: orderData.subtotal,
      delivery_charge: orderData.deliveryCharge,
      total: orderData.total,
      payment_method: orderData.paymentMethod,
      payment_status: orderData.payment_status || 'pending',
      status: 'confirmed',
      zone: orderData.zone || detectedZone,
      estimated_delivery: orderData.estimatedDelivery || deliveryTime,
      created_at: new Date().toISOString()
    };
    
    const { error } = await supa
      .from('orders')
      .insert([orderToInsert]);
    
    if (error) {
      console.error('Database error:', error);
      return false;
    }
    
    return true;
    
  } catch (error) {
    console.error('Save order error:', error);
    return false;
  }
}

async function loadOrdersFromDatabase() {
  try {
    if (!currentBusinessId) return [];
    
    const { data, error } = await supa
      .from('orders')
      .select('*')
      .eq('business_id', currentBusinessId)
      .order('created_at', { ascending: false });
    
    if (!error && data) {
      orders = data;
      orderTokens = data.map(order => ({
        id: order.token,
        orderId: order.order_id,
        amount: order.total,
        status: order.status,
        customer: order.customer_name || order.customer_phone,
        date: order.created_at,
        payment_status: order.payment_status
      }));
      updateTokenStats();
      renderTokenList();
      loadPendingPayments();
      return data;
    }
    return [];
  } catch (error) {
    console.error('Error loading orders:', error);
    return [];
  }
}

function updateTokenStats() {
  const totalEl = document.getElementById('totalTokensCount');
  const activeEl = document.getElementById('activeTokensCount');
  const todayEl = document.getElementById('todayTokensCount');
  
  if (totalEl) totalEl.textContent = orderTokens.length;
  
  const activeTokens = orderTokens.filter(t => ['confirmed', 'processing', 'shipped'].includes(t.status)).length;
  if (activeEl) activeEl.textContent = activeTokens;
  
  const today = new Date().toDateString();
  const todayTokens = orderTokens.filter(t => new Date(t.date).toDateString() === today).length;
  if (todayEl) todayEl.textContent = todayTokens;
}

function renderTokenList() {
  const tokenList = document.getElementById('tokenList');
  if (!tokenList) return;
  
  if (orderTokens.length === 0) {
    tokenList.innerHTML = '<p style="text-align:center; padding:20px;">No tokens yet</p>';
    return;
  }
  
  let html = '';
  orderTokens.slice(0, 20).forEach(token => {
    const date = new Date(token.date).toLocaleDateString();
    const statusColor = token.status === 'delivered' ? '#10b981' : token.status === 'cancelled' ? '#ef4444' : '#667eea';
    
    html += `
      <div class="token-item" onclick="viewOrderDetails('${token.orderId}')" style="padding:15px; border-bottom:1px solid #e2e8f0; cursor:pointer;">
        <div style="display:flex; justify-content:space-between;">
          <div><strong>${token.id}</strong></div>
          <span style="color:${statusColor};">${token.status}</span>
        </div>
        <div style="font-size:12px; color:#64748b;">${token.orderId} ‚Ä¢ ${date}</div>
        <div><strong>PKR ${token.amount}</strong></div>
      </div>
    `;
  });
  
  tokenList.innerHTML = html;
}

function searchAdminTokens() {
  const searchTerm = document.getElementById('adminTokenSearch').value.toLowerCase();
  const filtered = orderTokens.filter(token => 
    token.id.toLowerCase().includes(searchTerm) ||
    token.orderId.toLowerCase().includes(searchTerm) ||
    (token.customer && token.customer.toLowerCase().includes(searchTerm))
  );
  
  const tokenList = document.getElementById('tokenList');
  if (filtered.length === 0) {
    tokenList.innerHTML = '<p style="text-align:center; padding:20px;">No matches</p>';
    return;
  }
  
  let html = '';
  filtered.slice(0, 20).forEach(token => {
    const date = new Date(token.date).toLocaleDateString();
    html += `
      <div class="token-item" onclick="viewOrderDetails('${token.orderId}')" style="padding:15px; border-bottom:1px solid #e2e8f0; cursor:pointer;">
        <div><strong>${token.id}</strong></div>
        <div style="font-size:12px;">${token.orderId} ‚Ä¢ ${date}</div>
        <div><strong>PKR ${token.amount}</strong></div>
      </div>
    `;
  });
  
  tokenList.innerHTML = html;
}

async function viewOrderDetails(orderId) {
  const order = orders.find(o => o.order_id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('orderConfirmationModal');
  const content = document.getElementById('orderConfirmationContent');
  
  const items = Array.isArray(order.items) ? order.items : [];
  const itemsHtml = items.map(item => 
    `<div>‚Ä¢ ${item.title} x${item.quantity} - PKR ${(item.price * item.quantity).toFixed(2)}</div>`
  ).join('');
  
  content.innerHTML = `
    <div style="text-align:center; margin-bottom:20px;">
      <i class="fas fa-receipt" style="font-size:48px; color:#667eea;"></i>
      <h2>Order Details</h2>
    </div>
    
    <div style="background:#f8fafc; padding:15px; border-radius:12px; margin-bottom:15px;">
      <div><strong>Order ID:</strong> ${order.order_id}</div>
      <div><strong>Token:</strong> ${order.token}</div>
      <div><strong>Customer:</strong> ${order.customer_name || order.customer_phone}</div>
      <div><strong>Phone:</strong> ${order.customer_phone}</div>
      <div><strong>Address:</strong> ${order.customer_address}</div>
      <div><strong>Payment:</strong> ${order.payment_method}</div>
      <div><strong>Payment Status:</strong> 
        <span style="color:${order.payment_status === 'paid' ? '#10b981' : '#f59e0b'}">
          ${order.payment_status || 'pending'}
        </span>
      </div>
    </div>
    
    <div style="margin-bottom:15px;">
      <h3>Items</h3>
      ${itemsHtml}
    </div>
    
    <div style="background:#f8fafc; padding:15px; border-radius:12px;">
      <div style="display:flex; justify-content:space-between;">
        <span>Subtotal:</span> <span>PKR ${order.subtotal}</span>
      </div>
      <div style="display:flex; justify-content:space-between;">
        <span>Delivery:</span> <span>PKR ${order.delivery_charge}</span>
      </div>
      <div style="display:flex; justify-content:space-between; font-weight:800; margin-top:8px;">
        <span>Total:</span> <span>PKR ${order.total}</span>
      </div>
    </div>
    
    ${isAdminLoggedIn ? `
      <div style="margin-top:20px;">
        <select id="orderStatusSelect" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; margin-bottom:10px;">
          <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
          <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
          <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
          <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
          <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
        </select>
        <button onclick="updateOrderStatus('${order.id}')" style="width:100%; padding:12px; background:var(--success-gradient); color:white; border:none; border-radius:8px; font-weight:700;">Update Status</button>
      </div>
    ` : ''}
  `;
  
  openModal('orderConfirmationModal');
}

async function updateOrderStatus(orderId) {
  const status = document.getElementById('orderStatusSelect').value;
  
  const { error } = await supa
    .from('orders')
    .update({ status: status, updated_at: new Date().toISOString() })
    .eq('id', orderId);
  
  if (!error) {
    notificationManager.showAlert(`‚úÖ Order status updated to ${status}`, 'success');
    closeModal('orderConfirmationModal');
    loadOrdersFromDatabase();
  } else {
    notificationManager.showAlert('‚ùå Error updating order', 'error');
  }
}

function generateNewToken() {
  if (!isAdminLoggedIn) {
    notificationManager.showAlert('‚ùå Admin login required', 'error');
    return;
  }
  
  const token = generateOrderToken();
  notificationManager.showAlert(`‚úÖ New token: ${token}`, 'success');
}

// ===== MANUAL PAYMENT SYSTEM =====
function markAsPaid() {
  if (!currentOrderForProof) {
    notificationManager.showAlert('‚ùå Order information missing', 'error');
    return;
  }
  
  // Set amount in proof modal
  document.getElementById('proofAmount').value = currentOrderForProof.total;
  closeModal('paymentDetailsModal');
  openModal('paymentProofModal');
}

// File upload handlers
document.addEventListener('DOMContentLoaded', function() {
  const dropZone = document.getElementById('proofDropZone');
  if (dropZone) {
    dropZone.addEventListener('click', () => {
      document.getElementById('proofImage').click();
    });
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.background = '#ede9fe';
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.background = '#f8fafc';
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.background = '#f8fafc';
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleProofFile(files[0]);
      }
    });
  }
  
  const fileInput = document.getElementById('proofImage');
  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleProofFile(e.target.files[0]);
      }
    });
  }
});

function handleProofFile(file) {
  if (file.size > 5 * 1024 * 1024) {
    notificationManager.showAlert('‚ùå File size 5MB se zyada hai', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const preview = document.getElementById('proofImagePreview');
    const img = preview.querySelector('img');
    img.src = e.target.result;
    preview.style.display = 'block';
    document.getElementById('proofDropZone').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

function removeProofImage() {
  document.getElementById('proofImagePreview').style.display = 'none';
  document.getElementById('proofDropZone').style.display = 'block';
  document.getElementById('proofImage').value = '';
}

async function submitPaymentProof() {
  if (!currentOrderForProof) {
    notificationManager.showAlert('‚ùå Order information missing', 'error');
    return;
  }
  
  const transactionId = document.getElementById('proofTransactionId').value.trim();
  const amount = document.getElementById('proofAmount').value;
  
  if (!transactionId) {
    notificationManager.showAlert('‚ùå Transaction ID zaroori hai', 'error');
    return;
  }
  
  if (!amount || amount <= 0) {
    notificationManager.showAlert('‚ùå Sahi amount daalein', 'error');
    return;
  }
  
  // Update order in database
  const { error } = await supa
    .from('orders')
    .update({ 
      payment_status: 'proof_submitted',
      transaction_id: transactionId,
      proof_submitted_at: new Date().toISOString()
    })
    .eq('order_id', currentOrderForProof.orderId);
  
  if (!error) {
    // Send notifications
    await notificationManager.sendPaymentNotifications(currentOrderForProof, {
      transactionId: transactionId,
      amount: amount
    });
    
    closeModal('paymentProofModal');
    notificationManager.showAlert('‚úÖ Proof submitted! Admin will verify soon', 'success');
    
    // Update local orders
    await loadOrdersFromDatabase();
  } else {
    notificationManager.showAlert('‚ùå Error: ' + error.message, 'error');
  }
}

async function loadPendingPayments() {
  const pendingList = document.getElementById('pendingPaymentsList');
  if (!pendingList) return;
  
  const pending = orders.filter(o => o.payment_status === 'proof_submitted');
  document.getElementById('pendingPaymentCount').textContent = pending.length;
  
  if (pending.length === 0) {
    pendingList.innerHTML = '<p style="color:#94a3b8; text-align:center;">No pending payments</p>';
    return;
  }
  
  let html = '';
  pending.forEach(order => {
    html += `
      <div style="border:2px solid #f59e0b; border-radius:12px; padding:15px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <span style="font-weight:800;">${order.order_id}</span>
          <span style="background:#f59e0b20; color:#f59e0b; padding:4px 8px; border-radius:6px;">${order.payment_method}</span>
        </div>
        
        <div style="margin-bottom:10px;">
          <div><i class="fas fa-user"></i> ${order.customer_phone}</div>
          <div><i class="fas fa-tag"></i> PKR ${order.total}</div>
          <div><i class="fas fa-hashtag"></i> TXN: ${order.transaction_id || 'N/A'}</div>
        </div>
        
        <div style="display:flex; gap:10px;">
          <button onclick="confirmPayment('${order.id}')" 
                  style="flex:2; padding:12px; background:var(--success-gradient); color:white; border:none; border-radius:8px; font-weight:700;">
            <i class="fas fa-check-circle"></i> CONFIRM
          </button>
          <button onclick="rejectPayment('${order.id}')" 
                  style="flex:1; padding:12px; background:#ef4444; color:white; border:none; border-radius:8px; font-weight:700;">
            <i class="fas fa-times"></i> Reject
          </button>
        </div>
      </div>
    `;
  });
  
  pendingList.innerHTML = html;
}

async function confirmPayment(orderId) {
  if (!confirm('Payment confirm karna hai?')) return;
  
  const order = orders.find(o => o.id === orderId);
  
  const { error } = await supa
    .from('orders')
    .update({ 
      payment_status: 'paid',
      status: 'processing',
      payment_confirmed_at: new Date().toISOString()
    })
    .eq('id', orderId);
  
  if (!error) {
    await notificationManager.sendPaymentConfirmation(order);
    await loadOrdersFromDatabase();
    notificationManager.showAlert('‚úÖ Payment confirmed!', 'success');
  } else {
    notificationManager.showAlert('‚ùå Error: ' + error.message, 'error');
  }
}

async function rejectPayment(orderId) {
  const reason = prompt('Rejection reason?');
  if (!reason) return;
  
  const { error } = await supa
    .from('orders')
    .update({ 
      payment_status: 'payment_rejected',
      admin_notes: reason
    })
    .eq('id', orderId);
  
  if (!error) {
    await loadOrdersFromDatabase();
    notificationManager.showAlert('‚ùå Payment rejected', 'warning');
  }
}

// ===== ADMIN PROMO NOTIFICATIONS =====
async function sendPromotionalNotification() {
  const title = document.getElementById('notifTitle').value.trim();
  const body = document.getElementById('notifBody').value.trim();
  const type = document.getElementById('notifType').value;
  const sendWA = document.getElementById('sendWhatsApp').checked;
  const audience = document.getElementById('notifAudience').value;
  
  if (!title || !body) {
    notificationManager.showAlert('‚ùå Title aur message dono zaroori hain', 'error');
    return;
  }
  
  // Get customers based on audience
  let customers = [];
  if (audience === 'all') {
    const { data } = await supa
      .from('customers')
      .select('phone')
      .eq('business_id', currentBusinessId)
      .eq('is_active', true);
    customers = data || [];
  }
  
  // Send to admin first
  await notificationManager.sendPromotionalNotification(title, body, type);
  
  // Send WhatsApp to customers if enabled
  if (sendWA && customers.length > 0) {
    const message = `*${title}*\n\n${body}\n\n_From ${card.businessName}_`;
    
    // Send to first 10 customers (rate limit)
    for (let i = 0; i < Math.min(customers.length, 10); i++) {
      await notificationManager.sendWhatsApp(customers[i].phone, message);
      await new Promise(r => setTimeout(r, 2000));
    }
    
    notificationManager.showAlert(`‚úÖ Sent to ${Math.min(customers.length, 10)} customers`, 'success');
  }
  
  // Clear form
  document.getElementById('notifTitle').value = '';
  document.getElementById('notifBody').value = '';
}

// ===== CART MANAGEMENT =====
function updateCartCount() {
  const count = cart.length;
  const miniEl = document.getElementById('cartCountMini');
  const cartBadge = document.getElementById('cartBadge');
  
  if (miniEl) miniEl.textContent = count;
  
  if (cartBadge) {
    if (count > 0) {
      cartBadge.textContent = count > 99 ? '99+' : count;
      cartBadge.style.display = 'flex';
    } else {
      cartBadge.style.display = 'none';
    }
  }
  
  isolatedLocalStorage.setItem('cart', JSON.stringify(cart));
  
  if (currentPage === 'cartPage') loadCartPage();
}

function addToCart(productIndex) {
  const products = card.products || [];
  const product = products[productIndex];
  
  if (product) {
    const existingIndex = cart.findIndex(item => 
      item.title === product.title && 
      item.discountPrice === product.discountPrice
    );
    
    if (existingIndex === -1) {
      cart.push({ ...product, index: productIndex, quantity: 1 });
    } else {
      cart[existingIndex].quantity = (cart[existingIndex].quantity || 1) + 1;
    }
    updateCartCount();
    notificationManager.showAlert('‚úÖ Product added to cart!', 'success');
    notificationManager.addNotification('Cart Updated', `${product.title} added`, 'success');
  }
}

function addToCartFromModal() {
  if (currentProduct) {
    const products = card.products || [];
    const productIndex = products.findIndex(p => p.title === currentProduct.title);
    if (productIndex !== -1) {
      addToCart(productIndex);
      closeModal('productModal');
    }
  }
}

function removeFromCart(index) {
  if (cart[index]) {
    const productName = cart[index].title;
    cart.splice(index, 1);
    updateCartCount();
    notificationManager.showAlert('üóëÔ∏è Product removed', 'info');
  }
}

function updateQuantity(index, change) {
  if (cart[index]) {
    cart[index].quantity = Math.max(1, (cart[index].quantity || 1) + change);
    loadCartPage();
    updateCartCount();
  }
}

function loadCartPage() {
  const cartContent = document.getElementById('cartContent');
  const cartItemsCount = document.getElementById('cartItemsCount');
  
  if (cart.length === 0) {
    cartContent.innerHTML = `
      <div style="text-align:center; padding:40px; background:white; border-radius:20px; margin:16px;">
        <i class="fas fa-shopping-cart" style="font-size:64px; color:#cbd5e1;"></i>
        <h3>Your cart is empty</h3>
        <button onclick="navigateTo('productsPage')" style="margin-top:20px; padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px;">Browse Products</button>
      </div>
    `;
    cartItemsCount.textContent = '0 items';
    return;
  }
  
  let html = '';
  let total = 0;
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    total += itemTotal;
    
    html += `
      <div style="display:flex; gap:12px; background:white; padding:16px; border-radius:16px; margin-bottom:12px;">
        <img src="${item.image || ''}" style="width:80px; height:80px; object-fit:cover; border-radius:12px;" onerror="this.style.display='none'">
        <div style="flex:1;">
          <div style="font-weight:700;">${item.title || 'Product'}</div>
          <div style="font-weight:800; color:#10b981;">PKR ${itemTotal}</div>
          <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <button onclick="updateQuantity(${index}, -1)" style="width:30px; height:30px; border:1px solid #e2e8f0; background:white; border-radius:6px;">-</button>
              <span>${item.quantity}</span>
              <button onclick="updateQuantity(${index}, 1)" style="width:30px; height:30px; border:1px solid #e2e8f0; background:white; border-radius:6px;">+</button>
            </div>
            <button onclick="removeFromCart(${index})" style="color:#ef4444; background:none; border:none;">Remove</button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += `
    <div style="background:white; border-radius:20px; padding:20px; margin:16px;">
      <h3>Order Summary</h3>
      <div style="display:flex; justify-content:space-between; margin:10px 0;">
        <span>Subtotal</span> <span>PKR ${total}</span>
      </div>
      <button onclick="openCheckoutModal()" style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:800; margin-top:10px;">
        Proceed to Checkout
      </button>
    </div>
  `;
  
  cartContent.innerHTML = html;
  cartItemsCount.textContent = `${cart.length} items`;
}

// ===== PRODUCT CARDS =====
function createProductCard(product, index) {
  const price = product.discountPrice || product.originalPrice;
  const originalPrice = product.originalPrice && product.discountPrice ? product.originalPrice : null;
  
  const card = document.createElement('div');
  card.className = 'product-card';
  
  card.innerHTML = `
    <div class="product-image-container" onclick="zoomImage('${product.image || ''}', event)">
      <img src="${product.image || ''}" class="product-image" onerror="this.style.display='none'">
      ${originalPrice ? `<span class="discount-badge">-${Math.round((originalPrice - price)/originalPrice*100)}%</span>` : ''}
    </div>
    <div class="product-content">
      <div class="product-title">${product.title || 'Product'}</div>
      <div class="price-badge-container">
        <span class="current-price">PKR ${price}</span>
        ${originalPrice ? `<span class="original-price">PKR ${originalPrice}</span>` : ''}
      </div>
      <div class="product-actions">
        <button class="btn-primary" onclick="addToCart(${index}); event.stopPropagation();">
          <i class="fas fa-cart-plus"></i> Add
        </button>
        <button class="btn-secondary" onclick="buyNow(${index}); event.stopPropagation();">
          <i class="fas fa-bolt"></i> Buy
        </button>
      </div>
    </div>
  `;
  
  card.onclick = (e) => {
    if (!e.target.closest('button')) showProductModal(index);
  };
  
  return card;
}

function showProductModal(index) {
  const product = card.products[index];
  if (!product) return;
  
  currentProduct = product;
  document.getElementById('modalImage').src = product.image || '';
  document.getElementById('modalTitle').textContent = product.title || 'Product';
  document.getElementById('modalDescription').textContent = product.desc || 'No description';
  
  const price = product.discountPrice || product.originalPrice;
  document.getElementById('modalPrice').innerHTML = `<div style="font-size:24px; font-weight:900; color:#10b981;">PKR ${price}</div>`;
  
  openModal('productModal');
}

function zoomImage(url, e) {
  if (e) e.stopPropagation();
  if (url) {
    document.getElementById('zoomedImage').src = url;
    document.getElementById('imageZoomOverlay').style.display = 'flex';
  }
}

function closeImageZoom() {
  document.getElementById('imageZoomOverlay').style.display = 'none';
}

function filterProducts() {
  const term = document.getElementById('productsSearch').value.toLowerCase();
  const products = card.products || [];
  const container = document.getElementById('allProducts');
  container.innerHTML = '';
  
  products.filter(p => p.title?.toLowerCase().includes(term))
    .forEach((p, i) => container.appendChild(createProductCard(p, i)));
}

function buyNow(index) {
  const product = card.products[index];
  if (product) {
    cart = [{ ...product, quantity: 1 }];
    updateCartCount();
    openCheckoutModal();
  }
}

function buyNowFromModal() {
  if (currentProduct) {
    cart = [{ ...currentProduct, quantity: 1 }];
    updateCartCount();
    closeModal('productModal');
    openCheckoutModal();
  }
}

// ===== CHECKOUT =====
async function openCheckoutModal() {
  if (cart.length === 0) {
    notificationManager.showAlert('Cart is empty', 'warning');
    return;
  }
  
  selectedCheckoutPhone = getCustomerPhone();
  selectedCheckoutAddress = getCustomerAddress();
  
  document.getElementById('checkoutPhoneText').textContent = selectedCheckoutPhone || 'No phone';
  document.getElementById('checkoutAddressDisplay').innerHTML = selectedCheckoutAddress || 'No address saved';
  
  let subtotal = 0;
  let itemsHtml = '';
  
  cart.forEach(item => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    subtotal += itemTotal;
    
    itemsHtml += `
      <div style="display:flex; justify-content:space-between; padding:8px; background:#f8fafc; border-radius:8px; margin-bottom:5px;">
        <span>${item.title} x${item.quantity}</span>
        <span>PKR ${itemTotal}</span>
      </div>
    `;
  });
  
  document.getElementById('checkoutItems').innerHTML = itemsHtml;
  document.getElementById('checkoutSubtotal').textContent = subtotal.toFixed(2);
  
  renderProfessionalPaymentMethods();
  
  if (selectedCheckoutAddress) {
    calculateDeliveryCharge(selectedCheckoutAddress);
  } else {
    deliveryCharge = 0;
    document.getElementById('deliveryZoneBadge').textContent = 'Address Required';
    document.getElementById('checkoutDelivery').textContent = '0';
    document.getElementById('checkoutTotal').textContent = subtotal.toFixed(2);
  }
  
  checkoutPaymentMethod = 'cod';
  openModal('checkoutModal');
}

function renderProfessionalPaymentMethods() {
  const grid = document.getElementById('proPaymentGrid');
  if (!grid) return;
  
  let html = '';
  
  // COD
  html += `
    <div class="pro-payment-card ${checkoutPaymentMethod === 'cod' ? 'selected' : ''}" onclick="selectProPaymentMethod('cod')">
      <div class="pro-payment-icon" style="background:#10b981;"><i class="fas fa-truck"></i></div>
      <div>Cash on Delivery</div>
    </div>
  `;
  
  // JazzCash
  if (card.payments?.gateways?.jazzcash?.active) {
    html += `
      <div class="pro-payment-card ${checkoutPaymentMethod === 'jazzcash' ? 'selected' : ''}" onclick="selectProPaymentMethod('jazzcash')">
        <div class="pro-payment-icon" style="background:#FF6B00;"><i class="fas fa-mobile-alt"></i></div>
        <div>JazzCash</div>
      </div>
    `;
  }
  
  // EasyPaisa
  if (card.payments?.gateways?.easypaisa?.active) {
    html += `
      <div class="pro-payment-card ${checkoutPaymentMethod === 'easypaisa' ? 'selected' : ''}" onclick="selectProPaymentMethod('easypaisa')">
        <div class="pro-payment-icon" style="background:#0A5C36;"><i class="fas fa-wallet"></i></div>
        <div>EasyPaisa</div>
      </div>
    `;
  }
  
  // Bank
  if (card.payments?.gateways?.bank?.active) {
    html += `
      <div class="pro-payment-card ${checkoutPaymentMethod === 'bank' ? 'selected' : ''}" onclick="selectProPaymentMethod('bank')">
        <div class="pro-payment-icon" style="background:#2563eb;"><i class="fas fa-university"></i></div>
        <div>Bank Transfer</div>
      </div>
    `;
  }
  
  // Card
  if (card.payments?.gateways?.card?.active) {
    html += `
      <div class="pro-payment-card ${checkoutPaymentMethod === 'card' ? 'selected' : ''}" onclick="selectProPaymentMethod('card')">
        <div class="pro-payment-icon" style="background:#8b5cf6;"><i class="fas fa-credit-card"></i></div>
        <div>Card</div>
      </div>
    `;
  }
  
  // WhatsApp
  html += `
    <div class="pro-payment-card ${checkoutPaymentMethod === 'whatsapp' ? 'selected' : ''}" onclick="selectProPaymentMethod('whatsapp')">
      <div class="pro-payment-icon" style="background:#25D366;"><i class="fab fa-whatsapp"></i></div>
      <div>WhatsApp</div>
    </div>
  `;
  
  grid.innerHTML = html;
}

function selectProPaymentMethod(method) {
  checkoutPaymentMethod = method;
  
  document.querySelectorAll('.pro-payment-card').forEach(c => c.classList.remove('selected'));
  const selected = document.querySelectorAll(`.pro-payment-card[onclick*="${method}"]`);
  selected.forEach(c => c.classList.add('selected'));
  
  if (method !== 'cod' && method !== 'whatsapp') {
    showPaymentDetailsModal(method);
  }
}

function showPaymentDetailsModal(method) {
  const title = document.getElementById('paymentMethodTitle');
  const content = document.getElementById('paymentDetailsContent');
  
  if (method === 'jazzcash' && card.payments?.gateways?.jazzcash) {
    title.innerHTML = 'JazzCash Payment';
    content.innerHTML = `
      <div style="text-align:center;">
        <div style="font-size:24px; font-weight:900; color:#FF6B00; background:#FF6B0010; padding:15px; border-radius:12px; margin-bottom:15px;">
          ${card.payments.gateways.jazzcash.number || '03001234567'}
        </div>
        ${card.payments.gateways.jazzcash.barcode ? `
          <img src="${card.payments.gateways.jazzcash.barcode}" style="max-width:200px; border-radius:12px;">
        ` : ''}
      </div>
    `;
  } else if (method === 'easypaisa' && card.payments?.gateways?.easypaisa) {
    title.innerHTML = 'EasyPaisa Payment';
    content.innerHTML = `
      <div style="text-align:center;">
        <div style="font-size:24px; font-weight:900; color:#0A5C36; background:#0A5C3610; padding:15px; border-radius:12px;">
          ${card.payments.gateways.easypaisa.number || '03001234567'}
        </div>
      </div>
    `;
  } else if (method === 'bank' && card.payments?.gateways?.bank) {
    title.innerHTML = 'Bank Transfer';
    content.innerHTML = `
      <div>
        <div><strong>Bank:</strong> ${card.payments.gateways.bank.bankName}</div>
        <div><strong>Account:</strong> ${card.payments.gateways.bank.accountNumber}</div>
        <div><strong>Title:</strong> ${card.payments.gateways.bank.accountTitle}</div>
      </div>
    `;
  } else if (method === 'card' && card.payments?.gateways?.card) {
    title.innerHTML = 'Card Payment';
    content.innerHTML = '<p>You will be redirected for secure payment</p>';
  }
  
  openModal('paymentDetailsModal');
  closeModal('checkoutModal');
}

// ===== PLACE ORDER =====
async function placeOrder() {
  if (!selectedCheckoutPhone) {
    notificationManager.showAlert('‚ùå Phone number required', 'error');
    openPhoneInput();
    return;
  }
  
  if (!selectedCheckoutAddress) {
    notificationManager.showAlert('‚ùå Address required', 'error');
    openAddressInput(true);
    return;
  }
  
  if (cart.length === 0) {
    notificationManager.showAlert('‚ùå Cart empty', 'error');
    return;
  }
  
  const subtotal = calculateCartSubtotal();
  const total = subtotal + deliveryCharge;
  const orderId = 'ORD-' + Date.now().toString().slice(-8);
  const token = generateOrderToken();
  
  const orderData = {
    orderId: orderId,
    token: token,
    customerPhone: selectedCheckoutPhone,
    customerAddress: selectedCheckoutAddress,
    items: cart.map(i => ({
      title: i.title,
      price: parseFloat(i.discountPrice || i.originalPrice || 0),
      quantity: i.quantity || 1
    })),
    subtotal: subtotal,
    deliveryCharge: deliveryCharge,
    total: total,
    paymentMethod: getPaymentMethodName(checkoutPaymentMethod),
    payment_status: checkoutPaymentMethod === 'cod' ? 'pending' : 'pending',
    zone: detectedZone,
    estimatedDelivery: deliveryTime
  };
  
  const saved = await saveOrderToDatabase(orderData);
  
  if (saved) {
    currentOrderForProof = orderData;
    localStorage.setItem('currentOrderId', orderId);
    
    cart = [];
    updateCartCount();
    closeModal('checkoutModal');
    
    // Send notifications
    await notificationManager.sendOrderNotifications(orderData);
    
    // Show confirmation
    showOrderConfirmation(orderData);
    
    // Show proof upload for digital payments
    if (checkoutPaymentMethod !== 'cod' && checkoutPaymentMethod !== 'whatsapp') {
      setTimeout(() => {
        if (confirm('Payment proof upload karna chahte hain?')) {
          openModal('paymentProofModal');
        }
      }, 1000);
    }
  } else {
    notificationManager.showAlert('‚ùå Order failed', 'error');
  }
}

function showOrderConfirmation(orderData) {
  const content = document.getElementById('orderConfirmationContent');
  
  content.innerHTML = `
    <div class="order-ticket">
      <div style="text-align:center; margin-bottom:20px;">
        <i class="fas fa-check-circle" style="font-size:48px; color:#10b981;"></i>
        <h2 style="color:white;">Order Confirmed!</h2>
        <p>Token: ${orderData.token}</p>
      </div>
      
      <div style="margin:15px 0;">
        <div><strong>Order ID:</strong> ${orderData.orderId}</div>
        <div><strong>Total:</strong> PKR ${orderData.total}</div>
        <div><strong>Payment:</strong> ${orderData.paymentMethod}</div>
      </div>
      
      ${orderData.paymentMethod !== 'COD' ? `
        <div style="background:rgba(255,255,255,0.2); padding:15px; border-radius:12px;">
          <p>üì∏ Payment proof upload karein</p>
          <button onclick="openModal('paymentProofModal')" style="background:white; color:#667eea; border:none; padding:10px; border-radius:8px; width:100%; font-weight:700;">
            Upload Proof
          </button>
        </div>
      ` : ''}
      
      <button onclick="navigateTo('deliveryPage')" style="margin-top:20px; background:white; color:#667eea; border:none; padding:15px; border-radius:12px; width:100%; font-weight:700;">
        Track Order
      </button>
    </div>
  `;
  
  openModal('orderConfirmationModal');
}

// ===== ADMIN FUNCTIONS =====
function showAdminTab(tab) {
  document.getElementById('adminOrdersTab').style.display = tab === 'orders' ? 'block' : 'none';
  document.getElementById('adminNotificationsTab').style.display = tab === 'notifications' ? 'block' : 'none';
  document.getElementById('adminTokensTab').style.display = tab === 'tokens' ? 'block' : 'none';
  
  document.getElementById('tabOrders').style.background = tab === 'orders' ? '#667eea' : '#f1f5f9';
  document.getElementById('tabOrders').style.color = tab === 'orders' ? 'white' : '#475569';
  document.getElementById('tabNotifications').style.background = tab === 'notifications' ? '#667eea' : '#f1f5f9';
  document.getElementById('tabNotifications').style.color = tab === 'notifications' ? 'white' : '#475569';
  document.getElementById('tabTokens').style.background = tab === 'tokens' ? '#667eea' : '#f1f5f9';
  document.getElementById('tabTokens').style.color = tab === 'tokens' ? 'white' : '#475569';
}

function searchOrders() {
  const term = document.getElementById('adminOrderSearch').value.toLowerCase();
  const filtered = orders.filter(o => 
    o.order_id.toLowerCase().includes(term) ||
    o.token.toLowerCase().includes(term) ||
    o.customer_phone.includes(term)
  );
  
  const list = document.getElementById('allOrdersList');
  if (filtered.length === 0) {
    list.innerHTML = '<p>No orders found</p>';
    return;
  }
  
  let html = '';
  filtered.slice(0, 20).forEach(o => {
    html += `
      <div onclick="viewOrderDetails('${o.order_id}')" style="padding:12px; border-bottom:1px solid #e2e8f0; cursor:pointer;">
        <div style="display:flex; justify-content:space-between;">
          <span><strong>${o.order_id}</strong></span>
          <span style="color:${o.payment_status === 'paid' ? '#10b981' : '#f59e0b'}">${o.payment_status}</span>
        </div>
        <div style="font-size:12px;">${o.customer_phone} ‚Ä¢ PKR ${o.total}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

async function loadAdminPanel() {
  await loadOrdersFromDatabase();
  renderTokenList();
  loadPendingPayments();
  loadCustomerStats();
}

async function loadCustomerStats() {
  const { data } = await supa
    .from('customers')
    .select('count')
    .eq('business_id', currentBusinessId);
  
  document.getElementById('totalCustomersStat').textContent = data?.[0]?.count || 0;
}

// ===== LOGIN SYSTEM =====
function toggleLogin() {
  if (isAdminLoggedIn) {
    logoutAdmin();
  } else {
    navigateTo('loginPage');
  }
}

function updateLoginUI() {
  const icon = document.getElementById('loginIcon');
  icon.className = isAdminLoggedIn ? 'fas fa-sign-out-alt' : 'fas fa-sign-in-alt';
}

function attemptLogin() {
  const password = document.getElementById('adminPasswordInput').value;
  
  if (password === businessAdminPassword) {
    isAdminLoggedIn = true;
    isolatedLocalStorage.setItem('isAdminLoggedIn', 'true');
    updateLoginUI();
    notificationManager.showAlert('‚úÖ Login successful!', 'success');
    navigateTo('adminPage');
    loadAdminPanel();
  } else {
    notificationManager.showAlert('‚ùå Incorrect password', 'error');
  }
}

function handleLoginKeypress(e) {
  if (e.key === 'Enter') attemptLogin();
}

function logoutAdmin() {
  isAdminLoggedIn = false;
  isolatedLocalStorage.removeItem('isAdminLoggedIn');
  updateLoginUI();
  notificationManager.showAlert('üëã Logged out', 'info');
  navigateTo('homePage');
}

// ===== NAVIGATION =====
let lastBackPress = 0;

function initializeRouting() {
  window.addEventListener('hashchange', handleHashChange);
  setTimeout(() => {
    const hash = window.location.hash.replace('#', '') || 'home';
    handleHashChange();
  }, 100);
}

function handleHashChange() {
  const hash = window.location.hash.replace('#', '');
  const pages = {
    'home': 'homePage', 'products': 'productsPage', 'cart': 'cartPage',
    'about': 'aboutPage', 'contact': 'contactPage', 'delivery': 'deliveryPage',
    'admin': 'adminPage', 'login': 'loginPage'
  };
  
  if (pages[hash] && currentPage !== pages[hash]) {
    navigateToDirect(pages[hash]);
  }
}

function navigateToDirect(pageId) {
  if (currentPage === pageId) return;
  
  const oldPage = document.getElementById(currentPage);
  const newPage = document.getElementById(pageId);
  
  if (!newPage) return;
  
  if (oldPage) {
    oldPage.classList.remove('active');
    oldPage.classList.add('slide-out');
  }
  
  setTimeout(() => {
    if (oldPage) oldPage.classList.remove('slide-out');
    newPage.classList.add('active');
    currentPage = pageId;
    
    document.getElementById('headerBackBtn').style.display = pageId !== 'homePage' ? 'flex' : 'none';
    
    // Update nav
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const navMap = { 'homePage': 0, 'productsPage': 1, 'cartPage': 2, 'aboutPage': 3, 'contactPage': 4 };
    if (navMap[pageId] !== undefined) {
      document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active');
    }
    
    document.getElementById('notificationDrawer').classList.remove('open');
    
    // Load page content
    if (pageId === 'homePage') loadHomePage();
    else if (pageId === 'productsPage') loadProductsPage();
    else if (pageId === 'cartPage') loadCartPage();
    else if (pageId === 'aboutPage') loadAboutPage();
    else if (pageId === 'contactPage') loadContactPage();
    else if (pageId === 'deliveryPage') loadDeliveryStatus();
    else if (pageId === 'adminPage' && isAdminLoggedIn) loadAdminPanel();
    else if (pageId === 'adminPage' && !isAdminLoggedIn) navigateTo('loginPage');
  }, 300);
  
  navigationHistory.push(pageId);
}

function navigateTo(pageId) {
  const hashMap = {
    'homePage': 'home', 'productsPage': 'products', 'cartPage': 'cart',
    'aboutPage': 'about', 'contactPage': 'contact', 'deliveryPage': 'delivery',
    'adminPage': 'admin', 'loginPage': 'login'
  };
  
  if (hashMap[pageId]) {
    window.location.hash = `#${hashMap[pageId]}`;
  }
}

function goBack() {
  const drawer = document.getElementById('notificationDrawer');
  if (drawer && drawer.classList.contains('open')) {
    toggleNotificationDrawer();
    return;
  }
  
  if (navigationHistory.length > 1) {
    navigationHistory.pop();
    navigateTo(navigationHistory[navigationHistory.length - 1]);
  } else {
    const now = Date.now();
    if (now - lastBackPress < 2000) {
      document.getElementById('exitModal').style.display = 'flex';
    } else {
      lastBackPress = now;
      notificationManager.showAlert('Press back again to exit', 'info');
    }
  }
}

function closeExitModal() {
  document.getElementById('exitModal').style.display = 'none';
}

function exitApp() {
  if (window.history.length > 1) {
    window.history.go(-1);
  } else {
    window.close();
  }
}

function closeInstallPermissionModal() {
  document.getElementById('installPermissionModal').style.display = 'none';
}

function acceptInstallPermissions() {
  document.getElementById('installPermissionModal').style.display = 'none';
  notificationManager.requestPermission();
}

// ===== PAGE LOADERS =====
function loadHomePage() {
  const featured = document.getElementById('featuredProducts');
  const products = card.products || [];
  featured.innerHTML = '';
  products.slice(0, 4).forEach((p, i) => featured.appendChild(createProductCard(p, i)));
}

function loadProductsPage() {
  const all = document.getElementById('allProducts');
  const products = card.products || [];
  all.innerHTML = '';
  products.forEach((p, i) => all.appendChild(createProductCard(p, i)));
}

function loadAboutPage() {
  document.getElementById('aboutContent').innerHTML = `
    <div style="background:white; border-radius:16px; padding:24px;">
      <h2>${card.businessName || card.name}</h2>
      <p>${card.business?.about || 'Welcome to our business.'}</p>
    </div>
  `;
  
  // Business hours
  if (card.businessHours) {
    const hours = document.getElementById('businessHours');
    hours.innerHTML = '';
    const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    
    card.businessHours.forEach((day, i) => {
      if (i < 7) {
        hours.innerHTML += `
          <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #e2e8f0;">
            <span>${days[i]}</span>
            <span>${day.status === 'closed' ? 'Closed' : day.start + ' - ' + day.end}</span>
          </div>
        `;
      }
    });
  }
  
  // Holidays
  if (card.holidays?.length > 0) {
    const holidays = document.getElementById('holidaysList');
    holidays.innerHTML = '';
    card.holidays.forEach(h => {
      holidays.innerHTML += `
        <div style="display:flex; justify-content:space-between; padding:8px;">
          <span>${h.name}</span>
          <span>${new Date(h.date).toLocaleDateString()}</span>
        </div>
      `;
    });
  }
}

function loadContactPage() {
  document.getElementById('contactPhone').textContent = card.phone || 'N/A';
  document.getElementById('contactEmail').textContent = card.email || 'N/A';
  document.getElementById('contactAddress').textContent = card.address || 'N/A';
  document.getElementById('customerPhoneDisplay').textContent = getCustomerPhone() || 'Tap to set';
  document.getElementById('customerAddressDisplay').textContent = getCustomerAddress() || 'Tap to set';
  
  const social = document.getElementById('socialGrid');
  const media = card.socialMedia || {};
  social.innerHTML = '';
  
  const platforms = [
    { key: 'facebook', icon: 'fab fa-facebook', color: '#1877F2' },
    { key: 'instagram', icon: 'fab fa-instagram', color: '#E4405F' },
    { key: 'twitter', icon: 'fab fa-twitter', color: '#1DA1F2' }
  ];
  
  platforms.forEach(p => {
    if (media[p.key]) {
      social.innerHTML += `
        <a href="${media[p.key]}" target="_blank" style="text-decoration:none;">
          <div style="background:${p.color}; color:white; padding:10px; border-radius:10px; text-align:center;">
            <i class="${p.icon}"></i>
          </div>
        </a>
      `;
    }
  });
}

// ===== CUSTOMER DATA =====
function generateDeviceId() {
  let id = localStorage.getItem('customer_device_id');
  if (!id) {
    id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('customer_device_id', id);
  }
  return id;
}

function initCustomerData() {
  customerData.deviceId = generateDeviceId();
  customerData.phone = getCustomerPhone();
}

// ===== CONTACT ACTIONS =====
function openWhatsAppChat() {
  if (card.phone) {
    const phone = card.phone.replace(/\D/g, '');
    window.open(`https://wa.me/${phone}`, '_blank');
  }
}

function makeCall() {
  if (card.phone) window.open(`tel:${card.phone}`);
}

function sendEmail() {
  if (card.email) window.open(`mailto:${card.email}`);
}

function openMap() {
  if (card.address) window.open(`https://maps.google.com/?q=${encodeURIComponent(card.address)}`, '_blank');
}

// ===== INITIALIZATION =====
document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  let id = params.get("id") || localStorage.getItem("lastCardId");
  
  if (id && id.length === 6) {
    const { data } = await supa.from('short_urls').select('full_id').eq('short_id', id).single();
    if (data) {
      id = data.full_id;
      shortCardId = data.short_id;
    }
  }
  
  if (!id) {
    document.body.innerHTML = "<div style='padding:40px; text-align:center;'>Card not found</div>";
    return;
  }
  
  localStorage.setItem("lastCardId", id);
  currentBusinessId = id;
  
  const savedCart = isolatedLocalStorage.getItem('cart');
  cart = savedCart ? JSON.parse(savedCart) : [];
  
  isAdminLoggedIn = isolatedLocalStorage.getItem('isAdminLoggedIn') === 'true';
  
  initCustomerData();
  
  setTimeout(async () => {
    const { data, error } = await supa.from("cards").select("*").eq("id", id).single();
    if (error || !data) {
      document.body.innerHTML = "<div style='padding:40px; text-align:center;'>Card not found</div>";
      return;
    }
    
    card = JSON.parse(data.data);
    card.id = data.id;
    
    businessAdminPassword = generateAdminPassword(card.id, shortCardId);
    document.getElementById('passwordHint').textContent = shortCardId ? 
      `Hint: business123_${shortCardId.toLowerCase()}` : 'Hint: business123_{short_id}';
    
    await loadOrdersFromDatabase();
    await renderApp();
    
    initializeRouting();
    
    navigationHistory.push('homePage');
    updateCartCount();
    updateLoginUI();
    notificationManager.updateBadge();
    updateDeliveryIcon();
    
    setTimeout(() => checkForDeliveries(), 1000);
    notificationManager.addNotification('Welcome!', 'Browse products and enjoy shopping', 'info');
    
    setTimeout(() => {
      if (!window.matchMedia('(display-mode: standalone)').matches && deferredPrompt) {
        document.getElementById('installPermissionModal').style.display = 'flex';
      }
    }, 3000);
  }, 2000);
});

async function renderApp() {
  setupDynamicPWA(card);
  document.getElementById('businessHeader').textContent = card.businessName || card.name || "Premium Business";
  document.getElementById('photo').src = card.profileImage || '';
  document.getElementById('name').textContent = card.name || '';
  document.getElementById('business').textContent = card.businessName || '';
  loadHomePage();
}

setInterval(checkForDeliveries, 30000);
</script>
</body>
</html>
