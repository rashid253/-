<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Digital Business App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a" id="themeColorMeta">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Premium Digital Business App">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap">

<style>
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
  --whatsapp-gradient: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --dark-color: #0f172a;
  --darker-color: #020617;
  --light-color: #f8fafc;
  --lighter-color: #ffffff;
  --glass-bg: rgba(255, 255, 255, 0.98);
  --glass-border: rgba(255, 255, 255, 0.2);
  --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  --shadow-lg: 0 20px 60px rgba(0,0,0,0.15);
  --shadow-md: 0 10px 30px rgba(0,0,0,0.1);
  --shadow-sm: 0 4px 15px rgba(0,0,0,0.08);
  --border-radius-xl: 32px;
  --border-radius-lg: 24px;
  --border-radius-md: 16px;
  --border-radius-sm: 12px;
  --border-radius-xs: 8px;
  --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Poppins', sans-serif;
  background: var(--primary-gradient);
  min-height: 100vh;
  color: var(--dark-color);
  position: fixed;
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: none;
}

.app-container {
  position: relative;
  width: 100%;
  height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  background: var(--light-color);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
  border-radius: 0;
}

.page {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 0;
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--light-color);
  transform: translateX(100%);
  opacity: 0;
  visibility: hidden;
  transition: var(--transition-slow);
  z-index: 1;
}

.page.active {
  transform: translateX(0);
  opacity: 1;
  visibility: visible;
  z-index: 2;
}

.page.slide-out {
  transform: translateX(-100%);
  opacity: 0;
  visibility: hidden;
}

#loadingScreen {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: var(--primary-gradient);
  z-index: 100;
}

.loader {
  width: 80px;
  height: 80px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 30px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-width: 480px;
  height: 70px;
  background: var(--glass-bg);
  backdrop-filter: blur(30px);
  border-top: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0 15px;
  z-index: 1000;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
  border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 8px;
  border-radius: var(--border-radius-md);
  cursor: pointer;
  transition: var(--transition);
  flex: 1;
  position: relative;
}

.nav-item.active {
  background: rgba(102, 126, 234, 0.1);
}

.nav-icon {
  font-size: 22px;
  color: #64748b;
  transition: var(--transition);
  position: relative;
}

.nav-item.active .nav-icon {
  color: #667eea;
  transform: scale(1.1);
}

.nav-label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  transition: var(--transition);
}

.nav-item.active .nav-label {
  color: #667eea;
  font-weight: 700;
}

.header-icons {
  position: absolute;
  top: 20px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 25px;
  z-index: 10;
  padding: 0 20px;
}

.header-icon-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  border-radius: 50%;
  border: 1px solid rgba(255, 255, 255, 0.3);
  transition: var(--transition-fast);
  position: relative;
}

.delivery-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #10b981;
  color: white;
  font-size: 10px;
  font-weight: 900;
  min-width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid rgba(255,255,255,0.5);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 11;
}

/* ===== MODERN ECOMMERCE LABELS - HALF BAHAR, TOP CORNERS ===== */
.discount-badge {
  position: absolute;
  top: -8px;
  left: -8px;
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
  font-size: 12px;
  font-weight: 900;
  padding: 6px 12px;
  border-radius: 30px;
  box-shadow: 0 6px 14px rgba(239, 68, 68, 0.3);
  display: flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255,255,255,0.4);
  z-index: 20;
  letter-spacing: 0.5px;
  backdrop-filter: blur(2px);
}

.offer-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  font-size: 11px;
  font-weight: 800;
  padding: 6px 14px;
  border-radius: 30px;
  box-shadow: 0 6px 14px rgba(16, 185, 129, 0.3);
  display: flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255,255,255,0.4);
  z-index: 20;
  backdrop-filter: blur(2px);
}

.feature-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  color: white;
  font-size: 11px;
  font-weight: 800;
  padding: 6px 14px;
  border-radius: 30px;
  box-shadow: 0 6px 14px rgba(139, 92, 246, 0.3);
  border: 1px solid rgba(255,255,255,0.4);
  z-index: 20;
  backdrop-filter: blur(2px);
}

/* ===== PRICE BADGE - BOTTOM LEFT CORNER ===== */
.price-badge {
  position: absolute;
  bottom: -6px;
  left: -6px;
  background: rgba(15, 23, 42, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 8px 16px;
  border-radius: 30px;
  font-weight: 800;
  font-size: 14px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
  display: flex;
  align-items: center;
  gap: 8px;
  z-index: 20;
}

/* ===== PERCENTAGE DISCOUNT - BOTTOM RIGHT CORNER ===== */
.percentage-badge {
  position: absolute;
  bottom: -6px;
  right: -6px;
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  font-size: 13px;
  font-weight: 900;
  padding: 8px 16px;
  border-radius: 30px;
  box-shadow: 0 6px 14px rgba(245, 158, 11, 0.3);
  display: flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255,255,255,0.4);
  z-index: 20;
  letter-spacing: 0.5px;
  backdrop-filter: blur(2px);
}

.original-price {
  text-decoration: line-through;
  opacity: 0.7;
  font-size: 12px;
  font-weight: 500;
  margin-right: 6px;
}

.current-price {
  font-weight: 900;
  color: #10b981;
}

/* ===== CART BADGE ===== */
.cart-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background: var(--danger-gradient);
  color: white;
  font-size: 11px;
  font-weight: 900;
  min-width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 5px;
  border: 2px solid var(--glass-bg);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 10;
}

/* ===== PRODUCT CARD STYLES ===== */
.products-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  padding: 0 16px;
  align-items: stretch;
  margin-bottom: 20px;
}

.product-card {
  background: var(--lighter-color);
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.04);
  padding: 12px;
  transition: var(--transition-fast);
  cursor: pointer;
  position: relative;
  display: flex;
  flex-direction: column;
}

.product-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.08);
}

.product-image-container {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;
  background: #f8fafc;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 12px;
  border: 1px solid #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
}

.product-image {
  width: 100%;
  height: 100%;
  object-fit: contain;
  transition: transform 0.3s ease;
  padding: 8px;
}

.product-card.clicked .product-image {
  transform: scale(1.8);
}

.product-content {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 4px 0;
}

.product-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--dark-color);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  min-height: 36px;
}

.product-actions {
  display: flex;
  gap: 8px;
  margin-top: 4px;
}

.btn-primary, .btn-secondary {
  flex: 1;
  padding: 10px 0;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  transition: var(--transition-fast);
}

.btn-primary {
  background: var(--success-gradient);
  color: white;
}

.btn-secondary {
  background: var(--info-gradient);
  color: white;
}

/* ===== MODAL STYLES ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(15px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: var(--glass-bg);
  border-radius: 24px;
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--glass-border);
}

.close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(0,0,0,0.1);
  color: var(--dark-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  cursor: pointer;
  z-index: 10;
}

/* ===== IMAGE ZOOM OVERLAY ===== */
.image-zoom-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}

.image-zoom-content {
  max-width: 90%;
  max-height: 90%;
  animation: zoomIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes zoomIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* ===== BACK BUTTON FIX ===== */
.back-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  border: 1px solid rgba(255,255,255,0.3);
  z-index: 100;
  transition: var(--transition-fast);
}

.back-btn:hover {
  transform: scale(1.1);
  background: rgba(255,255,255,0.3);
}

/* ===== EXIT MODAL ===== */
.exit-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  padding: 20px;
}

.exit-modal {
  background: var(--glass-bg);
  border-radius: 24px;
  width: 100%;
  max-width: 350px;
  padding: 30px;
  text-align: center;
  border: 1px solid var(--glass-border);
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

.exit-modal h2 {
  color: var(--dark-color);
  margin-bottom: 15px;
  font-size: 22px;
  font-weight: 800;
}

.exit-modal p {
  color: #64748b;
  margin-bottom: 25px;
  font-size: 15px;
  line-height: 1.5;
}

.exit-modal-buttons {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.exit-modal-btn {
  flex: 1;
  padding: 15px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
}

.exit-modal-btn.cancel {
  background: #f1f5f9;
  color: #64748b;
}

.exit-modal-btn.exit {
  background: var(--danger-gradient);
  color: white;
}

/* ===== NOTIFICATION ALERT ===== */
.notification-alert {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--whatsapp-gradient);
  color: white;
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: var(--shadow-xl);
  z-index: 3000;
  max-width: 300px;
  animation: slideIn 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
  font-weight: 700;
  font-size: 14px;
  text-align: center;
  display: none;
}

@keyframes slideIn {
  from { top: 50px; opacity: 0; }
  to { top: 100px; opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

/* ===== PAGE HEADERS ===== */
#homePage, #productsPage, #cartPage, #aboutPage, #contactPage, #deliveryPage, #adminPage, #loginPage {
  padding-top: 80px;
  padding-bottom: 100px;
  background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
}

.app-header {
  background: var(--primary-gradient);
  padding: 80px 25px 30px;
  border-radius: 0 0 50px 50px;
  margin: 0;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-md);
}

.welcome-text h1 {
  color: white;
  font-size: 32px;
  font-weight: 900;
  margin-bottom: 8px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.products-header, .cart-header, .about-header, .contact-header, .delivery-page-header {
  background: var(--primary-gradient);
  padding: 50px 25px 30px;
  margin: 0;
  position: relative;
  overflow: hidden;
}

.products-header h1, .cart-header h1, .about-header h1, .contact-header h1, .delivery-page-header h1 {
  color: white;
  font-size: 28px;
  font-weight: 800;
  margin-bottom: 12px;
  position: relative;
  z-index: 1;
  margin-top: 20px;
}

.share-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 100;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 480px) {
  .app-container { max-width: 100%; }
  .products-grid { gap: 12px; padding: 0 12px; }
  .product-card { padding: 10px; }
  .discount-badge, .offer-badge, .feature-badge { font-size: 10px; padding: 5px 10px; }
  .price-badge { font-size: 12px; padding: 6px 12px; }
  .percentage-badge { font-size: 11px; padding: 6px 12px; }
}

@media (prefers-color-scheme: dark) {
  :root {
    --light-color: #0f172a;
    --lighter-color: #1e293b;
    --dark-color: #f8fafc;
    --glass-bg: rgba(30, 41, 59, 0.95);
  }
  body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
  .app-container { background: var(--light-color); }
  .product-card { background: var(--lighter-color); border-color: rgba(255,255,255,0.1); }
}
</style>
</head>

<body>
<div class="app-container">
  <!-- Image Zoom Overlay -->
  <div class="image-zoom-overlay" id="imageZoomOverlay" onclick="closeImageZoom()">
    <img src="" class="image-zoom-content" id="zoomedImage">
  </div>

  <!-- Exit Confirmation Modal -->
  <div class="exit-modal-overlay" id="exitModal">
    <div class="exit-modal">
      <h2><i class="fas fa-sign-out-alt"></i> Exit App?</h2>
      <p>Are you sure you want to exit? Press back again to confirm.</p>
      <div class="exit-modal-buttons">
        <button class="exit-modal-btn cancel" onclick="closeExitModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="exit-modal-btn exit" onclick="exitApp()">
          <i class="fas fa-sign-out-alt"></i> Exit
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="page active">
    <div class="loader"></div>
    <h1 id="loadingTitle">Digital Business App</h1>
    <p id="loadingSubtitle">Loading your premium business experience...</p>
  </div>

  <!-- Home Page -->
  <div id="homePage" class="page">
    <div class="share-btn" onclick="shareBusiness()" title="Share Business">
      <i class="fas fa-share-alt"></i>
    </div>
    
    <div class="app-header">
      <div class="header-icons">
        <div class="header-icon-btn" id="deliveryStatusBtn" onclick="checkDeliveryStatus()">
          <i class="fas fa-truck" id="deliveryIcon"></i>
          <div class="delivery-badge" id="deliveryBadge" style="display:none;"></div>
        </div>
        
        <div class="header-icon-btn" id="loginBtn" onclick="toggleLogin()">
          <i class="fas fa-sign-in-alt" id="loginIcon"></i>
        </div>
      </div>
      
      <div class="welcome-text">
        <h1 id="businessHeader">Welcome</h1>
        <p>Premium business at your fingertips</p>
      </div>
      
      <div class="quick-actions" style="display:grid; grid-template-columns:repeat(2,1fr); gap:15px; margin-top:20px;">
        <div class="action-card" onclick="navigateTo('productsPage')" style="background:rgba(255,255,255,0.2); padding:20px; border-radius:24px; text-align:center; color:white; cursor:pointer;">
          <div style="font-size:28px; margin-bottom:15px;"><i class="fas fa-shopping-bag"></i></div>
          <h3 style="font-size:17px; font-weight:800;">Shop Now</h3>
          <p style="font-size:13px; opacity:0.9;">Browse products</p>
        </div>
        <div class="action-card" onclick="navigateTo('cartPage')" style="background:rgba(255,255,255,0.2); padding:20px; border-radius:24px; text-align:center; color:white; cursor:pointer;">
          <div style="font-size:28px; margin-bottom:15px; position:relative;">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge" style="display:none;">0</span>
          </div>
          <h3 style="font-size:17px; font-weight:800;">My Cart</h3>
          <p style="font-size:13px; opacity:0.9;"><span id="cartCountMini">0</span> items</p>
        </div>
        <div class="action-card" onclick="openWhatsAppChat('greeting')" style="background:rgba(255,255,255,0.2); padding:20px; border-radius:24px; text-align:center; color:white; cursor:pointer;">
          <div style="font-size:28px; margin-bottom:15px;"><i class="fab fa-whatsapp"></i></div>
          <h3 style="font-size:17px; font-weight:800;">Live Chat</h3>
          <p style="font-size:13px; opacity:0.9;">Instant support</p>
        </div>
        <div class="action-card" onclick="navigateTo('contactPage')" style="background:rgba(255,255,255,0.2); padding:20px; border-radius:24px; text-align:center; color:white; cursor:pointer;">
          <div style="font-size:28px; margin-bottom:15px;"><i class="fas fa-map-marker-alt"></i></div>
          <h3 style="font-size:17px; font-weight:800;">Location</h3>
          <p style="font-size:13px; opacity:0.9;">Find us</p>
        </div>
      </div>
    </div>

    <div class="profile-section" style="background:white; border-radius:32px; padding:30px; margin:40px 25px; box-shadow:var(--shadow-lg); text-align:center;">
      <img src="" id="photo" class="profile-avatar" loading="lazy" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:5px solid white; margin-bottom:20px;">
      <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
        <span id="name" style="font-size:22px; font-weight:900; color:var(--dark-color);">Loading...</span>
        <i class="fas fa-badge-check verified-badge" style="color:#667eea; font-size:18px;"></i>
      </div>
      <div id="business" style="font-size:16px; color:#764ba2; font-weight:700; padding:6px 18px; background:rgba(118,75,162,0.1); border-radius:50px; display:inline-block;"></div>
    </div>

    <div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:40px 25px 20px; padding-bottom:15px; border-bottom:2px solid #f1f5f9;">
      <h2 style="font-size:20px; font-weight:900; color:var(--dark-color); display:flex; align-items:center; gap:10px;">
        <i class="fas fa-gift" style="color:#667eea;"></i> Featured Products
      </h2>
      <div class="see-all" onclick="navigateTo('productsPage')" style="color:#667eea; font-weight:700; font-size:14px; cursor:pointer; display:flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(102,126,234,0.1); border-radius:8px;">
        See All <i class="fas fa-arrow-right"></i>
      </div>
    </div>
    
    <div class="products-grid" id="featuredProducts"></div>
    <div class="page-footer-spacer" style="height:30px;"></div>
  </div>

  <!-- Products Page -->
  <div id="productsPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="products-header">
      <h1>Products & Offers</h1>
      <p style="color:rgba(255,255,255,0.95); font-size:16px;">Discover our premium collection</p>
    </div>
    
    <div class="products-search" style="position:relative; margin:20px; background:white; border-radius:24px; padding:5px; box-shadow:var(--shadow-md);">
      <input type="text" id="productsSearch" placeholder="Search products..." onkeyup="filterProducts()" style="width:100%; padding:15px 50px 15px 20px; border:none; border-radius:16px; font-size:15px; background:transparent;">
      <i class="fas fa-search" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); color:#64748b; font-size:20px;"></i>
    </div>
    
    <div class="products-grid" id="allProducts"></div>
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Cart Page -->
  <div id="cartPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="cart-header">
      <h1>My Cart</h1>
      <p id="cartItemsCount">0 items</p>
    </div>
    
    <div id="cartContent"></div>
    <div class="page-footer-spacer"></div>
  </div>

  <!-- About Page -->
  <div id="aboutPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="about-header">
      <h1>About Business</h1>
    </div>
    
    <div class="about-content" id="aboutContent" style="background:white; border-radius:24px; padding:25px; margin:25px; box-shadow:var(--shadow-md);"></div>
    
    <div class="business-hours" style="background:white; border-radius:24px; padding:25px; margin:20px; box-shadow:var(--shadow-md);">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:20px;"><i class="fas fa-clock" style="color:#667eea;"></i> Business Hours</h3>
      <div class="hours-list" id="businessHours"></div>
    </div>
    
    <div class="business-hours" style="background:white; border-radius:24px; padding:25px; margin:20px; box-shadow:var(--shadow-md);">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:20px;"><i class="fas fa-calendar-times" style="color:#ef4444;"></i> Holidays</h3>
      <div class="hours-list" id="holidaysList"></div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Contact Page -->
  <div id="contactPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="contact-header">
      <h1>Contact Us</h1>
      <p>Get in touch anytime</p>
    </div>
    
    <div class="contact-info" style="background:white; border-radius:24px; padding:20px; margin:25px; box-shadow:var(--shadow-md);">
      <div class="contact-item" onclick="openPhoneInput()" style="display:flex; align-items:center; gap:15px; padding:18px; margin-bottom:15px; background:#f8fafc; border-radius:16px; cursor:pointer;">
        <div class="contact-icon" style="width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:var(--primary-gradient); flex-shrink:0;">
          <i class="fas fa-user-plus"></i>
        </div>
        <div class="contact-details" style="flex:1;">
          <div class="contact-label" style="font-size:11px; color:#64748b; margin-bottom:4px; font-weight:700;">Your Phone Number</div>
          <div class="contact-value" id="customerPhoneDisplay" style="font-size:14px; font-weight:700; color:var(--dark-color);">Tap to add your number</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="makeCall()" style="display:flex; align-items:center; gap:15px; padding:18px; margin-bottom:15px; background:#f8fafc; border-radius:16px; cursor:pointer;">
        <div class="contact-icon" style="width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:var(--success-gradient); flex-shrink:0;">
          <i class="fas fa-phone"></i>
        </div>
        <div class="contact-details" style="flex:1;">
          <div class="contact-label" style="font-size:11px; color:#64748b; margin-bottom:4px; font-weight:700;">Call Us</div>
          <div class="contact-value" id="contactPhone" style="font-size:14px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="openWhatsAppChat('greeting')" style="display:flex; align-items:center; gap:15px; margin-bottom:15px; padding:18px; background:#f8fafc; border-radius:16px; cursor:pointer;">
        <div class="contact-icon" style="width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:#25D366; flex-shrink:0;">
          <i class="fab fa-whatsapp"></i>
        </div>
        <div class="contact-details" style="flex:1;">
          <div class="contact-label" style="font-size:11px; color:#64748b; margin-bottom:4px; font-weight:700;">WhatsApp</div>
          <div class="contact-value" id="contactWhatsApp" style="font-size:14px; font-weight:700; color:var(--dark-color);">Chat Now</div>
        </div>
      </div>
      
      <div class="contact-item email-item" onclick="sendEmail()" style="display:flex; align-items:center; gap:15px; margin-bottom:15px; padding:18px; background:#f8fafc; border-radius:16px; cursor:pointer;">
        <div class="contact-icon" style="width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:var(--secondary-gradient); flex-shrink:0;">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="contact-details" style="flex:1;">
          <div class="contact-label" style="font-size:11px; color:#64748b; margin-bottom:4px; font-weight:700;">Email</div>
          <div class="contact-value" id="contactEmail" style="font-size:14px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="openMap()" style="display:flex; align-items:center; gap:15px; padding:18px; background:#f8fafc; border-radius:16px; cursor:pointer;">
        <div class="contact-icon" style="width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:var(--warning-gradient); flex-shrink:0;">
          <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="contact-details" style="flex:1;">
          <div class="contact-label" style="font-size:11px; color:#64748b; margin-bottom:4px; font-weight:700;">Address</div>
          <div class="contact-value" id="contactAddress" style="font-size:14px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
    </div>
    
    <div class="social-links" style="background:white; border-radius:24px; padding:25px; margin:20px; box-shadow:var(--shadow-md);">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:20px;"><i class="fas fa-share-alt" style="color:#667eea;"></i> Follow Us</h3>
      <div class="social-grid" id="socialGrid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px;"></div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Delivery Status Page -->
  <div id="deliveryPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="delivery-page-header">
      <h1><i class="fas fa-truck"></i> Delivery Status</h1>
      <p>Track your orders in real-time</p>
    </div>
    
    <div id="deliveryContent"></div>
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Admin Page -->
  <div id="adminPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="delivery-page-header">
      <h1><i class="fas fa-cog"></i> Delivery Admin</h1>
      <p>Manage customer deliveries</p>
    </div>
    
    <div id="adminContent"></div>
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Login Page -->
  <div id="loginPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="delivery-page-header">
      <h1><i class="fas fa-lock"></i> Admin Login</h1>
      <p>Enter password to access admin panel</p>
    </div>
    
    <div class="login-page-content" style="padding:40px 25px; text-align:center;">
      <div class="login-title" style="font-size:24px; font-weight:900; color:var(--dark-color); margin-bottom:10px;">Admin Access</div>
      <div class="login-subtitle" style="font-size:14px; color:#64748b; margin-bottom:30px;">Enter the admin password to continue</div>
      
      <input type="password" class="password-input" id="adminPasswordInput" 
             placeholder="Enter password" onkeypress="handleLoginKeypress(event)"
             style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:16px; font-size:16px; margin-bottom:20px; text-align:center; letter-spacing:2px;">
      
      <button onclick="attemptLogin()" class="admin-btn success" style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-size:16px; font-weight:700; cursor:pointer;">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
      
      <div class="password-hint" id="passwordHint" style="font-size:12px; color:#94a3b8; margin-top:20px;">
        Hint: Password format is business123_{short_id}
      </div>
      
      <div id="logoutSection" style="display:none; margin-top:30px;">
        <button onclick="logoutAdmin()" class="logout-btn" style="display:flex; align-items:center; gap:8px; padding:8px 15px; background:rgba(239,68,68,0.9); color:white; border:none; border-radius:20px; font-size:13px; font-weight:700; cursor:pointer; margin:0 auto;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="navigateTo('homePage')">
      <div class="nav-icon"><i class="fas fa-home"></i></div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" onclick="navigateTo('productsPage')">
      <div class="nav-icon"><i class="fas fa-shopping-bag"></i></div>
      <div class="nav-label">Products</div>
    </div>
    <div class="nav-item" onclick="navigateTo('cartPage')">
      <div class="nav-icon"><i class="fas fa-shopping-cart"></i></div>
      <div class="nav-label">Cart</div>
    </div>
    <div class="nav-item" onclick="navigateTo('aboutPage')">
      <div class="nav-icon"><i class="fas fa-info-circle"></i></div>
      <div class="nav-label">About</div>
    </div>
    <div class="nav-item" onclick="navigateTo('contactPage')">
      <div class="nav-icon"><i class="fas fa-phone"></i></div>
      <div class="nav-label">Contact</div>
    </div>
  </div>
</div>

<!-- Notification Alert -->
<div class="notification-alert" id="notificationAlert"></div>

<!-- Delivery Status Modal -->
<div class="delivery-modal-overlay" id="deliveryStatusModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); z-index:20000; padding:20px;">
  <div class="delivery-modal" style="background:white; border-radius:24px; width:100%; max-width:400px; max-height:80vh; overflow-y:auto; position:relative;">
    <button onclick="closeDeliveryModal()" style="position:absolute;top:15px;right:15px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.1);border:none;color:var(--dark-color);font-size:24px;cursor:pointer;">×</button>
    <div id="deliveryStatusContent" style="padding:40px 25px;"></div>
  </div>
</div>

<!-- Product Modal -->
<div class="modal-overlay" id="productModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('productModal')">×</button>
    
    <div style="padding:25px;">
      <!-- Image Container - Zoomable -->
      <div style="position:relative; width:100%; aspect-ratio:1/1; background:#f8fafc; border-radius:16px; margin-bottom:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden;" onclick="zoomImage(document.getElementById('modalImage').src, event)">
        <img src="" id="modalImage" class="product-image" style="width:100%; height:100%; object-fit:contain; padding:16px;">
      </div>
      
      <!-- Product Details -->
      <h2 id="modalTitle" style="font-size:20px; font-weight:800; color:var(--dark-color); margin-bottom:8px;"></h2>
      <p id="modalDescription" style="color:#64748b; line-height:1.6; margin-bottom:16px; font-size:14px;"></p>
      
      <!-- Price Container -->
      <div id="modalPrice" style="margin-bottom:20px; padding-bottom:20px; border-bottom:2px solid #f1f5f9;"></div>
      
      <!-- Action Buttons -->
      <div style="display:flex; gap:12px; margin-bottom:20px;">
        <button onclick="buyNowFromModal()" style="flex:1; padding:16px; border:none; border-radius:12px; font-size:15px; font-weight:800; cursor:pointer; background:var(--primary-gradient); color:white;">
          <i class="fas fa-bolt"></i> Buy Now
        </button>
        <button onclick="addToCartFromModal()" style="flex:1; padding:16px; border:none; border-radius:12px; font-size:15px; font-weight:800; cursor:pointer; background:var(--secondary-gradient); color:white;">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>
      
      <!-- Payment Options (Hidden by Default) -->
      <div id="directCheckoutSection" style="display:none; margin-top:20px; padding-top:20px; border-top:2px solid #f1f5f9;">
        <h3 style="font-size:17px; font-weight:800; color:var(--dark-color); margin-bottom:15px;">Select Payment Method</h3>
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="payment-option" onclick="selectBuyNowPayment('whatsapp')" id="whatsappBuyNowOption" style="padding:15px; border:2px solid #e2e8f0; border-radius:16px; cursor:pointer; display:flex; align-items:center; gap:12px; background:white;">
            <div style="width:45px; height:45px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:#25D366;"><i class="fab fa-whatsapp"></i></div>
            <div><div style="font-weight:800; font-size:14px;">WhatsApp Order</div><div style="font-size:12px; color:#64748b;">Confirm via WhatsApp</div></div>
          </div>
          <div class="payment-option" onclick="selectBuyNowPayment('cod')" id="codBuyNowOption" style="padding:15px; border:2px solid #e2e8f0; border-radius:16px; cursor:pointer; display:flex; align-items:center; gap:12px; background:white;">
            <div style="width:45px; height:45px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:#10b981;"><i class="fas fa-truck"></i></div>
            <div><div style="font-weight:800; font-size:14px;">Cash on Delivery</div><div style="font-size:12px; color:#64748b;">Pay when arrives</div></div>
          </div>
        </div>
        <button onclick="checkoutBuyNow()" style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-size:16px; font-weight:800; cursor:pointer; margin-top:20px;">
          Complete Purchase
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Modal -->
<div class="modal-overlay" id="checkoutModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('checkoutModal')">×</button>
    <div style="padding:25px;">
      <h2 style="font-size:22px; font-weight:800; color:var(--dark-color); margin-bottom:20px;">Checkout</h2>
      <div id="checkoutItems" style="margin-bottom:25px; max-height:250px; overflow-y:auto; padding-right:10px;"></div>
      <div style="margin:20px 0;">
        <h3 style="font-size:17px; font-weight:800; color:var(--dark-color); margin-bottom:15px;">Payment Method</h3>
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="payment-option" onclick="selectCheckoutPayment('whatsapp')" id="whatsappCheckoutOption" style="padding:15px; border:2px solid #e2e8f0; border-radius:16px; cursor:pointer; display:flex; align-items:center; gap:12px; background:white;">
            <div style="width:45px; height:45px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:#25D366;"><i class="fab fa-whatsapp"></i></div>
            <div><div style="font-weight:800; font-size:14px;">WhatsApp Order</div><div style="font-size:12px; color:#64748b;">Confirm via WhatsApp</div></div>
          </div>
          <div class="payment-option" onclick="selectCheckoutPayment('cod')" id="codCheckoutOption" style="padding:15px; border:2px solid #e2e8f0; border-radius:16px; cursor:pointer; display:flex; align-items:center; gap:12px; background:white;">
            <div style="width:45px; height:45px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; background:#10b981;"><i class="fas fa-truck"></i></div>
            <div><div style="font-weight:800; font-size:14px;">Cash on Delivery</div><div style="font-size:12px; color:#64748b;">Pay when arrives</div></div>
          </div>
        </div>
      </div>
      <div style="background:#f8fafc; padding:20px; border-radius:16px; margin:25px 0;">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
          <span style="color:#64748b;">Subtotal</span>
          <span style="font-weight:800; color:var(--dark-color);">PKR <span id="checkoutSubtotal">0</span></span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:15px; padding-top:15px; border-top:2px solid #e2e8f0;">
          <span style="font-size:18px; font-weight:800; color:var(--dark-color);">Total</span>
          <span style="font-size:24px; font-weight:900; color:#10b981;">PKR <span id="checkoutTotal">0</span></span>
        </div>
      </div>
      <button onclick="proceedToPayment()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:16px; font-size:17px; font-weight:800; cursor:pointer;">
        <i class="fas fa-lock"></i> Secure Checkout
      </button>
    </div>
  </div>
</div>

<!-- Payment Details Modal -->
<div class="modal-overlay" id="paymentDetailsModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('paymentDetailsModal')">×</button>
    <div style="padding:25px;">
      <h2 style="font-size:22px; font-weight:800; color:var(--dark-color); margin-bottom:20px;" id="paymentMethodTitle">Payment Details</h2>
      <div id="paymentDetailsContent"></div>
      <button onclick="confirmPayment()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:16px; font-size:17px; font-weight:800; cursor:pointer; margin-top:25px;">
        Confirm Payment
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// ===== SUPABASE CLIENT =====
const supa = supabase.createClient(
  "https://dfvnefbxgayxqgjjgtrr.supabase.co",
  "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ===== MAIN APP VARIABLES =====
let card = {};
let currentProduct = null;
let cart = [];
let buyNowPaymentMethod = 'whatsapp';
let checkoutPaymentMethod = 'whatsapp';
let currentPage = 'loadingScreen';
let deliveryStatusData = [];
let businessAdminPassword = "";
let shortCardId = "";
let isAdminLoggedIn = false;
let currentBusinessId = '';
let orders = [];
let orderTokens = [];
let navigationHistory = [];
let lastBackPress = 0;
let backPressCount = 0;

// ===== FIXED HASH ROUTING SYSTEM - PAGE BACK FIX =====
window.addEventListener('load', function() {
  if (!window.location.hash) {
    window.location.hash = '#home';
  } else {
    handleHashChange();
  }
});

window.addEventListener('hashchange', handleHashChange);

function handleHashChange() {
  const hash = window.location.hash.replace('#', '');
  const pageMap = {
    'home': 'homePage',
    'products': 'productsPage',
    'cart': 'cartPage',
    'about': 'aboutPage',
    'contact': 'contactPage',
    'delivery': 'deliveryPage',
    'admin': 'adminPage',
    'login': 'loginPage'
  };
  
  if (pageMap[hash]) {
    navigateToDirect(pageMap[hash]);
  } else {
    window.location.hash = '#home';
  }
}

function navigateToDirect(pageId) {
  if (currentPage === pageId) return;
  
  const oldPage = document.getElementById(currentPage);
  const newPage = document.getElementById(pageId);
  
  if (oldPage) {
    oldPage.classList.remove('active');
    oldPage.classList.add('slide-out');
  }
  
  setTimeout(() => {
    if (oldPage) oldPage.classList.remove('slide-out');
    newPage.classList.add('active');
    currentPage = pageId;
    
    // Update nav items
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const navMap = { 'homePage': 0, 'productsPage': 1, 'cartPage': 2, 'aboutPage': 3, 'contactPage': 4 };
    if (navMap[pageId] !== undefined) {
      const navItems = document.querySelectorAll('.nav-item');
      if (navItems[navMap[pageId]]) navItems[navMap[pageId]].classList.add('active');
    }
    
    // Load page content
    switch(pageId) {
      case 'homePage': loadHomePage(); break;
      case 'productsPage': loadProductsPage(); break;
      case 'cartPage': loadCartPage(); break;
      case 'aboutPage': loadAboutPage(); break;
      case 'contactPage': loadContactPage(); break;
      case 'deliveryPage': loadDeliveryStatus(); break;
      case 'adminPage': if (isAdminLoggedIn) loadAdminPanel(); else navigateTo('loginPage'); break;
    }
  }, 300);
  
  navigationHistory.push(pageId);
  if (navigationHistory.length > 20) navigationHistory.shift();
}

function navigateTo(pageId) {
  const hashMap = {
    'homePage': 'home',
    'productsPage': 'products',
    'cartPage': 'cart',
    'aboutPage': 'about',
    'contactPage': 'contact',
    'deliveryPage': 'delivery',
    'adminPage': 'admin',
    'loginPage': 'login'
  };
  
  if (hashMap[pageId]) {
    window.location.hash = hashMap[pageId];
  }
}

function goBack() {
  if (navigationHistory.length > 1) {
    navigationHistory.pop();
    const previousPage = navigationHistory[navigationHistory.length - 1];
    const hashMap = {
      'homePage': 'home',
      'productsPage': 'products',
      'cartPage': 'cart',
      'aboutPage': 'about',
      'contactPage': 'contact',
      'deliveryPage': 'delivery',
      'adminPage': 'admin',
      'loginPage': 'login'
    };
    if (hashMap[previousPage]) {
      window.location.hash = hashMap[previousPage];
    } else {
      window.location.hash = 'home';
    }
  } else {
    const now = Date.now();
    if (now - lastBackPress < 2000) {
      document.getElementById('exitModal').style.display = 'flex';
    } else {
      lastBackPress = now;
      showNotification('Press back again to exit');
    }
  }
}

// ===== EXIT MODAL FUNCTIONS =====
function closeExitModal() {
  document.getElementById('exitModal').style.display = 'none';
  backPressCount = 0;
}

function exitApp() {
  if (window.history.length > 1) {
    window.history.go(-1);
  } else {
    window.close();
  }
}

// ===== DATA ISOLATION SYSTEM =====
function getStorageKey(key) {
  const businessKey = currentBusinessId ? currentBusinessId.substring(0, 8) : 'default';
  return `business_${businessKey}_${key}`;
}

const isolatedLocalStorage = {
  setItem: function(key, value) { localStorage.setItem(getStorageKey(key), value); },
  getItem: function(key) { return localStorage.getItem(getStorageKey(key)); },
  removeItem: function(key) { localStorage.removeItem(getStorageKey(key)); }
};

// ===== CUSTOMER PHONE MANAGEMENT =====
function getCustomerPhone() {
  return isolatedLocalStorage.getItem('customerPhone') || '';
}

function saveCustomerPhone(phone) {
  isolatedLocalStorage.setItem('customerPhone', phone);
  document.getElementById('customerPhoneDisplay').textContent = phone || 'Tap to add your number';
  showNotification('✅ Phone number saved!');
}

function updateCustomerPhoneDisplay() {
  const phone = getCustomerPhone();
  document.getElementById('customerPhoneDisplay').textContent = phone || 'Tap to add your number';
}

function openPhoneInput() {
  const currentPhone = getCustomerPhone();
  const phone = prompt("Enter your phone number for delivery:", currentPhone || "");
  if (phone) {
    const cleanedPhone = phone.replace(/\D/g, '');
    if (cleanedPhone.length >= 10) {
      saveCustomerPhone(cleanedPhone);
      if (currentPage === 'deliveryPage') loadDeliveryStatus();
    } else {
      showNotification('❌ Please enter a valid phone number');
    }
  }
}

// ===== SHORT ID SYSTEM =====
function generateShortId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let shortId = '';
  for (let i = 0; i < 6; i++) shortId += chars.charAt(Math.floor(Math.random() * chars.length));
  return shortId;
}

// ===== PASSWORD GENERATOR =====
function generateAdminPassword(cardId, shortId) {
  const shortPart = shortId ? shortId.toLowerCase() : (cardId ? cardId.substring(0, 6).toLowerCase() : 'default');
  return `business123_${shortPart}`;
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message) {
  const notification = document.getElementById('notificationAlert');
  notification.textContent = message;
  notification.style.display = 'block';
  setTimeout(() => { notification.style.display = 'none'; }, 3000);
}

// ===== CART MANAGEMENT =====
function updateCartCount() {
  const count = cart.length;
  document.getElementById('cartCountMini').textContent = count;
  const cartBadge = document.getElementById('cartBadge');
  if (cartBadge) {
    if (count > 0) {
      cartBadge.textContent = count > 99 ? '99+' : count;
      cartBadge.style.display = 'flex';
    } else {
      cartBadge.style.display = 'none';
    }
  }
  isolatedLocalStorage.setItem('cart', JSON.stringify(cart));
  if (currentPage === 'cartPage') loadCartPage();
}

function addToCart(productIndex) {
  const products = card.products || [];
  const product = products[productIndex];
  if (product) {
    const existingIndex = cart.findIndex(item => item.title === product.title && item.discountPrice === product.discountPrice);
    if (existingIndex === -1) {
      cart.push({ ...product, index: productIndex, quantity: 1 });
    } else {
      cart[existingIndex].quantity = (cart[existingIndex].quantity || 1) + 1;
    }
    updateCartCount();
    showNotification('✅ Product added to cart!');
  }
}

function removeFromCart(index) {
  cart.splice(index, 1);
  updateCartCount();
}

function updateQuantity(index, change) {
  if (cart[index]) {
    cart[index].quantity = Math.max(1, (cart[index].quantity || 1) + change);
    loadCartPage();
  }
}

function loadCartPage() {
  const cartContent = document.getElementById('cartContent');
  const cartItemsCount = document.getElementById('cartItemsCount');
  
  if (cart.length === 0) {
    cartContent.innerHTML = '<div style="text-align:center; padding:80px 25px;"><i class="fas fa-shopping-cart" style="font-size:80px; color:#cbd5e1; opacity:0.5;"></i><h3 style="font-size:22px; color:var(--dark-color); margin:20px 0 15px; font-weight:800;">Your cart is empty</h3><p style="color:#64748b; margin-bottom:30px;">Add some products to get started</p><button onclick="navigateTo(\'productsPage\')" style="padding:15px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:16px; font-size:16px; font-weight:700; cursor:pointer;">Browse Products</button></div>';
    cartItemsCount.textContent = '0 items';
    return;
  }
  
  let html = '<div style="display:flex; flex-direction:column; gap:15px; padding:20px;">';
  let total = 0;
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    total += itemTotal;
    
    html += `
      <div style="display:flex; gap:15px; background:white; padding:15px; border-radius:24px; box-shadow:var(--shadow-md);">
        <img src="${item.image || ''}" style="width:80px; height:80px; border-radius:16px; object-fit:contain; background:white; padding:8px;" loading="lazy" onerror="this.style.display='none'">
        <div style="flex:1;">
          <div style="font-weight:700; color:var(--dark-color); margin-bottom:8px;">${item.title || 'Product'}</div>
          <div style="font-weight:800; color:#ef4444; margin-bottom:12px;">PKR ${itemTotal.toFixed(2)}</div>
          <div style="display:flex; align-items:center; gap:12px;">
            <div style="display:flex; align-items:center; gap:10px; background:#f8fafc; padding:6px; border-radius:12px;">
              <button onclick="updateQuantity(${index}, -1)" style="width:28px; height:28px; border:2px solid #e2e8f0; background:white; border-radius:8px; font-size:18px; cursor:pointer;">-</button>
              <span style="font-weight:800; min-width:25px; text-align:center;">${item.quantity || 1}</span>
              <button onclick="updateQuantity(${index}, 1)" style="width:28px; height:28px; border:2px solid #e2e8f0; background:white; border-radius:8px; font-size:18px; cursor:pointer;">+</button>
            </div>
            <button onclick="removeFromCart(${index})" style="background:var(--danger-gradient); color:white; border:none; border-radius:8px; padding:6px 12px; font-size:11px; font-weight:700; cursor:pointer;">Remove</button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div><div style="background:white; border-radius:24px; padding:25px; margin:25px; box-shadow:var(--shadow-md);"><h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #f1f5f9;"><i class="fas fa-receipt"></i> Order Summary</h3><div style="display:flex; justify-content:space-between; margin-bottom:12px;"><span style="color:#475569;">Subtotal</span><span style="font-weight:800; color:var(--dark-color);">PKR ${total.toFixed(2)}</span></div><div style="display:flex; justify-content:space-between; margin-bottom:12px;"><span style="color:#475569;">Shipping</span><span style="color:#475569;">PKR 0</span></div><div style="display:flex; justify-content:space-between; margin-top:15px; padding-top:15px; border-top:2px solid #f1f5f9;"><span style="font-size:22px; font-weight:900; color:var(--dark-color);">Total</span><span style="font-size:22px; font-weight:900; color:#10b981;">PKR ${total.toFixed(2)}</span></div><button onclick="openCheckoutModal()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:16px; font-size:17px; font-weight:800; cursor:pointer; margin-top:25px;"><i class="fas fa-lock"></i> Proceed to Checkout</button></div>';
  
  cartContent.innerHTML = html;
  cartItemsCount.textContent = `${cart.length} ${cart.length === 1 ? 'item' : 'items'}`;
}

// ===== MODAL FUNCTIONS =====
function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  document.body.style.overflow = 'auto';
}

// ===== IMAGE ZOOM =====
function zoomImage(imageUrl, event) {
  if (event) event.stopPropagation();
  if (imageUrl && imageUrl.trim()) {
    document.getElementById('zoomedImage').src = imageUrl;
    document.getElementById('imageZoomOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeImageZoom() {
  document.getElementById('imageZoomOverlay').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// ===== FIXED: MODERN PRODUCT CARD WITH HALF BAHAR LABELS =====
function createProductCard(product, index) {
  const price = product.discountPrice || product.originalPrice;
  const originalPrice = product.originalPrice && product.discountPrice ? product.originalPrice : null;
  const hasDiscount = originalPrice && price && originalPrice > price;
  
  let discountPercentage = '';
  if (hasDiscount && originalPrice && price) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    discountPercentage = `<span class="discount-badge"><i class="fas fa-tag"></i> -${discount}%</span>`;
  }
  
  let offerBadge = '';
  if (product.offerTag) {
    offerBadge = `<span class="offer-badge"><i class="fas fa-gift"></i> ${product.offerTag}</span>`;
  }
  
  let featureBadges = '';
  if (product.badges && product.badges.length > 0) {
    featureBadges = product.badges.slice(0, 1).map(badge => 
      `<span class="feature-badge">${badge}</span>`
    ).join('');
  }
  
  // PRICE BADGE - BOTTOM LEFT
  let priceHtml = '';
  if (price) {
    if (hasDiscount && originalPrice) {
      priceHtml = `<span class="price-badge"><span class="original-price">PKR ${originalPrice}</span><span class="current-price">PKR ${price}</span></span>`;
    } else {
      priceHtml = `<span class="price-badge"><span class="current-price">PKR ${price}</span></span>`;
    }
  }
  
  // PERCENTAGE BADGE - BOTTOM RIGHT (agar product mein discount % nahi hai to show offer)
  let bottomRightBadge = '';
  if (hasDiscount && originalPrice && price) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    bottomRightBadge = `<span class="percentage-badge"><i class="fas fa-bolt"></i> ${discount}% OFF</span>`;
  } else if (product.badges && product.badges.length > 0) {
    bottomRightBadge = `<span class="percentage-badge"><i class="fas fa-star"></i> ${product.badges[0]}</span>`;
  }
  
  const cardElement = document.createElement('div');
  cardElement.className = 'product-card';
  
  cardElement.innerHTML = `
    <div class="product-image-container" onclick="zoomImage('${product.image || ''}', event)">
      <img src="${product.image || ''}" class="product-image" loading="lazy" onerror="this.style.display='none'">
      ${discountPercentage}
      ${offerBadge || featureBadges}
      ${priceHtml}
      ${bottomRightBadge}
    </div>
    <div class="product-content">
      <div class="product-title">${product.title || 'Product'}</div>
      <div class="product-actions">
        <button class="btn-primary" onclick="showProductModal(${index}); event.stopPropagation();">
          <i class="fas fa-bolt"></i> Buy
        </button>
        <button class="btn-secondary" onclick="addToCart(${index}); event.stopPropagation();">
          <i class="fas fa-cart-plus"></i> Add
        </button>
      </div>
    </div>
  `;
  
  cardElement.onclick = (e) => {
    if (!e.target.closest('button') && !e.target.closest('.product-image-container')) {
      showProductModal(index);
    }
  };
  
  return cardElement;
}

function showProductModal(productIndex) {
  const products = card.products || [];
  currentProduct = products[productIndex];
  if (!currentProduct) return;
  
  const price = currentProduct.discountPrice || currentProduct.originalPrice;
  const originalPrice = currentProduct.originalPrice && currentProduct.discountPrice ? currentProduct.originalPrice : null;
  const hasDiscount = originalPrice && price && originalPrice > price;
  
  document.getElementById('modalImage').src = currentProduct.image || '';
  document.getElementById('modalTitle').textContent = currentProduct.title || 'Product';
  document.getElementById('modalDescription').textContent = currentProduct.desc || 'No description available';
  
  const modalPrice = document.getElementById('modalPrice');
  if (hasDiscount && originalPrice && price) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    modalPrice.innerHTML = `
      <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <div style="text-decoration:line-through; color:#94a3b8; font-size:16px; font-weight:500;">PKR ${originalPrice}</div>
        <div style="color:#10b981; font-size:28px; font-weight:900;">PKR ${price}</div>
        <div style="background:var(--danger-gradient); color:white; padding:6px 12px; border-radius:30px; font-size:13px; font-weight:800;">${discount}% OFF</div>
      </div>
    `;
  } else {
    modalPrice.innerHTML = `<div style="color:#10b981; font-size:28px; font-weight:900;">PKR ${price || 'N/A'}</div>`;
  }
  
  document.getElementById('directCheckoutSection').style.display = 'none';
  selectBuyNowPayment('whatsapp');
  
  openModal('productModal');
}

function addToCartFromModal() {
  if (currentProduct) {
    const products = card.products || [];
    const productIndex = products.findIndex(p => p.title === currentProduct.title);
    if (productIndex !== -1) {
      addToCart(productIndex);
      closeModal('productModal');
    }
  }
}

function buyNowFromModal() {
  document.getElementById('directCheckoutSection').style.display = 'block';
}

function selectBuyNowPayment(method) {
  buyNowPaymentMethod = method;
  ['whatsappBuyNowOption', 'codBuyNowOption'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.borderColor = '#e2e8f0';
  });
  const selected = document.getElementById(method === 'whatsapp' ? 'whatsappBuyNowOption' : 'codBuyNowOption');
  if (selected) selected.style.borderColor = method === 'whatsapp' ? '#25D366' : '#10b981';
}

function checkoutBuyNow() {
  if (!currentProduct) return;
  const price = currentProduct.discountPrice || currentProduct.originalPrice || 0;
  const businessName = card.businessName || card.name || "Your Business";
  let message = `Hello ${businessName} Team,\n\nI would like to place an order:\n\n🛒 *${currentProduct.title || 'Product'}*\n💰 PKR ${price}\n\n💳 Payment: ${buyNowPaymentMethod === 'whatsapp' ? 'WhatsApp Order' : 'Cash on Delivery'}\n\nPlease confirm availability. Thank you!`;
  if (card.phone) window.open(`https://wa.me/${card.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`, '_blank');
  closeModal('productModal');
  showNotification('✅ Order request sent!');
}

// ===== CHECKOUT FUNCTIONS =====
function openCheckoutModal() {
  if (cart.length === 0) { showNotification('Your cart is empty'); return; }
  const checkoutItems = document.getElementById('checkoutItems');
  let subtotal = 0;
  checkoutItems.innerHTML = '';
  cart.forEach(item => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    subtotal += itemTotal;
    checkoutItems.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding:12px; background:#f8fafc; border-radius:12px;"><div><div style="font-weight:800; margin-bottom:4px;">${item.title || 'Product'}</div><div style="font-size:12px; color:#64748b;">Qty: ${item.quantity || 1}</div></div><div style="font-weight:800;">PKR ${itemTotal.toFixed(2)}</div></div>`;
  });
  document.getElementById('checkoutSubtotal').textContent = subtotal.toFixed(2);
  document.getElementById('checkoutTotal').textContent = subtotal.toFixed(2);
  selectCheckoutPayment('whatsapp');
  openModal('checkoutModal');
}

function selectCheckoutPayment(method) {
  checkoutPaymentMethod = method;
  ['whatsappCheckoutOption', 'codCheckoutOption'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.borderColor = '#e2e8f0';
  });
  const selected = document.getElementById(method === 'whatsapp' ? 'whatsappCheckoutOption' : 'codCheckoutOption');
  if (selected) selected.style.borderColor = method === 'whatsapp' ? '#25D366' : '#10b981';
}

function proceedToPayment() {
  if (cart.length === 0) return;
  const total = cart.reduce((sum, item) => sum + (parseFloat(item.discountPrice || item.originalPrice || 0) * (item.quantity || 1)), 0);
  const businessName = card.businessName || card.name || "Your Business";
  let message = `Hello ${businessName} Team,\n\nI would like to place an order:\n\n`;
  cart.forEach((item, i) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    message += `${i+1}. ${item.title || 'Product'} - Qty: ${item.quantity || 1} - PKR ${(price * (item.quantity || 1)).toFixed(2)}\n`;
  });
  message += `\n💰 Total: PKR ${total.toFixed(2)}\n💳 Payment: ${checkoutPaymentMethod === 'whatsapp' ? 'WhatsApp Order' : 'Cash on Delivery'}\n\nPlease confirm availability. Thank you!`;
  if (card.phone) window.open(`https://wa.me/${card.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`, '_blank');
  cart = [];
  updateCartCount();
  closeModal('checkoutModal');
  navigateTo('homePage');
  showNotification('✅ Order sent!');
}

function confirmPayment() {
  if (currentPage.includes('checkout')) proceedToPayment();
  else checkoutBuyNow();
  closeModal('paymentDetailsModal');
}

// ===== LOAD PAGES =====
function loadHomePage() {
  const featuredProducts = document.getElementById('featuredProducts');
  const products = card.products || [];
  featuredProducts.innerHTML = '';
  products.slice(0, 4).forEach((product, index) => featuredProducts.appendChild(createProductCard(product, index)));
}

function loadProductsPage() {
  const allProducts = document.getElementById('allProducts');
  const products = card.products || [];
  allProducts.innerHTML = '';
  products.forEach((product, index) => allProducts.appendChild(createProductCard(product, index)));
}

function filterProducts() {
  const searchTerm = document.getElementById('productsSearch').value.toLowerCase();
  const products = card.products || [];
  const allProducts = document.getElementById('allProducts');
  allProducts.innerHTML = '';
  products.filter(p => p.title?.toLowerCase().includes(searchTerm) || p.desc?.toLowerCase().includes(searchTerm)).forEach((p, i) => allProducts.appendChild(createProductCard(p, i)));
}

function loadAboutPage() {
  document.getElementById('aboutContent').innerHTML = `<p style="line-height:1.8; color:#475569;">${card.business?.about || 'No information available'}</p>`;
  if (card.businessHours) {
    const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
    const businessHours = document.getElementById('businessHours');
    businessHours.innerHTML = '';
    card.businessHours.forEach((day, i) => {
      if (day) {
        const item = document.createElement('div');
        item.style = "display:flex; justify-content:space-between; padding:15px; background:#f8fafc; border-radius:16px; margin-bottom:12px;";
        if (!day.open || day.status === 'closed') item.innerHTML = `<span style="font-weight:600; color:#475569;">${days[i]}</span><span style="color:#ef4444; font-weight:600; background:rgba(239,68,68,0.1); padding:5px 12px; border-radius:20px;">Closed</span>`;
        else item.innerHTML = `<span style="font-weight:600; color:#475569;">${days[i]}</span><span style="font-weight:600; color:#10b981; background:rgba(16,185,129,0.1); padding:5px 12px; border-radius:20px;">${day.start || ''} - ${day.end || ''}</span>`;
        businessHours.appendChild(item);
      }
    });
  }
}

function loadContactPage() {
  document.getElementById('contactPhone').textContent = card.phone || 'Not available';
  document.getElementById('contactEmail').textContent = card.email || 'Not available';
  document.getElementById('contactAddress').textContent = card.address || 'Not available';
  updateCustomerPhoneDisplay();
  
  const socialGrid = document.getElementById('socialGrid');
  const socialMedia = card.socialMedia || {};
  socialGrid.innerHTML = '';
  const platforms = [
    { key: 'facebook', icon: 'fab fa-facebook-f', label: 'Facebook', bg: '#1877F2' },
    { key: 'instagram', icon: 'fab fa-instagram', label: 'Instagram', bg: '#E4405F' },
    { key: 'twitter', icon: 'fab fa-twitter', label: 'Twitter', bg: '#1DA1F2' },
    { key: 'linkedin', icon: 'fab fa-linkedin-in', label: 'LinkedIn', bg: '#0A66C2' },
    { key: 'youtube', icon: 'fab fa-youtube', label: 'YouTube', bg: '#FF0000' }
  ];
  platforms.forEach(p => {
    const url = socialMedia[p.key];
    if (url && url.trim()) {
      const link = document.createElement('a');
      link.href = url.includes('://') ? url : `https://${url}`;
      link.target = '_blank';
      link.style = "text-decoration:none; color:inherit;";
      link.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; gap:12px; padding:20px; background:#f8fafc; border-radius:16px;"><div style="width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; color:white; background:${p.bg}"><i class="${p.icon}"></i></div><div style="font-size:11px; font-weight:900; color:var(--dark-color);">${p.label}</div></div>`;
      socialGrid.appendChild(link);
    }
  });
}

// ===== DELIVERY FUNCTIONS =====
async function checkForDeliveries() {
  const phone = getCustomerPhone();
  if (!phone) return;
  try {
    const { data, error } = await supa.from('delivery_status').select('*').eq('customer_phone', phone).order('last_updated', { ascending: false });
    if (!error && data) deliveryStatusData = data;
  } catch (e) { console.error(e); }
}

function checkDeliveryStatus() {
  if (!getCustomerPhone()) { openPhoneInput(); showNotification('Please add your phone number to track orders'); return; }
  navigateTo('deliveryPage');
}

async function loadDeliveryStatus() {
  const phone = getCustomerPhone();
  if (!phone) {
    document.getElementById('deliveryContent').innerHTML = '<div style="text-align:center; padding:60px 20px;"><i class="fas fa-phone" style="font-size:60px; color:#cbd5e1;"></i><h3 style="font-size:20px; color:var(--dark-color); margin:20px 0 15px; font-weight:800;">Phone Number Needed</h3><p style="color:#64748b; margin-bottom:30px;">Please save your phone number to track deliveries.</p><button onclick="openPhoneInput()" style="padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">Add Phone Number</button></div>';
    return;
  }
  const { data, error } = await supa.from('delivery_status').select('*').eq('customer_phone', phone).order('last_updated', { ascending: false });
  if (error || !data || data.length === 0) {
    document.getElementById('deliveryContent').innerHTML = '<div style="text-align:center; padding:60px 20px;"><i class="fas fa-truck" style="font-size:60px; color:#10b981;"></i><h3 style="font-size:20px; color:var(--dark-color); margin:20px 0 15px; font-weight:800;">No Active Deliveries</h3><p style="color:#64748b; margin-bottom:30px;">Your delivery status will appear here once you place an order.</p><button onclick="navigateTo(\'productsPage\')" style="padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;"><i class="fas fa-shopping-bag"></i> Shop Now</button></div>';
    return;
  }
  let html = '';
  data.forEach(order => {
    const statusClass = order.status;
    const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
    const updatedTime = new Date(order.last_updated).toLocaleString();
    html += `<div class="delivery-card" style="border-left:5px solid ${order.status === 'delivered' ? '#10b981' : order.status === 'cancelled' ? '#ef4444' : '#667eea'}; background:white; border-radius:24px; padding:20px; margin:15px; box-shadow:var(--shadow-md);"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><span style="font-size:16px; font-weight:800; color:var(--dark-color);">Order #${order.order_id}</span><span style="padding:6px 12px; border-radius:20px; font-size:12px; font-weight:700; background:${order.status === 'pending' ? '#fef3c7' : order.status === 'processing' ? '#dbeafe' : order.status === 'shipped' ? '#ede9fe' : order.status === 'delivered' ? '#d1fae5' : '#fee2e2'}; color:${order.status === 'pending' ? '#92400e' : order.status === 'processing' ? '#1e40af' : order.status === 'shipped' ? '#5b21b6' : order.status === 'delivered' ? '#065f46' : '#991b1b'};">${statusText}</span></div><div style="color:#475569; font-size:14px; margin:8px 0;"><i class="fas fa-user"></i> ${order.customer_name || 'Customer'}</div>${order.location ? `<div style="color:#475569; font-size:14px; margin:8px 0;"><i class="fas fa-map-marker-alt"></i> ${order.location}</div>` : ''}${order.delivery_person ? `<div style="color:#475569; font-size:14px; margin:8px 0;"><i class="fas fa-user-tag"></i> ${order.delivery_person}</div>` : ''}<div style="font-size:12px; color:#94a3b8; margin-top:15px;"><i class="fas fa-clock"></i> Updated: ${updatedTime}</div></div>`;
  });
  document.getElementById('deliveryContent').innerHTML = html;
}

function closeDeliveryModal() {
  document.getElementById('deliveryStatusModal').style.display = 'none';
}

// ===== LOGIN SYSTEM =====
function toggleLogin() {
  if (isAdminLoggedIn) { if (confirm("Logout?")) logoutAdmin(); }
  else navigateTo('loginPage');
}

function updateLoginUI() {
  const icon = document.getElementById('loginIcon');
  if (isAdminLoggedIn) { icon.className = 'fas fa-sign-out-alt'; document.getElementById('loginBtn').title = 'Logout'; }
  else { icon.className = 'fas fa-sign-in-alt'; document.getElementById('loginBtn').title = 'Login'; }
}

function attemptLogin() {
  if (document.getElementById('adminPasswordInput').value === businessAdminPassword) {
    isAdminLoggedIn = true;
    isolatedLocalStorage.setItem('isAdminLoggedIn', 'true');
    updateLoginUI();
    showNotification('✅ Login successful!');
    navigateTo('adminPage');
  } else {
    showNotification('❌ Incorrect password');
    document.getElementById('adminPasswordInput').value = '';
  }
}

function handleLoginKeypress(e) { if (e.key === 'Enter') attemptLogin(); }
function logoutAdmin() { isAdminLoggedIn = false; isolatedLocalStorage.removeItem('isAdminLoggedIn'); updateLoginUI(); showNotification('👋 Logged out'); navigateTo('homePage'); }

// ===== ADMIN FUNCTIONS =====
async function loadAdminPanel() {
  const { data, error } = await supa.from('delivery_status').select('*').order('last_updated', { ascending: false });
  if (error) { document.getElementById('adminContent').innerHTML = '<p style="padding:20px;color:#ef4444;">Error</p>'; return; }
  let html = '<div style="padding:15px; display:flex; justify-content:flex-end;"><button onclick="logoutAdmin()" class="logout-btn" style="display:flex; align-items:center; gap:8px; padding:8px 15px; background:rgba(239,68,68,0.9); color:white; border:none; border-radius:20px; font-size:13px; font-weight:700; cursor:pointer;"><i class="fas fa-sign-out-alt"></i> Logout</button></div><input type="text" id="adminSearch" placeholder="Search orders..." onkeyup="searchAdminOrders()" style="width:calc(100% - 30px); margin:15px; padding:12px; border:2px solid #e2e8f0; border-radius:8px;"><button onclick="addNewOrder()" style="width:calc(100% - 30px); margin:15px; padding:12px; background:var(--primary-gradient); color:white; border:none; border-radius:8px; font-weight:700;"><i class="fas fa-plus"></i> Add Order</button>';
  if (!data || data.length === 0) html += '<p style="text-align:center; padding:40px;">No orders</p>';
  else data.forEach(order => {
    html += `<div class="admin-order-card" data-order-id="${order.order_id}" data-phone="${order.customer_phone}" style="background:white; border-radius:24px; padding:20px; margin:15px; box-shadow:var(--shadow-md);"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><div><div style="font-size:15px; font-weight:800;">Order #${order.order_id}</div><div style="color:#64748b; font-size:13px;">${order.customer_name || ''} ${order.customer_phone}</div></div><div style="font-size:12px; color:#94a3b8;">${new Date(order.last_updated).toLocaleString()}</div></div><select class="admin-select" data-id="${order.id}" style="width:100%; padding:10px; border:2px solid #e2e8f0; border-radius:8px; margin-bottom:10px;"><option value="pending" ${order.status==='pending'?'selected':''}>⏳ Pending</option><option value="processing" ${order.status==='processing'?'selected':''}>🔄 Processing</option><option value="shipped" ${order.status==='shipped'?'selected':''}>🚚 Shipped</option><option value="delivered" ${order.status==='delivered'?'selected':''}>✅ Delivered</option><option value="cancelled" ${order.status==='cancelled'?'selected':''}>❌ Cancelled</option></select><input type="text" class="admin-input" data-id="${order.id}" placeholder="Location" value="${order.location||''}" style="width:100%; padding:10px; border:2px solid #e2e8f0; border-radius:8px; margin-bottom:10px;"><input type="text" class="admin-input" data-id="${order.id}" placeholder="Delivery Person" value="${order.delivery_person||''}" style="width:100%; padding:10px; border:2px solid #e2e8f0; border-radius:8px; margin-bottom:10px;"><button onclick="updateOrder('${order.id}')" style="width:100%; padding:12px; background:var(--success-gradient); color:white; border:none; border-radius:8px; font-weight:700;">Update Order</button></div>`;
  });
  document.getElementById('adminContent').innerHTML = html;
}

function searchAdminOrders() {
  const term = document.getElementById('adminSearch').value.toLowerCase();
  document.querySelectorAll('.admin-order-card').forEach(c => {
    c.style.display = c.textContent.toLowerCase().includes(term) ? 'block' : 'none';
  });
}

async function updateOrder(id) {
  const status = document.querySelector(`.admin-select[data-id="${id}"]`).value;
  const location = document.querySelector(`.admin-input[data-id="${id}"]`).value;
  const person = document.querySelectorAll(`.admin-input[data-id="${id}"]`)[1]?.value;
  const { error } = await supa.from('delivery_status').update({ status, location, delivery_person: person, last_updated: new Date().toISOString() }).eq('id', id);
  if (!error) { showNotification('✅ Updated'); loadAdminPanel(); if(currentPage==='deliveryPage') loadDeliveryStatus(); }
  else showNotification('❌ Error');
}

function addNewOrder() {
  const id = prompt("Order ID:"), phone = prompt("Phone:"), name = prompt("Name (optional):");
  if (!id || !phone) { showNotification('❌ Required'); return; }
  supa.from('delivery_status').insert([{ order_id: id, customer_phone: phone, customer_name: name||'', status: 'pending', last_updated: new Date().toISOString() }]).then(({error}) => {
    if (!error) { showNotification('✅ Added'); loadAdminPanel(); } else showNotification('❌ Error');
  });
}

// ===== SHARE BUSINESS =====
function shareBusiness() {
  const name = card.businessName || card.name || "Business";
  const url = window.location.href.split('?')[0] + (shortCardId ? `?id=${shortCardId}` : '');
  if (navigator.share) navigator.share({ title: name, text: `Check out ${name}!`, url }).catch(() => fallbackShare(url));
  else fallbackShare(url);
}
function fallbackShare(url) { navigator.clipboard.writeText(url); showNotification('📋 Link copied!'); }

// ===== WHATSAPP & CONTACT ACTIONS =====
function openWhatsAppChat() { if (card.phone) window.open(`https://wa.me/${card.phone.replace(/\D/g, '')}?text=Hello%20${encodeURIComponent(card.businessName||'')}`, '_blank'); }
function makeCall() { if (card.phone) window.open(`tel:${card.phone}`); }
function sendEmail() { if (card.email) window.open(`mailto:${card.email}?subject=Inquiry`); }
function openMap() { if (card.address) window.open(`https://maps.google.com/?q=${encodeURIComponent(card.address)}`, '_blank'); }

// ===== PWA SETUP =====
function setupDynamicPWA(businessData) {
  const name = businessData.businessName || businessData.name || "Business";
  document.title = name + " App";
  document.getElementById('loadingTitle').textContent = name + " App";
  document.getElementById('loadingSubtitle').textContent = `Loading ${name} experience...`;
}

// ===== INITIALIZATION =====
document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(location.search);
  let id = urlParams.get("id") || localStorage.getItem("lastCardId");
  
  if (id && id.length === 6) {
    const { data: mapping } = await supa.from('short_urls').select('full_id').eq('short_id', id).single();
    if (mapping) { id = mapping.full_id; shortCardId = mapping.short_id; }
  } else if (id && id.length === 36) {
    const shortId = generateShortId();
    await supa.from('short_urls').insert([{ short_id: shortId, full_id: id }]).then(() => shortCardId = shortId);
  }
  
  if (!id) { document.body.innerHTML = "<div style='padding:40px; text-align:center; color:white;'><h2>Card not found</h2></div>"; return; }
  
  localStorage.setItem("lastCardId", id);
  currentBusinessId = id;
  
  const savedCart = isolatedLocalStorage.getItem('cart');
  cart = savedCart ? JSON.parse(savedCart) : [];
  isAdminLoggedIn = isolatedLocalStorage.getItem('isAdminLoggedIn') === 'true';
  
  setTimeout(async () => {
    const { data, error } = await supa.from("cards").select("*").eq("id", id).single();
    if (error || !data) { document.body.innerHTML = "<div style='padding:40px; text-align:center; color:white;'><h2>Card not found</h2></div>"; return; }
    
    card = JSON.parse(data.data);
    card.id = data.id;
    
    businessAdminPassword = generateAdminPassword(card.id, shortCardId);
    document.getElementById('passwordHint').textContent = shortCardId ? `Hint: Password is business123_${shortCardId.toLowerCase()}` : `Hint: Password format is business123_{short_id}`;
    
    setupDynamicPWA(card);
    document.getElementById('businessHeader').textContent = card.businessName || card.name || "Premium Business";
    if (card.profileImage) document.getElementById('photo').src = card.profileImage;
    document.getElementById('name').textContent = card.name || "";
    document.getElementById('business').textContent = card.businessName || "";
    
    loadHomePage();
    updateCartCount();
    updateLoginUI();
    updateCustomerPhoneDisplay();
    
    navigationHistory.push('homePage');
    if (!window.location.hash) window.location.hash = '#home';
    else handleHashChange();
    
    setTimeout(() => checkForDeliveries(), 1000);
  }, 2000);
});

setInterval(checkForDeliveries, 30000);
</script>
</body>
</html>
