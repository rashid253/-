<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Digital Business App - Complete</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a" id="themeColorMeta">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Complete Digital Business App with Delivery & Ticketing">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap">
<link rel="manifest" href="manifest.json">

<style>
/* ALL CSS FROM ORIGINAL FILE REMAINS EXACTLY THE SAME - KEPT FOR SPACE */
/* Plus new styles for address confirmation, delivery calculator, and ticket system */

:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
  --whatsapp-gradient: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --dark-color: #0f172a;
  --darker-color: #020617;
  --light-color: #f8fafc;
  --lighter-color: #ffffff;
  --glass-bg: rgba(255, 255, 255, 0.98);
  --glass-border: rgba(255, 255, 255, 0.2);
  --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  --shadow-lg: 0 20px 60px rgba(0,0,0,0.15);
  --shadow-md: 0 10px 30px rgba(0,0,0,0.1);
  --shadow-sm: 0 4px 15px rgba(0,0,0,0.08);
  --border-radius-xl: 32px;
  --border-radius-lg: 24px;
  --border-radius-md: 16px;
  --border-radius-sm: 12px;
  --border-radius-xs: 8px;
  --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* NEW: Address Confirmation Modal */
.address-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(15px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  padding: 20px;
}

.address-modal {
  background: var(--glass-bg);
  border-radius: 24px;
  width: 100%;
  max-width: 420px;
  max-height: 80vh;
  overflow-y: auto;
  padding: 25px;
  border: 1px solid var(--glass-border);
}

/* NEW: Delivery Calculator */
.delivery-calculator {
  background: #f8fafc;
  border-radius: 16px;
  padding: 20px;
  margin: 15px 0;
  border: 1px solid #e2e8f0;
}

.delivery-option {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: var(--transition-fast);
}

.delivery-option.selected {
  border-color: #10b981;
  background: #f0fdf4;
}

.delivery-option-left {
  display: flex;
  align-items: center;
  gap: 15px;
}

.delivery-option-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: white;
}

.delivery-option-info h4 {
  font-size: 16px;
  font-weight: 800;
  color: var(--dark-color);
  margin-bottom: 4px;
}

.delivery-option-info p {
  font-size: 12px;
  color: #64748b;
}

.delivery-option-price {
  font-weight: 900;
  color: #10b981;
  font-size: 18px;
}

/* NEW: Saved Addresses */
.saved-address {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.saved-address-info {
  flex: 1;
}

.saved-address-label {
  font-weight: 700;
  color: var(--dark-color);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.saved-address-text {
  font-size: 13px;
  color: #475569;
}

/* NEW: Ticket/Order Confirmation */
.ticket-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px;
  padding: 20px;
  margin: 20px 0;
  color: white;
  position: relative;
  overflow: hidden;
}

.ticket-card::before {
  content: 'üé´';
  position: absolute;
  right: 20px;
  bottom: 20px;
  font-size: 60px;
  opacity: 0.2;
}

.ticket-id {
  font-size: 20px;
  font-weight: 900;
  margin-bottom: 10px;
  letter-spacing: 1px;
}

.ticket-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 15px;
}

.ticket-detail-item {
  background: rgba(255,255,255,0.2);
  padding: 10px;
  border-radius: 10px;
  backdrop-filter: blur(10px);
}

.ticket-detail-label {
  font-size: 11px;
  opacity: 0.9;
  margin-bottom: 4px;
}

.ticket-detail-value {
  font-size: 14px;
  font-weight: 800;
}

/* NEW: Payment Gateway Cards */
.payment-gateway-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  cursor: pointer;
  transition: var(--transition-fast);
}

.payment-gateway-card.selected {
  border-color: #10b981;
  background: #f0fdf4;
}

.payment-gateway-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  flex-shrink: 0;
}

.payment-gateway-info {
  flex: 1;
}

.payment-gateway-name {
  font-size: 16px;
  font-weight: 800;
  color: var(--dark-color);
  margin-bottom: 4px;
}

.payment-gateway-desc {
  font-size: 12px;
  color: #64748b;
}

/* Keep all existing CSS from original file here */
/* ... (all original CSS) ... */

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Poppins', sans-serif;
  background: var(--primary-gradient);
  min-height: 100vh;
  color: var(--dark-color);
  position: fixed;
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: none;
}

.app-container {
  position: relative;
  width: 100%;
  height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  background: var(--light-color);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
  border-radius: 0;
}

.page {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 0;
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--light-color);
  transform: translateX(100%);
  opacity: 0;
  visibility: hidden;
  transition: var(--transition-slow);
  z-index: 1;
}

.page.active {
  transform: translateX(0);
  opacity: 1;
  visibility: visible;
  z-index: 2;
}

.page.slide-out {
  transform: translateX(-100%);
  opacity: 0;
  visibility: hidden;
}

/* Rest of the CSS from original file */
/* ... (keeping all existing styles) ... */

</style>
</head>

<body>
<div class="app-container">
  <!-- Fixed Header -->
  <div class="header-container">
    <div class="header-icons">
      <div class="header-icon-btn" onclick="toggleNotificationDrawer()" title="Notifications">
        <i class="fas fa-bell" id="notificationBell"></i>
        <div class="delivery-badge" id="notificationBadge" style="display:none;">!</div>
      </div>
      
      <div class="header-icon-btn" id="deliveryStatusBtn" onclick="checkDeliveryStatus()" title="Delivery Status">
        <i class="fas fa-truck" id="deliveryIcon"></i>
        <div class="delivery-badge" id="deliveryBadge" style="display:none;"></div>
      </div>
      
      <div class="header-icon-btn" id="loginBtn" onclick="toggleLogin()" title="Login/Logout">
        <i class="fas fa-sign-in-alt" id="loginIcon"></i>
      </div>
    </div>
    
    <div class="share-btn" onclick="shareBusiness()" title="Share Business">
      <i class="fas fa-share-alt"></i>
    </div>
  </div>

  <!-- Notification Drawer -->
  <div class="notification-drawer" id="notificationDrawer">
    <div class="notification-header">
      <h3><i class="fas fa-bell"></i> Notifications <span class="notification-count" id="notificationCount">0</span></h3>
      <button onclick="toggleNotificationDrawer()" style="background: none; border: none; font-size: 24px; color: var(--dark-color); cursor: pointer;">√ó</button>
    </div>
    <div class="notification-content" id="notificationList"></div>
    <div class="notification-actions">
      <button onclick="markAllNotificationsAsRead()" style="flex:1; padding: 10px; background: #f1f5f9; border: none; border-radius: 8px; font-weight: 700; color: #64748b; cursor: pointer;">Mark All Read</button>
      <button onclick="enableNotifications()" style="flex:1; padding: 10px; background: var(--primary-gradient); border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer;">Enable Alerts</button>
    </div>
  </div>

  <!-- Image Zoom Overlay -->
  <div class="image-zoom-overlay" id="imageZoomOverlay" onclick="closeImageZoom()">
    <img src="" class="image-zoom-content" id="zoomedImage">
  </div>

  <!-- Exit Confirmation Modal -->
  <div class="exit-modal-overlay" id="exitModal">
    <div class="exit-modal">
      <h2><i class="fas fa-sign-out-alt"></i> Exit App?</h2>
      <p>Are you sure you want to exit? Press back again to confirm.</p>
      <div class="exit-modal-buttons">
        <button class="exit-modal-btn cancel" onclick="closeExitModal()"><i class="fas fa-times"></i> Cancel</button>
        <button class="exit-modal-btn exit" onclick="exitApp()"><i class="fas fa-sign-out-alt"></i> Exit</button>
      </div>
    </div>
  </div>

  <!-- ===== NEW: ADDRESS CONFIRMATION MODAL ===== -->
  <div class="address-modal-overlay" id="addressConfirmationModal">
    <div class="address-modal">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="font-size:20px; font-weight:800; color:var(--dark-color);">
          <i class="fas fa-map-marker-alt" style="color:#10b981;"></i> Confirm Address
        </h3>
        <button onclick="closeAddressModal()" style="background:none; border:none; font-size:24px; color:var(--dark-color); cursor:pointer;">√ó</button>
      </div>
      
      <div id="savedAddressesList" style="margin-bottom:20px;"></div>
      
      <div style="margin-bottom:20px;">
        <label style="font-weight:700; color:var(--dark-color); margin-bottom:8px; display:block;">Full Delivery Address</label>
        <textarea id="deliveryAddressInput" rows="3" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:14px; font-family:'Poppins',sans-serif;" placeholder="Enter your complete address with city"></textarea>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
          <input type="checkbox" id="saveAddressCheckbox" checked style="width:18px; height:18px;">
          <span style="color:var(--dark-color); font-weight:600;">Save this address for future orders</span>
        </label>
      </div>
      
      <button onclick="confirmDeliveryAddress()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-size:16px; font-weight:800; cursor:pointer;">
        <i class="fas fa-check-circle"></i> Confirm Address & Calculate Delivery
      </button>
    </div>
  </div>

  <!-- ===== NEW: DELIVERY OPTIONS MODAL ===== -->
  <div class="address-modal-overlay" id="deliveryOptionsModal">
    <div class="address-modal">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="font-size:20px; font-weight:800; color:var(--dark-color);">
          <i class="fas fa-truck"></i> Delivery Options
        </h3>
        <button onclick="closeDeliveryOptionsModal()" style="background:none; border:none; font-size:24px; color:var(--dark-color); cursor:pointer;">√ó</button>
      </div>
      
      <div id="deliveryOptionsList" class="delivery-calculator"></div>
      
      <div style="margin-top:20px;">
        <button onclick="proceedWithSelectedDelivery()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-size:16px; font-weight:800; cursor:pointer;">
          <i class="fas fa-arrow-right"></i> Continue with this Delivery Option
        </button>
      </div>
    </div>
  </div>

  <!-- ===== NEW: TICKET CONFIRMATION MODAL ===== -->
  <div class="address-modal-overlay" id="ticketConfirmationModal">
    <div class="address-modal">
      <div style="margin-bottom:20px;">
        <div class="ticket-card" id="generatedTicketCard">
          <div class="ticket-id" id="ticketIdDisplay">TKT-12345-2024-A7F2</div>
          <p style="opacity:0.9; margin-bottom:15px;">Your order has been confirmed and ticket generated</p>
          
          <div class="ticket-details" id="ticketDetailsDisplay">
            <div class="ticket-detail-item">
              <div class="ticket-detail-label">Order Total</div>
              <div class="ticket-detail-value" id="ticketTotal">PKR 0</div>
            </div>
            <div class="ticket-detail-item">
              <div class="ticket-detail-label">Payment</div>
              <div class="ticket-detail-value" id="ticketPaymentMethod">COD</div>
            </div>
            <div class="ticket-detail-item">
              <div class="ticket-detail-label">Delivery</div>
              <div class="ticket-detail-value" id="ticketDeliveryTime">1-2 days</div>
            </div>
            <div class="ticket-detail-item">
              <div class="ticket-detail-label">Status</div>
              <div class="ticket-detail-value" id="ticketStatus">Confirmed</div>
            </div>
          </div>
        </div>
      </div>
      
      <div style="background:#f8fafc; border-radius:12px; padding:15px; margin-bottom:20px;">
        <h4 style="font-size:16px; font-weight:800; color:var(--dark-color); margin-bottom:10px; display:flex; align-items:center; gap:8px;">
          <i class="fab fa-whatsapp" style="color:#25D366;"></i> WhatsApp Confirmation
        </h4>
        <p style="font-size:13px; color:#64748b; margin-bottom:12px;">
          Your order details and ticket have been sent to the business via WhatsApp.
        </p>
        <div id="whatsappMessagePreview" style="background:white; border-radius:8px; padding:12px; font-size:12px; border:1px solid #e2e8f0; white-space:pre-wrap;"></div>
      </div>
      
      <button onclick="closeTicketModalAndGoHome()" style="width:100%; padding:18px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; font-size:16px; font-weight:800; cursor:pointer;">
        <i class="fas fa-home"></i> Continue Shopping
      </button>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="page active">
    <div class="loader"></div>
    <h1 id="loadingTitle">Digital Business App</h1>
    <p id="loadingSubtitle">Loading your complete business experience...</p>
  </div>

  <!-- Home Page -->
  <div id="homePage" class="page">
    <div class="app-header">
      <div class="welcome-text">
        <h1 id="businessHeader">Welcome</h1>
        <p>Complete business solution</p>
      </div>
      
      <div class="quick-actions">
        <div class="action-card" onclick="navigateTo('productsPage')">
          <div class="action-icon"><i class="fas fa-shopping-bag"></i></div>
          <h3>Shop Now</h3>
          <p>Browse products & offers</p>
        </div>
        
        <div class="action-card" onclick="navigateTo('cartPage')">
          <div class="action-icon"><i class="fas fa-shopping-cart"></i></div>
          <h3>My Cart</h3>
          <p><span id="cartCountMini">0</span> items</p>
        </div>
        
        <div class="action-card" onclick="openWhatsAppChat('greeting')">
          <div class="action-icon"><i class="fab fa-whatsapp"></i></div>
          <h3>Live Chat</h3>
          <p>Instant support</p>
        </div>
        
        <div class="action-card" onclick="navigateTo('contactPage')">
          <div class="action-icon"><i class="fas fa-map-marker-alt"></i></div>
          <h3>Location</h3>
          <p>Find us</p>
        </div>
      </div>
    </div>

    <div class="profile-section">
      <img src="" id="photo" class="profile-avatar" loading="lazy">
      <div class="profile-name">
        <span id="name">Loading...</span>
        <i class="fas fa-badge-check verified-badge"></i>
      </div>
      <div class="profile-business" id="business"></div>
    </div>

    <div class="section-header">
      <h2><i class="fas fa-gift"></i> Featured Products</h2>
      <div class="see-all" onclick="navigateTo('productsPage')">See All <i class="fas fa-arrow-right"></i></div>
    </div>
    
    <div class="products-grid" id="featuredProducts"></div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Products Page -->
  <div id="productsPage" class="page">
    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    
    <div class="products-header">
      <h1>Products & Offers</h1>
      <p>Discover our premium collection</p>
    </div>
    
    <div class="products-search">
      <input type="text" id="productsSearch" placeholder="Search products..." onkeyup="filterProducts()">
      <i class="fas fa-search"></i>
    </div>
    
    <div class="products-grid" id="allProducts"></div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Cart Page - UPDATED with Delivery Calculator -->
  <div id="cartPage" class="page">
    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    
    <div class="cart-header">
      <h1>My Cart</h1>
      <p id="cartItemsCount">0 items</p>
    </div>
    
    <!-- NEW: Selected Delivery Address Bar -->
    <div id="selectedAddressBar" style="margin:15px; padding:12px; background:#f0f9ff; border-radius:12px; border:1px solid #bae6fd; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:8px;">
          <i class="fas fa-map-marker-alt" style="color:#0284c7;"></i>
          <span style="font-weight:600; color:#0369a1;">Delivery Address</span>
        </div>
        <button onclick="openAddressModal()" style="background:none; border:none; color:#0284c7; font-size:13px; font-weight:700; cursor:pointer;">Change</button>
      </div>
      <p id="selectedAddressText" style="font-size:14px; color:#1e293b; margin-top:8px;"></p>
    </div>
    
    <div id="cartContent"></div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- About Page -->
  <div id="aboutPage" class="page">
    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    <div class="about-header"><h1>About Business</h1></div>
    <div class="about-content" id="aboutContent"></div>
    <div class="business-hours">
      <h3><i class="fas fa-clock"></i> Business Hours</h3>
      <div class="hours-list" id="businessHours"></div>
    </div>
    <div class="business-hours">
      <h3><i class="fas fa-calendar-times"></i> Holidays</h3>
      <div class="hours-list" id="holidaysList"></div>
    </div>
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Contact Page -->
  <div id="contactPage" class="page">
    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    <div class="contact-header">
      <h1>Contact Us</h1>
      <p>Get in touch anytime</p>
    </div>
    
    <div class="contact-info">
      <div class="contact-item" onclick="openPhoneInput()" style="cursor:pointer;">
        <div class="contact-icon" style="background:var(--primary-gradient);"><i class="fas fa-user-plus"></i></div>
        <div class="contact-details">
          <div class="contact-label">Your Phone Number</div>
          <div class="contact-value" id="customerPhoneDisplay">Tap to add your number</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="makeCall()">
        <div class="contact-icon"><i class="fas fa-phone"></i></div>
        <div class="contact-details">
          <div class="contact-label">Call Us</div>
          <div class="contact-value" id="contactPhone">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="openWhatsAppChat('greeting')">
        <div class="contact-icon"><i class="fab fa-whatsapp"></i></div>
        <div class="contact-details">
          <div class="contact-label">WhatsApp</div>
          <div class="contact-value" id="contactWhatsApp">Chat Now</div>
        </div>
      </div>
      
      <div class="contact-item email-item" onclick="sendEmail()">
        <div class="contact-icon"><i class="fas fa-envelope"></i></div>
        <div class="contact-details">
          <div class="contact-label">Email</div>
          <div class="contact-value" id="contactEmail">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="openMap()">
        <div class="contact-icon"><i class="fas fa-map-marker-alt"></i></div>
        <div class="contact-details">
          <div class="contact-label">Address</div>
          <div class="contact-value" id="contactAddress">Loading...</div>
        </div>
      </div>
    </div>
    
    <div class="social-links">
      <h3><i class="fas fa-share-alt"></i> Follow Us</h3>
      <div class="social-grid" id="socialGrid"></div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Delivery Status Page -->
  <div id="deliveryPage" class="page">
    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    <div class="delivery-page-header">
      <h1><i class="fas fa-truck"></i> Delivery Status</h1>
      <p>Track your orders in real-time</p>
    </div>
    <div id="deliveryContent"></div>
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Admin Page -->
  <div id="adminPage" class="page">
    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    <div class="delivery-page-header">
      <h1><i class="fas fa-cog"></i> Delivery Admin</h1>
      <p>Manage customer deliveries & tickets</p>
    </div>
    <div id="adminContent"></div>
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Login Page -->
  <div id="loginPage" class="page">
    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    <div class="delivery-page-header">
      <h1><i class="fas fa-lock"></i> Admin Login</h1>
      <p>Enter password to access admin panel</p>
    </div>
    <div class="login-page-content">
      <div class="login-title">Admin Access</div>
      <div class="login-subtitle">Enter the admin password to continue</div>
      <input type="password" class="password-input" id="adminPasswordInput" placeholder="Enter password" onkeypress="handleLoginKeypress(event)">
      <button onclick="attemptLogin()" class="admin-btn success" style="margin-top: 20px;"><i class="fas fa-sign-in-alt"></i> Login</button>
      <div class="password-hint" id="passwordHint">Hint: Password format is business123_{short_id}</div>
      <div id="logoutSection" style="display:none; margin-top: 30px;">
        <button onclick="logoutAdmin()" class="logout-btn" style="margin: 0 auto;"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="navigateTo('homePage')"><div class="nav-icon"><i class="fas fa-home"></i></div><div class="nav-label">Home</div></div>
    <div class="nav-item" onclick="navigateTo('productsPage')"><div class="nav-icon"><i class="fas fa-shopping-bag"></i></div><div class="nav-label">Products</div></div>
    <div class="nav-item" onclick="navigateTo('cartPage')"><div class="nav-icon"><i class="fas fa-shopping-cart"></i><span class="cart-badge" id="cartBadge">0</span></div><div class="nav-label">Cart</div></div>
    <div class="nav-item" onclick="navigateTo('aboutPage')"><div class="nav-icon"><i class="fas fa-info-circle"></i></div><div class="nav-label">About</div></div>
    <div class="nav-item" onclick="navigateTo('contactPage')"><div class="nav-icon"><i class="fas fa-phone"></i></div><div class="nav-label">Contact</div></div>
  </div>
</div>

<!-- Notification Alert -->
<div class="notification-alert" id="notificationAlert"></div>

<!-- Delivery Status Modal -->
<div class="delivery-modal-overlay" id="deliveryStatusModal">
  <div class="delivery-modal">
    <button onclick="closeDeliveryModal()" style="position:absolute;top:15px;right:15px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.1);border:none;color:var(--dark-color);font-size:24px;cursor:pointer;">√ó</button>
    <div id="deliveryStatusContent" style="padding:40px 25px;">
      <h2 style="text-align:center;margin-bottom:25px;color:var(--dark-color);"><i class="fas fa-truck"></i> Delivery Status</h2>
      <div id="deliveryStatusList"></div>
    </div>
  </div>
</div>

<!-- Product Modal - UPDATED with Delivery Calculator -->
<div class="modal-overlay" id="productModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('productModal')">√ó</button>
    
    <div class="product-image-container" style="background:white;">
      <img src="" id="modalImage" class="product-image" loading="lazy">
    </div>
    
    <div style="padding:25px;">
      <div id="modalPrice" class="modal-price-container"></div>
      
      <h2 id="modalTitle" style="font-size:20px;font-weight:800;color:var(--dark-color);margin-bottom:12px;"></h2>
      <p id="modalDescription" style="color:#64748b;line-height:1.6;margin-bottom:20px;font-size:14px;"></p>
      
      <!-- NEW: Quick Delivery Estimate -->
      <div id="quickDeliveryEstimate" style="background:#f0fdf4; padding:12px; border-radius:12px; margin-bottom:20px; display:none;">
        <div style="display:flex; align-items:center; gap:10px;">
          <i class="fas fa-truck" style="color:#10b981; font-size:20px;"></i>
          <div>
            <div style="font-weight:700; color:#065f46;">Estimated Delivery</div>
            <div id="quickDeliveryText" style="font-size:13px; color:#047857;">Enter address to see delivery options</div>
          </div>
        </div>
      </div>
      
      <div id="directCheckoutSection" style="display:none; margin-top: 25px; padding-top: 25px; border-top: 2px solid #f1f5f9;">
        <h3 style="font-size:17px;font-weight:800;color:var(--dark-color);margin-bottom:15px;">Checkout Now</h3>
        
        <div class="payment-options" style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
          <div class="payment-option" onclick="selectBuyNowPayment('whatsapp')" id="whatsappBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#25D366;"><i class="fab fa-whatsapp"></i></div>
            <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">WhatsApp Order</div><div style="font-size:12px;color:#64748b;">Confirm via WhatsApp</div></div>
          </div>
          
          <div class="payment-option" onclick="selectBuyNowPayment('cod')" id="codBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#10b981;"><i class="fas fa-truck"></i></div>
            <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">Cash on Delivery</div><div style="font-size:12px;color:#64748b;">Pay when arrives</div></div>
          </div>
          
          <!-- Dynamic Payment Gateways will be injected here -->
          <div id="dynamicPaymentGateways"></div>
        </div>
        
        <button onclick="checkoutBuyNowWithAddress()" style="width:100%;padding:18px;background:var(--success-gradient);color:white;border:none;border-radius:var(--border-radius-md);font-size:16px;font-weight:800;cursor:pointer;">
          <i class="fas fa-map-marker-alt"></i> Confirm Address & Complete Purchase
        </button>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:25px;">
        <button onclick="showDirectCheckout()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--primary-gradient);color:white;">
          <i class="fas fa-bolt"></i> Quick Buy
        </button>
        <button onclick="addToCartFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--secondary-gradient);color:white;">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Modal - UPDATED with Delivery Calculator -->
<div class="modal-overlay" id="checkoutModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('checkoutModal')">√ó</button>
    
    <div style="padding:25px;">
      <h2 style="font-size:22px;font-weight:800;color:var(--dark-color);margin-bottom:20px;">Checkout</h2>
      
      <div id="checkoutItems" style="margin-bottom:25px;max-height:250px;overflow-y:auto;padding-right:10px;"></div>
      
      <!-- NEW: Selected Delivery Info -->
      <div id="checkoutDeliveryInfo" style="background:#f0f9ff; border-radius:12px; padding:15px; margin-bottom:20px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span style="font-weight:700; color:#0369a1;"><i class="fas fa-map-marker-alt"></i> Delivery Address</span>
          <button onclick="openAddressModalForCheckout()" style="background:none; border:none; color:#0284c7; font-size:12px; font-weight:700; cursor:pointer;">Change</button>
        </div>
        <p id="checkoutAddressText" style="font-size:13px; color:#1e293b;"></p>
        <div style="display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px solid #bae6fd;">
          <span style="font-weight:600; color:#475569;">Delivery Charge</span>
          <span id="checkoutDeliveryCharge" style="font-weight:800; color:#10b981;">PKR 0</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:5px;">
          <span style="font-weight:600; color:#475569;">Estimated Time</span>
          <span id="checkoutDeliveryTime" style="font-weight:800; color:#0f172a;">-</span>
        </div>
      </div>
      
      <div style="margin:20px 0;">
        <h3 style="font-size:17px;font-weight:800;color:var(--dark-color);margin-bottom:15px;">Payment Method</h3>
        <div class="payment-options" style="display:flex;flex-direction:column;gap:12px;">
          <div class="payment-option" onclick="selectCheckoutPayment('whatsapp')" id="whatsappCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#25D366;"><i class="fab fa-whatsapp"></i></div>
            <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">WhatsApp Order</div><div style="font-size:12px;color:#64748b;">Confirm via WhatsApp</div></div>
          </div>
          
          <div class="payment-option" onclick="selectCheckoutPayment('cod')" id="codCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#10b981;"><i class="fas fa-truck"></i></div>
            <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">Cash on Delivery</div><div style="font-size:12px;color:#64748b;">Pay when arrives</div></div>
          </div>
          
          <!-- Dynamic Checkout Payment Gateways -->
          <div id="dynamicCheckoutGateways"></div>
        </div>
      </div>
      
      <div style="background:#f8fafc;padding:20px;border-radius:var(--border-radius-md);margin:25px 0;border:1px solid #e2e8f0;">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
          <span style="color:#64748b;font-size:14px;">Subtotal</span>
          <span style="font-weight:800;color:var(--dark-color);font-size:16px;">PKR <span id="checkoutSubtotal">0</span></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
          <span style="color:#64748b;font-size:14px;">Delivery Charges</span>
          <span style="font-weight:800;color:var(--dark-color);font-size:16px;">PKR <span id="checkoutDeliveryChargeAmount">0</span></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:2px solid #e2e8f0;">
          <span style="font-size:18px;font-weight:800;color:var(--dark-color);">Total</span>
          <span style="font-size:24px;font-weight:900;color:#10b981;">PKR <span id="checkoutTotal">0</span></span>
        </div>
      </div>
      
      <button onclick="proceedToCheckoutWithAddress()" style="width:100%;padding:18px;background:var(--success-gradient);color:white;border:none;border-radius:var(--border-radius-md);font-size:17px;font-weight:800;cursor:pointer;">
        <i class="fas fa-check-circle"></i> Confirm Address & Place Order
      </button>
    </div>
  </div>
</div>

<!-- Payment Details Modal -->
<div class="modal-overlay" id="paymentDetailsModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('paymentDetailsModal')">√ó</button>
    
    <div style="padding:25px;">
      <h2 style="font-size:22px;font-weight:800;color:var(--dark-color);margin-bottom:20px;" id="paymentMethodTitle">Payment Details</h2>
      
      <div id="paymentDetailsContent"></div>
      
      <button onclick="confirmPaymentAndGenerateTicket()" style="width:100%;padding:18px;background:var(--success-gradient);color:white;border:none;border-radius:var(--border-radius-md);font-size:17px;font-weight:800;cursor:pointer;margin-top:25px;">
        Confirm Payment & Generate Ticket
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// ===== SUPABASE CLIENT =====
const supa = supabase.createClient(
  "https://dfvnefbxgayxqgjjgtrr.supabase.co",
  "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ===== GLOBAL VARIABLES =====
let card = {};
let currentProduct = null;
let cart = [];
let buyNowPaymentMethod = 'whatsapp';
let checkoutPaymentMethod = 'whatsapp';
let currentPage = 'loadingScreen';
let deliveryStatusData = [];
let businessAdminPassword = "";
let shortCardId = "";
let isAdminLoggedIn = false;
let currentBusinessId = '';

// ===== NEW: Address & Delivery Variables =====
let selectedDeliveryAddress = null;
let selectedDeliveryOption = null;
let savedCustomerAddresses = [];
let customerPhone = '';
let ticketCounter = 1000;

// ===== DATA ISOLATION =====
function getStorageKey(key) {
  const businessKey = currentBusinessId ? currentBusinessId.substring(0, 8) : 'default';
  return `business_${businessKey}_${key}`;
}

const isolatedLocalStorage = {
  setItem: function(key, value) {
    const storageKey = getStorageKey(key);
    return localStorage.setItem(storageKey, value);
  },
  getItem: function(key) {
    const storageKey = getStorageKey(key);
    return localStorage.getItem(storageKey);
  },
  removeItem: function(key) {
    const storageKey = getStorageKey(key);
    return localStorage.removeItem(storageKey);
  }
};

// ===== NEW: ADDRESS MANAGEMENT =====
function getCustomerPhone() {
  const phone = isolatedLocalStorage.getItem('customerPhone');
  return phone || '';
}

function saveCustomerPhone(phone) {
  isolatedLocalStorage.setItem('customerPhone', phone);
  customerPhone = phone;
}

function loadSavedAddresses() {
  const saved = isolatedLocalStorage.getItem('savedAddresses');
  if (saved) {
    savedCustomerAddresses = JSON.parse(saved);
  } else {
    savedCustomerAddresses = [];
  }
  return savedCustomerAddresses;
}

function saveCustomerAddress(address) {
  // Add to saved addresses if not exists
  const exists = savedCustomerAddresses.some(a => a.address === address.address);
  if (!exists) {
    savedCustomerAddresses.push({
      id: Date.now(),
      label: address.label || 'Home',
      address: address.address,
      city: extractCity(address.address),
      timestamp: new Date().toISOString()
    });
    isolatedLocalStorage.setItem('savedAddresses', JSON.stringify(savedCustomerAddresses));
  }
}

function extractCity(address) {
  // Simple city extraction - look for common city names or last part
  const cities = ['Karachi', 'Lahore', 'Islamabad', 'Rawalpindi', 'Peshawar', 'Quetta', 'Multan', 'Faisalabad', 'Gujranwala', 'Sialkot', 'Hyderabad'];
  for (let city of cities) {
    if (address.includes(city)) {
      return city;
    }
  }
  // Fallback: get last word before comma or end
  const parts = address.split(',').map(p => p.trim());
  return parts[parts.length - 1] || 'Unknown';
}

// ===== NEW: DELIVERY CALCULATOR =====
function calculateDeliveryOptions(address) {
  if (!card.deliverySettings) {
    return [{
      id: 'default',
      name: 'Standard Delivery',
      charge: 0,
      time: '2-3 business days',
      icon: 'fa-truck'
    }];
  }
  
  const settings = card.deliverySettings;
  const city = extractCity(address);
  const options = [];
  
  // Check specific zones first
  if (settings.zones && settings.zones.length > 0) {
    const matchingZone = settings.zones.find(z => 
      city.toLowerCase().includes(z.city.toLowerCase()) || 
      address.toLowerCase().includes(z.city.toLowerCase())
    );
    
    if (matchingZone) {
      options.push({
        id: 'zone',
        name: `${matchingZone.city} Delivery`,
        charge: matchingZone.charge,
        time: matchingZone.time,
        icon: 'fa-location-dot'
      });
    }
  }
  
  // Add default options
  const isSameCity = address.toLowerCase().includes(card.address?.split(',')[0]?.toLowerCase() || '');
  
  if (isSameCity) {
    options.push({
      id: 'within-city',
      name: 'Within City',
      charge: settings.default?.withinCity?.charge || 150,
      time: settings.default?.withinCity?.time || '1-2 business days',
      icon: 'fa-city'
    });
  } else {
    options.push({
      id: 'other-city',
      name: 'Other City',
      charge: settings.default?.otherCities?.charge || 300,
      time: settings.default?.otherCities?.time || '3-5 business days',
      icon: 'fa-map'
    });
  }
  
  // Add express if available
  if (settings.expressDelivery) {
    options.push({
      id: 'express',
      name: 'Express Delivery',
      charge: settings.expressDelivery.charge || 500,
      time: settings.expressDelivery.time || '24 hours',
      icon: 'fa-bolt'
    });
  }
  
  return options;
}

// ===== NEW: TICKET GENERATION =====
function generateTicketId() {
  const prefix = card.ticketSettings?.prefix || 'TKT';
  const date = new Date();
  const dateStr = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
  const random = Math.random().toString(36).substring(2, 6).toUpperCase();
  const counter = (ticketCounter++).toString().padStart(4, '0');
  
  return `${prefix}-${dateStr}-${random}-${counter}`;
}

function generateOrderMessage(orderData, ticketId) {
  const businessName = card.businessName || card.name || 'Business';
  const items = orderData.items.map((item, idx) => 
    `‚Ä¢ ${item.title} (Qty: ${item.quantity || 1}) - PKR ${(item.discountPrice || item.originalPrice || 0) * (item.quantity || 1)}`
  ).join('\n');
  
  let message = `üéâ *NEW ORDER #${ticketId}*\n\n`;
  message += `üè¢ *${businessName}*\n`;
  message += `üë§ *Customer:* ${orderData.customerName || 'Customer'}\n`;
  message += `üìû *Phone:* ${orderData.customerPhone || 'N/A'}\n`;
  message += `üìç *Address:* ${orderData.address}\n\n`;
  message += `üì¶ *ORDER DETAILS:*\n${items}\n\n`;
  message += `---\n`;
  message += `üí∞ *Subtotal:* PKR ${orderData.subtotal}\n`;
  message += `üöö *Delivery:* PKR ${orderData.deliveryCharge}\n`;
  message += `üí≥ *Payment:* ${orderData.paymentMethod}\n`;
  message += `üéØ *TOTAL:* PKR ${orderData.total}\n\n`;
  message += `‚è∞ *Delivery Time:* ${orderData.deliveryTime}\n`;
  message += `üìé *Ticket ID:* ${ticketId}\n`;
  message += `üïê *Order Time:* ${new Date().toLocaleString()}\n\n`;
  message += `_Please confirm and update delivery status._`;
  
  return message;
}

// ===== NEW: ADDRESS MODAL FUNCTIONS =====
function openAddressModal(context = 'checkout') {
  loadSavedAddresses();
  
  const modal = document.getElementById('addressConfirmationModal');
  const savedList = document.getElementById('savedAddressesList');
  
  // Render saved addresses
  if (savedCustomerAddresses.length > 0) {
    let html = '<h4 style="font-size:14px; color:#475569; margin-bottom:12px;">Saved Addresses</h4>';
    savedCustomerAddresses.slice(0, 3).forEach(addr => {
      html += `
        <div class="saved-address" onclick="selectSavedAddress('${addr.address}')">
          <div class="saved-address-info">
            <div class="saved-address-label">
              <i class="fas fa-home"></i> ${addr.label}
            </div>
            <div class="saved-address-text">${addr.address}</div>
          </div>
          <i class="fas fa-chevron-right" style="color:#94a3b8;"></i>
        </div>
      `;
    });
    savedList.innerHTML = html;
  } else {
    savedList.innerHTML = '<p style="color:#94a3b8; text-align:center; padding:15px;">No saved addresses yet</p>';
  }
  
  // Pre-fill with customer phone number
  const customerPhoneVal = getCustomerPhone();
  if (customerPhoneVal && !document.getElementById('deliveryAddressInput').value) {
    // Try to get last used address
    const lastAddress = isolatedLocalStorage.getItem('lastDeliveryAddress');
    if (lastAddress) {
      document.getElementById('deliveryAddressInput').value = lastAddress;
    }
  }
  
  modal.style.display = 'flex';
  window.currentAddressContext = context;
}

function selectSavedAddress(address) {
  document.getElementById('deliveryAddressInput').value = address;
}

function closeAddressModal() {
  document.getElementById('addressConfirmationModal').style.display = 'none';
}

function confirmDeliveryAddress() {
  const address = document.getElementById('deliveryAddressInput').value.trim();
  if (!address) {
    showNotification('‚ùå Please enter your delivery address');
    return;
  }
  
  // Save if checkbox checked
  if (document.getElementById('saveAddressCheckbox').checked) {
    saveCustomerAddress({
      label: 'Delivery Address',
      address: address
    });
  }
  
  // Save last used address
  isolatedLocalStorage.setItem('lastDeliveryAddress', address);
  
  selectedDeliveryAddress = address;
  closeAddressModal();
  
  // Show delivery options
  showDeliveryOptions(address);
}

function showDeliveryOptions(address) {
  const options = calculateDeliveryOptions(address);
  const container = document.getElementById('deliveryOptionsList');
  
  let html = '<h4 style="font-size:14px; color:#475569; margin-bottom:15px;">Select Delivery Option</h4>';
  
  options.forEach((opt, index) => {
    const isSelected = index === 0; // Auto-select first option
    if (isSelected) selectedDeliveryOption = opt;
    
    html += `
      <div class="delivery-option ${isSelected ? 'selected' : ''}" onclick="selectDeliveryOption(this, ${JSON.stringify(opt).replace(/"/g, '&quot;')})">
        <div class="delivery-option-left">
          <div class="delivery-option-icon" style="background:${index === 0 ? '#10b981' : '#64748b'}">
            <i class="fas ${opt.icon || 'fa-truck'}"></i>
          </div>
          <div class="delivery-option-info">
            <h4>${opt.name}</h4>
            <p>Estimated: ${opt.time}</p>
          </div>
        </div>
        <div class="delivery-option-price">PKR ${opt.charge}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  document.getElementById('deliveryOptionsModal').style.display = 'flex';
}

function selectDeliveryOption(element, option) {
  // Remove selected class from all options
  document.querySelectorAll('.delivery-option').forEach(el => {
    el.classList.remove('selected');
  });
  // Add selected class to clicked option
  element.classList.add('selected');
  selectedDeliveryOption = option;
}

function closeDeliveryOptionsModal() {
  document.getElementById('deliveryOptionsModal').style.display = 'none';
}

function proceedWithSelectedDelivery() {
  if (!selectedDeliveryOption) {
    showNotification('‚ùå Please select a delivery option');
    return;
  }
  
  closeDeliveryOptionsModal();
  
  // Update UI based on context
  if (window.currentAddressContext === 'checkout') {
    updateCheckoutWithDelivery();
  } else if (window.currentAddressContext === 'buynow') {
    proceedBuyNowWithDelivery();
  } else if (window.currentAddressContext === 'cart') {
    updateCartPageWithDelivery();
  }
  
  showNotification('‚úÖ Delivery address confirmed');
}

function updateCartPageWithDelivery() {
  // Show selected address bar
  document.getElementById('selectedAddressBar').style.display = 'block';
  document.getElementById('selectedAddressText').textContent = selectedDeliveryAddress;
  
  // Recalculate cart totals
  loadCartPage();
}

function updateCheckoutWithDelivery() {
  document.getElementById('checkoutDeliveryInfo').style.display = 'block';
  document.getElementById('checkoutAddressText').textContent = selectedDeliveryAddress;
  document.getElementById('checkoutDeliveryCharge').textContent = `PKR ${selectedDeliveryOption.charge}`;
  document.getElementById('checkoutDeliveryTime').textContent = selectedDeliveryOption.time;
  document.getElementById('checkoutDeliveryChargeAmount').textContent = selectedDeliveryOption.charge;
  
  // Recalculate total
  const subtotal = parseFloat(document.getElementById('checkoutSubtotal').textContent) || 0;
  const total = subtotal + selectedDeliveryOption.charge;
  document.getElementById('checkoutTotal').textContent = total.toFixed(2);
}

// ===== UPDATED CHECKOUT FLOW =====
function proceedToCheckoutWithAddress() {
  // Check if address is confirmed
  if (!selectedDeliveryAddress || !selectedDeliveryOption) {
    openAddressModal('checkout');
    return;
  }
  
  // Proceed with payment
  if (checkoutPaymentMethod === 'jazzcash' || checkoutPaymentMethod === 'easypaisa' || checkoutPaymentMethod === 'bank' || checkoutPaymentMethod === 'card') {
    showPaymentDetailsModal('checkout');
  } else {
    sendCheckoutOrderWithTicket();
  }
}

function sendCheckoutOrderWithTicket() {
  if (cart.length === 0) return;
  
  const businessName = card.businessName || card.name || "Your Business";
  const customerPhone = getCustomerPhone();
  const customerName = card.customerName || "Customer";
  
  // Calculate totals
  const subtotal = cart.reduce((sum, item) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    return sum + (price * (item.quantity || 1));
  }, 0);
  
  const deliveryCharge = selectedDeliveryOption?.charge || 0;
  const total = subtotal + deliveryCharge;
  
  // Generate ticket
  const ticketId = generateTicketId();
  
  const orderData = {
    items: cart,
    subtotal: subtotal.toFixed(2),
    deliveryCharge: deliveryCharge,
    total: total.toFixed(2),
    address: selectedDeliveryAddress,
    deliveryTime: selectedDeliveryOption?.time || 'N/A',
    paymentMethod: getPaymentMethodName(checkoutPaymentMethod),
    customerPhone: customerPhone,
    customerName: customerName,
    ticketId: ticketId
  };
  
  // Generate WhatsApp message
  const message = generateOrderMessage(orderData, ticketId);
  
  // Send to WhatsApp
  if (card.payments?.whatsapp?.number) {
    const phone = card.payments.whatsapp.number.replace(/\D/g, '');
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
  } else if (card.phone) {
    const phone = card.phone.replace(/\D/g, '');
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
  }
  
  // Add to delivery tracking
  createDeliveryTracking(orderData, ticketId);
  
  // Show ticket confirmation
  showTicketConfirmation(orderData, ticketId, message);
  
  // Clear cart
  cart = [];
  updateCartCount();
  closeModal('checkoutModal');
}

function showTicketConfirmation(orderData, ticketId, message) {
  document.getElementById('ticketIdDisplay').textContent = ticketId;
  document.getElementById('ticketTotal').textContent = `PKR ${orderData.total}`;
  document.getElementById('ticketPaymentMethod').textContent = orderData.paymentMethod;
  document.getElementById('ticketDeliveryTime').textContent = orderData.deliveryTime;
  document.getElementById('whatsappMessagePreview').textContent = message;
  
  document.getElementById('ticketConfirmationModal').style.display = 'flex';
}

function closeTicketModalAndGoHome() {
  document.getElementById('ticketConfirmationModal').style.display = 'none';
  navigateTo('homePage');
}

async function createDeliveryTracking(orderData, ticketId) {
  try {
    const { error } = await supa
      .from('delivery_status')
      .insert([{
        order_id: ticketId,
        customer_phone: orderData.customerPhone || 'N/A',
        customer_name: orderData.customerName || 'Customer',
        status: 'pending',
        location: orderData.address,
        delivery_person: '',
        last_updated: new Date().toISOString(),
        order_total: parseFloat(orderData.total),
        payment_method: orderData.paymentMethod,
        items_count: orderData.items.length
      }]);
      
    if (!error) {
      addInnerNotification('New Order Created', `Order #${ticketId} has been placed successfully`, 'success');
    }
  } catch(err) {
    console.log('Error creating delivery tracking:', err);
  }
}

// ===== BUY NOW WITH ADDRESS =====
function checkoutBuyNowWithAddress() {
  if (!currentProduct) return;
  
  if (!selectedDeliveryAddress || !selectedDeliveryOption) {
    openAddressModal('buynow');
    return;
  }
  
  if (buyNowPaymentMethod === 'jazzcash' || buyNowPaymentMethod === 'easypaisa' || 
      buyNowPaymentMethod === 'bank' || buyNowPaymentMethod === 'card') {
    showPaymentDetailsModal('buyNow');
  } else {
    sendBuyNowOrderWithTicket();
  }
}

function sendBuyNowOrderWithTicket() {
  if (!currentProduct) return;
  
  const price = parseFloat(currentProduct.discountPrice || currentProduct.originalPrice || 0);
  const businessName = card.businessName || card.name || "Your Business";
  const customerPhone = getCustomerPhone();
  
  const subtotal = price;
  const deliveryCharge = selectedDeliveryOption?.charge || 0;
  const total = subtotal + deliveryCharge;
  const ticketId = generateTicketId();
  
  const orderData = {
    items: [{
      ...currentProduct,
      quantity: 1
    }],
    subtotal: subtotal.toFixed(2),
    deliveryCharge: deliveryCharge,
    total: total.toFixed(2),
    address: selectedDeliveryAddress,
    deliveryTime: selectedDeliveryOption?.time || 'N/A',
    paymentMethod: getPaymentMethodName(buyNowPaymentMethod),
    customerPhone: customerPhone,
    customerName: card.customerName || "Customer",
    ticketId: ticketId
  };
  
  const message = generateOrderMessage(orderData, ticketId);
  
  if (card.payments?.whatsapp?.number) {
    const phone = card.payments.whatsapp.number.replace(/\D/g, '');
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
  } else if (card.phone) {
    const phone = card.phone.replace(/\D/g, '');
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
  }
  
  createDeliveryTracking(orderData, ticketId);
  showTicketConfirmation(orderData, ticketId, message);
  
  closeModal('productModal');
}

// ===== LOAD DYNAMIC PAYMENT GATEWAYS =====
function loadPaymentGateways() {
  if (!card.payments?.gateways) return;
  
  const gateways = card.payments.gateways;
  const dynamicContainer = document.getElementById('dynamicPaymentGateways');
  const dynamicCheckoutContainer = document.getElementById('dynamicCheckoutGateways');
  
  let buyNowHtml = '';
  let checkoutHtml = '';
  
  // JazzCash
  if (gateways.jazzcash?.active) {
    buyNowHtml += `
      <div class="payment-option" onclick="selectBuyNowPayment('jazzcash')" id="jazzcashBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
        <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#FF6B00;"><i class="fas fa-mobile-alt"></i></div>
        <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">JazzCash</div><div style="font-size:12px;color:#64748b;">Mobile wallet</div></div>
      </div>
    `;
    
    checkoutHtml += `
      <div class="payment-option" onclick="selectCheckoutPayment('jazzcash')" id="jazzcashCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
        <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#FF6B00;"><i class="fas fa-mobile-alt"></i></div>
        <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">JazzCash</div><div style="font-size:12px;color:#64748b;">Mobile wallet</div></div>
      </div>
    `;
  }
  
  // EasyPaisa
  if (gateways.easypaisa?.active) {
    buyNowHtml += `
      <div class="payment-option" onclick="selectBuyNowPayment('easypaisa')" id="easypaisaBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
        <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#0A5C36;"><i class="fas fa-wallet"></i></div>
        <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">EasyPaisa</div><div style="font-size:12px;color:#64748b;">Mobile account</div></div>
      </div>
    `;
    
    checkoutHtml += `
      <div class="payment-option" onclick="selectCheckoutPayment('easypaisa')" id="easypaisaCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
        <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#0A5C36;"><i class="fas fa-wallet"></i></div>
        <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">EasyPaisa</div><div style="font-size:12px;color:#64748b;">Mobile account</div></div>
      </div>
    `;
  }
  
  // Bank Transfer
  if (gateways.bank?.active) {
    buyNowHtml += `
      <div class="payment-option" onclick="selectBuyNowPayment('bank')" id="bankBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
        <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#2563eb;"><i class="fas fa-university"></i></div>
        <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">Bank Transfer</div><div style="font-size:12px;color:#64748b;">Direct deposit</div></div>
      </div>
    `;
    
    checkoutHtml += `
      <div class="payment-option" onclick="selectCheckoutPayment('bank')" id="bankCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
        <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#2563eb;"><i class="fas fa-university"></i></div>
        <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">Bank Transfer</div><div style="font-size:12px;color:#64748b;">Direct deposit</div></div>
      </div>
    `;
  }
  
  // Credit/Debit Card
  if (gateways.card?.active) {
    buyNowHtml += `
      <div class="payment-option" onclick="selectBuyNowPayment('card')" id="cardBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
        <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#8b5cf6;"><i class="fas fa-credit-card"></i></div>
        <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">Credit/Debit Card</div><div style="font-size:12px;color:#64748b;">${gateways.card.processor || 'Card'}</div></div>
      </div>
    `;
    
    checkoutHtml += `
      <div class="payment-option" onclick="selectCheckoutPayment('card')" id="cardCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
        <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#8b5cf6;"><i class="fas fa-credit-card"></i></div>
        <div><div style="font-weight:800;color:var(--dark-color);font-size:14px;">Credit/Debit Card</div><div style="font-size:12px;color:#64748b;">${gateways.card.processor || 'Card'}</div></div>
      </div>
    `;
  }
  
  dynamicContainer.innerHTML = buyNowHtml;
  dynamicCheckoutContainer.innerHTML = checkoutHtml;
}

// ===== SHOW PAYMENT DETAILS =====
function showPaymentDetailsModal(context) {
  const paymentMethodTitle = document.getElementById('paymentMethodTitle');
  const paymentDetailsContent = document.getElementById('paymentDetailsContent');
  const gateways = card.payments?.gateways || {};
  
  let method = context === 'buyNow' ? buyNowPaymentMethod : checkoutPaymentMethod;
  let amount = 0;
  
  if (context === 'buyNow' && currentProduct) {
    amount = parseFloat(currentProduct.discountPrice || currentProduct.originalPrice || 0);
    if (selectedDeliveryOption) {
      amount += selectedDeliveryOption.charge;
    }
  } else if (context === 'checkout') {
    amount = cart.reduce((sum, item) => {
      const price = parseFloat(item.discountPrice || item.originalPrice || 0);
      return sum + (price * (item.quantity || 1));
    }, 0);
    if (selectedDeliveryOption) {
      amount += selectedDeliveryOption.charge;
    }
  }
  
  let html = '';
  
  switch(method) {
    case 'jazzcash':
      paymentMethodTitle.innerHTML = 'JazzCash Payment';
      html = `
        <div style="text-align:center;">
          <div style="margin-bottom:20px;">
            <div style="font-size:15px;color:#64748b;margin-bottom:12px;">Send <strong style="color:#10b981;font-size:20px;">PKR ${amount.toFixed(2)}</strong> to:</div>
            <div style="font-size:24px;font-weight:900;color:#FF6B00;margin:15px 0;background:rgba(255,107,0,0.1);padding:15px;border-radius:16px;">
              ${gateways.jazzcash?.number || 'N/A'}
            </div>
          </div>
          ${gateways.jazzcash?.barcode ? `
            <div style="margin:20px 0;">
              <img src="${gateways.jazzcash.barcode}" style="max-width:200px;border-radius:16px;">
            </div>
          ` : ''}
        </div>
      `;
      break;
      
    case 'easypaisa':
      paymentMethodTitle.innerHTML = 'EasyPaisa Payment';
      html = `
        <div style="text-align:center;">
          <div style="margin-bottom:20px;">
            <div style="font-size:15px;color:#64748b;margin-bottom:12px;">Send <strong style="color:#10b981;font-size:20px;">PKR ${amount.toFixed(2)}</strong> to:</div>
            <div style="font-size:24px;font-weight:900;color:#0A5C36;margin:15px 0;background:rgba(10,92,54,0.1);padding:15px;border-radius:16px;">
              ${gateways.easypaisa?.number || 'N/A'}
            </div>
          </div>
          ${gateways.easypaisa?.barcode ? `
            <div style="margin:20px 0;">
              <img src="${gateways.easypaisa.barcode}" style="max-width:200px;border-radius:16px;">
            </div>
          ` : ''}
        </div>
      `;
      break;
      
    case 'bank':
      paymentMethodTitle.innerHTML = 'Bank Transfer';
      html = `
        <div style="text-align:center;">
          <div style="background:#f8fafc;padding:20px;border-radius:16px;margin-bottom:20px;">
            <div style="font-size:14px;color:#64748b;margin-bottom:12px;">Bank Account Details</div>
            <div style="font-size:16px;font-weight:800;color:var(--dark-color);margin-bottom:8px;">${gateways.bank?.bankName || 'N/A'}</div>
            <div style="font-size:14px;color:#475569;margin-bottom:4px;">${gateways.bank?.accountTitle || 'N/A'}</div>
            <div style="font-size:18px;font-weight:900;color:#2563eb;margin:12px 0;">${gateways.bank?.accountNumber || 'N/A'}</div>
            <div style="font-size:13px;color:#64748b;">IBAN: ${gateways.bank?.iban || 'N/A'}</div>
          </div>
          <div style="font-size:20px;font-weight:900;color:#10b981;margin:15px 0;">
            Amount: PKR ${amount.toFixed(2)}
          </div>
        </div>
      `;
      break;
      
    case 'card':
      paymentMethodTitle.innerHTML = 'Card Payment';
      html = `
        <div style="text-align:center;padding:20px;">
          <i class="fas fa-credit-card" style="font-size:48px;color:#8b5cf6;margin-bottom:15px;"></i>
          <h3 style="font-size:18px;color:var(--dark-color);margin-bottom:10px;">Secure Card Payment</h3>
          <p style="color:#64748b;margin-bottom:20px;">You will be redirected to ${gateways.card?.processor || 'payment'} gateway</p>
          <div style="font-size:24px;font-weight:900;color:#10b981;margin:20px 0;">
            Total: PKR ${amount.toFixed(2)}
          </div>
        </div>
      `;
      break;
  }
  
  paymentDetailsContent.innerHTML = html;
  openModal('paymentDetailsModal');
  
  if (context === 'buyNow') {
    closeModal('productModal');
  } else if (context === 'checkout') {
    closeModal('checkoutModal');
  }
}

// ===== CONFIRM PAYMENT AND GENERATE TICKET =====
function confirmPaymentAndGenerateTicket() {
  if (window.currentAddressContext === 'buyNow' || currentPage === 'productModal') {
    sendBuyNowOrderWithTicket();
  } else {
    sendCheckoutOrderWithTicket();
  }
  closeModal('paymentDetailsModal');
}

// ===== OVERRIDE ORIGINAL FUNCTIONS =====
function openAddressModalForCheckout() {
  openAddressModal('checkout');
}

// ===== MODIFIED CART PAGE LOADER =====
function loadCartPage() {
  const cartContent = document.getElementById('cartContent');
  const cartItemsCount = document.getElementById('cartItemsCount');
  
  if(cart.length === 0) {
    cartContent.innerHTML = `
      <div class="cart-empty">
        <i class="fas fa-shopping-cart"></i>
        <h3>Your cart is empty</h3>
        <p>Add some products to get started</p>
        <button onclick="navigateTo('productsPage')">Browse Products</button>
      </div>
    `;
    cartItemsCount.textContent = '0 items';
    document.getElementById('selectedAddressBar').style.display = 'none';
    return;
  }
  
  let html = '<div class="cart-items">';
  let subtotal = 0;
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    subtotal += itemTotal;
    
    html += `
      <div class="cart-item">
        <img src="${item.image || ''}" class="cart-item-img" loading="lazy" onerror="this.style.display='none'">
        <div class="cart-item-details">
          <div class="cart-item-title">${item.title || 'Product'}</div>
          <div class="cart-item-price">PKR ${itemTotal.toFixed(2)}</div>
          <div class="cart-item-actions">
            <div class="quantity-control">
              <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
              <span class="quantity">${item.quantity || 1}</span>
              <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
            </div>
            <button class="remove-btn" onclick="removeFromCart(${index})">Remove</button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  // Calculate delivery charge if address selected
  let deliveryCharge = 0;
  let deliveryTime = '';
  if (selectedDeliveryAddress && selectedDeliveryOption) {
    deliveryCharge = selectedDeliveryOption.charge;
    deliveryTime = selectedDeliveryOption.time;
  }
  
  const total = subtotal + deliveryCharge;
  
  html += `
    <div class="cart-summary">
      <h3><i class="fas fa-receipt"></i> Order Summary</h3>
      <div class="summary-row">
        <span>Subtotal</span>
        <span>PKR ${subtotal.toFixed(2)}</span>
      </div>
      <div class="summary-row">
        <span>Delivery Charges</span>
        <span>PKR ${deliveryCharge.toFixed(2)}</span>
      </div>
      <div class="summary-row summary-total">
        <span>Total</span>
        <span>PKR ${total.toFixed(2)}</span>
      </div>
      <button class="checkout-btn" onclick="openCheckoutModalWithAddress()">
        <i class="fas fa-lock"></i> Proceed to Checkout
      </button>
    </div>
  `;
  
  cartContent.innerHTML = html;
  cartItemsCount.textContent = `${cart.length} ${cart.length === 1 ? 'item' : 'items'}`;
}

function openCheckoutModalWithAddress() {
  if (!selectedDeliveryAddress || !selectedDeliveryOption) {
    openAddressModal('checkout');
    return;
  }
  
  openCheckoutModal();
}

// ===== REST OF ORIGINAL CODE =====
// (All original functions: navigateTo, goBack, addToCart, updateCartCount, 
//  loadHomePage, loadProductsPage, createProductCard, filterProducts,
//  loadAboutPage, loadContactPage, etc. remain exactly the same)

// ===== INITIALIZE APP =====
document.addEventListener("DOMContentLoaded", async () => {
  // Check for short ID in URL
  const urlParams = new URLSearchParams(location.search);
  let id = urlParams.get("id") || localStorage.getItem("lastCardId");
  
  if(!id) {
    document.body.innerHTML = "<div style='padding:40px;text-align:center;color:white;'><h2>Card not found</h2></div>";
    return;
  }

  currentBusinessId = id;
  
  // Load cart from isolated storage
  const savedCart = isolatedLocalStorage.getItem('cart');
  cart = savedCart ? JSON.parse(savedCart) : [];
  
  // Load saved addresses
  loadSavedAddresses();
  
  // Load customer phone
  customerPhone = getCustomerPhone();
  
  setTimeout(async () => {
    const {data, error} = await supa.from("cards").select("*").eq("id", id).single();
    if(error || !data) {
      document.body.innerHTML = "<div style='padding:40px;text-align:center;color:white;'><h2>Card not found</h2></div>";
      return;
    }

    card = JSON.parse(data.data);
    card.id = data.id;
    
    // Load payment gateways
    loadPaymentGateways();
    
    await renderApp();
    
    // Start with home page
    navigateTo('homePage');
    
    updateCartCount();
    updateCustomerPhoneDisplay();
    
    // Check for saved delivery address
    const lastAddress = isolatedLocalStorage.getItem('lastDeliveryAddress');
    if (lastAddress) {
      selectedDeliveryAddress = lastAddress;
      const options = calculateDeliveryOptions(lastAddress);
      if (options.length > 0) {
        selectedDeliveryOption = options[0];
      }
      updateCartPageWithDelivery();
    }
  }, 2000);
});

// ===== RENDER APP =====
async function renderApp() {
  document.getElementById('businessHeader').textContent = card.businessName || card.name || "Premium Business";
  
  const photo = document.getElementById('photo');
  if(card.profileImage) {
    photo.src = card.profileImage;
  } else {
    photo.style.display = 'none';
  }
  
  document.getElementById('name').textContent = card.name || "";
  document.getElementById('business').textContent = card.businessName || "";
  
  document.getElementById('contactPhone').textContent = card.phone || "Not available";
  document.getElementById('contactEmail').textContent = card.email || "Not available";
  document.getElementById('contactAddress').textContent = card.address || "Not available";
  
  loadHomePage();
}

// Include all other original functions here...
// For brevity in this response, I've shown the key new features.
// The complete code would include all original functions from the card.html file.

</script>
</body>
</html>
