<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Digital Business App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap">

<style>
/* All CSS remains exactly the same - only JavaScript changes */
/* ... [ALL CSS STYLES REMAIN THE SAME AS BEFORE] ... */
</style>
</head>

<body>
<div class="app-container">
  <!-- Image Zoom Overlay -->
  <div class="image-zoom-overlay" id="imageZoomOverlay" onclick="closeImageZoom()">
    <img src="" class="image-zoom-content" id="zoomedImage">
  </div>

  <!-- Exit Confirmation Modal -->
  <div class="exit-modal-overlay" id="exitModal">
    <div class="exit-modal">
      <h2><i class="fas fa-sign-out-alt"></i> Exit App?</h2>
      <p>Are you sure you want to exit? Press back again to confirm.</p>
      <div class="exit-modal-buttons">
        <button class="exit-modal-btn cancel" onclick="closeExitModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="exit-modal-btn exit" onclick="exitApp()">
          <i class="fas fa-sign-out-alt"></i> Exit
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="page active">
    <div class="loader"></div>
    <h1>Digital Business App</h1>
    <p>Loading your premium business experience...</p>
  </div>

  <!-- Home Page -->
  <div id="homePage" class="page">
    <div class="app-header">
      <!-- Centered Header Icons -->
      <div class="header-icons">
        <!-- Delivery Status Icon -->
        <div class="header-icon-btn" id="deliveryStatusBtn" onclick="checkDeliveryStatus()">
          <i class="fas fa-truck" id="deliveryIcon"></i>
          <div class="delivery-badge" id="deliveryBadge" style="display:none;"></div>
        </div>
        
        <!-- Login/Logout Icon -->
        <div class="header-icon-btn" id="loginBtn" onclick="toggleLogin()">
          <i class="fas fa-sign-in-alt" id="loginIcon"></i>
        </div>
      </div>
      
      <div class="welcome-text">
        <h1 id="businessHeader">Welcome</h1>
        <p>Premium business at your fingertips</p>
      </div>
      
      <div class="quick-actions">
        <div class="action-card" onclick="navigateTo('productsPage')">
          <div class="action-icon">
            <i class="fas fa-shopping-bag"></i>
          </div>
          <h3>Shop Now</h3>
          <p>Browse products & offers</p>
        </div>
        
        <div class="action-card" onclick="navigateTo('cartPage')">
          <div class="action-icon">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <h3>My Cart</h3>
          <p><span id="cartCountMini">0</span> items</p>
        </div>
        
        <div class="action-card" onclick="openWhatsAppChat('greeting')">
          <div class="action-icon">
            <i class="fab fa-whatsapp"></i>
          </div>
          <h3>Live Chat</h3>
          <p>Instant support</p>
        </div>
        
        <div class="action-card" onclick="navigateTo('contactPage')">
          <div class="action-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <h3>Location</h3>
          <p>Find us</p>
        </div>
      </div>
    </div>

    <div class="profile-section">
      <img src="" id="photo" class="profile-avatar" loading="lazy">
      <div class="profile-name">
        <span id="name">Loading...</span>
        <i class="fas fa-badge-check verified-badge"></i>
      </div>
      <div class="profile-business" id="business"></div>
    </div>

    <div class="section-header">
      <h2><i class="fas fa-gift"></i> Featured Products</h2>
      <div class="see-all" onclick="navigateTo('productsPage')">
        See All <i class="fas fa-arrow-right"></i>
      </div>
    </div>
    
    <div class="products-grid" id="featuredProducts">
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Products Page -->
  <div id="productsPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="products-header">
      <h1>Products & Offers</h1>
      <p>Discover our premium collection</p>
    </div>
    
    <div class="products-search">
      <input type="text" id="productsSearch" placeholder="Search products..." onkeyup="filterProducts()">
      <i class="fas fa-search"></i>
    </div>
    
    <div class="products-grid" id="allProducts">
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Cart Page -->
  <div id="cartPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="cart-header">
      <h1>My Cart</h1>
      <p id="cartItemsCount">0 items</p>
    </div>
    
    <div id="cartContent">
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- About Page -->
  <div id="aboutPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="about-header">
      <h1>About Business</h1>
    </div>
    
    <div class="about-content" id="aboutContent">
    </div>
    
    <div class="business-hours">
      <h3><i class="fas fa-clock"></i> Business Hours</h3>
      <div class="hours-list" id="businessHours">
      </div>
    </div>
    
    <div class="business-hours">
      <h3><i class="fas fa-calendar-times"></i> Holidays</h3>
      <div class="hours-list" id="holidaysList">
      </div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Contact Page -->
  <div id="contactPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="contact-header">
      <h1>Contact Us</h1>
      <p>Get in touch anytime</p>
    </div>
    
    <div class="contact-info">
      <!-- Customer Phone Input -->
      <div class="contact-item" onclick="openPhoneInput()" style="cursor:pointer;">
        <div class="contact-icon" style="background:var(--primary-gradient);">
          <i class="fas fa-user-plus"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">Your Phone Number</div>
          <div class="contact-value" id="customerPhoneDisplay">
            Tap to add your number
          </div>
        </div>
      </div>
      
      <div class="contact-item" onclick="makeCall()">
        <div class="contact-icon">
          <i class="fas fa-phone"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">Call Us</div>
          <div class="contact-value" id="contactPhone">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="openWhatsAppChat('greeting')">
        <div class="contact-icon">
          <i class="fab fa-whatsapp"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">WhatsApp</div>
          <div class="contact-value" id="contactWhatsApp">Chat Now</div>
        </div>
      </div>
      
      <div class="contact-item email-item" onclick="sendEmail()">
        <div class="contact-icon">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">Email</div>
          <div class="contact-value" id="contactEmail">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="openMap()">
        <div class="contact-icon">
          <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">Address</div>
          <div class="contact-value" id="contactAddress">Loading...</div>
        </div>
      </div>
    </div>
    
    <div class="social-links">
      <h3><i class="fas fa-share-alt"></i> Follow Us</h3>
      <div class="social-grid" id="socialGrid">
      </div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== DELIVERY STATUS PAGE ===== -->
  <div id="deliveryPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="delivery-page-header">
      <h1><i class="fas fa-truck"></i> Delivery Status</h1>
      <p>Track your orders in real-time</p>
    </div>
    
    <div id="deliveryContent">
      <!-- Delivery status will load here -->
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== ADMIN DELIVERY PAGE ===== -->
  <div id="adminPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="delivery-page-header">
      <h1><i class="fas fa-cog"></i> Delivery Admin</h1>
      <p>Manage customer deliveries</p>
    </div>
    
    <div id="adminContent">
      <!-- Admin panel will load here -->
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== SIMPLE LOGIN PAGE ===== -->
  <div id="loginPage" class="page">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <div class="delivery-page-header">
      <h1><i class="fas fa-lock"></i> Admin Login</h1>
      <p>Enter password to access admin panel</p>
    </div>
    
    <div class="login-page-content">
      <div class="login-title">Admin Access</div>
      <div class="login-subtitle">Enter the admin password to continue</div>
      
      <input type="password" class="password-input" id="adminPasswordInput" 
             placeholder="Enter password" onkeypress="handleLoginKeypress(event)">
      
      <button onclick="attemptLogin()" class="admin-btn success" style="margin-top: 20px;">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
      
      <div class="password-hint" id="passwordHint">
        Hint: Password format is business123_{short_id}
      </div>
      
      <div id="logoutSection" style="display:none; margin-top: 30px;">
        <button onclick="logoutAdmin()" class="logout-btn" style="margin: 0 auto;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="navigateTo('homePage')">
      <div class="nav-icon">
        <i class="fas fa-home"></i>
      </div>
      <div class="nav-label">Home</div>
    </div>
    
    <div class="nav-item" onclick="navigateTo('productsPage')">
      <div class="nav-icon">
        <i class="fas fa-shopping-bag"></i>
      </div>
      <div class="nav-label">Products</div>
    </div>
    
    <div class="nav-item" onclick="navigateTo('cartPage')">
      <div class="nav-icon">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge" id="cartBadge">0</span>
      </div>
      <div class="nav-label">Cart</div>
    </div>
    
    <div class="nav-item" onclick="navigateTo('aboutPage')">
      <div class="nav-icon">
        <i class="fas fa-info-circle"></i>
      </div>
      <div class="nav-label">About</div>
    </div>
    
    <div class="nav-item" onclick="navigateTo('contactPage')">
      <div class="nav-icon">
        <i class="fas fa-phone"></i>
      </div>
      <div class="nav-label">Contact</div>
    </div>
  </div>
</div>

<!-- Notification Alert -->
<div class="notification-alert" id="notificationAlert"></div>

<!-- Delivery Status Modal -->
<div class="delivery-modal-overlay" id="deliveryStatusModal">
  <div class="delivery-modal">
    <button onclick="closeDeliveryModal()" style="position:absolute;top:15px;right:15px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.1);border:none;color:var(--dark-color);font-size:24px;cursor:pointer;">√ó</button>
    <div id="deliveryStatusContent" style="padding:40px 25px;">
      <h2 style="text-align:center;margin-bottom:25px;color:var(--dark-color);">
        <i class="fas fa-truck"></i> Delivery Status
      </h2>
      <div id="deliveryStatusList"></div>
    </div>
  </div>
</div>

<!-- Other Modals -->
<div class="modal-overlay" id="productModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('productModal')">√ó</button>
    
    <div class="product-image-container" style="background:white;">
      <img src="" id="modalImage" class="product-image" loading="lazy">
    </div>
    
    <div style="padding:25px;">
      <!-- MODAL PRICE - Below image in content flow -->
      <div id="modalPrice" class="modal-price-container"></div>
      
      <h2 id="modalTitle" style="font-size:20px;font-weight:800;color:var(--dark-color);margin-bottom:12px;"></h2>
      <p id="modalDescription" style="color:#64748b;line-height:1.6;margin-bottom:20px;font-size:14px;"></p>
      
      <div id="directCheckoutSection" style="display:none; margin-top: 25px; padding-top: 25px; border-top: 2px solid #f1f5f9;">
        <h3 style="font-size:17px;font-weight:800;color:var(--dark-color);margin-bottom:15px;">
          Checkout Now
        </h3>
        
        <div class="payment-options" style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
          <div class="payment-option" onclick="selectBuyNowPayment('whatsapp')" id="whatsappBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#25D366;">
              <i class="fab fa-whatsapp"></i>
            </div>
            <div>
              <div style="font-weight:800;color:var(--dark-color);font-size:14px;">WhatsApp Order</div>
              <div style="font-size:12px;color:#64748b;">Confirm via WhatsApp</div>
            </div>
          </div>
          
          <div class="payment-option" onclick="selectBuyNowPayment('cod')" id="codBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#10b981;">
              <i class="fas fa-truck"></i>
            </div>
            <div>
              <div style="font-weight:800;color:var(--dark-color);font-size:14px;">Cash on Delivery</div>
              <div style="font-size:12px;color:#64748b;">Pay when arrives</div>
            </div>
          </div>
          
          <div class="payment-option" onclick="selectBuyNowPayment('jazzcash')" id="jazzcashBuyNowOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#FF6B00;">
              <i class="fas fa-qrcode"></i>
            </div>
            <div>
              <div style="font-weight:800;color:var(--dark-color);font-size:14px;">JazzCash / EasyPaisa</div>
              <div style="font-size:12px;color:#64748b;">Pay via QR Code</div>
            </div>
          </div>
        </div>
        
        <button onclick="checkoutBuyNow()" style="width:100%;padding:18px;background:var(--success-gradient);color:white;border:none;border-radius:var(--border-radius-md);font-size:16px;font-weight:800;cursor:pointer;">
          Complete Purchase
        </button>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:25px;">
        <button onclick="showDirectCheckout()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--primary-gradient);color:white;">
          <i class="fas fa-bolt"></i> Quick Buy
        </button>
        <button onclick="addToCartFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--secondary-gradient);color:white;">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="checkoutModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('checkoutModal')">√ó</button>
    
    <div style="padding:25px;">
      <h2 style="font-size:22px;font-weight:800;color:var(--dark-color);margin-bottom:20px;">
        Checkout
      </h2>
      
      <div id="checkoutItems" style="margin-bottom:25px;max-height:250px;overflow-y:auto;padding-right:10px;">
      </div>
      
      <div style="margin:20px 0;">
        <h3 style="font-size:17px;font-weight:800;color:var(--dark-color);margin-bottom:15px;">
          Payment Method
        </h3>
        <div class="payment-options" style="display:flex;flex-direction:column;gap:12px;">
          <div class="payment-option" onclick="selectCheckoutPayment('whatsapp')" id="whatsappCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#25D366;">
              <i class="fab fa-whatsapp"></i>
            </div>
            <div>
              <div style="font-weight:800;color:var(--dark-color);font-size:14px;">WhatsApp Order</div>
              <div style="font-size:12px;color:#64748b;">Confirm via WhatsApp</div>
            </div>
          </div>
          
          <div class="payment-option" onclick="selectCheckoutPayment('cod')" id="codCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#10b981;">
              <i class="fas fa-truck"></i>
            </div>
            <div>
              <div style="font-weight:800;color:var(--dark-color);font-size:14px;">Cash on Delivery</div>
              <div style="font-size:12px;color:#64748b;">Pay when arrives</div>
            </div>
          </div>
          
          <div class="payment-option" onclick="selectCheckoutPayment('jazzcash')" id="jazzcashCheckoutOption" style="padding:15px;border:2px solid #e2e8f0;border-radius:var(--border-radius-md);cursor:pointer;display:flex;align-items:center;gap:12px;background:white;">
            <div class="payment-icon" style="width:45px;height:45px;border-radius:var(--border-radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;color:white;background:#FF6B00;">
              <i class="fas fa-qrcode"></i>
            </div>
            <div>
              <div style="font-weight:800;color:var(--dark-color);font-size:14px;">JazzCash / EasyPaisa</div>
              <div style="font-size:12px;color:#64748b;">Pay via QR Code</div>
            </div>
          </div>
        </div>
      </div>
      
      <div style="background:#f8fafc;padding:20px;border-radius:var(--border-radius-md);margin:25px 0;border:1px solid #e2e8f0;">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
          <span style="color:#64748b;font-size:14px;">Subtotal</span>
          <span style="font-weight:800;color:var(--dark-color);font-size:16px;">PKR <span id="checkoutSubtotal">0</span></span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
          <span style="color:#64748b;font-size:14px;">Shipping</span>
          <span style="font-weight:800;color:var(--dark-color);font-size:16px;">PKR 0</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:2px solid #e2e8f0;">
          <span style="font-size:18px;font-weight:800;color:var(--dark-color);">Total</span>
          <span style="font-size:24px;font-weight:900;color:#10b981;">PKR <span id="checkoutTotal">0</span></span>
        </div>
      </div>
      
      <button onclick="proceedToPayment()" style="width:100%;padding:18px;background:var(--success-gradient);color:white;border:none;border-radius:var(--border-radius-md);font-size:17px;font-weight:800;cursor:pointer;">
        <i class="fas fa-lock"></i> Secure Checkout
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="paymentDetailsModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('paymentDetailsModal')">√ó</button>
    
    <div style="padding:25px;">
      <h2 style="font-size:22px;font-weight:800;color:var(--dark-color);margin-bottom:20px;" id="paymentMethodTitle">
        Payment Details
      </h2>
      
      <div id="paymentDetailsContent">
      </div>
      
      <button onclick="confirmPayment()" style="width:100%;padding:18px;background:var(--success-gradient);color:white;border:none;border-radius:var(--border-radius-md);font-size:17px;font-weight:800;cursor:pointer;margin-top:25px;">
        Confirm Payment
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// ===== SUPABASE CLIENT INITIALIZATION =====
const supa = supabase.createClient(
  "https://dfvnefbxgayxqgjjgtrr.supabase.co",
  "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ===== BUSINESS DATA ISOLATION SYSTEM =====
// Each generated app will have its own isolated data in Supabase
let currentBusinessId = '';
let shortBusinessId = '';
let isAdminLoggedIn = false;
let businessData = {}; // Will store all business-specific data

// ===== SHORT URL SYSTEM =====
function generateShortId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let shortId = '';
  for (let i = 0; i < 7; i++) {
    shortId += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return shortId;
}

// ===== PASSWORD GENERATOR SYSTEM =====
function generateAdminPassword(businessId) {
  if (!businessId) return "admin123_default";
  const shortId = businessId.substring(0, 8).toLowerCase();
  return `business123_${shortId}`;
}

// ===== LOCAL STORAGE ISOLATION =====
// Each business app will have its own isolated localStorage keys
function getStorageKey(key) {
  // Prefix all localStorage keys with business ID
  return `business_${currentBusinessId}_${key}`;
}

const isolatedLocalStorage = {
  setItem: function(key, value) {
    return localStorage.setItem(getStorageKey(key), value);
  },
  
  getItem: function(key) {
    return localStorage.getItem(getStorageKey(key));
  },
  
  removeItem: function(key) {
    return localStorage.removeItem(getStorageKey(key));
  },
  
  clear: function() {
    // Only clear items for this business
    const prefix = `business_${currentBusinessId}_`;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(prefix)) {
        localStorage.removeItem(key);
      }
    }
  }
};

// ===== BUSINESS DATA LOADING =====
async function loadBusinessData(businessId) {
  try {
    // Load business profile
    const { data: profileData, error: profileError } = await supa
      .from('business_profiles')
      .select('*')
      .eq('id', businessId)
      .single();
    
    if (profileError) {
      console.error('Error loading business profile:', profileError);
      return null;
    }
    
    // Load business products
    const { data: productsData, error: productsError } = await supa
      .from('business_products')
      .select('*')
      .eq('business_id', businessId)
      .order('created_at', { ascending: false });
    
    if (productsError) {
      console.error('Error loading products:', productsError);
      return null;
    }
    
    // Load business hours
    const { data: hoursData, error: hoursError } = await supa
      .from('business_hours')
      .select('*')
      .eq('business_id', businessId);
    
    // Load business social media
    const { data: socialData, error: socialError } = await supa
      .from('business_social')
      .select('*')
      .eq('business_id', businessId);
    
    // Load business payments
    const { data: paymentsData, error: paymentsError } = await supa
      .from('business_payments')
      .select('*')
      .eq('business_id', businessId)
      .single();
    
    // Compile all business data
    businessData = {
      profile: profileData || {},
      products: productsData || [],
      hours: hoursData || [],
      social: socialData || [],
      payments: paymentsData || {}
    };
    
    return businessData;
    
  } catch (error) {
    console.error('Error loading business data:', error);
    return null;
  }
}

// ===== BUSINESS DATA PARSING =====
function parseBusinessData(rawData) {
  // Parse profile
  const profile = rawData.profile || {};
  
  // Parse products
  const products = (rawData.products || []).map(product => {
    try {
      return {
        title: product.title || '',
        desc: product.description || '',
        image: product.image_url || '',
        originalPrice: product.original_price || 0,
        discountPrice: product.discount_price || product.original_price || 0,
        badges: product.badges ? JSON.parse(product.badges) : [],
        category: product.category || ''
      };
    } catch (e) {
      return {
        title: product.title || '',
        desc: product.description || '',
        image: product.image_url || '',
        originalPrice: product.original_price || 0,
        discountPrice: product.discount_price || product.original_price || 0,
        badges: [],
        category: product.category || ''
      };
    }
  });
  
  // Parse business hours
  const businessHours = [];
  const hoursData = rawData.hours || [];
  if (hoursData.length > 0) {
    hoursData.forEach(hour => {
      businessHours[parseInt(hour.day_of_week)] = {
        open: hour.is_open,
        start: hour.open_time,
        end: hour.close_time,
        status: hour.is_open ? 'open' : 'closed'
      };
    });
  }
  
  // Parse social media
  const socialMedia = {};
  (rawData.social || []).forEach(social => {
    if (social.platform && social.url) {
      socialMedia[social.platform.toLowerCase()] = social.url;
    }
  });
  
  // Parse payments
  const payments = rawData.payments || {};
  
  return {
    id: profile.id,
    name: profile.owner_name || '',
    businessName: profile.business_name || '',
    profileImage: profile.profile_image || '',
    phone: profile.phone || '',
    email: profile.email || '',
    address: profile.address || '',
    
    business: {
      about: profile.about || 'No information available'
    },
    
    products: products,
    businessHours: businessHours,
    socialMedia: socialMedia,
    payments: payments,
    
    holidays: profile.holidays ? JSON.parse(profile.holidays) : []
  };
}

// ===== CUSTOMER PHONE MANAGEMENT =====
function getCustomerPhone() {
  const phone = isolatedLocalStorage.getItem('customerPhone');
  return phone;
}

function saveCustomerPhone(phone) {
  isolatedLocalStorage.setItem('customerPhone', phone);
}

function saveBusinessPhone(phone) {
  isolatedLocalStorage.setItem('businessPhone', phone);
}

// ===== NAVIGATION SYSTEM =====
let currentPage = 'loadingScreen';
let navigationHistory = [];

// Initialize hash-based routing
function initializeRouting() {
  window.addEventListener('hashchange', handleHashChange);
  
  setTimeout(() => {
    const hash = window.location.hash.replace('#', '');
    if (hash) {
      handleHashChange();
    } else {
      window.location.hash = '#home';
    }
  }, 100);
}

function handleHashChange() {
  const hash = window.location.hash.replace('#', '');
  const pageMap = {
    'home': 'homePage',
    'products': 'productsPage',
    'cart': 'cartPage',
    'about': 'aboutPage',
    'contact': 'contactPage',
    'delivery': 'deliveryPage',
    'admin': 'adminPage',
    'login': 'loginPage'
  };
  
  if (pageMap[hash]) {
    if (currentPage !== pageMap[hash]) {
      navigateToDirect(pageMap[hash]);
    }
  } else {
    window.location.hash = '#home';
  }
}

function navigateToDirect(pageId) {
  if(currentPage === pageId) return;
  
  const oldPage = document.getElementById(currentPage);
  const newPage = document.getElementById(pageId);
  
  if(oldPage) {
    oldPage.classList.remove('active');
    oldPage.classList.add('slide-out');
  }
  
  setTimeout(() => {
    if(oldPage) oldPage.classList.remove('slide-out');
    newPage.classList.add('active');
    currentPage = pageId;
    
    // Update navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active');
    });
    
    const navMap = {
      'homePage': 0,
      'productsPage': 1,
      'cartPage': 2,
      'aboutPage': 3,
      'contactPage': 4,
      'deliveryPage': 0,
      'adminPage': 0,
      'loginPage': 0
    };
    
    if(navMap[pageId] !== undefined) {
      document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active');
    }
    
    // Load page content
    switch(pageId) {
      case 'homePage':
        loadHomePage();
        break;
      case 'productsPage':
        loadProductsPage();
        break;
      case 'cartPage':
        loadCartPage();
        break;
      case 'aboutPage':
        loadAboutPage();
        break;
      case 'contactPage':
        loadContactPage();
        break;
      case 'deliveryPage':
        loadDeliveryStatus();
        break;
      case 'adminPage':
        if (isAdminLoggedIn) {
          loadAdminPanel();
        } else {
          navigateTo('loginPage');
        }
        break;
    }
  }, 300);
}

function navigateTo(pageId) {
  const hashMap = {
    'homePage': 'home',
    'productsPage': 'products',
    'cartPage': 'cart',
    'aboutPage': 'about',
    'contactPage': 'contact',
    'deliveryPage': 'delivery',
    'adminPage': 'admin',
    'loginPage': 'login'
  };
  
  if (hashMap[pageId]) {
    window.location.hash = `#${hashMap[pageId]}`;
    navigationHistory.push(pageId);
  }
}

function goBack() {
  if (navigationHistory.length > 1) {
    navigationHistory.pop();
    const previousPage = navigationHistory[navigationHistory.length - 1];
    
    const hashMap = {
      'homePage': 'home',
      'productsPage': 'products',
      'cartPage': 'cart',
      'aboutPage': 'about',
      'contactPage': 'contact',
      'deliveryPage': 'delivery',
      'adminPage': 'admin',
      'loginPage': 'login'
    };
    
    if (hashMap[previousPage]) {
      window.history.back();
    } else {
      navigateTo('homePage');
    }
  } else {
    navigateTo('homePage');
  }
}

window.addEventListener('popstate', function(event) {
  // Let the hashchange handler deal with it
});

// ===== EXIT MODAL FUNCTIONS =====
function showExitModal() {
  document.getElementById('exitModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeExitModal() {
  document.getElementById('exitModal').style.display = 'none';
  document.body.style.overflow = 'auto';
  backPressCount = 0;
}

function exitApp() {
  if (document.fullscreenElement) {
    document.exitFullscreen();
  }
  
  if (window.history.length > 1) {
    window.history.go(-1);
  } else {
    window.close();
  }
}

// ===== DELIVERY SYSTEM FUNCTIONS =====
let deliveryStatusData = [];
let businessAdminPassword = "";

async function checkForDeliveries() {
  try {
    const customerPhone = getCustomerPhone();
    
    if(!customerPhone) {
      console.log('No customer phone found for business', currentBusinessId.substring(0, 8));
      updateDeliveryIcon();
      return;
    }
    
    const { data, error } = await supa
      .from('delivery_status')
      .select('*')
      .eq('customer_phone', customerPhone)
      .eq('business_id', currentBusinessId) // Only deliveries for this business
      .order('last_updated', { ascending: false });
      
    if(error) {
      console.error('Delivery check error:', error);
      updateDeliveryIcon();
      return;
    }
    
    if(data && data.length > 0) {
      deliveryStatusData = data;
      updateDeliveryIcon();
      
      const pendingOrders = data.filter(order => order.status === 'pending');
      if (pendingOrders.length > 0) {
        showNotification(`üöö You have ${pendingOrders.length} pending delivery${pendingOrders.length > 1 ? 's' : ''}`);
      }
    } else {
      deliveryStatusData = [];
      updateDeliveryIcon();
    }
  } catch(err) {
    console.log('Delivery check failed:', err);
    updateDeliveryIcon();
  }
}

function updateDeliveryIcon() {
  const icon = document.getElementById('deliveryIcon');
  const badge = document.getElementById('deliveryBadge');
  
  if(deliveryStatusData.length > 0) {
    icon.style.color = '#10b981';
    
    badge.textContent = deliveryStatusData.length;
    badge.style.display = 'flex';
    
    const hasPending = deliveryStatusData.some(order => order.status === 'pending');
    if (hasPending) {
      badge.classList.add('alert');
    } else {
      badge.classList.remove('alert');
    }
  } else {
    icon.style.color = 'white';
    badge.style.display = 'none';
    badge.classList.remove('alert');
  }
}

function checkDeliveryStatus() {
  const customerPhone = getCustomerPhone();
  
  if(!customerPhone) {
    openPhoneInput();
    showNotification('Please add your phone number to track deliveries');
    return;
  }
  
  navigateTo('deliveryPage');
}

async function loadDeliveryStatus() {
  const phone = getCustomerPhone();
  
  if(!phone) {
    document.getElementById('deliveryContent').innerHTML = `
      <div class="no-deliveries">
        <i class="fas fa-phone"></i>
        <h3>Phone Number Needed</h3>
        <p>Please save your phone number to track deliveries.</p>
        <button onclick="openPhoneInput()" style="padding:12px 30px;background:var(--primary-gradient);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">
          Add Phone Number
        </button>
      </div>
    `;
    return;
  }
  
  const { data, error } = await supa
    .from('delivery_status')
    .select('*')
    .eq('customer_phone', phone)
    .eq('business_id', currentBusinessId)
    .order('last_updated', { ascending: false });
    
  if(error) {
    document.getElementById('deliveryContent').innerHTML = `
      <div style="text-align:center;padding:40px;color:#ef4444;">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Error loading deliveries</p>
        <button onclick="loadDeliveryStatus()" style="margin-top:15px;padding:10px 20px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;">
          Try Again
        </button>
      </div>
    `;
    return;
  }
  
  if(!data || data.length === 0) {
    document.getElementById('deliveryContent').innerHTML = `
      <div class="no-deliveries">
        <i class="fas fa-truck" style="color:#10b981;"></i>
        <h3>No Active Deliveries</h3>
        <p>Your delivery status will appear here once you place an order.</p>
        <button onclick="navigateTo('productsPage')" style="padding:12px 30px;background:var(--primary-gradient);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">
          <i class="fas fa-shopping-bag"></i> Shop Now
        </button>
      </div>
    `;
    return;
  }
  
  let html = '';
  data.forEach(order => {
    const statusClass = order.status;
    const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
    const updatedTime = new Date(order.last_updated).toLocaleString();
    
    html += `
      <div class="delivery-card ${statusClass}">
        <div class="delivery-header">
          <div class="delivery-order-id">Order #${order.order_id}</div>
          <div class="delivery-status ${statusClass}">${statusText}</div>
        </div>
        
        <div class="delivery-info">
          <i class="fas fa-user"></i>
          <span>${order.customer_name || 'Customer'}</span>
        </div>
        
        ${order.location ? `
          <div class="delivery-info">
            <i class="fas fa-map-marker-alt"></i>
            <span>${order.location}</span>
          </div>
        ` : ''}
        
        ${order.delivery_person ? `
          <div class="delivery-info">
            <i class="fas fa-user-tag"></i>
            <span>${order.delivery_person}</span>
          </div>
        ` : ''}
        
        <div class="delivery-timestamp">
          <i class="fas fa-clock"></i>
          <span>Updated: ${updatedTime}</span>
        </div>
      </div>
    `;
  });
  
  document.getElementById('deliveryContent').innerHTML = html;
}

// ===== CUSTOMER PHONE FUNCTIONS =====
function openPhoneInput() {
  const currentPhone = getCustomerPhone();
  const phone = prompt("Enter your phone number for delivery tracking:", currentPhone || "");
  
  if (phone) {
    const cleanedPhone = phone.replace(/\D/g, '');
    if (cleanedPhone.length >= 10) {
      saveCustomerPhone(cleanedPhone);
      updateCustomerPhoneDisplay();
      showNotification('‚úÖ Phone number saved successfully!');
      
      checkForDeliveries();
      
      if (currentPage === 'deliveryPage') {
        loadDeliveryStatus();
      }
    } else {
      showNotification('‚ùå Please enter a valid phone number');
    }
  }
}

function updateCustomerPhoneDisplay() {
  const phone = getCustomerPhone();
  const displayElement = document.getElementById('customerPhoneDisplay');
  
  if (phone) {
    displayElement.textContent = phone;
    displayElement.style.color = '#10b981';
    displayElement.style.fontWeight = '800';
  } else {
    displayElement.textContent = 'Tap to add your number';
    displayElement.style.color = '';
    displayElement.style.fontWeight = '';
  }
}

// ===== LOGIN/LOGOUT SYSTEM =====
function toggleLogin() {
  if (isAdminLoggedIn) {
    if (confirm("Are you sure you want to logout?")) {
      logoutAdmin();
    }
  } else {
    navigateTo('loginPage');
  }
}

function updateLoginUI() {
  const loginIcon = document.getElementById('loginIcon');
  const loginBtn = document.getElementById('loginBtn');
  
  if (isAdminLoggedIn) {
    loginIcon.className = 'fas fa-sign-out-alt';
    loginBtn.title = 'Logout';
  } else {
    loginIcon.className = 'fas fa-sign-in-alt';
    loginBtn.title = 'Login';
  }
}

function attemptLogin() {
  const passwordInput = document.getElementById('adminPasswordInput');
  const enteredPassword = passwordInput.value;
  
  if (enteredPassword === businessAdminPassword) {
    isAdminLoggedIn = true;
    isolatedLocalStorage.setItem('isAdminLoggedIn', 'true');
    updateLoginUI();
    showNotification('‚úÖ Login successful!');
    navigateTo('adminPage');
  } else {
    showNotification('‚ùå Incorrect password. Try again.');
    passwordInput.value = '';
    passwordInput.focus();
  }
}

function handleLoginKeypress(event) {
  if (event.key === 'Enter') {
    attemptLogin();
  }
}

function logoutAdmin() {
  isAdminLoggedIn = false;
  isolatedLocalStorage.removeItem('isAdminLoggedIn');
  updateLoginUI();
  showNotification('üëã Logged out successfully');
  navigateTo('homePage');
}

// ===== ADMIN FUNCTIONS =====
async function loadAdminPanel() {
  const { data, error } = await supa
    .from('delivery_status')
    .select('*')
    .eq('business_id', currentBusinessId)
    .order('last_updated', { ascending: false });
    
  if(error || !data) {
    document.getElementById('adminContent').innerHTML = '<p style="padding:20px;color:#ef4444;">Error loading data</p>';
    return;
  }
  
  let html = `
    <div style="padding: 15px; display: flex; justify-content: flex-end;">
      <button onclick="logoutAdmin()" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
    
    <input type="text" class="admin-search" id="adminSearch" placeholder="Search orders by ID, phone, name..." onkeyup="searchAdminOrders()">
    
    <button onclick="addNewOrder()" class="admin-btn">
      <i class="fas fa-plus"></i> Add New Order
    </button>
  `;
  
  if(data.length === 0) {
    html += '<p style="text-align:center;padding:40px;color:#64748b;">No orders found</p>';
  } else {
    data.forEach(order => {
      const statusClass = order.status;
      const updatedTime = new Date(order.last_updated).toLocaleString();
      
      html += `
        <div class="admin-order-card" data-order-id="${order.order_id}" data-phone="${order.customer_phone}">
          <div class="admin-order-header">
            <div>
              <div class="admin-order-id">Order #${order.order_id}</div>
              <div class="admin-customer-info">${order.customer_name || 'No name'}</div>
              <div class="admin-customer-info">${order.customer_phone}</div>
            </div>
            <div style="font-size:12px;color:#94a3b8;">${updatedTime}</div>
          </div>
          
          <select class="admin-select" data-id="${order.id}">
            <option value="pending" ${statusClass === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
            <option value="processing" ${statusClass === 'processing' ? 'selected' : ''}>üîÑ Processing</option>
            <option value="shipped" ${statusClass === 'shipped' ? 'selected' : ''}>üöö Shipped</option>
            <option value="delivered" ${statusClass === 'delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
            <option value="cancelled" ${statusClass === 'cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
          </select>
          
          <input type="text" class="admin-input" data-id="${order.id}" 
                 placeholder="Location" value="${order.location || ''}">
                 
          <input type="text" class="admin-input" data-id="${order.id}" 
                 placeholder="Delivery Person" value="${order.delivery_person || ''}">
                 
          <button onclick="updateOrder('${order.id}')" class="admin-btn success">
            Update Order
          </button>
        </div>
      `;
    });
  }
  
  document.getElementById('adminContent').innerHTML = html;
}

function searchAdminOrders() {
  const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
  const cards = document.querySelectorAll('.admin-order-card');
  
  cards.forEach(card => {
    const orderId = card.getAttribute('data-order-id').toLowerCase();
    const phone = card.getAttribute('data-phone').toLowerCase();
    const text = card.textContent.toLowerCase();
    
    if(orderId.includes(searchTerm) || phone.includes(searchTerm) || text.includes(searchTerm)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

async function updateOrder(orderId) {
  const status = document.querySelector(`.admin-select[data-id="${orderId}"]`).value;
  const location = document.querySelector(`.admin-input[data-id="${orderId}"]`).value;
  const deliveryPerson = document.querySelectorAll(`.admin-input[data-id="${orderId}"]`)[1]?.value;
  
  const { error } = await supa
    .from('delivery_status')
    .update({
      status: status,
      location: location,
      delivery_person: deliveryPerson,
      last_updated: new Date().toISOString()
    })
    .eq('id', orderId);
    
  if(!error) {
    showNotification('‚úÖ Order updated successfully!');
    loadAdminPanel();
    if(currentPage === 'deliveryPage') {
      loadDeliveryStatus();
    }
  } else {
    showNotification('‚ùå Error updating order');
  }
}

function addNewOrder() {
  const orderId = prompt("Enter Order ID:");
  const customerPhone = prompt("Enter Customer Phone:");
  const customerName = prompt("Enter Customer Name (optional):");
  
  if(!orderId || !customerPhone) {
    showNotification('‚ùå Order ID and Phone are required');
    return;
  }
  
  supa
    .from('delivery_status')
    .insert([{
      order_id: orderId,
      customer_phone: customerPhone,
      customer_name: customerName || '',
      status: 'pending',
      location: '',
      delivery_person: '',
      last_updated: new Date().toISOString(),
      business_id: currentBusinessId // Associate with this business
    }])
    .then(({ error }) => {
      if(!error) {
        showNotification('‚úÖ Order added successfully!');
        loadAdminPanel();
      } else {
        showNotification('‚ùå Error adding order: ' + error.message);
      }
    });
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message) {
  const notification = document.getElementById('notificationAlert');
  notification.textContent = message;
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

// ===== AUTO-REFRESH DELIVERIES =====
setInterval(checkForDeliveries, 30000);

// ===== MAIN APP VARIABLES =====
let currentProduct = null;
let cart = [];
let buyNowPaymentMethod = 'whatsapp';
let checkoutPaymentMethod = 'whatsapp';

// ===== BUSINESS DATA RENDER =====
async function renderApp() {
  const card = businessData.parsed;
  
  if (!card) {
    document.body.innerHTML = "<div style='padding:40px;text-align:center;color:white;'><h2>Business not found</h2></div>";
    return;
  }
  
  document.getElementById('businessHeader').textContent = card.businessName || card.name || "Premium Business";
  
  const photo = document.getElementById('photo');
  if(card.profileImage) {
    photo.src = card.profileImage;
  } else {
    photo.style.display = 'none';
  }
  
  document.getElementById('name').textContent = card.name || "";
  document.getElementById('business').textContent = card.businessName || "";
  
  document.getElementById('contactPhone').textContent = card.phone || "Not available";
  document.getElementById('contactEmail').textContent = card.email || "Not available";
  document.getElementById('contactAddress').textContent = card.address || "Not available";
  
  loadHomePage();
}

// ===== CART MANAGEMENT FUNCTIONS =====
function updateCartCount() {
  const count = cart.length;
  document.getElementById('cartCountMini').textContent = count;
  document.getElementById('cartBadge').textContent = count;
  
  isolatedLocalStorage.setItem('cart', JSON.stringify(cart));
  
  if(currentPage === 'cartPage') {
    loadCartPage();
  }
}

function addToCart(productIndex) {
  const products = businessData.parsed?.products || [];
  const product = products[productIndex];
  
  if(product) {
    const existingIndex = cart.findIndex(item => 
      item.title === product.title && 
      item.discountPrice === product.discountPrice
    );
    
    if(existingIndex === -1) {
      cart.push({
        ...product,
        index: productIndex,
        quantity: 1
      });
    } else {
      cart[existingIndex].quantity = (cart[existingIndex].quantity || 1) + 1;
    }
    updateCartCount();
    showNotification('Product added to cart!');
  }
}

function removeFromCart(index) {
  cart.splice(index, 1);
  updateCartCount();
}

function updateQuantity(index, change) {
  if(cart[index]) {
    cart[index].quantity = Math.max(1, (cart[index].quantity || 1) + change);
    loadCartPage();
  }
}

// ===== PRODUCT DISPLAY FUNCTIONS =====
function loadHomePage() {
  const featuredProducts = document.getElementById('featuredProducts');
  const products = businessData.parsed?.products || [];
  
  featuredProducts.innerHTML = '';
  
  const featuredProductsList = products.filter(product => 
    product.badges && product.badges.length > 0
  ).slice(0, 4);
  
  featuredProductsList.forEach((product, index) => {
    const originalIndex = products.findIndex(p => p.title === product.title);
    featuredProducts.appendChild(createProductCard(product, originalIndex));
  });
  
  if(featuredProductsList.length === 0) {
    products.slice(0, 4).forEach((product, index) => {
      featuredProducts.appendChild(createProductCard(product, index));
    });
  }
}

function loadProductsPage() {
  const allProducts = document.getElementById('allProducts');
  const products = businessData.parsed?.products || [];
  
  allProducts.innerHTML = '';
  
  products.forEach((product, index) => {
    allProducts.appendChild(createProductCard(product, index));
  });
}

function createProductCard(product, index) {
  const price = product.discountPrice || product.originalPrice;
  const originalPrice = product.originalPrice && product.discountPrice ? product.originalPrice : null;
  const hasDiscount = originalPrice && price && originalPrice > price;
  
  let discountPercentage = '';
  if(hasDiscount && originalPrice && price) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    if(discount > 0) {
      discountPercentage = `<div class="discount-badge">${discount}% OFF</div>`;
    }
  }
  
  let priceBadgeHtml = '';
  if(price) {
    priceBadgeHtml = `<div class="price-badge">`;
    if(hasDiscount && originalPrice) {
      priceBadgeHtml += `<div class="original-price">PKR ${originalPrice}</div>`;
      priceBadgeHtml += `<div class="current-price">PKR ${price}</div>`;
    } else {
      priceBadgeHtml += `<div class="current-price">PKR ${price}</div>`;
    }
    priceBadgeHtml += `</div>`;
  }
  
  const badgeClasses = {
    'üî• Hot Deal': 'hot',
    '‚≠ê Best Seller': 'best-seller',
    'üí∏ Discount': 'discount',
    '‚è≥ Limited Stock': 'limited',
    'üõí In Stock': 'stock',
    'üöö Free Delivery': 'delivery'
  };
  
  let badgesHtml = '';
  if(product.badges && product.badges.length > 0) {
    badgesHtml = `<div class="product-badges">`;
    product.badges.slice(0, 2).forEach(badge => {
      const badgeClass = badgeClasses[badge] || 'discount';
      badgesHtml += `<span class="badge ${badgeClass}">${badge}</span>`;
    });
    badgesHtml += `</div>`;
  }
  
  const card = document.createElement('div');
  card.className = 'product-card';
  
  card.innerHTML = `
    <div class="product-image-container" onclick="zoomImage('${product.image || ''}', event)">
      <img src="${product.image || ''}" class="product-image" loading="lazy" onerror="this.style.display='none'">
      ${discountPercentage}
      ${priceBadgeHtml}
      ${badgesHtml}
    </div>
    <div class="product-content">
      <div class="product-title">${product.title || 'Product'}</div>
      <div class="product-actions">
        <button class="btn-primary" onclick="showProductModal(${index}); event.stopPropagation();">
          <i class="fas fa-bolt"></i> Quick Buy
        </button>
        <button class="btn-secondary" onclick="addToCart(${index}); event.stopPropagation();">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>
    </div>
  `;
  
  card.onclick = (e) => {
    if (!e.target.closest('button')) {
      showProductModal(index);
    }
  };
  
  return card;
}

function zoomImage(imageUrl, event) {
  event.stopPropagation();
  
  const overlay = document.getElementById('imageZoomOverlay');
  const zoomedImage = document.getElementById('zoomedImage');
  
  if (imageUrl) {
    zoomedImage.src = imageUrl;
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeImageZoom() {
  const overlay = document.getElementById('imageZoomOverlay');
  overlay.style.display = 'none';
  document.body.style.overflow = 'auto';
}

function filterProducts() {
  const searchTerm = document.getElementById('productsSearch').value.toLowerCase();
  const products = businessData.parsed?.products || [];
  const allProducts = document.getElementById('allProducts');
  
  allProducts.innerHTML = '';
  
  const filteredProducts = products.filter(product => 
    product.title?.toLowerCase().includes(searchTerm) ||
    product.desc?.toLowerCase().includes(searchTerm) ||
    (product.badges && product.badges.some(badge => badge.toLowerCase().includes(searchTerm)))
  );
  
  filteredProducts.forEach((product, index) => {
    const originalIndex = products.findIndex(p => p.title === product.title);
    allProducts.appendChild(createProductCard(product, originalIndex));
  });
}

function loadCartPage() {
  const cartContent = document.getElementById('cartContent');
  const cartItemsCount = document.getElementById('cartItemsCount');
  
  if(cart.length === 0) {
    cartContent.innerHTML = `
      <div class="cart-empty">
        <i class="fas fa-shopping-cart"></i>
        <h3>Your cart is empty</h3>
        <p>Add some products to get started</p>
        <button onclick="navigateTo('productsPage')">
          Browse Products
        </button>
      </div>
    `;
    cartItemsCount.textContent = '0 items';
    return;
  }
  
  let html = '<div class="cart-items">';
  let total = 0;
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    total += itemTotal;
    
    html += `
      <div class="cart-item">
        <img src="${item.image || ''}" class="cart-item-img" loading="lazy" onerror="this.style.display='none'">
        <div class="cart-item-details">
          <div class="cart-item-title">${item.title || 'Product'}</div>
          <div class="cart-item-price">PKR ${itemTotal.toFixed(2)}</div>
          <div class="cart-item-actions">
            <div class="quantity-control">
              <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
              <span class="quantity">${item.quantity || 1}</span>
              <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
            </div>
            <button class="remove-btn" onclick="removeFromCart(${index})">
              Remove
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  html += `
    <div class="cart-summary">
      <h3><i class="fas fa-receipt"></i> Order Summary</h3>
      <div class="summary-row">
        <span>Subtotal</span>
        <span>PKR ${total.toFixed(2)}</span>
      </div>
      <div class="summary-row">
        <span>Shipping</span>
        <span>PKR 0</span>
      </div>
      <div class="summary-row summary-total">
        <span>Total</span>
        <span>PKR ${total.toFixed(2)}</span>
      </div>
      <button class="checkout-btn" onclick="openCheckoutModal()">
        <i class="fas fa-lock"></i> Proceed to Checkout
      </button>
    </div>
  `;
  
  cartContent.innerHTML = html;
  cartItemsCount.textContent = `${cart.length} ${cart.length === 1 ? 'item' : 'items'}`;
}

function loadAboutPage() {
  const aboutContent = document.getElementById('aboutContent');
  const businessHours = document.getElementById('businessHours');
  const holidaysList = document.getElementById('holidaysList');
  
  aboutContent.innerHTML = `
    <p>${businessData.parsed?.business?.about || 'No information available'}</p>
  `;
  
  if(businessData.parsed?.businessHours && businessData.parsed.businessHours.length > 0) {
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    businessHours.innerHTML = '';
    
    businessData.parsed.businessHours.forEach((day, index) => {
      if(day) {
        const hourItem = document.createElement('div');
        hourItem.className = 'hour-item';
        
        if(!day.open || day.status === 'closed') {
          hourItem.innerHTML = `
            <span class="day-name">${days[index]}</span>
            <span class="day-time closed">Closed</span>
          `;
        } else {
          hourItem.innerHTML = `
            <span class="day-name">${days[index]}</span>
            <span class="day-time">${day.start || ''} - ${day.end || ''}</span>
          `;
        }
        
        businessHours.appendChild(hourItem);
      }
    });
  }
  
  if(businessData.parsed?.holidays && businessData.parsed.holidays.length > 0) {
    holidaysList.innerHTML = '';
    
    businessData.parsed.holidays.forEach(holiday => {
      if(holiday.name && holiday.date) {
        const date = new Date(holiday.date);
        const formattedDate = date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
        
        const holidayItem = document.createElement('div');
        holidayItem.className = 'hour-item';
        holidayItem.innerHTML = `
          <span class="day-name">${holiday.name}</span>
          <span class="day-time">${formattedDate}</span>
        `;
        holidaysList.appendChild(holidayItem);
      }
    });
  }
}

function loadContactPage() {
  const socialGrid = document.getElementById('socialGrid');
  const socialMedia = businessData.parsed?.socialMedia || {};
  
  socialGrid.innerHTML = '';
  
  const socialPlatforms = [
    { key: 'facebook', icon: 'fab fa-facebook-f', label: 'Facebook', className: 'facebook' },
    { key: 'instagram', icon: 'fab fa-instagram', label: 'Instagram', className: 'instagram' },
    { key: 'twitter', icon: 'fab fa-twitter', label: 'Twitter', className: 'twitter' },
    { key: 'linkedin', icon: 'fab fa-linkedin-in', label: 'LinkedIn', className: 'linkedin' },
    { key: 'youtube', icon: 'fab fa-youtube', label: 'YouTube', className: 'youtube' },
    { key: 'tiktok', icon: 'fab fa-tiktok', label: 'TikTok', className: 'tiktok' }
  ];
  
  socialPlatforms.forEach(platform => {
    const url = socialMedia[platform.key];
    if(url && url.trim()) {
      const socialLink = document.createElement('a');
      socialLink.className = 'social-link';
      socialLink.href = url.includes('://') ? url : `https://${url}`;
      socialLink.target = '_blank';
      socialLink.innerHTML = `
        <div class="social-icon ${platform.className}">
          <i class="${platform.icon}"></i>
        </div>
        <div class="social-label">${platform.label}</div>
      `;
      socialGrid.appendChild(socialLink);
    }
  });
}

function showProductModal(productIndex) {
  const products = businessData.parsed?.products || [];
  currentProduct = products[productIndex];
  
  if(!currentProduct) return;
  
  const price = currentProduct.discountPrice || currentProduct.originalPrice;
  const originalPrice = currentProduct.originalPrice && currentProduct.discountPrice ? currentProduct.originalPrice : null;
  const hasDiscount = originalPrice && price && originalPrice > price;
  
  document.getElementById('modalImage').src = currentProduct.image || '';
  document.getElementById('modalTitle').textContent = currentProduct.title || 'Product';
  document.getElementById('modalDescription').textContent = currentProduct.desc || 'No description available';
  
  const modalPrice = document.getElementById('modalPrice');
  if(hasDiscount) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    modalPrice.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <div style="text-decoration:line-through;color:#94a3b8;font-size:16px;font-weight:500;">PKR ${originalPrice}</div>
        <div style="color:#10b981;font-size:24px;font-weight:900;">PKR ${price}</div>
        <div style="background:var(--danger-gradient);color:white;padding:4px 8px;border-radius:4px;font-size:13px;font-weight:800;">${discount}% OFF</div>
      </div>
    `;
  } else {
    modalPrice.innerHTML = `
      <div style="color:#10b981;font-size:24px;font-weight:900;">PKR ${price || 'N/A'}</div>
    `;
  }
  
  document.getElementById('directCheckoutSection').style.display = 'none';
  selectBuyNowPayment('whatsapp');
  
  openModal('productModal');
}

function showDirectCheckout() {
  document.getElementById('directCheckoutSection').style.display = 'block';
}

function addToCartFromModal() {
  if(currentProduct) {
    const products = businessData.parsed?.products || [];
    const productIndex = products.findIndex(p => p.title === currentProduct.title);
    
    if(productIndex !== -1) {
      addToCart(productIndex);
      closeModal('productModal');
    }
  }
}

function selectBuyNowPayment(method) {
  buyNowPaymentMethod = method;
  
  const whatsappOption = document.getElementById('whatsappBuyNowOption');
  const codOption = document.getElementById('codBuyNowOption');
  const jazzcashOption = document.getElementById('jazzcashBuyNowOption');
  
  [whatsappOption, codOption, jazzcashOption].forEach(option => {
    if(option) {
      option.style.borderColor = '#e2e8f0';
    }
  });
  
  if(method === 'whatsapp' && whatsappOption) {
    whatsappOption.style.borderColor = '#25D366';
  } else if(method === 'cod' && codOption) {
    codOption.style.borderColor = '#10b981';
  } else if(method === 'jazzcash' && jazzcashOption) {
    jazzcashOption.style.borderColor = '#FF6B00';
  }
}

function checkoutBuyNow() {
  if(!currentProduct) return;
  
  const payments = businessData.parsed?.payments || {};
  if(buyNowPaymentMethod === 'jazzcash' && payments?.jazzcash?.active) {
    showPaymentDetailsModal('buyNow');
  } else {
    sendBuyNowOrder();
  }
}

function sendBuyNowOrder() {
  if(!currentProduct) return;
  
  const card = businessData.parsed;
  const price = currentProduct.discountPrice || currentProduct.originalPrice || 0;
  const businessName = card.businessName || card.name || "Your Business";
  
  let message = `Hello ${businessName} Team,\n\n`;
  message += `I would like to place an order for the following product:\n\n`;
  message += `üõí **Product:** ${currentProduct.title || 'Product'}\n`;
  message += `üí∞ **Price:** PKR ${price}\n`;
  
  if(currentProduct.desc) {
    message += `üìù **Description:** ${currentProduct.desc}\n`;
  }
  
  message += `\n---\n`;
  message += `üí≥ **Payment Method:** ${getPaymentMethodName(buyNowPaymentMethod)}\n`;
  
  const payments = businessData.parsed?.payments || {};
  if(buyNowPaymentMethod === 'jazzcash' && payments?.jazzcash?.active) {
    message += `üì± **Payment Details:** Amount sent to ${payments.jazzcash.number || ''}\n`;
    message += `üí∏ **Via:** ${payments.jazzcash.type === 'easypaisa' ? 'EasyPaisa' : 'JazzCash'}\n`;
  } else if(buyNowPaymentMethod === 'cod') {
    message += `üì¶ **Delivery:** I prefer Cash on Delivery\n`;
  }
  
  message += `\nPlease confirm product availability and share estimated delivery time.\n`;
  message += `Thank you!\n`;
  
  if(card.phone) {
    const phone = card.phone.replace(/\D/g, '');
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
  }
  
  closeModal('productModal');
}

function openCheckoutModal() {
  const checkoutItems = document.getElementById('checkoutItems');
  let subtotal = 0;
  
  checkoutItems.innerHTML = '';
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    subtotal += itemTotal;
    
    checkoutItems.innerHTML += `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:12px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0;">
        <div>
          <div style="font-weight:800;color:var(--dark-color);margin-bottom:4px;">${item.title || 'Product'}</div>
          <div style="font-size:12px;color:#64748b;">Qty: ${item.quantity || 1}</div>
        </div>
        <div style="font-weight:800;color:var(--dark-color);font-size:16px;">PKR ${itemTotal.toFixed(2)}</div>
      </div>
    `;
  });
  
  document.getElementById('checkoutSubtotal').textContent = subtotal.toFixed(2);
  document.getElementById('checkoutTotal').textContent = subtotal.toFixed(2);
  selectCheckoutPayment('whatsapp');
  
  openModal('checkoutModal');
}

function selectCheckoutPayment(method) {
  checkoutPaymentMethod = method;
  
  const whatsappOption = document.getElementById('whatsappCheckoutOption');
  const codOption = document.getElementById('codCheckoutOption');
  const jazzcashOption = document.getElementById('jazzcashCheckoutOption');
  
  [whatsappOption, codOption, jazzcashOption].forEach(option => {
    if(option) {
      option.style.borderColor = '#e2e8f0';
    }
  });
  
  if(method === 'whatsapp' && whatsappOption) {
    whatsappOption.style.borderColor = '#25D366';
  } else if(method === 'cod' && codOption) {
    codOption.style.borderColor = '#10b981';
  } else if(method === 'jazzcash' && jazzcashOption) {
    jazzcashOption.style.borderColor = '#FF6B00';
  }
}

function proceedToPayment() {
  if(cart.length === 0) return;
  
  const payments = businessData.parsed?.payments || {};
  if(checkoutPaymentMethod === 'jazzcash' && payments?.jazzcash?.active) {
    showPaymentDetailsModal('checkout');
  } else {
    sendCheckoutOrder();
  }
}

function showPaymentDetailsModal(context) {
  const paymentMethodTitle = document.getElementById('paymentMethodTitle');
  const paymentDetailsContent = document.getElementById('paymentDetailsContent');
  const card = businessData.parsed;
  const payments = businessData.parsed?.payments || {};
  const businessName = card.businessName || card.name || "Your Business";
  
  if(context === 'buyNow' && currentProduct) {
    const price = currentProduct.discountPrice || currentProduct.originalPrice || 0;
    paymentMethodTitle.innerHTML = `JazzCash Payment`;
    
    paymentDetailsContent.innerHTML = `
      <div style="text-align:center;">
        <div style="margin-bottom:20px;">
          <div style="font-size:15px;color:#64748b;margin-bottom:12px;">Send <strong style="color:#10b981;font-size:20px;">PKR ${price}</strong> to:</div>
          <div style="font-size:24px;font-weight:900;color:#FF6B00;margin:15px 0;background:rgba(255,107,0,0.1);padding:15px;border-radius:16px;">
            ${payments.jazzcash?.number || ''}
          </div>
          <div style="font-size:13px;color:#64748b;margin-top:10px;">For: ${currentProduct.title || 'Product'}</div>
        </div>
        
        ${payments.jazzcash?.barcode ? `
          <div style="margin:20px 0;text-align:center;">
            <div style="font-size:14px;color:#64748b;margin-bottom:12px;font-weight:700;">Scan QR Code to Pay</div>
            <img src="${payments.jazzcash.barcode}" style="max-width:200px;max-height:200px;border-radius:16px;border:2px solid #e2e8f0;display:block;margin:0 auto;background:white;padding:12px;">
          </div>
        ` : ''}
        
        <div style="background:#f0f9ff;padding:15px;border-radius:16px;margin-top:20px;">
          <div style="font-size:14px;color:#64748b;margin-bottom:10px;font-weight:800;">Instructions:</div>
          <ol style="text-align:left;padding-left:20px;margin:12px 0;color:#475569;line-height:1.6;">
            <li style="margin-bottom:8px;">Complete payment using the QR code or number above</li>
            <li style="margin-bottom:8px;">Take screenshot of payment confirmation</li>
            <li>Share screenshot via WhatsApp for order verification</li>
          </ol>
        </div>
      </div>
    `;
  } else if(context === 'checkout') {
    const total = cart.reduce((sum, item) => {
      const price = parseFloat(item.discountPrice || item.originalPrice || 0);
      return sum + (price * (item.quantity || 1));
    }, 0);
    
    paymentMethodTitle.innerHTML = `JazzCash Payment`;
    
    paymentDetailsContent.innerHTML = `
      <div style="text-align:center;">
        <div style="margin-bottom:20px;">
          <div style="font-size:15px;color:#64748b;margin-bottom:12px;">Send <strong style="color:#10b981;font-size:20px;">PKR ${total.toFixed(2)}</strong> to:</div>
          <div style="font-size:24px;font-weight:900;color:#FF6B00;margin:15px 0;background:rgba(255,107,0,0.1);padding:15px;border-radius:16px;">
            ${payments.jazzcash?.number || ''}
          </div>
          <div style="font-size:13px;color:#64748b;margin-top:10px;">For: ${businessName} - Order (${cart.length} items)</div>
        </div>
        
        ${payments.jazzcash?.barcode ? `
          <div style="margin:20px 0;text-align:center;">
            <div style="font-size:14px;color:#64748b;margin-bottom:12px;font-weight:700;">Scan QR Code to Pay</div>
            <img src="${payments.jazzcash.barcode}" style="max-width:200px;max-height:200px;border-radius:16px;border:2px solid #e2e8f0;display:block;margin:0 auto;background:white;padding:12px;">
          </div>
        ` : ''}
        
        <div style="background:#f0f9ff;padding:15px;border-radius:16px;margin-top:20px;">
          <div style="font-size:14px;color:#64748b;margin-bottom:10px;font-weight:800;">Instructions:</div>
          <ol style="text-align:left;padding-left:20px;margin:12px 0;color:#475569;line-height:1.6;">
            <li style="margin-bottom:8px;">Complete payment using the QR code or number above</li>
            <li style="margin-bottom:8px;">Take screenshot of payment confirmation</li>
            <li>Share screenshot via WhatsApp for order verification</li>
          </ol>
        </div>
      </div>
    `;
  }
  
  openModal('paymentDetailsModal');
  closeModal(context === 'buyNow' ? 'productModal' : 'checkoutModal');
}

function confirmPayment() {
  if(currentPage === 'checkoutModal' || checkoutPaymentMethod === 'jazzcash') {
    sendCheckoutOrder();
  } else {
    sendBuyNowOrder();
  }
  closeModal('paymentDetailsModal');
}

function sendCheckoutOrder() {
  if(cart.length === 0) return;
  
  const card = businessData.parsed;
  const businessName = card.businessName || card.name || "Your Business";
  
  let message = `Hello ${businessName} Team,\n\n`;
  message += `I would like to place an order:\n\n`;
  message += `üõí **Order Details:**\n`;
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const total = price * (item.quantity || 1);
    message += `${index + 1}. ${item.title || 'Product'} - Qty: ${item.quantity || 1} - PKR ${total.toFixed(2)}\n`;
  });
  
  const orderTotal = cart.reduce((sum, item) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    return sum + (price * (item.quantity || 1));
  }, 0);
  
  message += `\n---\n`;
  message += `üí∞ **Subtotal:** PKR ${orderTotal.toFixed(2)}\n`;
  message += `üì¶ **Shipping:** PKR 0\n`;
  message += `üéØ **Total:** PKR ${orderTotal.toFixed(2)}\n\n`;
  
  message += `üí≥ **Payment Method:** ${getPaymentMethodName(checkoutPaymentMethod)}\n`;
  
  const payments = businessData.parsed?.payments || {};
  if(checkoutPaymentMethod === 'jazzcash' && payments?.jazzcash?.active) {
    message += `üì± **Payment Details:** Amount sent to ${payments.jazzcash.number || ''}\n`;
    message += `üí∏ **Via:** ${payments.jazzcash.type === 'easypaisa' ? 'EasyPaisa' : 'JazzCash'}\n`;
  } else if(checkoutPaymentMethod === 'cod') {
    message += `üì¶ **Delivery:** I prefer Cash on Delivery\n`;
  }
  
  message += `\nPlease confirm all items are available and share estimated delivery time.\n`;
  message += `Delivery address will be shared in next message.\n`;
  message += `Thank you!\n`;
  
  if(card.phone) {
    const phone = card.phone.replace(/\D/g, '');
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
  }
  
  cart = [];
  updateCartCount();
  closeModal('checkoutModal');
  navigateTo('homePage');
}

function getPaymentMethodName(method) {
  const payments = businessData.parsed?.payments || {};
  switch(method) {
    case 'whatsapp': return 'WhatsApp Order';
    case 'cod': return 'Cash on Delivery';
    case 'jazzcash': return payments?.jazzcash?.type === 'easypaisa' ? 'EasyPaisa' : 'JazzCash';
    default: return 'WhatsApp Order';
  }
}

function openWhatsAppChat(context) {
  const card = businessData.parsed;
  if(!card.phone) {
    showNotification('WhatsApp number not available');
    return;
  }
  
  const phone = card.phone.replace(/\D/g, '');
  const businessName = card.businessName || card.name || "Your Business";
  
  let message = `Hello ${businessName} Team,\n\n`;
  message += `I came across your business and I'm interested in your products/services.\n`;
  message += `Could you please share more information about:\n`;
  message += `1. Current offers/discounts\n`;
  message += `2. Product availability\n`;
  message += `3. Delivery options and charges\n\n`;
  message += `Thank you!`;
  
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
}

function makeCall() {
  const card = businessData.parsed;
  if(card.phone) {
    window.open(`tel:${card.phone}`);
  }
}

function sendEmail() {
  const card = businessData.parsed;
  if(card.email) {
    const subject = encodeURIComponent(`Inquiry - ${card.businessName || 'Business'}`);
    const body = encodeURIComponent(`Hello,\n\nI would like to know more about your products/services.\n\nPlease share more information.\n\nThank you!`);
    window.open(`mailto:${card.email}?subject=${subject}&body=${body}`);
  }
}

function openMap() {
  const card = businessData.parsed;
  if(card.address) {
    window.open(`https://maps.google.com/?q=${encodeURIComponent(card.address)}`, '_blank');
  }
}

function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  document.body.style.overflow = 'auto';
}

function openDeliveryModal() {
  document.getElementById('deliveryStatusModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeDeliveryModal() {
  document.getElementById('deliveryStatusModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// ===== INITIALIZE APP =====
document.addEventListener("DOMContentLoaded", async () => {
  // Check for business ID in URL
  const urlParams = new URLSearchParams(location.search);
  let id = urlParams.get("id") || localStorage.getItem("lastBusinessId");
  
  // If it's a short ID (7 characters), map it to full UUID
  if (id && id.length === 7) {
    const { data: mapping } = await supa
      .from('short_urls')
      .select('full_id')
      .eq('short_id', id)
      .single();
    
    if (mapping) {
      id = mapping.full_id;
      shortBusinessId = mapping.short_id;
    }
  } else {
    // Generate short ID for new businesses
    if (id && id.length === 36) { // UUID length
      const shortId = generateShortId();
      await supa
        .from('short_urls')
        .insert([{ short_id: shortId, full_id: id }]);
      shortBusinessId = shortId;
    }
  }
  
  if(!id) {
    document.body.innerHTML = "<div style='padding:40px;text-align:center;color:white;'><h2>Business not found</h2></div>";
    return;
  }

  // Save the business ID globally
  localStorage.setItem("lastBusinessId", id);
  currentBusinessId = id;
  
  // Load business data
  const rawData = await loadBusinessData(id);
  
  if (!rawData) {
    document.body.innerHTML = "<div style='padding:40px;text-align:center;color:white;'><h2>Business data not found</h2></div>";
    return;
  }
  
  // Parse and store business data
  businessData = {
    raw: rawData,
    parsed: parseBusinessData(rawData)
  };
  
  // Load cart from isolated storage
  cart = JSON.parse(isolatedLocalStorage.getItem('cart')) || [];
  
  // Load admin login status
  isAdminLoggedIn = isolatedLocalStorage.getItem('isAdminLoggedIn') === 'true';
  
  // Generate unique admin password for this business
  businessAdminPassword = generateAdminPassword(id);
  console.log("Admin password generated for business", id.substring(0, 8), ":", businessAdminPassword);
  
  // Update password hint with short ID
  if (shortBusinessId) {
    document.getElementById('passwordHint').textContent = 
      `Hint: Password format is business123_${shortBusinessId.substring(0, 8).toLowerCase()}`;
  }
  
  // Save business phone for admin check
  if (businessData.parsed.phone) {
    saveBusinessPhone(businessData.parsed.phone);
  }
  
  setTimeout(async () => {
    await renderApp();
    
    // Initialize routing after render
    initializeRouting();
    
    // Start with home page
    navigationHistory.push('homePage');
    
    updateCartCount();
    updateLoginUI();
    updateCustomerPhoneDisplay();
    
    // Check for deliveries
    setTimeout(() => {
      checkForDeliveries();
    }, 1000);
  }, 2000);
});
</script>
</body>
</html>
