<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title id="dynamicTitle">Digital Business - 8SnzR9</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f172a" id="themeColorMeta">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Premium Digital Business App">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap">
<link rel="manifest" href="manifest.json" id="manifestLink">
<style>
/* ===== COMPLETE STYLES - AP KA OLD STYLE SAME HAI ===== */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
  --whatsapp-gradient: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --dark-color: #0f172a;
  --darker-color: #020617;
  --light-color: #f8fafc;
  --lighter-color: #ffffff;
  --glass-bg: rgba(255, 255, 255, 0.98);
  --glass-border: rgba(255, 255, 255, 0.2);
  --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  --shadow-lg: 0 20px 60px rgba(0,0,0,0.15);
  --shadow-md: 0 10px 30px rgba(0,0,0,0.1);
  --shadow-sm: 0 4px 15px rgba(0,0,0,0.08);
  --border-radius-xl: 32px;
  --border-radius-lg: 24px;
  --border-radius-md: 16px;
  --border-radius-sm: 12px;
  --border-radius-xs: 8px;
  --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'Poppins', sans-serif;
  background: var(--primary-gradient);
  min-height: 100vh;
  color: var(--dark-color);
  position: fixed;
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: none;
}
.app-container {
  position: relative;
  width: 100%;
  height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  background: var(--light-color);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
  border-radius: 0;
}
.page {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 0;
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--light-color);
  transform: translateX(100%);
  opacity: 0;
  visibility: hidden;
  transition: var(--transition-slow);
  z-index: 1;
}
.page.active {
  transform: translateX(0);
  opacity: 1;
  visibility: visible;
  z-index: 2;
}
.page.slide-out {
  transform: translateX(-100%);
  opacity: 0;
  visibility: hidden;
}
#loadingScreen {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: var(--primary-gradient);
  z-index: 100;
}
.loader {
  width: 80px;
  height: 80px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 30px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-width: 480px;
  height: 70px;
  background: var(--glass-bg);
  backdrop-filter: blur(30px);
  border-top: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0 15px;
  z-index: 1000;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
  border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 8px;
  border-radius: var(--border-radius-md);
  cursor: pointer;
  transition: var(--transition);
  flex: 1;
  position: relative;
}
.nav-item.active { background: rgba(102, 126, 234, 0.1); }
.nav-icon {
  font-size: 22px;
  color: #64748b;
  transition: var(--transition);
  position: relative;
}
.nav-item.active .nav-icon {
  color: #667eea;
  transform: scale(1.1);
}
.nav-label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  transition: var(--transition);
}
.nav-item.active .nav-label {
  color: #667eea;
  font-weight: 700;
}
.header-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  max-width: 480px;
  height: 80px;
  background: rgba(102, 126, 234, 0.95);
  backdrop-filter: blur(30px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 1001;
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}
.header-back-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: absolute;
  left: 16px;
  top: 18px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.save-contact-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: absolute;
  left: 76px;
  top: 18px;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.header-icons {
  position: absolute;
  top: 18px;
  right: 16px;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 12px;
  z-index: 9998;
}
.header-icon-btn {
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  transition: var(--transition-fast);
  color: white;
  font-size: 20px;
  position: relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.delivery-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #10b981;
  color: white;
  font-size: 10px;
  font-weight: 900;
  min-width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid rgba(255,255,255,0.5);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 11;
}
.cart-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ef4444;
  color: white;
  font-size: 11px;
  font-weight: 900;
  min-width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
  z-index: 12;
  padding: 0 4px;
}
.notification-drawer {
  position: fixed;
  top: 0;
  right: -350px;
  width: 320px;
  height: 100%;
  background: var(--glass-bg);
  backdrop-filter: blur(30px);
  border-left: 1px solid var(--glass-border);
  box-shadow: -10px 0 40px rgba(0,0,0,0.2);
  z-index: 2000;
  transition: var(--transition-slow);
  display: flex;
  flex-direction: column;
}
.notification-drawer.open { right: 0; }
.products-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  padding: 0 12px;
  align-items: stretch;
  margin-bottom: 20px;
}
.product-card {
  height: 280px;
  width: 100%;
  display: flex;
  flex-direction: column;
  background: var(--lighter-color);
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  padding: 10px;
  overflow: hidden;
  transition: var(--transition-fast);
  cursor: pointer;
  position: relative;
  min-height: 280px;
  max-height: 280px;
}
.product-image-container {
  position: relative;
  width: 100%;
  height: 160px;
  background: #f8fafc;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 8px;
  flex-shrink: 0;
  border: 1px solid #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
}
.product-image {
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  display: block;
  padding: 4px;
}
.badge-container {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  z-index: 15;
}
.discount-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background: rgba(239, 68, 68, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 10px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 800;
  box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}
.offer-badge {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(16, 185, 129, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 12px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}
.feature-badge {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(139, 92, 246, 0.9);
  backdrop-filter: blur(4px);
  color: white;
  padding: 4px 10px;
  border-radius: 30px;
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.3);
  z-index: 20;
}
.product-content {
  display: flex;
  flex-direction: column;
  flex: 1;
  padding: 0 2px;
  position: relative;
}
.product-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--dark-color);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  height: 34px;
  margin-bottom: 6px;
}
.price-badge-container {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  height: 24px;
}
.current-price {
  font-weight: 900;
  color: #10b981;
  font-size: 15px;
  background: rgba(16, 185, 129, 0.1);
  padding: 4px 10px;
  border-radius: 20px;
  display: inline-flex;
  align-items: center;
}
.original-price {
  text-decoration: line-through;
  color: #94a3b8;
  font-size: 11px;
  font-weight: 500;
  margin-left: 8px;
}
.product-actions {
  display: flex;
  gap: 8px;
  height: 32px;
  margin-top: auto;
}
.btn-primary, .btn-secondary {
  flex: 1;
  height: 32px;
  border: none;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  transition: var(--transition-fast);
  white-space: nowrap;
  padding: 0 8px;
}
.btn-primary { background: var(--success-gradient); color: white; }
.btn-secondary { background: var(--info-gradient); color: white; }
.image-zoom-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}
.image-zoom-content {
  max-width: 90%;
  max-height: 90%;
  animation: zoomIn 0.3s ease;
}
.exit-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  padding: 20px;
}
.install-button-container {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  animation: slideDown 0.5s ease;
}
.install-btn {
  padding: 12px 24px;
  background: var(--primary-gradient);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 8px;
}
.order-card {
  background: var(--lighter-color);
  border-radius: var(--border-radius-lg);
  padding: 16px;
  margin: 12px 16px;
  box-shadow: var(--shadow-md);
  border: 1px solid #e2e8f0;
  border-left: 5px solid #667eea;
}
.address-auto-detect {
  background: var(--light-color);
  border-radius: var(--border-radius-md);
  padding: 16px;
  margin: 16px 0;
  border: 2px dashed #667eea;
}
.delivery-charge-calculator {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: var(--border-radius-md);
  padding: 20px;
  margin: 16px 0;
  border: 1px solid #e2e8f0;
}
.pro-payment-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin: 16px 0;
}
.pro-payment-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: var(--border-radius-md);
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}
.pro-payment-card.selected {
  border-color: #10b981;
  background: #f0fdf4;
}
.order-ticket {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: var(--border-radius-lg);
  padding: 24px;
  margin: 20px 0;
  color: white;
  position: relative;
  overflow: hidden;
}
.token-management {
  background: white;
  border-radius: var(--border-radius-lg);
  padding: 20px;
  margin: 16px;
  box-shadow: var(--shadow-md);
}
.token-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(15px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  padding: 20px;
}
.modal-content {
  background: var(--glass-bg);
  border-radius: var(--border-radius-xl);
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--glass-border);
}
.close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(0,0,0,0.1);
  color: var(--dark-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  cursor: pointer;
  z-index: 10;
}
.product-modal-image-container {
  position: relative;
  width: 100%;
  min-height: 200px;
  max-height: 300px;
  background: #f8fafc;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #f1f5f9;
}
.product-modal-image {
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 280px;
  object-fit: contain;
  display: block;
  padding: 8px;
}
.modal-price-container {
  margin-bottom: 16px;
  padding: 12px 0;
  border-bottom: 1px solid #f1f5f9;
}
.notification-alert {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--whatsapp-gradient);
  color: white;
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: var(--shadow-xl);
  z-index: 3000;
  max-width: 300px;
  animation: slideIn 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
  font-weight: 700;
  font-size: 14px;
  text-align: center;
  display: none;
}
#homePage, #productsPage, #cartPage, #aboutPage, #contactPage, #deliveryPage, #adminPage, #loginPage {
  padding-top: 80px;
  padding-bottom: 100px;
  background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
}
.app-header {
  background: var(--primary-gradient);
  padding: 30px 25px;
  border-radius: 0 0 50px 50px;
  margin: 0;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-md);
}
.quick-actions {
  display: grid;
  grid-template-columns: repeat(4,1fr);
  gap: 12px;
  margin-top: 30px;
}
.action-card {
  background: rgba(255,255,255,0.2);
  padding: 12px;
  border-radius: 16px;
  text-align: center;
  color: white;
  cursor: pointer;
}
@media (max-width: 480px) {
  .app-container { max-width: 100%; }
  .pro-payment-grid { grid-template-columns: 1fr; }
  .token-stats { grid-template-columns: 1fr; }
  .quick-actions { grid-template-columns: repeat(2,1fr); }
  .notification-drawer { width: 100%; right: -100%; }
}
@keyframes slideIn {
  from { top: 50px; opacity: 0; }
  to { top: 100px; opacity: 1; }
}
@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}
@keyframes slideDown {
  from { top: -100px; opacity: 0; }
  to { top: 20px; opacity: 1; }
}
@keyframes zoomIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #f1f5f9; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>
</head>
<body>
<div class="app-container">
  <!-- ===== FIXED HEADER ===== -->
  <div class="header-container">
    <button class="header-back-btn" id="headerBackBtn" onclick="window.goBack()" style="display:none;">
      <i class="fas fa-arrow-left"></i>
    </button>
    <button class="save-contact-btn" onclick="window.saveBusinessToContacts()" title="Save to Contacts">
      <i class="fas fa-address-card"></i>
    </button>
    <div class="header-icons">
      <div class="header-icon-btn" onclick="window.toggleNotificationDrawer()" title="Notifications">
        <i class="fas fa-bell" id="notificationBell"></i>
        <div class="delivery-badge" id="notificationBadge" style="display:none;">!</div>
      </div>
      <div class="header-icon-btn" id="deliveryStatusBtn" onclick="window.checkDeliveryStatus()" title="Delivery Status">
        <i class="fas fa-truck" id="deliveryIcon"></i>
        <div class="delivery-badge" id="deliveryBadge" style="display:none;"></div>
      </div>
      <div class="header-icon-btn" id="loginBtn" onclick="window.toggleLogin()" title="Login/Logout">
        <i class="fas fa-sign-in-alt" id="loginIcon"></i>
      </div>
      <div class="header-icon-btn" onclick="window.shareBusiness()" title="Share Business">
        <i class="fas fa-share-alt"></i>
      </div>
    </div>
  </div>

  <!-- ===== NOTIFICATION DRAWER ===== -->
  <div class="notification-drawer" id="notificationDrawer">
    <div class="notification-header">
      <h3><i class="fas fa-bell"></i> Notifications <span class="notification-count" id="notificationCount">0</span></h3>
      <button onclick="window.toggleNotificationDrawer()" style="background: none; border: none; font-size: 24px; color: var(--dark-color); cursor: pointer;">×</button>
    </div>
    <div class="notification-content" id="notificationList"></div>
    <div class="notification-actions">
      <button onclick="window.markAllNotificationsAsRead()" style="flex:1; padding: 10px; background: #f1f5f9; border: none; border-radius: 8px; font-weight: 700; color: #64748b; cursor: pointer;">Mark All Read</button>
      <button onclick="window.enableNotifications()" style="flex:1; padding: 10px; background: var(--primary-gradient); border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer;">Enable Alerts</button>
    </div>
  </div>

  <!-- ===== IMAGE ZOOM OVERLAY ===== -->
  <div class="image-zoom-overlay" id="imageZoomOverlay" onclick="window.closeImageZoom()">
    <img src="" class="image-zoom-content" id="zoomedImage">
  </div>

  <!-- ===== EXIT MODAL ===== -->
  <div class="exit-modal-overlay" id="exitModal">
    <div class="exit-modal">
      <h2><i class="fas fa-sign-out-alt"></i> Exit App?</h2>
      <p>Are you sure you want to exit? Press back again to confirm.</p>
      <div class="exit-modal-buttons">
        <button class="exit-modal-btn cancel" onclick="window.closeExitModal()"><i class="fas fa-times"></i> Cancel</button>
        <button class="exit-modal-btn exit" onclick="window.exitApp()"><i class="fas fa-sign-out-alt"></i> Exit</button>
      </div>
    </div>
  </div>

  <!-- ===== INSTALL PERMISSION MODAL ===== -->
  <div class="exit-modal-overlay" id="installPermissionModal" style="display:none;">
    <div class="install-permission-modal" style="background:white; max-width:340px; padding:24px; border-radius:24px;">
      <h2 style="margin-bottom:12px;"><i class="fas fa-download" style="color:#667eea;"></i> Enhance Your Experience</h2>
      <p style="margin-bottom:16px; color:#64748b;">To provide you with the best experience, we'd like to:</p>
      <div class="permission-features" style="margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Save business details to your contacts</span></div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Enable push notifications for orders</span></div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><i class="fas fa-check-circle" style="color:#10b981;"></i><span>Install app for quick access</span></div>
      </div>
      <p style="font-size: 14px; color: #94a3b8; margin-bottom:20px;">Your data is secure and never shared with third parties.</p>
      <div class="permission-buttons" style="display:flex; gap:12px;">
        <button class="permission-btn cancel" onclick="window.closeInstallPermissionModal()" style="flex:1; padding:12px; background:#f1f5f9; border:none; border-radius:12px; font-weight:700; color:#475569; cursor:pointer;"><i class="fas fa-times"></i> Skip</button>
        <button class="permission-btn accept" onclick="window.acceptInstallPermissions()" style="flex:1; padding:12px; background:var(--success-gradient); border:none; border-radius:12px; font-weight:700; color:white; cursor:pointer;"><i class="fas fa-check"></i> Accept & Continue</button>
      </div>
    </div>
  </div>

  <!-- ===== LOADING SCREEN ===== -->
  <div id="loadingScreen" class="page active">
    <div class="loader"></div>
    <h1 id="loadingTitle">Digital Business</h1>
    <p id="loadingSubtitle">Loading your premium business experience...</p>
  </div>

  <!-- ===== HOME PAGE ===== -->
  <div id="homePage" class="page">
    <div class="app-header">
      <div class="welcome-text">
        <h1 id="businessHeader" style="color:white;">Welcome</h1>
        <p style="color:rgba(255,255,255,0.9);">Premium business at your fingertips</p>
      </div>
      <div class="quick-actions">
        <div class="action-card" onclick="window.navigateTo('productsPage')">
          <div class="action-icon"><i class="fas fa-shopping-bag" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Shop Now</h3>
          <p style="font-size:11px; opacity:0.9;">Browse products</p>
        </div>
        <div class="action-card" onclick="window.navigateTo('cartPage')">
          <div class="action-icon"><i class="fas fa-shopping-cart" style="font-size:24px; position:relative;" id="cartIcon">
            <span class="cart-badge" id="cartBadge" style="display:none;">0</span>
          </i></div>
          <h3 style="font-size:14px; margin-top:8px;">My Cart</h3>
          <p style="font-size:11px; opacity:0.9;"><span id="cartCountMini">0</span> items</p>
        </div>
        <div class="action-card" onclick="window.openWhatsAppChat()">
          <div class="action-icon"><i class="fab fa-whatsapp" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Live Chat</h3>
          <p style="font-size:11px; opacity:0.9;">Instant support</p>
        </div>
        <div class="action-card" onclick="window.navigateTo('contactPage')">
          <div class="action-icon"><i class="fas fa-map-marker-alt" style="font-size:24px;"></i></div>
          <h3 style="font-size:14px; margin-top:8px;">Location</h3>
          <p style="font-size:11px; opacity:0.9;">Find us</p>
        </div>
      </div>
    </div>
    <div class="profile-section" style="display:flex; align-items:center; gap:16px; padding:20px; background:white; margin:20px; border-radius:20px; box-shadow:var(--shadow-md);">
      <img src="" id="photo" class="profile-avatar" loading="lazy" style="width:64px; height:64px; border-radius:50%; object-fit:cover; border:3px solid var(--primary-gradient);">
      <div>
        <div class="profile-name" style="display:flex; align-items:center; gap:6px;">
          <span id="name" style="font-size:18px; font-weight:800; color:var(--dark-color);">Loading...</span>
          <i class="fas fa-badge-check verified-badge" style="color:#10b981;"></i>
        </div>
        <div class="profile-business" id="business" style="font-size:14px; color:#64748b; margin-top:4px;"></div>
      </div>
    </div>
    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; padding:0 16px; margin-bottom:16px;">
      <h2 style="font-size:18px; font-weight:800; color:var(--dark-color); display:flex; align-items:center; gap:8px;">
        <i class="fas fa-gift" style="color:#667eea;"></i> Featured Products
      </h2>
      <div class="see-all" onclick="window.navigateTo('productsPage')" style="font-size:14px; color:#667eea; font-weight:600; cursor:pointer;">See All <i class="fas fa-arrow-right"></i></div>
    </div>
    <div class="products-grid" id="featuredProducts"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== PRODUCTS PAGE ===== -->
  <div id="productsPage" class="page">
    <div class="products-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">Products & Offers</h1>
      <p style="color:#64748b; margin-top:4px;">Discover our premium collection</p>
    </div>
    <div class="products-search" style="position:relative; margin:16px; padding:0 4px;">
      <input type="text" id="productsSearch" placeholder="Search products..." onkeyup="window.filterProducts()" style="width:100%; padding:14px 20px; padding-left:50px; border:2px solid #e2e8f0; border-radius:30px; font-size:15px;">
      <i class="fas fa-search" style="position:absolute; left:24px; top:50%; transform:translateY(-50%); color:#94a3b8;"></i>
    </div>
    <div class="products-grid" id="allProducts"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== CART PAGE ===== -->
  <div id="cartPage" class="page">
    <div class="cart-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">My Cart</h1>
      <p id="cartItemsCount" style="color:#64748b; margin-top:4px;">0 items</p>
    </div>
    <div id="cartContent" style="padding:16px;"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== ABOUT PAGE ===== -->
  <div id="aboutPage" class="page">
    <div class="about-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">About Business</h1>
    </div>
    <div class="about-content" id="aboutContent" style="padding:20px; color:#475569; line-height:1.6;"></div>
    <div class="business-hours" style="padding:20px;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;"><i class="fas fa-clock" style="color:#667eea;"></i> Business Hours</h3>
      <div class="hours-list" id="businessHours" style="background:white; border-radius:16px; padding:16px;"></div>
    </div>
    <div class="business-hours" style="padding:20px; padding-top:0;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;"><i class="fas fa-calendar-times" style="color:#ef4444;"></i> Holidays</h3>
      <div class="hours-list" id="holidaysList" style="background:white; border-radius:16px; padding:16px;"></div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== CONTACT PAGE ===== -->
  <div id="contactPage" class="page">
    <div class="contact-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);">Contact Us</h1>
      <p style="color:#64748b; margin-top:4px;">Get in touch anytime</p>
    </div>
    <div class="contact-info" style="padding:16px;">
      <!-- Contact items same as before -->
      <div class="contact-item" onclick="window.saveBusinessToContacts()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#667eea; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-address-card"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Save Business Contact</div>
          <div class="contact-value" style="font-size:16px; font-weight:700; color:var(--dark-color);">Tap to save to phonebook</div>
        </div>
      </div>
      <div class="contact-item" onclick="window.openPhoneInput()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#10b981; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-mobile-alt"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">My Delivery Phone</div>
          <div class="contact-value" id="customerPhoneDisplay" style="font-size:16px; font-weight:700; color:var(--dark-color);">Tap to set your number</div>
        </div>
      </div>
      <div class="contact-item" onclick="window.openAddressInput()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#f59e0b; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-map-marker-alt"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">My Delivery Address</div>
          <div class="contact-value" id="customerAddressDisplay" style="font-size:16px; font-weight:700; color:var(--dark-color);">Tap to set your address</div>
        </div>
      </div>
      <div class="contact-item" onclick="window.makeCall()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#2563eb; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-phone"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Call Business</div>
          <div class="contact-value" id="contactPhone" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
      <div class="contact-item" onclick="window.openWhatsAppChat()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#25D366; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fab fa-whatsapp"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">WhatsApp</div>
          <div class="contact-value" id="contactWhatsApp" style="font-size:16px; font-weight:700; color:var(--dark-color);">Chat Now</div>
        </div>
      </div>
      <div class="contact-item email-item" onclick="window.sendEmail()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#8b5cf6; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-envelope"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Email</div>
          <div class="contact-value" id="contactEmail" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
      <div class="contact-item" onclick="window.openMap()" style="display:flex; align-items:center; gap:16px; padding:16px; background:white; border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-sm); cursor:pointer;">
        <div class="contact-icon" style="width:48px; height:48px; background:#ef4444; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;"><i class="fas fa-map-marker-alt"></i></div>
        <div class="contact-details">
          <div class="contact-label" style="font-size:14px; color:#64748b;">Address</div>
          <div class="contact-value" id="contactAddress" style="font-size:16px; font-weight:700; color:var(--dark-color);">Loading...</div>
        </div>
      </div>
    </div>
    <div class="social-links" style="padding:16px;">
      <h3 style="font-size:18px; font-weight:800; color:var(--dark-color); margin-bottom:16px; display:flex; align-items:center; gap:8px;"><i class="fas fa-share-alt" style="color:#667eea;"></i> Follow Us</h3>
      <div class="social-grid" id="socialGrid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px;"></div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== DELIVERY STATUS PAGE ===== -->
  <div id="deliveryPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-truck" style="color:#10b981;"></i> My Orders</h1>
      <p style="color:#64748b; margin-top:4px;">Track your orders in real-time</p>
    </div>
    <div id="deliveryContent" style="padding:16px;"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== ADMIN PAGE ===== -->
  <div id="adminPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-cog" style="color:#667eea;"></i> Business Admin</h1>
      <p style="color:#64748b; margin-top:4px;">Manage orders, tokens & deliveries</p>
    </div>
    <div class="token-management">
      <div class="token-header">
        <h3 style="font-size:18px; font-weight:800; color:var(--dark-color);"><i class="fas fa-ticket-alt" style="color:#667eea;"></i> Order Tokens</h3>
        <button onclick="window.generateNewToken()" style="background:var(--success-gradient); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer;"><i class="fas fa-plus"></i> Generate Token</button>
      </div>
      <div class="token-stats" id="tokenStats">
        <div class="stat-card"><div class="stat-number" id="totalTokensCount">0</div><div class="stat-label">Total Tokens</div></div>
        <div class="stat-card"><div class="stat-number" id="activeTokensCount">0</div><div class="stat-label">Active</div></div>
        <div class="stat-card"><div class="stat-number" id="todayTokensCount">0</div><div class="stat-label">Today</div></div>
      </div>
      <div style="margin-bottom:16px;">
        <input type="text" id="adminTokenSearch" placeholder="Search tokens, orders, customers..." style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px;" onkeyup="window.searchAdminTokens()">
      </div>
      <div class="token-list" id="tokenList"></div>
    </div>
    <div id="adminContent"></div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== LOGIN PAGE ===== -->
  <div id="loginPage" class="page">
    <div class="delivery-page-header" style="padding:20px; background:white; border-bottom:1px solid #e2e8f0;">
      <h1 style="font-size:24px; font-weight:800; color:var(--dark-color);"><i class="fas fa-lock" style="color:#667eea;"></i> Admin Login</h1>
      <p style="color:#64748b; margin-top:4px;">Enter password to access admin panel</p>
    </div>
    <div class="login-page-content" style="padding:24px;">
      <div class="login-title" style="font-size:20px; font-weight:800; color:var(--dark-color); margin-bottom:8px;">Admin Access</div>
      <div class="login-subtitle" style="color:#64748b; margin-bottom:24px;">Enter the admin password to continue</div>
      <input type="password" class="password-input" id="adminPasswordInput" placeholder="Enter password" onkeypress="window.handleLoginKeypress(event)" style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:12px; font-size:16px;">
      <button onclick="window.attemptLogin()" class="admin-btn success" style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:700; font-size:16px; margin-top:20px; cursor:pointer;"><i class="fas fa-sign-in-alt"></i> Login</button>
      <div class="password-hint" id="passwordHint" style="margin-top:20px; padding:16px; background:#f1f5f9; border-radius:12px; color:#64748b; font-size:14px;"></div>
      <div id="logoutSection" style="display:none; margin-top: 30px;">
        <button onclick="window.logoutAdmin()" class="logout-btn" style="margin: 0 auto; padding:12px 24px; background:#ef4444; color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
    <div class="page-footer-spacer" style="height:20px;"></div>
  </div>

  <!-- ===== BOTTOM NAVIGATION ===== -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="window.navigateTo('homePage')"><div class="nav-icon"><i class="fas fa-home"></i></div><div class="nav-label">Home</div></div>
    <div class="nav-item" onclick="window.navigateTo('productsPage')"><div class="nav-icon"><i class="fas fa-shopping-bag"></i></div><div class="nav-label">Products</div></div>
    <div class="nav-item" onclick="window.navigateTo('cartPage')"><div class="nav-icon"><i class="fas fa-shopping-cart"></i></div><div class="nav-label">Cart</div></div>
    <div class="nav-item" onclick="window.navigateTo('aboutPage')"><div class="nav-icon"><i class="fas fa-info-circle"></i></div><div class="nav-label">About</div></div>
    <div class="nav-item" onclick="window.navigateTo('contactPage')"><div class="nav-icon"><i class="fas fa-phone"></i></div><div class="nav-label">Contact</div></div>
  </div>
</div>

<!-- ===== NOTIFICATION ALERT ===== -->
<div class="notification-alert" id="notificationAlert"></div>

<!-- ===== DELIVERY STATUS MODAL ===== -->
<div class="delivery-modal-overlay" id="deliveryStatusModal" style="display:none;">
  <div class="delivery-modal" style="background:white; max-width:340px; width:90%; border-radius:24px; position:relative; padding:20px;">
    <button onclick="window.closeDeliveryModal()" style="position:absolute;top:15px;right:15px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.1);border:none;color:var(--dark-color);font-size:24px;cursor:pointer;">×</button>
    <div id="deliveryStatusContent" style="padding:40px 25px;"></div>
  </div>
</div>

<!-- ===== PROFESSIONAL CHECKOUT MODAL ===== -->
<div class="modal-overlay" id="checkoutModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('checkoutModal')">×</button>
    <div style="padding:25px;">
      <h2 style="font-size:22px;font-weight:800;color:var(--dark-color);margin-bottom:20px;"><i class="fas fa-shopping-cart"></i> Secure Checkout</h2>
      <div id="checkoutItems" style="margin-bottom:20px; max-height:200px; overflow-y:auto; padding-right:10px;"></div>
      <div class="address-auto-detect">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3 style="font-size:16px; font-weight:800; color:var(--dark-color);"><i class="fas fa-map-marker-alt" style="color:#667eea;"></i> Delivery Address</h3>
          <button onclick="window.openAddressInput(true)" style="background:#667eea; color:white; border:none; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:700; cursor:pointer;"><i class="fas fa-pencil-alt"></i> Change</button>
        </div>
        <div id="checkoutAddressDisplay" style="padding:12px; background:#f8fafc; border-radius:8px; font-size:14px; color:#475569; border-left:4px solid #667eea;"></div>
        <div id="checkoutPhoneDisplay" style="margin-top:8px; padding:8px 12px; background:#f1f5f9; border-radius:8px; font-size:13px; color:#475569;"><i class="fas fa-phone-alt"></i> <span id="checkoutPhoneText">No phone number</span></div>
      </div>
      <div class="delivery-charge-calculator" id="deliveryCalculator">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span style="font-weight:700; color:var(--dark-color);"><i class="fas fa-truck"></i> Delivery Estimate</span>
          <span id="deliveryZoneBadge" style="background:#667eea; color:white; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:700;">Calculating...</span>
        </div>
        <div class="delivery-estimate" id="deliveryEstimate"><i class="fas fa-clock" style="color:#3b82f6;"></i> <span id="deliveryTimeEstimate">Calculating delivery time...</span></div>
        <div style="display:flex; justify-content:space-between; margin-top:12px; padding-top:12px; border-top:1px dashed #e2e8f0;">
          <span style="font-weight:600; color:#475569;">Delivery Charge</span>
          <span id="deliveryChargeAmount" style="font-weight:800; color:#10b981;">PKR 0</span>
        </div>
      </div>
      <h3 style="font-size:16px; font-weight:800; color:var(--dark-color); margin:20px 0 12px;"><i class="fas fa-credit-card"></i> Payment Method</h3>
      <div class="pro-payment-grid" id="proPaymentGrid"></div>
      <div style="background:#f8fafc; padding:20px; border-radius:var(--border-radius-md); margin:20px 0; border:1px solid #e2e8f0;">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><span style="color:#64748b;">Subtotal</span><span style="font-weight:800; color:var(--dark-color);">PKR <span id="checkoutSubtotal">0</span></span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><span style="color:#64748b;">Delivery</span><span style="font-weight:800; color:var(--dark-color);">PKR <span id="checkoutDelivery">0</span></span></div>
        <div style="display:flex; justify-content:space-between; margin-top:12px; padding-top:12px; border-top:2px solid #e2e8f0;">
          <span style="font-size:18px; font-weight:800; color:var(--dark-color);">Total</span>
          <span style="font-size:24px; font-weight:900; color:#10b981;">PKR <span id="checkoutTotal">0</span></span>
        </div>
      </div>
      <button onclick="window.placeOrder()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:var(--border-radius-md); font-size:17px; font-weight:800; cursor:pointer;"><i class="fas fa-lock"></i> Place Order & Generate Token</button>
    </div>
  </div>
</div>

<!-- ===== ORDER CONFIRMATION MODAL ===== -->
<div class="modal-overlay" id="orderConfirmationModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('orderConfirmationModal')">×</button>
    <div style="padding:25px;" id="orderConfirmationContent"></div>
  </div>
</div>

<!-- ===== PAYMENT DETAILS MODAL ===== -->
<div class="modal-overlay" id="paymentDetailsModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('paymentDetailsModal')">×</button>
    <div style="padding:25px;">
      <h2 style="font-size:22px; font-weight:800; color:var(--dark-color); margin-bottom:20px;" id="paymentMethodTitle">Payment Details</h2>
      <div id="paymentDetailsContent"></div>
      <button onclick="window.completePaymentAndConfirmOrder()" style="width:100%; padding:18px; background:var(--success-gradient); color:white; border:none; border-radius:var(--border-radius-md); font-size:17px; font-weight:800; cursor:pointer; margin-top:25px;"><i class="fas fa-check-circle"></i> Confirm Payment</button>
    </div>
  </div>
</div>

<!-- ===== PRODUCT MODAL ===== -->
<div class="modal-overlay" id="productModal">
  <div class="modal-content">
    <button class="close-btn" onclick="window.closeModal('productModal')">×</button>
    <div class="product-modal-image-container" style="background:white;">
      <img src="" id="modalImage" class="product-modal-image" loading="lazy">
    </div>
    <div style="padding:25px;">
      <div id="modalPrice" class="modal-price-container"></div>
      <h2 id="modalTitle" style="font-size:20px;font-weight:800;color:var(--dark-color);margin-bottom:12px;"></h2>
      <p id="modalDescription" style="color:#64748b;line-height:1.6;margin-bottom:20px;font-size:14px;"></p>
      <div style="display:flex;gap:12px;margin-top:25px;">
        <button onclick="window.buyNowFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--primary-gradient);color:white;"><i class="fas fa-bolt"></i> Quick Buy</button>
        <button onclick="window.addToCartFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--secondary-gradient);color:white;"><i class="fas fa-cart-plus"></i> Add to Cart</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// ============================================
// DIGITAL BUSINESS APP - NEW DATABASE STRUCTURE
// TABLES: businesses, products, orders, users
// ============================================

const supabase = supabase.createClient(
  "https://dfvnefbxgayxqgjjgtrr.supabase.co",
  "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ===== GLOBAL VARIABLES =====
let business = null;
let products = [];
let cart = [];
let currentProduct = null;
let currentPage = 'loadingScreen';
let currentBusinessId = '';
let shortBusinessId = '';
let orders = [];
let orderTokens = [];
let selectedCheckoutAddress = '';
let selectedCheckoutPhone = '';
let checkoutPaymentMethod = 'cod';
let deliveryCharge = 0;
let deliveryTime = '';
let detectedZone = '';
let isAdminLoggedIn = false;
let businessAdminPassword = '';
let innerNotifications = [];
let unreadNotifications = 0;
let customerData = { deviceId: '', name: '', phone: '', email: '' };
let navigationHistory = [];

// ===== DATA ISOLATION =====
function getStorageKey(key) {
  const businessKey = currentBusinessId ? currentBusinessId.substring(0, 8) : 'default';
  return `business_${businessKey}_${key}`;
}

const isolatedLocalStorage = {
  setItem: (key, value) => localStorage.setItem(getStorageKey(key), value),
  getItem: (key) => localStorage.getItem(getStorageKey(key)),
  removeItem: (key) => localStorage.removeItem(getStorageKey(key))
};

// ===== CUSTOMER DATA =====
function getCustomerPhone() { return isolatedLocalStorage.getItem('customerPhone') || ''; }
function getCustomerAddress() { return isolatedLocalStorage.getItem('customerAddress') || ''; }

function saveCustomerPhone(phone) {
  isolatedLocalStorage.setItem('customerPhone', phone);
  document.getElementById('customerPhoneDisplay')?.textContent = phone || 'Tap to set your number';
  document.getElementById('checkoutPhoneText').textContent = phone || 'No phone number';
  selectedCheckoutPhone = phone;
}

function saveCustomerAddress(address) {
  isolatedLocalStorage.setItem('customerAddress', address);
  document.getElementById('customerAddressDisplay').textContent = address || 'Tap to set your address';
  document.getElementById('checkoutAddressDisplay').innerHTML = `<i class="fas fa-home"></i> ${address || 'No address saved'}`;
  selectedCheckoutAddress = address;
  if (address) calculateDeliveryCharge(address);
}

function openPhoneInput() {
  const phone = prompt("Enter your phone number:", getCustomerPhone() || "");
  if (phone) {
    const cleaned = phone.replace(/\D/g, '');
    if (cleaned.length >= 10) {
      saveCustomerPhone(cleaned);
      showNotification('✅ Phone number saved!');
    } else showNotification('❌ Valid phone number required');
  }
}

function openAddressInput() {
  const address = prompt("Enter your delivery address:", getCustomerAddress() || "");
  if (address?.trim()) {
    saveCustomerAddress(address.trim());
    showNotification('✅ Address saved!');
  }
}

// ===== DELIVERY CALCULATOR =====
function calculateDeliveryCharge(address) {
  if (!address) {
    deliveryCharge = 0; deliveryTime = 'Enter address'; detectedZone = 'Unknown';
    updateDeliveryUI(); return;
  }
  const addr = address.toLowerCase();
  let charge = 150, time = '1-2 days', zone = 'Standard';
  if (addr.includes('karachi') || addr.includes('lahore') || addr.includes('islamabad')) {
    charge = 150; time = '1-2 days'; zone = 'Metro';
  } else { charge = 300; time = '3-5 days'; zone = 'Other'; }
  if (business?.delivery_settings?.free_delivery_min && calculateCartSubtotal() >= business.delivery_settings.free_delivery_min) {
    charge = 0; time += ' (Free)';
  }
  deliveryCharge = charge; deliveryTime = time; detectedZone = zone;
  updateDeliveryUI();
}

function updateDeliveryUI() {
  document.getElementById('deliveryZoneBadge').textContent = detectedZone;
  document.getElementById('deliveryTimeEstimate').innerHTML = `<i class="fas fa-clock"></i> ${deliveryTime}`;
  document.getElementById('deliveryChargeAmount').textContent = `PKR ${deliveryCharge}`;
  document.getElementById('checkoutDelivery').textContent = deliveryCharge;
  const subtotal = parseFloat(document.getElementById('checkoutSubtotal')?.textContent) || 0;
  document.getElementById('checkoutTotal').textContent = (subtotal + deliveryCharge).toFixed(2);
}

function calculateCartSubtotal() {
  return cart.reduce((sum, item) => sum + (parseFloat(item.discount_price || item.original_price || 0) * (item.quantity || 1)), 0);
}

// ===== ORDER TOKEN =====
function generateOrderToken() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let rand = '';
  for (let i = 0; i < 4; i++) rand += chars.charAt(Math.floor(Math.random() * chars.length));
  return `TKT-${Date.now().toString().slice(-6)}-${rand}`;
}

function generateAdminPassword(id, shortId) {
  return `business123_${shortId?.toLowerCase() || 'default'}`;
}

// ===== NOTIFICATIONS =====
function showNotification(msg) {
  const el = document.getElementById('notificationAlert');
  el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 3000);
}

function addInnerNotification(title, msg, type = 'info') {
  innerNotifications.unshift({ id: Date.now(), title, message: msg, type, time: new Date(), read: false });
  unreadNotifications++;
  updateNotificationBellCount();
}

function updateNotificationBellCount() {
  const badge = document.getElementById('notificationBadge');
  if (unreadNotifications > 0) {
    badge.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
    badge.style.display = 'flex';
  } else badge.style.display = 'none';
}

// ===== CART =====
function updateCartCount() {
  const count = cart.length;
  document.getElementById('cartCountMini').textContent = count;
  const badge = document.getElementById('cartBadge');
  if (badge) {
    if (count > 0) { badge.textContent = count > 99 ? '99+' : count; badge.style.display = 'flex'; }
    else badge.style.display = 'none';
  }
  isolatedLocalStorage.setItem('cart', JSON.stringify(cart));
  if (currentPage === 'cartPage') loadCartPage();
}

function addToCart(index) {
  const product = products[index];
  if (!product) return;
  const existing = cart.findIndex(item => item.id === product.id);
  if (existing === -1) cart.push({ ...product, quantity: 1 });
  else cart[existing].quantity = (cart[existing].quantity || 1) + 1;
  updateCartCount();
  showNotification('✅ Added to cart!');
}

function removeFromCart(index) { cart.splice(index, 1); updateCartCount(); showNotification('🗑️ Removed'); }
function updateQuantity(index, change) { if (cart[index]) { cart[index].quantity = Math.max(1, (cart[index].quantity || 1) + change); loadCartPage(); updateCartCount(); } }

function loadCartPage() {
  const content = document.getElementById('cartContent');
  const countEl = document.getElementById('cartItemsCount');
  if (cart.length === 0) {
    content.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fas fa-shopping-cart" style="font-size:64px; color:#cbd5e1;"></i><h3>Your cart is empty</h3><button onclick="window.navigateTo(\'productsPage\')" style="padding:12px 30px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; margin-top:20px;">Shop Now</button></div>';
    countEl.textContent = '0 items'; return;
  }
  let html = '', total = 0;
  cart.forEach((item, i) => {
    const price = parseFloat(item.discount_price || item.original_price || 0);
    const itemTotal = price * (item.quantity || 1);
    total += itemTotal;
    html += `<div style="display:flex; gap:12px; background:white; padding:16px; border-radius:16px; margin-bottom:12px;">
      <img src="${item.image_url || ''}" style="width:80px; height:80px; object-fit:cover; border-radius:12px;" onerror="this.style.display='none'">
      <div style="flex:1;">
        <div style="font-weight:700;">${item.title}</div>
        <div style="font-weight:800; color:#10b981;">PKR ${itemTotal.toFixed(2)}</div>
        <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
          <div style="display:flex; align-items:center; gap:8px; background:#f1f5f9; border-radius:8px; padding:4px;">
            <button onclick="window.updateQuantity(${i}, -1)" style="width:30px; height:30px; border:none; background:white; border-radius:6px; font-weight:700;">-</button>
            <span style="font-weight:700;">${item.quantity || 1}</span>
            <button onclick="window.updateQuantity(${i}, 1)" style="width:30px; height:30px; border:none; background:white; border-radius:6px; font-weight:700;">+</button>
          </div>
          <button onclick="window.removeFromCart(${i})" style="color:#ef4444; border:none; background:none;">Remove</button>
        </div>
      </div>
    </div>`;
  });
  html += `<div style="background:white; border-radius:20px; padding:20px; margin:16px;">
    <h3 style="font-weight:800;">Order Summary</h3>
    <div style="display:flex; justify-content:space-between; margin:12px 0;"><span>Subtotal</span><span style="font-weight:700;">PKR ${total.toFixed(2)}</span></div>
    <div style="display:flex; justify-content:space-between; margin:12px 0;"><span>Shipping</span><span style="color:#64748b;">Calculated at checkout</span></div>
    <div style="display:flex; justify-content:space-between; margin:20px 0; padding-top:12px; border-top:2px solid #e2e8f0;">
      <span style="font-size:18px; font-weight:800;">Total</span>
      <span style="font-size:20px; font-weight:900; color:#10b981;">PKR ${total.toFixed(2)}</span>
    </div>
    <button onclick="window.openCheckoutModal()" style="width:100%; padding:16px; background:var(--success-gradient); color:white; border:none; border-radius:12px; font-weight:800;">Proceed to Checkout</button>
  </div>`;
  content.innerHTML = html;
  countEl.textContent = `${cart.length} ${cart.length === 1 ? 'item' : 'items'}`;
}

// ===== PRODUCT CARDS =====
function createProductCard(product, index) {
  const price = product.discount_price || product.original_price;
  const original = product.original_price;
  const hasDiscount = original && price && original > price;
  const discount = hasDiscount ? Math.round(((original - price) / original) * 100) : 0;
  const div = document.createElement('div');
  div.className = 'product-card';
  div.innerHTML = `
    <div class="product-image-container" onclick="window.zoomImage('${product.image_url || ''}', event)">
      <img src="${product.image_url || ''}" class="product-image" loading="lazy" onerror="this.style.display='none'">
      <div class="badge-container">
        ${hasDiscount ? `<span class="discount-badge"><i class="fas fa-tag"></i> -${discount}%</span>` : ''}
        ${product.offer_tag ? `<span class="offer-badge"><i class="fas fa-gift"></i> ${product.offer_tag}</span>` : ''}
        ${product.badges?.length ? `<span class="feature-badge">${product.badges[0]}</span>` : ''}
      </div>
    </div>
    <div class="product-content">
      <div class="product-title">${product.title || 'Product'}</div>
      <div class="price-badge-container">
        <span class="current-price">PKR ${price}</span>
        ${hasDiscount ? `<span class="original-price">PKR ${original}</span>` : ''}
      </div>
      <div class="product-actions">
        <button class="btn-primary" onclick="window.addToCart(${index}); event.stopPropagation();"><i class="fas fa-cart-plus"></i> Add</button>
        <button class="btn-secondary" onclick="window.buyNow(${index}); event.stopPropagation();"><i class="fas fa-bolt"></i> Buy</button>
      </div>
    </div>
  `;
  div.onclick = (e) => { if (!e.target.closest('button')) showProductModal(index); };
  return div;
}

function showProductModal(index) {
  const p = products[index];
  if (!p) return;
  currentProduct = p;
  document.getElementById('modalImage').src = p.image_url || '';
  document.getElementById('modalTitle').textContent = p.title || '';
  document.getElementById('modalDescription').textContent = p.description || 'No description';
  const price = p.discount_price || p.original_price;
  const original = p.original_price;
  const hasDiscount = original && price && original > price;
  document.getElementById('modalPrice').innerHTML = hasDiscount 
    ? `<div style="display:flex; align-items:center; gap:12px;">
        <span style="text-decoration:line-through; color:#94a3b8;">PKR ${original}</span>
        <span style="color:#10b981; font-size:24px; font-weight:900;">PKR ${price}</span>
        <span style="background:var(--danger-gradient); color:white; padding:4px 8px; border-radius:4px;">${Math.round(((original-price)/original)*100)}% OFF</span>
      </div>`
    : `<div style="color:#10b981; font-size:24px; font-weight:900;">PKR ${price || 'N/A'}</div>`;
  openModal('productModal');
}

function zoomImage(url, e) { if (e) e.stopPropagation(); if (url) { document.getElementById('zoomedImage').src = url; document.getElementById('imageZoomOverlay').style.display = 'flex'; } }
function closeImageZoom() { document.getElementById('imageZoomOverlay').style.display = 'none'; }
function filterProducts() { /* Implement if needed */ }
function buyNow(index) { cart = [{ ...products[index], quantity: 1 }]; updateCartCount(); openCheckoutModal(); }
function buyNowFromModal() { if (currentProduct) { cart = [{ ...currentProduct, quantity: 1 }]; updateCartCount(); closeModal('productModal'); openCheckoutModal(); } }
function addToCartFromModal() { if (currentProduct) { const idx = products.findIndex(p => p.id === currentProduct.id); if (idx !== -1) addToCart(idx); closeModal('productModal'); } }

// ===== CHECKOUT =====
async function openCheckoutModal() {
  if (!cart.length) { showNotification('Cart empty'); return; }
  selectedCheckoutPhone = getCustomerPhone();
  selectedCheckoutAddress = getCustomerAddress();
  document.getElementById('checkoutPhoneText').textContent = selectedCheckoutPhone || 'No phone number';
  document.getElementById('checkoutAddressDisplay').innerHTML = selectedCheckoutAddress ? `<i class="fas fa-home"></i> ${selectedCheckoutAddress}` : '<span style="color:#ef4444;">No address saved</span>';
  let subtotal = 0, itemsHtml = '';
  cart.forEach(item => {
    const price = parseFloat(item.discount_price || item.original_price || 0);
    const total = price * (item.quantity || 1);
    subtotal += total;
    itemsHtml += `<div style="display:flex; justify-content:space-between; padding:8px; background:#f8fafc; border-radius:8px; margin-bottom:8px;">
      <span style="font-weight:800;">${item.quantity || 1}x</span>
      <span style="font-size:13px;">${item.title}</span>
      <span style="font-weight:800; color:#10b981;">PKR ${total.toFixed(2)}</span>
    </div>`;
  });
  document.getElementById('checkoutItems').innerHTML = itemsHtml;
  document.getElementById('checkoutSubtotal').textContent = subtotal.toFixed(2);
  renderPaymentMethods();
  if (selectedCheckoutAddress) calculateDeliveryCharge(selectedCheckoutAddress);
  else { deliveryCharge = 0; deliveryTime = 'Enter address'; detectedZone = 'Required'; updateDeliveryUI(); }
  checkoutPaymentMethod = 'cod';
  openModal('checkoutModal');
}

function renderPaymentMethods() {
  let html = '';
  html += `<div class="pro-payment-card ${checkoutPaymentMethod === 'cod' ? 'selected' : ''}" onclick="window.selectProPaymentMethod('cod')">
    <div class="pro-payment-icon" style="background:#10b981;"><i class="fas fa-truck"></i></div>
    <div style="font-weight:700;">Cash on Delivery</div>
    <div style="font-size:11px; color:#64748b;">Pay when order arrives</div>
  </div>`;
  if (business?.payment_gateways?.jazzcash?.active) {
    html += `<div class="pro-payment-card ${checkoutPaymentMethod === 'jazzcash' ? 'selected' : ''}" onclick="window.selectProPaymentMethod('jazzcash')">
      <div class="pro-payment-icon" style="background:#FF6B00;"><i class="fas fa-mobile-alt"></i></div>
      <div style="font-weight:700;">JazzCash</div>
      <div style="font-size:11px; color:#64748b;">${business.payment_gateways.jazzcash.number || 'Pay via app'}</div>
    </div>`;
  }
  if (business?.payment_gateways?.easypaisa?.active) {
    html += `<div class="pro-payment-card ${checkoutPaymentMethod === 'easypaisa' ? 'selected' : ''}" onclick="window.selectProPaymentMethod('easypaisa')">
      <div class="pro-payment-icon" style="background:#0A5C36;"><i class="fas fa-wallet"></i></div>
      <div style="font-weight:700;">EasyPaisa</div>
      <div style="font-size:11px; color:#64748b;">${business.payment_gateways.easypaisa.number || 'Pay via app'}</div>
    </div>`;
  }
  if (business?.payment_gateways?.bank?.active) {
    html += `<div class="pro-payment-card ${checkoutPaymentMethod === 'bank' ? 'selected' : ''}" onclick="window.selectProPaymentMethod('bank')">
      <div class="pro-payment-icon" style="background:#2563eb;"><i class="fas fa-university"></i></div>
      <div style="font-weight:700;">Bank Transfer</div>
      <div style="font-size:11px; color:#64748b;">${business.payment_gateways.bank.bankName || 'Direct transfer'}</div>
    </div>`;
  }
  if (business?.payment_gateways?.card?.active) {
    html += `<div class="pro-payment-card ${checkoutPaymentMethod === 'card' ? 'selected' : ''}" onclick="window.selectProPaymentMethod('card')">
      <div class="pro-payment-icon" style="background:#8b5cf6;"><i class="fas fa-credit-card"></i></div>
      <div style="font-weight:700;">Card Payment</div>
      <div style="font-size:11px; color:#64748b;">Visa / Mastercard</div>
    </div>`;
  }
  html += `<div class="pro-payment-card ${checkoutPaymentMethod === 'whatsapp' ? 'selected' : ''}" onclick="window.selectProPaymentMethod('whatsapp')">
    <div class="pro-payment-icon" style="background:#25D366;"><i class="fab fa-whatsapp"></i></div>
    <div style="font-weight:700;">WhatsApp Order</div>
    <div style="font-size:11px; color:#64748b;">Order via chat</div>
  </div>`;
  document.getElementById('proPaymentGrid').innerHTML = html;
}

function selectProPaymentMethod(method) {
  checkoutPaymentMethod = method;
  document.querySelectorAll('.pro-payment-card').forEach(c => c.classList.remove('selected'));
  document.querySelectorAll(`.pro-payment-card[onclick*="${method}"]`).forEach(c => c.classList.add('selected'));
  if (['jazzcash', 'easypaisa', 'bank', 'card'].includes(method)) showPaymentDetailsModal(method);
}

function showPaymentDetailsModal(method) {
  if (method === 'jazzcash' && business?.payment_gateways?.jazzcash) {
    document.getElementById('paymentMethodTitle').innerHTML = 'JazzCash Payment';
    document.getElementById('paymentDetailsContent').innerHTML = `<div style="text-align:center;">
      <div style="margin-bottom:20px;"><div style="color:#64748b;">Send payment to:</div>
      <div style="font-size:24px; font-weight:900; color:#FF6B00; background:rgba(255,107,0,0.1); padding:15px; border-radius:16px;">${business.payment_gateways.jazzcash.number || '03001234567'}</div></div>
      ${business.payment_gateways.jazzcash.barcode ? `<div><img src="${business.payment_gateways.jazzcash.barcode}" style="max-width:200px;"></div>` : ''}
    </div>`;
  } else if (method === 'easypaisa' && business?.payment_gateways?.easypaisa) {
    document.getElementById('paymentMethodTitle').innerHTML = 'EasyPaisa Payment';
    document.getElementById('paymentDetailsContent').innerHTML = `<div style="text-align:center;">
      <div style="margin-bottom:20px;"><div style="color:#64748b;">Send payment to:</div>
      <div style="font-size:24px; font-weight:900; color:#0A5C36; background:rgba(10,92,54,0.1); padding:15px; border-radius:16px;">${business.payment_gateways.easypaisa.number || '03001234567'}</div></div>
      ${business.payment_gateways.easypaisa.barcode ? `<div><img src="${business.payment_gateways.easypaisa.barcode}" style="max-width:200px;"></div>` : ''}
    </div>`;
  } else if (method === 'bank' && business?.payment_gateways?.bank) {
    document.getElementById('paymentMethodTitle').innerHTML = 'Bank Transfer';
    document.getElementById('paymentDetailsContent').innerHTML = `<div style="background:#f8fafc; border-radius:16px; padding:20px;">
      <div style="margin-bottom:16px;"><div style="color:#64748b;">Bank Name</div><div style="font-size:18px; font-weight:800;">${business.payment_gateways.bank.bankName || 'HBL'}</div></div>
      <div style="margin-bottom:16px;"><div style="color:#64748b;">Account Title</div><div style="font-size:16px; font-weight:700;">${business.payment_gateways.bank.accountTitle || 'Business Account'}</div></div>
      <div style="margin-bottom:16px;"><div style="color:#64748b;">Account Number</div><div style="font-size:18px; font-weight:900; color:#2563eb;">${business.payment_gateways.bank.accountNumber || '1234567890'}</div></div>
    </div>`;
  } else if (method === 'card') {
    document.getElementById('paymentMethodTitle').innerHTML = 'Card Payment';
    document.getElementById('paymentDetailsContent').innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-credit-card" style="font-size:48px; color:#8b5cf6;"></i><h3>Secure Card Payment</h3><p style="color:#64748b;">You will be redirected</p></div>';
  }
  openModal('paymentDetailsModal');
  closeModal('checkoutModal');
}

function completePaymentAndConfirmOrder() { placeOrder(); closeModal('paymentDetailsModal'); }

// ===== PLACE ORDER =====
async function placeOrder() {
  if (!selectedCheckoutPhone) { showNotification('❌ Phone number required'); openPhoneInput(); return; }
  if (!selectedCheckoutAddress) { showNotification('❌ Address required'); openAddressInput(); return; }
  if (!cart.length) { showNotification('❌ Cart empty'); closeModal('checkoutModal'); return; }

  try {
    const subtotal = calculateCartSubtotal();
    const total = subtotal + deliveryCharge;
    const orderId = 'ORD-' + Date.now().toString().slice(-8);
    const token = generateOrderToken();
    const orderItems = cart.map(item => ({
      title: item.title,
      price: parseFloat(item.discount_price || item.original_price || 0),
      quantity: item.quantity || 1,
      image_url: item.image_url || ''
    }));

    const orderData = {
      orderId, token,
      customerPhone: selectedCheckoutPhone,
      customerAddress: selectedCheckoutAddress,
      items: orderItems,
      subtotal, deliveryCharge, total,
      paymentMethod: checkoutPaymentMethod === 'cod' ? 'Cash on Delivery' : 
                     checkoutPaymentMethod === 'jazzcash' ? 'JazzCash' :
                     checkoutPaymentMethod === 'easypaisa' ? 'EasyPaisa' :
                     checkoutPaymentMethod === 'bank' ? 'Bank Transfer' :
                     checkoutPaymentMethod === 'card' ? 'Card Payment' : 'WhatsApp Order',
      zone: detectedZone,
      estimatedDelivery: deliveryTime
    };

    const { error } = await supabase
      .from('orders')
      .insert([{
        order_id: orderId,
        token: token,
        customer_phone: selectedCheckoutPhone,
        customer_address: selectedCheckoutAddress,
        items: orderItems,
        subtotal: subtotal,
        delivery_charge: deliveryCharge,
        total: total,
        payment_method: orderData.paymentMethod,
        status: 'confirmed',
        zone: detectedZone,
        estimated_delivery: deliveryTime,
        business_id: currentBusinessId,
        created_at: new Date().toISOString()
      }]);

    if (!error) {
      // Save user
      await supabase
        .from('users')
        .upsert([{
          business_id: currentBusinessId,
          device_id: customerData.deviceId,
          phone: selectedCheckoutPhone,
          address: selectedCheckoutAddress,
          last_active: new Date().toISOString()
        }], { onConflict: 'business_id,phone' });

      cart = [];
      updateCartCount();
      isolatedLocalStorage.setItem('cart', JSON.stringify(cart));
      closeModal('checkoutModal');
      
      // Show confirmation
      showOrderConfirmation(orderData);
      
      // WhatsApp
      if (business?.phone && checkoutPaymentMethod !== 'whatsapp') {
        const phone = business.phone.replace(/\D/g, '');
        let msg = `🛍️ *NEW ORDER CONFIRMED*\n\nOrder ID: ${orderId}\nToken: ${token}\nCustomer: ${selectedCheckoutPhone}\nAddress: ${selectedCheckoutAddress}\n\nItems:\n`;
        orderItems.forEach(i => msg += `• ${i.title} x${i.quantity} - PKR ${(i.price * i.quantity).toFixed(2)}\n`);
        msg += `\nSubtotal: PKR ${subtotal.toFixed(2)}\nDelivery: PKR ${deliveryCharge.toFixed(2)}\nTotal: PKR ${total.toFixed(2)}\nPayment: ${orderData.paymentMethod}`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
      }
      
      showNotification('✅ Order placed! Token: ' + token);
    } else showNotification('❌ Order failed');
  } catch (err) { console.error(err); showNotification('❌ Error'); }
}

function showOrderConfirmation(data) {
  const content = document.getElementById('orderConfirmationContent');
  let itemsHtml = '';
  data.items.forEach(i => itemsHtml += `<div class="order-item-row"><span>${i.title} x${i.quantity}</span><span>PKR ${(i.price * i.quantity).toFixed(2)}</span></div>`);
  content.innerHTML = `
    <div class="order-ticket">
      <div class="ticket-header"><span class="ticket-id">${data.token}</span><span class="ticket-date">${new Date().toLocaleString()}</span></div>
      <div class="ticket-body">
        <div style="text-align:center; margin-bottom:20px;"><i class="fas fa-check-circle" style="font-size:48px; color:#10b981;"></i><h3 style="color:white;">Order Confirmed!</h3></div>
        <div class="ticket-row"><span>Order ID:</span><span style="font-weight:800;">${data.orderId}</span></div>
        <div class="ticket-row"><span>Phone:</span><span>${data.customerPhone}</span></div>
        <div class="ticket-row"><span>Address:</span><span>${data.customerAddress}</span></div>
        <div class="ticket-row"><span>Delivery:</span><span>${data.estimatedDelivery}</span></div>
        <div style="margin:16px 0; padding:12px 0; border-top:2px dashed rgba(255,255,255,0.3); border-bottom:2px dashed rgba(255,255,255,0.3);">${itemsHtml}</div>
        <div class="ticket-row"><span>Subtotal:</span><span>PKR ${data.subtotal.toFixed(2)}</span></div>
        <div class="ticket-row"><span>Delivery:</span><span>PKR ${data.deliveryCharge.toFixed(2)}</span></div>
        <div class="ticket-total"><span>Total</span><span>PKR ${data.total.toFixed(2)}</span></div>
      </div>
      <div style="text-align:center; margin-top:20px; font-size:12px;">Payment: ${data.paymentMethod}</div>
    </div>
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button onclick="window.navigateTo('deliveryPage')" style="flex:1; padding:14px; background:var(--whatsapp-gradient); color:white; border:none; border-radius:12px; font-weight:700;"><i class="fas fa-truck"></i> Track Order</button>
    </div>
  `;
  openModal('orderConfirmationModal');
}

// ===== LOAD PAGES =====
function loadHomePage() {
  const grid = document.getElementById('featuredProducts');
  grid.innerHTML = '';
  products.filter(p => p.is_featured).slice(0, 4).forEach((p, i) => grid.appendChild(createProductCard(p, i)));
}
function loadProductsPage() {
  const grid = document.getElementById('allProducts');
  grid.innerHTML = '';
  products.forEach((p, i) => grid.appendChild(createProductCard(p, i)));
}
function loadAboutPage() {
  document.getElementById('aboutContent').innerHTML = `<div style="background:white; border-radius:16px; padding:24px;">
    <h2 style="font-size:20px; font-weight:800;">${business?.business_name || 'Business'}</h2>
    <p style="margin-top:12px;">${business?.description || 'Welcome to our business.'}</p>
  </div>`;
}
function loadContactPage() {
  document.getElementById('contactPhone').textContent = business?.phone || 'Not available';
  document.getElementById('contactEmail').textContent = business?.email || 'Not available';
  document.getElementById('contactAddress').textContent = business?.address || 'Not available';
  document.getElementById('customerPhoneDisplay').textContent = getCustomerPhone() || 'Tap to set';
  document.getElementById('customerAddressDisplay').textContent = getCustomerAddress() || 'Tap to set';
}
function loadDeliveryStatus() { document.getElementById('deliveryContent').innerHTML = '<div style="padding:40px; text-align:center;">Your orders will appear here</div>'; }

// ===== NAVIGATION =====
function navigateTo(pageId) {
  const hashMap = { homePage: 'home', productsPage: 'products', cartPage: 'cart', aboutPage: 'about', contactPage: 'contact', deliveryPage: 'delivery', adminPage: 'admin', loginPage: 'login' };
  if (hashMap[pageId]) window.location.hash = `#${hashMap[pageId]}`;
}
function navigateToDirect(pageId) {
  if (currentPage === pageId) return;
  document.getElementById(currentPage)?.classList.remove('active');
  document.getElementById(pageId)?.classList.add('active');
  currentPage = pageId;
  document.getElementById('headerBackBtn').style.display = pageId !== 'homePage' ? 'flex' : 'none';
  if (pageId === 'homePage') loadHomePage();
  else if (pageId === 'productsPage') loadProductsPage();
  else if (pageId === 'cartPage') loadCartPage();
  else if (pageId === 'aboutPage') loadAboutPage();
  else if (pageId === 'contactPage') loadContactPage();
  else if (pageId === 'deliveryPage') loadDeliveryStatus();
}
function goBack() { if (navigationHistory.length > 1) { navigationHistory.pop(); navigateTo(navigationHistory[navigationHistory.length - 1]); } else showNotification('Press back again to exit'); }
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

// ===== INIT =====
document.addEventListener("DOMContentLoaded", async () => {
  const shortId = new URLSearchParams(location.search).get("id");
  if (!shortId) { document.body.innerHTML = '<div style="padding:40px;"><h2>❌ Business ID Required</h2></div>'; return; }
  
  shortBusinessId = shortId;
  
  // Load business
  const { data: biz, error: bizErr } = await supabase
    .from('businesses')
    .select('*')
    .eq('short_id', shortId)
    .eq('is_active', true)
    .single();
  
  if (bizErr || !biz) { document.body.innerHTML = '<div style="padding:40px;"><h2>❌ Business Not Found</h2></div>'; return; }
  
  business = biz;
  currentBusinessId = biz.id;
  
  // Load products
  const { data: prods } = await supabase
    .from('products')
    .select('*')
    .eq('business_id', biz.id)
    .eq('is_available', true);
  products = prods || [];
  
  // Load cart
  const savedCart = isolatedLocalStorage.getItem('cart');
  cart = savedCart ? JSON.parse(savedCart) : [];
  
  // Render
  document.getElementById('businessHeader').textContent = biz.business_name;
  document.getElementById('name').textContent = biz.owner_name || 'Owner';
  document.getElementById('business').textContent = biz.business_name;
  if (biz.logo_url) document.getElementById('photo').src = biz.logo_url;
  
  document.getElementById('loadingScreen').classList.remove('active');
  document.getElementById('homePage').classList.add('active');
  currentPage = 'homePage';
  loadHomePage();
  updateCartCount();
  
  navigationHistory.push('homePage');
  window.location.hash = '#home';
});

// ===== GLOBAL FUNCTIONS =====
window.navigateTo = navigateTo;
window.navigateToDirect = navigateToDirect;
window.goBack = goBack;
window.openPhoneInput = openPhoneInput;
window.openAddressInput = openAddressInput;
window.addToCart = addToCart;
window.buyNow = buyNow;
window.buyNowFromModal = buyNowFromModal;
window.addToCartFromModal = addToCartFromModal;
window.removeFromCart = removeFromCart;
window.updateQuantity = updateQuantity;
window.openCheckoutModal = openCheckoutModal;
window.selectProPaymentMethod = selectProPaymentMethod;
window.placeOrder = placeOrder;
window.completePaymentAndConfirmOrder = completePaymentAndConfirmOrder;
window.zoomImage = zoomImage;
window.closeImageZoom = closeImageZoom;
window.showProductModal = showProductModal;
window.filterProducts = filterProducts;
window.openModal = openModal;
window.closeModal = closeModal;
window.showNotification = showNotification;
window.saveBusinessToContacts = saveBusinessToContacts;
window.shareBusiness = shareBusiness;
window.openWhatsAppChat = () => { if (business?.phone) window.open(`https://wa.me/${business.phone.replace(/\D/g,'')}`, '_blank'); };
window.makeCall = () => { if (business?.phone) window.open(`tel:${business.phone}`); };
window.sendEmail = () => { if (business?.email) window.open(`mailto:${business.email}`); };
window.openMap = () => { if (business?.address) window.open(`https://maps.google.com/?q=${encodeURIComponent(business.address)}`, '_blank'); };
window.toggleNotificationDrawer = () => document.getElementById('notificationDrawer').classList.toggle('open');
window.checkDeliveryStatus = () => navigateTo('deliveryPage');
window.toggleLogin = () => navigateTo('loginPage');
window.attemptLogin = () => { showNotification('Admin login coming soon'); };
window.logoutAdmin = () => { isAdminLoggedIn = false; showNotification('Logged out'); };
window.closeExitModal = () => document.getElementById('exitModal').style.display = 'none';
window.exitApp = () => { if (window.history.length > 1) window.history.go(-1); else window.close(); };
window.closeInstallPermissionModal = () => document.getElementById('installPermissionModal').style.display = 'none';
window.acceptInstallPermissions = () => { document.getElementById('installPermissionModal').style.display = 'none'; showNotification('✅ Thanks!'); };
window.closeDeliveryModal = () => document.getElementById('deliveryStatusModal').style.display = 'none';
window.generateNewToken = () => showNotification('Admin login required');
window.searchAdminTokens = () => {};
window.viewOrderDetails = () => {};
window.updateOrderStatus = () => {};
window.sendNotificationToAll = () => {};
window.markAllNotificationsAsRead = () => {};
window.enableNotifications = () => {};
window.downloadOrderTicket = () => {};
window.shareOrderTicket = () => {};

// Helper functions
function saveBusinessToContacts() {
  if (business?.phone) {
    navigator.clipboard.writeText(`Business: ${business.business_name}\nPhone: ${business.phone}\nEmail: ${business.email || ''}\nAddress: ${business.address || ''}`);
    showNotification('📋 Business info copied!');
  }
}
function shareBusiness() {
  const url = window.location.href;
  if (navigator.share) navigator.share({ title: business?.business_name, url });
  else { navigator.clipboard.writeText(url); showNotification('📋 Link copied!'); }
}
function generateDeviceId() {
  let id = localStorage.getItem('customer_device_id');
  if (!id) { id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2,9); localStorage.setItem('customer_device_id', id); }
  return id;
}
customerData.deviceId = generateDeviceId();
</script>
</body>
</html>
