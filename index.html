<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create Digital Business Card - Professional E-Commerce Suite</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{
  margin:0;
  font-family:'Poppins',system-ui;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height:100vh;
  color: #1e293b;
}

.wrap{
  max-width:480px;
  margin:auto;
  padding:20px;
}

h2{
  margin-top:20px;
  margin-bottom:10px;
  color:#0f172a;
  display:flex;
  align-items:center;
  gap:10px;
  font-size:18px;
  font-weight:600;
  background: rgba(255, 255, 255, 0.95);
  padding: 12px 16px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 2px solid rgba(102, 126, 234, 0.3);
}

.section-heading {
  color: #0f172a;
  font-size: 18px;
  font-weight: 600;
  margin: 20px 0 10px 0;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 2px solid rgba(102, 126, 234, 0.3);
  display: flex;
  align-items: center;
  gap: 10px;
}

input,textarea,select{
  width:100%;
  padding:14px;
  margin:8px 0;
  border-radius:12px;
  border:2px solid rgba(102, 126, 234, 0.3);
  box-sizing:border-box;
  font-size:15px;
  background:rgba(255,255,255,0.95);
  color: #1e293b;
  font-family: 'Poppins', sans-serif;
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

button{
  width:100%;
  padding:18px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color:white;
  font-size:17px;
  margin-top:20px;
  cursor:pointer;
  font-weight:600;
  box-shadow:0 8px 25px rgba(102,126,234,0.4);
  font-family: 'Poppins', sans-serif;
  transition: all 0.3s;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(102,126,234,0.5);
}

.form-section{
  background:rgba(255,255,255,0.95);
  border-radius:20px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
  border: 2px solid rgba(255,255,255,0.2);
}

.social-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.social-input {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
  transition: all 0.3s;
}

.social-input:hover {
  border-color: #667eea;
  background: white;
}

.social-input i {
  color: #666;
  font-size: 18px;
  width: 24px;
}

.social-input input {
  flex: 1;
  border: none;
  background: transparent;
  padding: 0;
  margin: 0;
  font-size: 14px;
  color: #1e293b;
}

.social-input input:focus {
  outline: none;
}

.offers-container {
  display: flex;
  gap: 16px;
  overflow-x: auto;
  padding: 10px 0;
  margin-top: 10px;
  scrollbar-width: thin;
}

.offers-container::-webkit-scrollbar {
  height: 6px;
}

.offers-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.offers-container::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 10px;
}

.offer-box {
  min-width: 280px;
  background: white;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border: 1px solid #e2e8f0;
}

.offer-box h3 {
  margin-top: 0;
  color: #1e293b;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 10px;
  border-bottom: 1px solid #e2e8f0;
}

.badgeGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-top:10px;
  font-size:14px;
}
.badgeGrid label{
  display:flex;
  gap:8px;
  align-items:center;
  cursor:pointer;
  color: #475569;
  padding: 6px 8px;
  border-radius: 6px;
  transition: all 0.2s;
}

.badgeGrid label:hover {
  background: #f1f5f9;
}

.badgeGrid input[type="checkbox"] {
  accent-color: #667eea;
}

.dayBox{
  background:#fff;
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
  display:grid;
  grid-template-columns:28px 1fr;
  gap:8px;
  align-items:center;
  border:1px solid #e2e8f0;
}
.dayCheck{display:flex;justify-content:center}
.dayContent{display:flex;flex-direction:column;gap:6px}
.dayRow{display:flex;align-items:center;gap:8px}
.dayRow label{font-weight:500;min-width:80px; color: #475569;}

.holidayBox{
  background:#fff;
  padding:16px;
  border-radius:12px;
  margin:12px 0;
  border:1px solid #e2e8f0;
}
.holidayHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.holidayHeader h2 {
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  box-shadow: none;
}
.addHolidayBtn{
  background:#10b981;
  color:white;
  border:none;
  padding:8px 16px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  font-weight:500;
  transition: all 0.3s;
}
.addHolidayBtn:hover {
  background: #0da271;
  transform: translateY(-2px);
}
.holidayItem{
  display:grid;
  grid-template-columns:1fr 120px auto;
  gap:10px;
  align-items:center;
  margin:8px 0;
  padding:10px;
  background:#f8fafc;
  border-radius:10px;
  border:1px solid #e2e8f0;
}
.holidayItem input[type="text"]{
  padding:10px;
  border:1px solid #e2e8f0;
  border-radius:8px;
  font-size:14px;
  background:white;
  color: #1e293b;
}
.holidayItem input[type="date"]{
  padding:10px;
  border:1px solid #e2e8f0;
  border-radius:8px;
  font-size:14px;
  min-width:120px;
  background:white;
  color:#334155;
}
.removeHoliday{
  background:#ef4444;
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 14px;
  cursor:pointer;
  font-size:16px;
  font-weight:bold;
  min-width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition: all 0.3s;
}
.removeHoliday:hover{
  background:#dc2626;
  transform: scale(1.05);
}

/* COMPLETE DELIVERY SETTINGS SECTION */
.delivery-settings {
  background: white;
  border-radius: 16px;
  padding: 16px;
  margin: 12px 0;
  border: 1px solid #e2e8f0;
}

.delivery-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin: 12px 0;
}

.delivery-input-group {
  margin-bottom: 12px;
}

.delivery-input-group label {
  display: block;
  margin-bottom: 6px;
  color: #475569;
  font-weight: 600;
  font-size: 14px;
}

.delivery-input-group input {
  width: 100%;
  padding: 10px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  background: white;
  color: #1e293b;
}

.delivery-input-group input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* DELIVERY ZONES SECTION */
.delivery-zones-container {
  margin-top: 20px;
  border-top: 2px solid #e2e8f0;
  padding-top: 16px;
}

.zone-item {
  display: grid;
  grid-template-columns: 1fr 100px 100px auto;
  gap: 8px;
  align-items: center;
  margin-bottom: 10px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
}

.zone-item input {
  padding: 8px;
  margin: 0;
  font-size: 13px;
}

.zone-actions {
  display: flex;
  gap: 6px;
}

.add-zone-btn {
  background: #8b5cf6;
  padding: 10px;
  margin-top: 10px;
  font-size: 14px;
}

/* PROFESSIONAL PAYMENT GATEWAYS - FIXED & COMPLETE */
.payment-gateways {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin: 20px 0;
}

.payment-option-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px;
  display: flex;
  align-items: flex-start;
  gap: 15px;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.payment-option-card:hover {
  border-color: #667eea;
  background: #f8fafc;
  transform: translateY(-2px);
}

.payment-option-card.selected {
  border-color: #10b981;
  background: #f0fdf4;
}

.payment-icon {
  width: 50px;
  height: 50px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  flex-shrink: 0;
}

.payment-details {
  flex: 1;
}

.payment-name {
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 4px;
  font-size: 16px;
}

.payment-fields {
  margin-top: 12px;
  display: none;
  animation: slideDown 0.3s ease;
}

.payment-option-card.selected .payment-fields {
  display: block;
}

.payment-fields input,
.payment-fields select {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 13px;
  background: white;
}

.payment-fields input:focus,
.payment-fields select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.payment-barcode-preview {
  margin-top: 8px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.payment-barcode-preview img {
  max-width: 60px;
  max-height: 60px;
  border-radius: 6px;
}

/* TOKEN SYSTEM SETTINGS - FROM INDEX.HTML INTEGRATED */
.token-settings {
  background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
  border-radius: 16px;
  padding: 20px;
  margin-top: 20px;
  border: 2px solid rgba(102, 126, 234, 0.3);
}

.token-settings h4 {
  color: #4c51bf;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 700;
}

.token-format-preview {
  background: #1e293b;
  color: #e2e8f0;
  font-family: monospace;
  padding: 12px;
  border-radius: 8px;
  font-size: 14px;
  margin-top: 8px;
  letter-spacing: 1px;
}

/* AUTO TICKET SETTINGS */
.ticket-settings {
  background: #f0f9ff;
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  border: 1px solid #bae6fd;
}

.ticket-settings h4 {
  color: #0369a1;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.ticket-template {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-top: 10px;
  border-left: 4px solid #0ea5e9;
}

/* Media Queries */
@media (max-width:480px){
  .holidayItem{
    grid-template-columns:1fr;
    gap:8px;
  }
  .holidayItem input[type="date"]{
    min-width:100%;
  }
  .social-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .delivery-grid {
    grid-template-columns: 1fr;
  }
  .zone-item {
    grid-template-columns: 1fr;
    gap: 8px;
  }
}

/* Payment Modal */
.payment-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(5px);
  z-index: 99999;
  justify-content: center;
  align-items: center;
  pointer-events: auto !important;
}

.payment-content {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 400px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  pointer-events: auto !important;
  position: relative;
  z-index: 999999;
}

.payment-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.payment-header h2 {
  margin: 0;
  color: white;
  background: transparent;
  border: none;
  padding: 0;
  box-shadow: none;
  font-size: 20px;
}

.close-payment {
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s;
  pointer-events: auto !important;
}
.close-payment:hover {
  background: rgba(255,255,255,0.3);
}

.whatsapp-preview {
  margin: 20px;
  padding: 15px;
  background: #f8fafc;
  border-radius: 12px;
  border-left: 4px solid #25D366;
}
.whatsapp-preview h4 {
  color: #25D366;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.preview-message {
  background: white;
  padding: 12px;
  border-radius: 8px;
  font-size: 14px;
  color: #1e293b;
  margin-bottom: 10px;
  line-height: 1.5;
  white-space: pre-line;
}

.form-label {
  color: #0f172a;
  font-weight: 600;
  margin-bottom: 5px;
  display: block;
  font-size: 14px;
}

input[type="file"] {
  padding: 10px;
  background: white;
  border: 2px dashed #cbd5f5;
  border-radius: 10px;
  cursor: pointer;
  pointer-events: auto !important;
}

input[type="file"]:hover {
  border-color: #667eea;
  background: #f8fafc;
}

h2 i {
  color: #667eea;
}

.success-message {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  z-index: 200000;
  max-width: 300px;
  animation: slideDown 0.5s ease;
  font-weight: 700;
  font-size: 14px;
  text-align: center;
  display: none;
  pointer-events: none;
}

@keyframes slideDown {
  from { top: -100px; opacity: 0; }
  to { top: 20px; opacity: 1; }
}

@keyframes slideUp {
  from { top: 20px; opacity: 1; }
  to { top: -100px; opacity: 0; }
}

.loading-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(10px);
  z-index: 300000;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  pointer-events: none;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  color: white;
  font-size: 18px;
  font-weight: 600;
}

/* Professional Payment Badge */
.payment-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 700;
  margin-left: 8px;
}

.payment-badge.active {
  background: #10b981;
  color: white;
}

.payment-badge.inactive {
  background: #ef4444;
  color: white;
}

/* Test Mode Indicator */
.test-mode-badge {
  background: #f59e0b;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 700;
  margin-left: 8px;
}

/* Order Token Preview */
.token-preview {
  background: #1e293b;
  border-radius: 8px;
  padding: 12px;
  margin: 10px 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.token-code {
  font-family: monospace;
  font-size: 16px;
  font-weight: 700;
  color: #10b981;
  letter-spacing: 2px;
}

.token-copy-btn {
  background: #334155;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
}

.token-copy-btn:hover {
  background: #475569;
}

/* ========== PAYMENT FIELDS FIX - CRITICAL ========== */
.payment-modal * {
  pointer-events: auto !important;
}

.payment-fields,
.payment-fields input,
.payment-fields select,
.payment-fields textarea,
.payment-fields button,
.payment-fields div,
.payment-details,
.payment-option-card,
.payment-option-card * {
  pointer-events: auto !important;
  cursor: text !important;
}

.payment-fields input,
.payment-fields select,
.payment-fields textarea {
  background: white !important;
  border: 2px solid #e2e8f0 !important;
  color: #1e293b !important;
  opacity: 1 !important;
  visibility: visible !important;
  display: block !important;
  position: relative !important;
  z-index: 999999 !important;
  pointer-events: auto !important;
  cursor: text !important;
  -webkit-user-select: auto !important;
  user-select: auto !important;
}

.payment-fields select {
  cursor: pointer !important;
}

.payment-fields input[type="file"] {
  cursor: pointer !important;
}

.payment-fields input:hover,
.payment-fields select:hover,
.payment-fields textarea:hover {
  border-color: #667eea !important;
}

.payment-fields input:focus,
.payment-fields select:focus,
.payment-fields textarea:focus {
  outline: none !important;
  border-color: #667eea !important;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2) !important;
}

.payment-option-card {
  cursor: pointer !important;
}

.payment-option-card.selected .payment-fields {
  display: block !important;
}

/* Fix for container elements */
.payment-content,
.payment-details,
.payment-gateways,
.token-settings,
.ticket-settings {
  pointer-events: auto !important;
}

/* Ensure modal doesn't block clicks */
.payment-modal {
  pointer-events: auto !important;
}

/* Fix for all inputs inside modal */
#paymentModal input:not([type="checkbox"]),
#paymentModal select,
#paymentModal textarea {
  pointer-events: auto !important;
  cursor: text !important;
}

#paymentModal input[type="checkbox"] {
  cursor: pointer !important;
  width: 18px;
  height: 18px;
}

#paymentModal label {
  cursor: pointer !important;
}

/* Emergency fix for all payment fields */
#fields-jazzcash input,
#fields-jazzcash select,
#fields-easypaisa input,
#fields-easypaisa select,
#fields-bank input,
#fields-bank select,
#fields-card input,
#fields-card select,
#fields-cod input,
#fields-cod select {
  pointer-events: auto !important;
  cursor: text !important;
  background: white !important;
  border: 2px solid #e2e8f0 !important;
  padding: 10px !important;
  margin: 6px 0 !important;
  border-radius: 8px !important;
}

/* Fix for file inputs */
#jazzcashBarcode,
#easypaisaBarcode {
  cursor: pointer !important;
}

/* Ensure selects are clickable */
.payment-fields select {
  cursor: pointer !important;
  appearance: auto !important;
  -webkit-appearance: menulist !important;
}

/* Override any potential pointer-events: none from parent styles */
.wrap *,
.form-section *,
.payment-modal * {
  pointer-events: auto !important;
}

/* Specific fix for social inputs - keep them working */
.social-input input {
  pointer-events: auto !important;
}

/* Fix for day inputs */
.dayBox input,
.dayBox select {
  pointer-events: auto !important;
}
</style>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
<div class="wrap">

<!-- Success Message -->
<div class="success-message" id="successMessage"></div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Creating your professional digital business card...</div>
</div>

<div class="form-section">
<h2><i class="fas fa-user" style="color:#667eea;"></i> Profile Information</h2>
<input type="file" id="profileImage" accept="image/*">
<input id="fullName" placeholder="Full Name (Required)" required>
<input id="phoneNumber" placeholder="Phone Number (Required)" type="tel" required>
<input id="email" placeholder="Email Address" type="email">
<input id="address" placeholder="Business Address (Required for delivery)" required>
</div>

<div class="form-section">
<h2><i class="fas fa-building" style="color:#667eea;"></i> Business Details</h2>
<input id="businessName" placeholder="Business Title (Required)" required>
<textarea id="businessAbout" placeholder="About your business" rows="4"></textarea>

<h2 style="margin-top:25px"><i class="fas fa-link" style="color:#667eea;"></i> Website & Social Media</h2>
<input type="url" id="website" placeholder="https://yourwebsite.com">

<div class="social-grid">
  <div class="social-input">
    <i class="fab fa-facebook" style="color:#1877F2;"></i>
    <input type="text" id="facebook" placeholder="Facebook URL">
  </div>
  <div class="social-input">
    <i class="fab fa-instagram" style="color:#E4405F;"></i>
    <input type="text" id="instagram" placeholder="Instagram URL">
  </div>
  <div class="social-input">
    <i class="fab fa-twitter" style="color:#1DA1F2;"></i>
    <input type="text" id="twitter" placeholder="Twitter URL">
  </div>
  <div class="social-input">
    <i class="fab fa-linkedin" style="color:#0A66C2;"></i>
    <input type="text" id="linkedin" placeholder="LinkedIn URL">
  </div>
  <div class="social-input">
    <i class="fab fa-youtube" style="color:#FF0000;"></i>
    <input type="text" id="youtube" placeholder="YouTube URL">
  </div>
  <div class="social-input">
    <i class="fab fa-tiktok" style="color:#000000;"></i>
    <input type="text" id="tiktok" placeholder="TikTok URL">
  </div>
</div>
</div>

<div class="form-section">
<h2><i class="fas fa-clock" style="color:#667eea;"></i> Business Hours</h2>
<div id="daysContainer"></div>
</div>

<div class="form-section">
<h2><i class="fas fa-calendar-times" style="color:#667eea;"></i> Special Holidays</h2>
<div id="holidaysContainer">
  <div class="holidayItem">
   <input type="text" class="holidayName" placeholder="E.g., Eid ul-Fitr" value="Eid ul-Fitr">
   <input type="date" class="holidayDate">
   <button type="button" class="removeHoliday" onclick="removeHoliday(this)">√ó</button>
  </div>
</div>
<button type="button" class="addHolidayBtn" onclick="addHoliday()">+ Add Holiday</button>
</div>

<!-- COMPLETE DELIVERY SETTINGS SECTION -->
<div class="form-section">
<h2><i class="fas fa-truck" style="color:#667eea;"></i> Complete Delivery Settings</h2>

<div class="delivery-settings">
  <h3 style="color:#1e293b; margin-bottom:15px; font-size:16px; font-weight:700;">
    <i class="fas fa-map-marker-alt"></i> Default Delivery Configuration
  </h3>
  
  <div class="delivery-grid">
    <div class="delivery-input-group">
      <label for="deliveryChargeCity">Within City - Delivery Charge (PKR)</label>
      <input type="number" id="deliveryChargeCity" placeholder="e.g., 150" min="0" value="150">
      <small style="color:#64748b;">Standard charge for same city</small>
    </div>
    
    <div class="delivery-input-group">
      <label for="deliveryChargeOther">Other Cities - Delivery Charge (PKR)</label>
      <input type="number" id="deliveryChargeOther" placeholder="e.g., 300" min="0" value="300">
      <small style="color:#64748b;">Charge for other cities</small>
    </div>
  </div>
  
  <div class="delivery-grid">
    <div class="delivery-input-group">
      <label for="deliveryTimeCity">Within City - Estimated Delivery</label>
      <input type="text" id="deliveryTimeCity" placeholder="e.g., 1-2 business days" value="1-2 business days">
      <small style="color:#64748b;">Placeholder: [X-Y] business days</small>
    </div>
    
    <div class="delivery-input-group">
      <label for="deliveryTimeOther">Other Cities - Estimated Delivery</label>
      <input type="text" id="deliveryTimeOther" placeholder="e.g., 3-5 business days" value="3-5 business days">
      <small style="color:#64748b;">Placeholder: [X-Y] business days</small>
    </div>
  </div>
  
  <div class="delivery-input-group">
    <label for="freeDeliveryMin">Free Delivery Minimum Order (PKR)</label>
    <input type="number" id="freeDeliveryMin" placeholder="e.g., 2000" min="0" value="2000">
    <small style="color:#64748b;">Orders above this amount get free delivery</small>
  </div>
  
  <div class="delivery-input-group">
    <label for="deliveryCutoffTime">Same Day Delivery Cutoff Time</label>
    <input type="time" id="deliveryCutoffTime" value="16:00">
    <small style="color:#64748b;">Orders after this time will be delivered next business day</small>
  </div>
  
  <div class="delivery-input-group">
    <label for="deliveryDays">Maximum Delivery Days</label>
    <input type="text" id="deliveryDays" placeholder="e.g., 5-7 days" value="5-7 days">
    <small style="color:#64748b;">Maximum time for remote areas</small>
  </div>
  
  <!-- MULTI-ZONE DELIVERY -->
  <div class="delivery-zones-container">
    <h4 style="display:flex; align-items:center; gap:8px; color:#475569; margin-bottom:15px;">
      <i class="fas fa-location-dot" style="color:#667eea;"></i> 
      Specific City/Zone Based Delivery (Optional)
    </h4>
    <p style="font-size:13px; color:#64748b; margin-bottom:15px;">
      Configure different charges and delivery times for specific cities or zones.
      This overrides default charges for matching addresses.
    </p>
    
    <div id="deliveryZonesList">
      <!-- Zones will be added here -->
    </div>
    
    <button type="button" class="add-zone-btn" onclick="addDeliveryZone()" style="background:#8b5cf6; width:100%;">
      <i class="fas fa-plus-circle"></i> Add Specific Zone/City
    </button>
  </div>
  
  <!-- ADDRESS CONFIRMATION SETTINGS -->
  <div style="margin-top:20px; padding:16px; background:#f0f9ff; border-radius:12px; border:1px solid #bae6fd;">
    <h4 style="display:flex; align-items:center; gap:8px; color:#0369a1; margin-bottom:12px;">
      <i class="fas fa-check-circle"></i> Address Confirmation Settings
    </h4>
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
      <input type="checkbox" id="requireAddressConfirmation" checked style="width:18px; height:18px;">
      <label for="requireAddressConfirmation" style="color:#1e293b; font-weight:600;">
        Require address confirmation before order placement
      </label>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
      <input type="checkbox" id="saveCustomerAddresses" checked style="width:18px; height:18px;">
      <label for="saveCustomerAddresses" style="color:#1e293b; font-weight:600;">
        Save customer addresses for future orders
      </label>
    </div>
  </div>
</div>
</div>

<div class="form-section">
<h2><i class="fas fa-gift" style="color:#667eea;"></i> Products & Offers</h2>
<div id="offersForm"></div>
<button type="button" onclick="addOffer()" style="background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);margin-top:12px">
 <i class="fas fa-plus"></i> Add Product
</button>
</div>

<button type="button" onclick="openPaymentModal()" style="background:linear-gradient(135deg, #059669 0%, #10b981 100%);margin-top:24px;position:relative;" id="paymentButton">
  <i class="fas fa-credit-card"></i> Configure Payments, Tokens & Tickets
</button>

<button type="button" onclick="generate()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin-top:24px" id="generateButton">
 <i class="fas fa-magic"></i> Generate Professional Digital Card
</button>
</div>

<!-- COMPLETE PAYMENT, TOKEN & TICKET MODAL - FIXED AND PROFESSIONAL -->
<div class="payment-modal" id="paymentModal">
  <div class="payment-content">
    <div class="payment-header">
      <h2><i class="fas fa-cog"></i> Payment & Token System</h2>
      <button class="close-payment" onclick="closePaymentModal()">√ó</button>
    </div>
    
    <div style="padding:20px; max-height:70vh; overflow-y:auto;">
      <!-- WhatsApp Settings -->
      <h3 style="color: #1e293b; margin-bottom: 15px; font-size: 18px; font-weight: 600; display:flex; align-items:center; gap:8px;">
        <i class="fab fa-whatsapp" style="color:#25D366;"></i> WhatsApp Business
      </h3>
      
      <div style="margin:20px 0; padding:16px; background:#f0f9ff; border-radius:12px;">
        <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">WhatsApp Number with Country Code</label>
        <input type="text" id="whatsappNumber" placeholder="+923001234567" value="+92" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;color: #1e293b; pointer-events:auto !important; cursor:text !important;">
        <small style="color:#666;display:block;margin-top:5px;">This number will receive all order notifications with tokens</small>
      </div>
      
      <div class="whatsapp-preview">
        <h4><i class="fab fa-whatsapp"></i> Order Confirmation with Token</h4>
        <div class="preview-message" id="whatsappPreview">
üéâ *NEW ORDER CONFIRMED* - TOKEN: TKT-123456-A7F2

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*Order ID:* ORD-12345678
*Token:* TKT-123456-A7F2
*Customer:* [Customer Name]
*Phone:* [Customer Phone]
*Address:* [Full Address]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*ITEMS:*
‚Ä¢ Product 1 (Qty: 1) - PKR 1,000
‚Ä¢ Product 2 (Qty: 2) - PKR 2,000

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*Subtotal:* PKR 3,000
*Delivery:* PKR 150
*TOTAL:* PKR 3,150

*Payment:* Cash on Delivery
*Est. Delivery:* 1-2 business days
*Zone:* Karachi

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Track order: Use token in delivery status
Thank you for your order! üõçÔ∏è
        </div>
        <small style="color:#666;">Auto-generated ticket with complete order details and unique token</small>
      </div>
      
      <!-- TOKEN SYSTEM SETTINGS - INTEGRATED FROM INDEX.HTML -->
      <div class="token-settings">
        <h4><i class="fas fa-ticket-alt" style="color:#667eea;"></i> Order Token System</h4>
        
        <div style="margin:15px 0;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
            <input type="checkbox" id="enableTokenSystem" checked style="width:18px; height:18px; pointer-events:auto !important; cursor:pointer !important;">
            <label for="enableTokenSystem" style="color:#1e293b; font-weight:600; cursor:pointer !important;">
              Enable automatic token generation for all orders
            </label>
          </div>
          
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
            <input type="checkbox" id="requireTokenForTracking" checked style="width:18px; height:18px; pointer-events:auto !important; cursor:pointer !important;">
            <label for="requireTokenForTracking" style="color:#1e293b; font-weight:600; cursor:pointer !important;">
              Require token for order tracking
            </label>
          </div>
        </div>
        
        <div style="margin-bottom:15px;">
          <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">Token Prefix</label>
          <input type="text" id="tokenPrefix" placeholder="e.g., TKT, ORD, SUP" value="TKT" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px; pointer-events:auto !important; cursor:text !important;">
          <small style="color:#64748b;display:block;margin-top:5px;">Will be combined with timestamp + random characters</small>
        </div>
        
        <div style="margin-bottom:15px;">
          <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">Token Length (excluding prefix)</label>
          <select id="tokenLength" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px; pointer-events:auto !important; cursor:pointer !important;">
            <option value="8">8 characters (e.g., TKT-1A2B3C4D)</option>
            <option value="10">10 characters (e.g., TKT-1A2B3C4D5E)</option>
            <option value="12" selected>12 characters (e.g., TKT-1A2B3C4D5E6F)</option>
          </select>
        </div>
        
        <div class="token-format-preview" id="tokenPreview">
          TKT-12345678-A1B2
        </div>
        <small style="color:#64748b;display:block;margin-top:8px;">
          Example token format: {PREFIX}-{TIMESTAMP}-{RANDOM}
        </small>
      </div>
      
      <!-- COMPLETE PROFESSIONAL PAYMENT GATEWAYS - FIXED -->
      <h3 style="color: #1e293b; margin: 30px 0 15px; font-size: 18px; font-weight: 600; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-credit-card"></i> Professional Payment Gateways
        <span class="payment-badge active">Active</span>
      </h3>
      
      <div class="payment-gateways" id="paymentGateways">
        <!-- JazzCash - Professional -->
        <div class="payment-option-card" onclick="selectPaymentGateway('jazzcash')" id="gateway-jazzcash">
          <div class="payment-icon" style="background:#FF6B00;">
            <i class="fas fa-mobile-alt"></i>
          </div>
          <div class="payment-details">
            <div class="payment-name">JazzCash <span style="font-size:12px; color:#64748b; font-weight:400;">Mobile Wallet</span></div>
            <div style="font-size:12px; color:#64748b;">Instant payments via JazzCash app</div>
            <div class="payment-fields" id="fields-jazzcash">
              <input type="text" id="jazzcashNumber" placeholder="JazzCash Account Number (03XXXXXXXXX)" value="03001234567" style="pointer-events:auto !important; cursor:text !important;">
              <div style="display:flex; gap:8px; margin-top:8px;">
                <input type="file" id="jazzcashBarcode" accept="image/*" style="flex:1; pointer-events:auto !important; cursor:pointer !important;">
                <span style="font-size:11px; color:#64748b; align-self:center;">Upload QR</span>
              </div>
              <div style="margin-top:8px;">
                <select id="jazzcashType" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:6px; pointer-events:auto !important; cursor:pointer !important;">
                  <option value="jazzcash">JazzCash Account</option>
                  <option value="easypaisa">EasyPaisa Account</option>
                </select>
              </div>
              <small style="color:#64748b; display:block; margin-top:5px;">
                <i class="fas fa-info-circle"></i> Customers will see this number to send payment
              </small>
            </div>
          </div>
        </div>
        
        <!-- EasyPaisa - Professional -->
        <div class="payment-option-card" onclick="selectPaymentGateway('easypaisa')" id="gateway-easypaisa">
          <div class="payment-icon" style="background:#0A5C36;">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="payment-details">
            <div class="payment-name">EasyPaisa <span style="font-size:12px; color:#64748b; font-weight:400;">Mobile Account</span></div>
            <div style="font-size:12px; color:#64748b;">Send payments via EasyPaisa app</div>
            <div class="payment-fields" id="fields-easypaisa">
              <input type="text" id="easypaisaNumber" placeholder="EasyPaisa Account Number" value="03001234567" style="pointer-events:auto !important; cursor:text !important;">
              <div style="display:flex; gap:8px; margin-top:8px;">
                <input type="file" id="easypaisaBarcode" accept="image/*" style="flex:1; pointer-events:auto !important; cursor:pointer !important;">
                <span style="font-size:11px; color:#64748b; align-self:center;">Upload QR</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Bank Transfer - Professional -->
        <div class="payment-option-card" onclick="selectPaymentGateway('bank')" id="gateway-bank">
          <div class="payment-icon" style="background:#2563eb;">
            <i class="fas fa-university"></i>
          </div>
          <div class="payment-details">
            <div class="payment-name">Bank Transfer <span style="font-size:12px; color:#64748b; font-weight:400;">Direct Deposit</span></div>
            <div style="font-size:12px; color:#64748b;">Local bank transfers</div>
            <div class="payment-fields" id="fields-bank">
              <select id="bankName" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:6px; margin-bottom:8px; pointer-events:auto !important; cursor:pointer !important;">
                <option value="HBL">Habib Bank Limited (HBL)</option>
                <option value="UBL">United Bank Limited (UBL)</option>
                <option value="MCB">MCB Bank Limited</option>
                <option value="ABL">Allied Bank Limited</option>
                <option value="Meezan">Meezan Bank</option>
                <option value="Alfalah">Bank Alfalah</option>
                <option value="Faysal">Faysal Bank</option>
                <option value="Other">Other Bank</option>
              </select>
              <input type="text" id="accountTitle" placeholder="Account Title (Exact Name)" value="Business Account" style="pointer-events:auto !important; cursor:text !important;">
              <input type="text" id="accountNumber" placeholder="Account Number" value="1234567890" style="pointer-events:auto !important; cursor:text !important;">
              <input type="text" id="ibanNumber" placeholder="IBAN (Optional)" value="PK36HBL001234567890" style="pointer-events:auto !important; cursor:text !important;">
            </div>
          </div>
        </div>
        
        <!-- Credit/Debit Card - Professional -->
        <div class="payment-option-card" onclick="selectPaymentGateway('card')" id="gateway-card">
          <div class="payment-icon" style="background:#8b5cf6;">
            <i class="fas fa-credit-card"></i>
          </div>
          <div class="payment-details">
            <div class="payment-name">Card Payment <span style="font-size:12px; color:#64748b; font-weight:400;">Visa/Mastercard</span></div>
            <div style="font-size:12px; color:#64748b;">Online card payments</div>
            <div class="payment-fields" id="fields-card">
              <select id="cardProcessor" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:6px; pointer-events:auto !important; cursor:pointer !important;">
                <option value="stripe">Stripe (International)</option>
                <option value="paypal">PayPal</option>
                <option value="razorpay">Razorpay</option>
                <option value="2checkout">2Checkout</option>
                <option value="square">Square</option>
              </select>
              <input type="text" id="merchantId" placeholder="Merchant ID / API Key / Publishable Key" value="pk_test_xxxxxxxxxxxx" style="pointer-events:auto !important; cursor:text !important;">
              <input type="text" id="webhookSecret" placeholder="Webhook Secret (Optional)" style="pointer-events:auto !important; cursor:text !important;">
              <small style="color:#64748b; display:block; margin-top:5px;">
                <i class="fas fa-lock"></i> Customer will be redirected for secure payment
              </small>
            </div>
          </div>
        </div>
        
        <!-- Cash on Delivery - Professional -->
        <div class="payment-option-card selected" onclick="selectPaymentGateway('cod')" id="gateway-cod">
          <div class="payment-icon" style="background:#10b981;">
            <i class="fas fa-truck"></i>
          </div>
          <div class="payment-details">
            <div class="payment-name">Cash on Delivery <span style="font-size:12px; color:#64748b; font-weight:400;">COD</span></div>
            <div style="font-size:12px; color:#64748b;">Pay when order arrives</div>
            <div class="payment-fields" id="fields-cod">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <input type="checkbox" id="codEnabled" checked style="width:18px; height:18px; pointer-events:auto !important; cursor:pointer !important;">
                <label for="codEnabled" style="color:#1e293b; font-weight:600; cursor:pointer !important;">Enable Cash on Delivery</label>
              </div>
              <input type="number" id="codMinimumOrder" placeholder="Minimum order amount for COD" value="500" style="margin-top:8px; pointer-events:auto !important; cursor:text !important;">
              <small style="color:#64748b; display:block; margin-top:5px;">
                <i class="fas fa-info-circle"></i> Orders below this amount require advance payment
              </small>
            </div>
          </div>
        </div>
      </div>
      
      <!-- PROFESSIONAL TICKET GENERATION SYSTEM -->
      <div class="ticket-settings">
        <h4><i class="fas fa-ticket-alt"></i> Professional Order Ticket System</h4>
        
        <div style="margin:15px 0;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
            <input type="checkbox" id="enableAutoTickets" checked style="width:18px; height:18px; pointer-events:auto !important; cursor:pointer !important;">
            <label for="enableAutoTickets" style="color:#1e293b; font-weight:600; cursor:pointer !important;">
              Automatically generate beautiful order tickets on confirmation
            </label>
          </div>
          
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
            <input type="checkbox" id="enableEmailTickets" checked style="width:18px; height:18px; pointer-events:auto !important; cursor:pointer !important;">
            <label for="enableEmailTickets" style="color:#1e293b; font-weight:600; cursor:pointer !important;">
              Send ticket details via email/SMS
            </label>
          </div>
          
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
            <input type="checkbox" id="enableWhatsappTickets" checked style="width:18px; height:18px; pointer-events:auto !important; cursor:pointer !important;">
            <label for="enableWhatsappTickets" style="color:#1e293b; font-weight:600; cursor:pointer !important;">
              Send ticket confirmation on WhatsApp with token
            </label>
          </div>
        </div>
        
        <div class="ticket-template">
          <div style="font-weight:700; color:#0369a1; margin-bottom:8px;">üé´ Professional Ticket Format</div>
          <div style="font-size:13px; background:white; padding:10px; border-radius:6px; font-family: monospace;">
            {PREFIX}-{ORDER_ID:8}-{DATE:YYYYMMDD}-{RANDOM:4}
          </div>
          <div style="font-size:12px; color:#64748b; margin-top:8px;">
            Example: TKT-12345678-20240315-A7F2
          </div>
        </div>
        
        <div style="margin-top:15px;">
          <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">Ticket ID Prefix</label>
          <input type="text" id="ticketPrefix" placeholder="e.g., TKT, ORD, SUP" value="TKT" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px; pointer-events:auto !important; cursor:text !important;">
        </div>
        
        <div style="margin-top:15px;">
          <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">Admin Email for Order Notifications</label>
          <input type="email" id="adminEmail" placeholder="admin@yourbusiness.com" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px; pointer-events:auto !important; cursor:text !important;">
        </div>
        
        <div style="margin-top:15px;">
          <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">Order Webhook URL (Optional)</label>
          <input type="url" id="webhookUrl" placeholder="https://yourdomain.com/webhook" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px; pointer-events:auto !important; cursor:text !important;">
          <small style="color:#64748b;display:block;margin-top:5px;">Receive order data via POST request when orders are placed</small>
        </div>
      </div>
      
      <button onclick="savePaymentAndTicketSettings()" style="width:100%;padding:15px;background:linear-gradient(135deg, #25D366 0%, #128C7E 100%);color:white;border:none;border-radius:12px;font-size:16px;font-weight:600;margin-top:20px;cursor:pointer; pointer-events:auto !important;">
        <i class="fas fa-save"></i> Save All Professional Settings
      </button>
      
      <button onclick="testTokenGeneration()" style="width:100%;padding:12px;background:#f1f5f9;color:#475569;border:none;border-radius:12px;font-size:14px;font-weight:600;margin-top:10px;cursor:pointer; pointer-events:auto !important;">
        <i class="fas fa-flask"></i> Test Token Generation
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const db = createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ========== GLOBAL VARIABLES ==========
let productCount = 0;
let deliveryZones = [];
let selectedPaymentGateways = ['cod']; // Default
let generatedTokens = []; // Store test tokens

// ========== UI HELPER FUNCTIONS ==========
function showSuccess(message) {
  const successMessage = document.getElementById('successMessage');
  successMessage.textContent = message;
  successMessage.style.display = 'block';
  setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
}

function showLoading() {
  document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

// ========== BUSINESS HOURS INITIALIZATION ==========
const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
days.forEach(d => {
 const dayBox = document.createElement("div");
 dayBox.className = "dayBox";
 dayBox.innerHTML = `
  <div class="dayCheck">
   <input type="checkbox" checked class="dayOpen">
  </div>
  <div class="dayContent">
   <div class="dayRow">
    <label style="min-width:100px">${d}</label>
    <select class="dayStatus" style="width:100px;padding:6px;border:1px solid #e2e8f0;border-radius:6px;">
     <option value="open">Open</option>
     <option value="closed">Closed</option>
    </select>
   </div>
   <div class="dayRow">
    <input type="time" class="dayStart" value="09:00" style="width:100px;padding:6px;border:1px solid #e2e8f0;border-radius:6px;">
    <span>to</span>
    <input type="time" class="dayEnd" value="17:00" style="width:100px;padding:6px;border:1px solid #e2e8f0;border-radius:6px;">
   </div>
  </div>
 `;
 daysContainer.appendChild(dayBox);
 
 const statusSelect = dayBox.querySelector('.dayStatus');
 const timeInputs = dayBox.querySelectorAll('.dayStart, .dayEnd');
 const openCheckbox = dayBox.querySelector('.dayOpen');
 
 statusSelect.addEventListener('change', function() {
  if(this.value === 'closed') {
   timeInputs.forEach(input => input.disabled = true);
   openCheckbox.checked = false;
  } else {
   timeInputs.forEach(input => input.disabled = false);
   openCheckbox.checked = true;
  }
 });
});

// ========== HOLIDAY MANAGEMENT ==========
function addHoliday() {
 const container = document.getElementById('holidaysContainer');
 const holidayItem = document.createElement('div');
 holidayItem.className = 'holidayItem';
 holidayItem.innerHTML = `
  <input type="text" class="holidayName" placeholder="E.g., Eid ul-Fitr">
  <input type="date" class="holidayDate" value="${new Date().toISOString().split('T')[0]}">
  <button type="button" class="removeHoliday" onclick="removeHoliday(this)">√ó</button>
 `;
 container.appendChild(holidayItem);
}

function removeHoliday(button) {
 button.parentElement.remove();
}

// ========== PRODUCT MANAGEMENT ==========
function addOffer(){
 productCount++;
 const box = document.createElement("div");
 box.className = "offer-box";
 box.innerHTML = `
  <h3><i class="fas fa-tag"></i> Product ${productCount}</h3>
  <input type="file" class="productImg" accept="image/*" style="width:100%;margin:10px 0;">
  <input class="productTitle" placeholder="Product Title" style="margin:8px 0;padding:12px;border:1px solid #e2e8f0;border-radius:8px;">
  <textarea class="productDesc" placeholder="Product Description" rows="2" style="margin:8px 0;padding:12px;border:1px solid #e2e8f0;border-radius:8px;"></textarea>
  
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;">
    <input type="number" class="originalPrice" placeholder="Original Price" style="padding:12px;border:1px solid #e2e8f0;border-radius:8px;">
    <input type="number" class="discountPrice" placeholder="Discounted Price" style="padding:12px;border:1px solid #e2e8f0;border-radius:8px;">
  </div>
  
  <div class="badgeGrid">
   <label><input type="checkbox" value="üî• Hot Deal"> Hot Deal</label>
   <label><input type="checkbox" value="‚≠ê Best Seller"> Best Seller</label>
   <label><input type="checkbox" value="üí∏ Discount"> Discount</label>
   <label><input type="checkbox" value="‚è≥ Limited Stock"> Limited Stock</label>
   <label><input type="checkbox" value="üõí In Stock"> In Stock</label>
   <label><input type="checkbox" value="üöö Free Delivery"> Free Delivery</label>
  </div>
 `;
 offersForm.appendChild(box);
 
 // Apply horizontal scrolling
 document.getElementById('offersForm').classList.add('offers-container');
}

// ========== DELIVERY ZONE MANAGEMENT ==========
function addDeliveryZone(zoneData = null) {
  const container = document.getElementById('deliveryZonesList');
  const zoneId = 'zone_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
  
  const zoneItem = document.createElement('div');
  zoneItem.className = 'zone-item';
  zoneItem.id = zoneId;
  zoneItem.innerHTML = `
    <input type="text" class="zone-name" placeholder="City/Area Name" value="${zoneData?.city || ''}">
    <input type="number" class="zone-charge" placeholder="Charge (PKR)" value="${zoneData?.charge || ''}">
    <input type="text" class="zone-time" placeholder="Delivery Time" value="${zoneData?.time || ''}">
    <div class="zone-actions">
      <button type="button" onclick="removeDeliveryZone('${zoneId}')" style="background:#ef4444; padding:8px; margin:0; width:40px; height:40px; border-radius:8px;">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  
  container.appendChild(zoneItem);
}

function removeDeliveryZone(zoneId) {
  document.getElementById(zoneId)?.remove();
}

// ========== PROFESSIONAL PAYMENT GATEWAY MANAGEMENT - FIXED ==========
function selectPaymentGateway(gateway) {
  // Single selection mode - only one gateway can be selected at a time
  selectedPaymentGateways = [gateway];
  
  // Update UI - remove selected class from all
  document.querySelectorAll('.payment-option-card').forEach(card => {
    card.classList.remove('selected');
  });
  
  // Add selected class to current gateway
  const card = document.getElementById(`gateway-${gateway}`);
  if (card) card.classList.add('selected');
  
  // Hide all payment fields
  document.querySelectorAll('.payment-fields').forEach(field => {
    field.style.display = 'none';
  });
  
  // Show current gateway fields
  const fields = document.getElementById(`fields-${gateway}`);
  if (fields) {
    fields.style.display = 'block';
    
    // Force enable all inputs in this field
    fields.querySelectorAll('input, select, textarea').forEach(input => {
      input.disabled = false;
      input.readOnly = false;
      input.style.pointerEvents = 'auto';
      input.style.cursor = input.type === 'file' ? 'pointer' : 'text';
    });
  }
}

// ========== TOKEN GENERATION SYSTEM ==========
function generateProfessionalToken() {
  const prefix = document.getElementById('tokenPrefix')?.value || 'TKT';
  const timestamp = Date.now().toString().slice(-8);
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let random = '';
  const length = parseInt(document.getElementById('tokenLength')?.value || 12) / 2;
  for (let i = 0; i < length; i++) {
    random += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return `${prefix}-${timestamp}-${random}`;
}

function generateOrderToken() {
  const prefix = document.getElementById('ticketPrefix')?.value || 'TKT';
  const timestamp = Date.now().toString().slice(-8);
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let random = '';
  for (let i = 0; i < 4; i++) {
    random += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  const date = new Date().toISOString().slice(0,10).replace(/-/g, '');
  return `${prefix}-${timestamp}-${date}-${random}`;
}

function testTokenGeneration() {
  const token = generateProfessionalToken();
  const orderToken = generateOrderToken();
  
  generatedTokens.push({ token, orderToken, time: new Date().toLocaleTimeString() });
  
  const preview = document.getElementById('tokenPreview');
  if (preview) {
    preview.innerHTML = `${token}<br><small style="color:#10b981;">Order Token: ${orderToken}</small>`;
    preview.style.padding = '12px';
    preview.style.lineHeight = '1.8';
  }
  
  showSuccess(`‚úÖ Token generated: ${token}`);
}

// ========== IMAGE COMPRESSION ==========
function resizeImage(file){
 return new Promise(res => {
  const img = new Image();
  img.onload = () => {
   const canvas = document.createElement("canvas");
   const max = 1024;
   const ratio = Math.min(max/img.width, max/img.height, 1);
   canvas.width = img.width * ratio;
   canvas.height = img.height * ratio;
   const ctx = canvas.getContext("2d");
   ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
   res(canvas.toDataURL("image/jpeg", 0.85));
  };
  img.src = URL.createObjectURL(file);
 });
}

// ========== PAYMENT MODAL FUNCTIONS ==========
function openPaymentModal() {
  const modal = document.getElementById('paymentModal');
  modal.style.display = 'flex';
  
  // Force enable all inputs in modal
  setTimeout(() => {
    modal.querySelectorAll('input, select, textarea').forEach(input => {
      input.disabled = false;
      input.readOnly = false;
      input.style.pointerEvents = 'auto';
      input.style.cursor = input.type === 'file' ? 'pointer' : 'text';
    });
  }, 100);
  
  // Update token preview
  testTokenGeneration();
}

function closePaymentModal() {
  document.getElementById('paymentModal').style.display = 'none';
}

function savePaymentAndTicketSettings() {
  showSuccess('‚úÖ Professional payment gateways, token system and tickets configured successfully!');
  
  // Generate sample token to show it's working
  const token = generateProfessionalToken();
  showSuccess(`üé´ Sample Token: ${token}`);
  
  setTimeout(() => {
    closePaymentModal();
  }, 1500);
}

// ========== SHORT ID GENERATION ==========
function generateShortId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let shortId = '';
  for (let i = 0; i < 6; i++) {
    shortId += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return shortId;
}

// ========== MAIN GENERATE FUNCTION ==========
async function generate(){
 // Validate required fields
 if(!document.getElementById('fullName').value || !document.getElementById('phoneNumber').value){
  alert("Name & Phone number are required");
  return;
 }

 if(!document.getElementById('businessName').value){
  alert("Business title is required");
  return;
 }
 
 if(!document.getElementById('address').value){
  alert("Business address is required for delivery services");
  return;
 }

 showLoading();

 try {
   const id = crypto.randomUUID();

   // Collect business hours
   const businessHoursArray = [];
   const dayBoxes = document.querySelectorAll(".dayBox");
   dayBoxes.forEach(box => {
    const open = box.querySelector(".dayOpen").checked;
    const status = box.querySelector(".dayStatus").value;
    const start = box.querySelector(".dayStart").value;
    const end = box.querySelector(".dayEnd").value;
    
    businessHoursArray.push({
     open: open && status === 'open',
     status: status,
     start: (open && status === 'open') ? start : null,
     end: (open && status === 'open') ? end : null
    });
   });

   // Collect holidays
   const holidaysArray = [];
   const holidayItems = document.querySelectorAll(".holidayItem");
   holidayItems.forEach(item => {
    const name = item.querySelector(".holidayName").value;
    const date = item.querySelector(".holidayDate").value;
    if(name.trim() && date) {
     holidaysArray.push({
      name: name.trim(),
      date: date
     });
    }
   });

   // Collect products
   const productsArray = [];
   const productBoxes = document.querySelectorAll(".offer-box");
   
   for(let i = 0; i < productBoxes.length; i++){
    const box = productBoxes[i];
    const title = box.querySelector(".productTitle").value;
    const desc = box.querySelector(".productDesc").value;
    const file = box.querySelector(".productImg").files[0];
    const originalPrice = box.querySelector(".originalPrice").value;
    const discountPrice = box.querySelector(".discountPrice").value;
    
    if(title || desc || file){
     const badges = Array.from(box.querySelectorAll("input[type=checkbox]:checked"))
      .map(cb => cb.value);
     
     const productData = {
      title: title || "",
      desc: desc || "",
      originalPrice: originalPrice ? parseFloat(originalPrice) : null,
      discountPrice: discountPrice ? parseFloat(discountPrice) : null,
      badges: badges,
      image: ""
     };
     
     if(file){
      productData.image = await resizeImage(file);
     }
     
     productsArray.push(productData);
    }
   }

   // Collect delivery zones
   const zonesList = [];
   const zoneItems = document.querySelectorAll('#deliveryZonesList .zone-item');
   zoneItems.forEach(zone => {
     const city = zone.querySelector('.zone-name').value.trim();
     const charge = zone.querySelector('.zone-charge').value;
     const time = zone.querySelector('.zone-time').value.trim();
     
     if(city && charge && time) {
       zonesList.push({
         city: city,
         charge: parseFloat(charge),
         time: time
       });
     }
   });

   // COLLECT COMPLETE PAYMENT METHODS
   const paymentMethods = {
     whatsapp: {
       active: !!document.getElementById('whatsappNumber')?.value,
       number: document.getElementById('whatsappNumber')?.value.trim() || '',
       greeting: "Hello! üëã Welcome to " + (document.getElementById('businessName')?.value.trim() || 'our business') + ". How may I assist you today?"
     },
     gateways: {},
     tokenSystem: {
       enabled: document.getElementById('enableTokenSystem')?.checked || true,
       requireTokenForTracking: document.getElementById('requireTokenForTracking')?.checked || true,
       prefix: document.getElementById('tokenPrefix')?.value || 'TKT',
       length: parseInt(document.getElementById('tokenLength')?.value || 12)
     }
   };
   
   // Collect selected payment gateways
   selectedPaymentGateways.forEach(gateway => {
     switch(gateway) {
       case 'jazzcash':
         paymentMethods.gateways.jazzcash = {
           active: true,
           number: document.getElementById('jazzcashNumber')?.value.trim() || '',
           type: document.getElementById('jazzcashType')?.value || 'jazzcash',
           barcode: ''
         };
         break;
       case 'easypaisa':
         paymentMethods.gateways.easypaisa = {
           active: true,
           number: document.getElementById('easypaisaNumber')?.value.trim() || '',
           barcode: ''
         };
         break;
       case 'bank':
         paymentMethods.gateways.bank = {
           active: true,
           bankName: document.getElementById('bankName')?.value || 'HBL',
           accountTitle: document.getElementById('accountTitle')?.value.trim() || '',
           accountNumber: document.getElementById('accountNumber')?.value.trim() || '',
           iban: document.getElementById('ibanNumber')?.value.trim() || ''
         };
         break;
       case 'card':
         paymentMethods.gateways.card = {
           active: true,
           processor: document.getElementById('cardProcessor')?.value || 'stripe',
           merchantId: document.getElementById('merchantId')?.value.trim() || '',
           webhookSecret: document.getElementById('webhookSecret')?.value.trim() || ''
         };
         break;
       case 'cod':
         paymentMethods.gateways.cod = {
           active: document.getElementById('codEnabled')?.checked || true,
           minimumOrder: parseFloat(document.getElementById('codMinimumOrder')?.value) || 500
         };
         break;
     }
   });
   
   // Process barcodes - only if gateway exists
   if (paymentMethods.gateways.jazzcash && document.getElementById('jazzcashBarcode')?.files[0]) {
     paymentMethods.gateways.jazzcash.barcode = await resizeImage(document.getElementById('jazzcashBarcode').files[0]);
   }
   if (paymentMethods.gateways.easypaisa && document.getElementById('easypaisaBarcode')?.files[0]) {
     paymentMethods.gateways.easypaisa.barcode = await resizeImage(document.getElementById('easypaisaBarcode').files[0]);
   }

   // COLLECT TICKET SYSTEM SETTINGS
   const ticketSettings = {
     enabled: document.getElementById('enableAutoTickets')?.checked || false,
     emailTickets: document.getElementById('enableEmailTickets')?.checked || false,
     whatsappTickets: document.getElementById('enableWhatsappTickets')?.checked || false,
     prefix: document.getElementById('ticketPrefix')?.value.trim() || 'TKT',
     adminEmail: document.getElementById('adminEmail')?.value.trim() || '',
     webhookUrl: document.getElementById('webhookUrl')?.value.trim() || '',
     format: '{PREFIX}-{ORDER_ID:8}-{DATE:YYYYMMDD}-{RANDOM:4}'
   };

   // COMPLETE DELIVERY SETTINGS
   const deliverySettings = {
     default: {
       withinCity: {
         charge: parseFloat(document.getElementById('deliveryChargeCity').value) || 150,
         time: document.getElementById('deliveryTimeCity').value.trim() || "1-2 business days"
       },
       otherCities: {
         charge: parseFloat(document.getElementById('deliveryChargeOther').value) || 300,
         time: document.getElementById('deliveryTimeOther').value.trim() || "3-5 business days"
       }
     },
     zones: zonesList,
     freeDeliveryMin: parseFloat(document.getElementById('freeDeliveryMin').value) || 2000,
     cutoffTime: document.getElementById('deliveryCutoffTime').value || "16:00",
     maxDays: document.getElementById('deliveryDays').value.trim() || "5-7 days",
     addressConfirmation: {
       required: document.getElementById('requireAddressConfirmation')?.checked || false,
       saveAddresses: document.getElementById('saveCustomerAddresses')?.checked || false
     }
   };

   // Social Media
   const socialMedia = {
     facebook: document.getElementById('facebook').value.trim(),
     instagram: document.getElementById('instagram').value.trim(),
     twitter: document.getElementById('twitter').value.trim(),
     linkedin: document.getElementById('linkedin').value.trim(),
     youtube: document.getElementById('youtube').value.trim(),
     tiktok: document.getElementById('tiktok').value.trim(),
     website: document.getElementById('website').value.trim()
   };

   // Prepare card data
   const cardData = {
    id: id,
    name: document.getElementById('fullName').value.trim(),
    phone: document.getElementById('phoneNumber').value.trim(),
    email: document.getElementById('email').value.trim(),
    address: document.getElementById('address').value.trim(),
    businessName: document.getElementById('businessName').value.trim(),
    business: {
     about: document.getElementById('businessAbout').value.trim()
    },
    socialMedia: socialMedia,
    businessHours: businessHoursArray,
    holidays: holidaysArray,
    products: productsArray,
    payments: paymentMethods,
    deliverySettings: deliverySettings,
    ticketSettings: ticketSettings,
    tokenSystem: paymentMethods.tokenSystem,
    ecommerce: true,
    version: '2.0.0',
    created: new Date().toISOString()
   };

   // Add profile image
   if(document.getElementById('profileImage').files[0]){
    cardData.profileImage = await resizeImage(document.getElementById('profileImage').files[0]);
   }

   // Save to Supabase
   const { data: inserted, error } = await db.from("cards").insert({
     id: id,
     data: JSON.stringify(cardData)
   }).select().single();

   if(error){
     hideLoading();
     console.error("Supabase error:", error);
     alert("Failed to save card: " + error.message);
     return;
   }

   // Store ID and redirect
   localStorage.setItem("lastCardId", inserted.id);
   
   hideLoading();
   showSuccess('‚úÖ Professional digital business card created successfully! Redirecting...');
   
   // Generate short URL and redirect
   try {
     const shortId = generateShortId();
     await db.from("short_urls").insert({
       short_id: shortId,
       full_id: inserted.id
     });
     
     showSuccess(`üé´ Token System Ready! Sample: ${generateProfessionalToken()}`);
     
     setTimeout(() => {
       location.href = "card.html?id=" + shortId;
     }, 2000);
     
   } catch (shortUrlError) {
     console.log("Short URL creation failed, using full ID:", shortUrlError);
     setTimeout(() => {
       location.href = "card.html?id=" + inserted.id;
     }, 2000);
   }

 } catch (error) {
   hideLoading();
   console.error("Error generating card:", error);
   alert("An error occurred while creating your digital card. Please try again.");
 }
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
  // Make offers horizontal
  document.getElementById('offersForm').classList.add('offers-container');
  
  // Add current date to holiday date fields
  const today = new Date().toISOString().split('T')[0];
  const holidayDateFields = document.querySelectorAll('.holidayDate');
  holidayDateFields.forEach(field => {
    if(!field.value) {
      field.value = today;
    }
  });
  
  // Add one initial product
  addOffer();
  
  // Add example delivery zones
  addDeliveryZone({city: "Karachi", charge: 150, time: "1-2 business days"});
  addDeliveryZone({city: "Lahore", charge: 200, time: "2-3 business days"});
  addDeliveryZone({city: "Islamabad", charge: 250, time: "2-3 business days"});
  addDeliveryZone({city: "Rawalpindi", charge: 250, time: "2-3 business days"});
  addDeliveryZone({city: "Faisalabad", charge: 250, time: "3-4 business days"});
  
  // Form validation
  const generateButton = document.getElementById('generateButton');
  const requiredFields = ['fullName', 'phoneNumber', 'businessName', 'address'];
  
  function validateForm() {
    let isValid = true;
    requiredFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (!field.value.trim()) {
        isValid = false;
        field.style.borderColor = '#ef4444';
      } else {
        field.style.borderColor = 'rgba(102, 126, 234, 0.3)';
      }
    });
    return isValid;
  }
  
  // Validate on input
  requiredFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    field.addEventListener('input', validateForm);
  });
  
  // Initialize payment gateways - COD selected by default
  setTimeout(() => {
    selectPaymentGateway('cod');
  }, 100);
  
  // Update WhatsApp preview
  const businessNameInput = document.getElementById('businessName');
  if (businessNameInput) {
    businessNameInput.addEventListener('input', function() {
      const preview = document.getElementById('whatsappPreview');
      if(preview) {
        preview.innerHTML = `üéâ *NEW ORDER CONFIRMED* - TOKEN: TKT-123456-A7F2

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*Order ID:* ORD-12345678
*Token:* TKT-123456-A7F2
*Customer:* [Customer Name]
*Phone:* [Customer Phone]
*Address:* [Full Address]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*ITEMS:*
‚Ä¢ Product 1 (Qty: 1) - PKR 1,000

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*Subtotal:* PKR 1,000
*Delivery:* PKR 150
*TOTAL:* PKR 1,150

*Payment:* Cash on Delivery
*Est. Delivery:* 1-2 business days

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Track order: Use token in delivery status
Thank you for your order from ${this.value}! üõçÔ∏è`;
      }
    });
  }
  
  // Update token preview when prefix changes
  const tokenPrefix = document.getElementById('tokenPrefix');
  if (tokenPrefix) {
    tokenPrefix.addEventListener('input', testTokenGeneration);
  }
  
  const tokenLength = document.getElementById('tokenLength');
  if (tokenLength) {
    tokenLength.addEventListener('change', testTokenGeneration);
  }
  
  // Validate before generating
  generateButton.addEventListener('click', function(e) {
    if (!validateForm()) {
      e.preventDefault();
      showSuccess('‚ùå Please fill in all required fields (marked in red)');
      return false;
    }
  });
  
  // Force enable all payment fields periodically
  setInterval(() => {
    const modal = document.getElementById('paymentModal');
    if (modal.style.display === 'flex') {
      modal.querySelectorAll('input, select, textarea').forEach(input => {
        input.disabled = false;
        input.readOnly = false;
        input.style.pointerEvents = 'auto';
      });
    }
  }, 500);
});
</script>
</body>
</html>
